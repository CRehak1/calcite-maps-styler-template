/*! Storymaps-Shortlist - v2.0.0 - 2016-08-23, 12:00:11 PM - This application is released under the Apache License V2.0 by Esri http://www.esri.com/ - https://github.com/Esri/map-series-storytelling-template-js */define("lib-build/css",[],function(){if(typeof window=="undefined")return{load:function(e,t,n){n()}};var e=document.getElementsByTagName("head")[0],t=window.navigator.userAgent.match(/Trident\/([^ ;]*)|AppleWebKit\/([^ ;]*)|Opera\/([^ ;]*)|rv\:([^ ;]*)(.*?)Gecko\/([^ ;]*)|MSIE\s([^ ;]*)/)||0,n=!1,r=!0;t[1]||t[7]?n=parseInt(t[1])<6||parseInt(t[7])<=9:t[2]?r=!1:t[4]&&(n=parseInt(t[4])<18);var i={};i.pluginBuilder="./css-builder";var s,o=function(){s=document.createElement("style"),e.appendChild(s)},u=function(e,t){o();var n=s.styleSheet||s.sheet;if(n&&n.addImport)n.addImport(e),s.onload=t;else{s.textContent='@import "'+e+'";';var r=setInterval(function(){try{s.sheet.cssRules,clearInterval(r),t()}catch(e){}},10)}},a=function(t,n){var i=document.createElement("link");i.type="text/css",i.rel="stylesheet";if(r)i.onload=function(){i.onload=function(){},setTimeout(n,7)};else var s=setInterval(function(){for(var e=0;e<document.styleSheets.length;e++){var t=document.styleSheets[e];if(t.href==i.href)return clearInterval(s),n()}},10);i.href=t,e.appendChild(i)};return i.normalize=function(e,t){return e.substr(e.length-4,4)==".css"&&(e=e.substr(0,e.length-4)),t(e)},i.load=function(e,t,r,i){(n?u:a)(t.toUrl(e+".css"),r)},i}),define("lib-build/css!lib-app/bootstrap/css/bootstrap.min",[],function(){}),define("lib-build/css!storymaps/common/ui/Modal",[],function(){}),define("lib-build/css!storymaps/common/Core",[],function(){}),define("storymaps/common/utils/Polyfills",[],function(){return{apply:function(){typeof String.prototype.trim!="function"&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),Date.now||(Date.now=function(){return(new Date).valueOf()}),Object.keys=Object.keys||function(e,t,n){n=[];for(t in e)n.hasOwnProperty.call(e,t)&&n.push(t);return n},function(){function n(e){this.message=e}var e=typeof exports!="undefined"?exports:this,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";n.prototype=new Error,n.prototype.name="InvalidCharacterError",e.btoa||(e.btoa=function(e){var r=String(e);for(var i,s,o=0,u=t,a="";r.charAt(o|0)||(u="=",o%1);a+=u.charAt(63&i>>8-o%1*8)){s=r.charCodeAt(o+=.75);if(s>255)throw new n("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");i=i<<8|s}return a}),e.atob||(e.atob=function(e){var r=String(e).replace(/=+$/,"");if(r.length%4==1)throw new n("'atob' failed: The string to be decoded is not correctly encoded.");for(var i=0,s,o,u=0,a="";o=r.charAt(u++);~o&&(s=i%4?s*64+o:o,i++%4)?a+=String.fromCharCode(255&s>>(-2*i&6)):0)o=t.indexOf(o);return a})}()}}}),define("storymaps/common/utils/SocialSharing",["dojo/Deferred","esri/urlUtils"],function(e,t){return{shareFacebook:function(e,t,n,r){var i="&p[title]="+encodeURIComponent(e||"")+"&p[summary]="+t+"&p[url]="+this.cleanURL(r||document.location.href);n?i+="&p[images][0]="+encodeURIComponent(n):i+="&p[images][0]="+encodeURIComponent($("meta[property='og:image']").attr("content")),window.open("http://www.facebook.com/sharer.php?s=100"+i,"","toolbar=0,status=0,width=626,height=436")},shareTwitter:function(e,t){var n="text="+encodeURIComponent(e||"")+"&url="+this.cleanURL(t||document.location.href)+"&related=EsriStoryMaps"+"&hashtags=storymap";window.open("https://twitter.com/intent/tweet?"+n,"","toolbar=0,status=0,width=626,height=436")},requestBitly:function(t){var n=["http://api.bitly.com/v3/shorten?callback=?","https://api-ssl.bitly.com/v3/shorten?callback=?"],r=location.protocol=="http:"?n[0]:n[1],i=this.cleanURL(t||document.location.href,!0),s=new e;return $.getJSON(r,{format:"json",apiKey:app.cfg.HEADER_SOCIAL.bitly.key,login:app.cfg.HEADER_SOCIAL.bitly.login,longUrl:i},function(e){!e||!e||!e.data.url?s.reject():s.resolve(e.data.url)}),s},cleanURL:function(e,n){var r=t.urlToObject(e),i=r.path;return r.query&&(delete r.query.edit,delete r.query.locale,delete r.query.folderId,$.each(Object.keys(r.query),function(e,t){e===0?i+="?":i+="&",i+=t+"="+r.query[t]})),n?i:encodeURIComponent(i)}}}),define("storymaps/common/utils/CommonHelper",["dojo/cookie","dojo/has","dojo/Deferred","dojo/DeferredList","./SocialSharing","esri/request","esri/dijit/Search","esri/tasks/locator","esri/urlUtils","esri/arcgis/utils","esri/geometry/webMercatorUtils","esri/geometry/Point","esri/geometry/Extent","esri/geometry/Polygon","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISTiledMapServiceLayer","esri/layers/OpenStreetMapLayer"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){return{isMobile:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)||navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/IEMobile/i)},switchToBuilder:function(){document.location.search.match(/appid/)?document.location=i.cleanURL(document.location.protocol+"//"+document.location.host+document.location.pathname+document.location.search,!0)+"&edit"+document.location.hash:document.location.search.slice(-1)=="?"?document.location=i.cleanURL(document.location.protocol+"//"+document.location.host+document.location.pathname,!0)+"?edit"+document.location.hash:document.location=i.cleanURL(document.location.protocol+"//"+document.location.host+document.location.pathname,!0)+"?edit"+document.location.hash},isArcGISHosted:function(){return/(\/)([a-zA-Z0-9]+(\/))*(apps\/|home\/)([a-zA-Z0-9\-\_]+\/)/.test(document.location.pathname)},browserSupportHistory:function(){return!!window.history&&!!history.pushState},getUrlParams:function(){var e=a.urlToObject(document.location.search).query;return e?e:!this.browserSupportHistory()&&!e?a.urlToObject(document.location.hash).query||{}:{}},getWebmapID:function(e){var t=this.getUrlParams();if(app.indexCfg&&app.indexCfg.webmap)return app.indexCfg.webmap;if(this.isArcGISHosted()||!e)return t.webmap;if(app.indexCfg.authorizedOwners&&app.indexCfg.authorizedOwners.length>0&&app.indexCfg.authorizedOwners[0])return t.webmap},getAppID:function(e){var t=this.getUrlParams();if(app.indexCfg&&app.indexCfg.appid)return app.indexCfg.appid;if(this.isArcGISHosted()||!e)return t.appid;if(app.indexCfg.authorizedOwners&&app.indexCfg.authorizedOwners.length>0&&app.indexCfg.authorizedOwners[0])return t.appid},getGraphicsLayerByName:function(e,t){var n;for(var r=0;r<e.graphicsLayerIds.length;r++){n=e.getLayer(e.graphicsLayerIds[r]);if(n.name==t)return n}return null},getWebMapExtentFromItem:function(e){if(!e.extent||e.extent.length!=2)return null;var t=l.geographicToWebMercator(new c(e.extent[0][0],e.extent[0][1])),n=l.geographicToWebMercator(new c(e.extent[1][0],e.extent[1][1]));return new h({xmax:n.x,xmin:t.x,ymax:n.y,ymin:t.y,spatialReference:{wkid:102100}})},serializeExtentToItem:function(e){if(!e||!e.spatialReference)return null;var t=e.spatialReference.wkid==4326?e:l.webMercatorToGeographic(e);return[[Math.round(t.xmin*1e4)/1e4,Math.round(t.ymin*1e4)/1e4],[Math.round(t.xmax*1e4)/1e4,Math.round(t.ymax*1e4)/1e4]]},serializedExtentEquals:function(e,t){return e&&t&&e.length==t.length&&e.length==2&&e[0][0]==t[0][0]&&e[0][1]==t[0][1]&&e[1][0]==t[1][0]&&e[1][1]==t[1][1]},cloneLayer:function(e){return e.url&&e.url.match(/virtualearth\./)?new v("http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer"):e instanceof v?new v(e.url):e instanceof d?new d(e.url):e.id=="OpenStreetMap"?new m:new v("http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer")},extentToPolygon:function(e){var t=new p(e.spatialReference);return t.addRing([[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]),t},getFirstLevelWhereExtentFit:function(e,t){var n=t.width,r=t.height,i=t._params.lods;if(!i)return-1;for(var s=i.length-1;s>=0;s--)if(n*t._params.lods[s].resolution>e.getWidth()&&r*t._params.lods[s].resolution>e.getHeight())return s;return-1},getPortalUser:function(){var t=e("esri_auth");if(!t)return;t=JSON.parse(t.replace('"ssl":undefined','"ssl":""'));if(t.urlKey&&t.customBaseUrl&&(t.urlKey+"."+t.customBaseUrl).toLowerCase()!=document.location.hostname.toLowerCase())return;return t?t.email:null},getPortalRole:function(){var t=e("esri_auth");if(!t)return;t=JSON.parse(t.replace('"ssl":undefined','"ssl":""'));if(t.urlKey&&t.customBaseUrl&&(t.urlKey+"."+t.customBaseUrl).toLowerCase()!=document.location.hostname.toLowerCase())return;return t?t.role:null},getAppViewModeURL:function(){return document.location.protocol+"//"+document.location.host+document.location.pathname+"?appid="+app.data.getWebAppItem().id},getWebmapViewerLinkFromSharingURL:function(e){var t=e.split("/sharing/")[0];return t+"/home/webmap/viewer.html"},getPortalURL:function(){return f.arcgisUrl.split("/sharing/")[0]},getItemURL:function(e){return this.getPortalURL()+"/home/item.html?id="+e},getMyContentURL:function(){return this.getPortalURL()+"/home/content.html"},getMyStoriesURL:function(){return app.isPortal?this.getPortalURL()+"/apps/MyStories/":"//storymaps.arcgis.com/en/my-stories/"},browserSupportAttachementUsingFileReader:function(){return!!window.FileReader&&!!window.FormData&&!!this.browserSupportCanvas()&&!!window.Blob},browserSupportCanvas:function(){var e=document.createElement("canvas");return!!e.getContext&&!!e.getContext("2d")},browserSupportFileReaderBinaryString:function(){if(!window.FileReader)return!1;var e=new window.FileReader;return"readAsArrayBuffer"in e},getBinaryStringFromArrayBuffer:function(e){var t=new Uint8Array(e),n="";for(var r=0;r<t.length;r++)n+=String.fromCharCode(t[r]);return n},addCSSRule:function(e,n,r){var i="head";if(t("ie")<=8)return;r&&(i=r.contents().find("head"));if(n){var s=$(i).find("#"+n).eq(0);if(s.length){s.html(e);return}}$("<style>").prop("type","text/css").attr("id",n).html(e).appendTo(i)},hex2rgba:function(e,t){if(!e||e==="")return"";var n=e.replace("#","").match(/../g),r=[],i;for(i in n)r.push(parseInt(n[i],16));return r.push(t),"rgba("+r.join()+")"},prependURLHTTP:function(e){return!e||e===""||e.match(/^mailto:/)?e:/^(https?:\/\/)|^(\/\/)/i.test(e)?e:"http://"+e},checkImageURL:function(e){return e&&e.match(/((\.png)|(\.jp(e)?g))$/i)},createGeocoder:function(e){var t=new n;if(!e||!e.map||!e.domNode)return t.resolve(),t;if(!app.cfg.HELPER_SERVICES.geocode)return t.resolve(),t;var i=[];$.each(app.cfg.HELPER_SERVICES.geocode,function(e,t){var n=s({url:t.url,content:{f:"json"},handleAs:"json",callbackParamName:"callback"});i.push(n)});var a=new r(i);return a.then(function(n){var r=[];$.each(n,function(e,t){if(!t[0])return;if(!t[1]||!t[1].singleLineAddressField)return;var n={};n.singleLineFieldName=t[1].singleLineAddressField.name;var i=new u(app.cfg.HELPER_SERVICES.geocode[e].url);n.name=app.cfg.HELPER_SERVICES.geocode[e].name?app.cfg.HELPER_SERVICES.geocode[e].name:t[1].name,n.locator=i,r.push(n)});if(r.length){var i=new o({map:e.map,sources:[],allPlaceholder:e.placeHolder,enableButtonMode:e.enableButtonMode},e.domNode),s=i.get("sources");$.each(r,function(e,t){s.push(t)}),i.set("sources",s),i.startup(),t.resolve(i)}}),t},debounce:function(e,t,n){var r;return function(){var i=this,s=arguments;clearTimeout(r),r=setTimeout(function(){r=null,n||e.apply(i,s)},t),n&&!r&&e.apply(i,s)}},findDifferences:function(e,t){var n=[],r=["this"];return function(e,t){if(e.constructor==Array)if(!t||t.constructor!=Array||t.length!=e.length)n.push({Property:r.join(""),ObjectA:e,ObjectB:t});else for(var i=0;i<e.length;i++)r.push("["+i.toString()+"]"),arguments.callee(e[i],t[i]),r.pop();else if(e.constructor==Object||e.constructor!=Number&&e.constructor!=String&&e.constructor!=Date&&e.constructor!=RegExp&&e.constructor!=Function&&e.constructor!=Boolean)for(var s in e)r.push("."+s),t[s]?e[s]&&e[s].constructor!=Function&&arguments.callee(e[s],t[s]):n.push({Property:r.join(""),ObjectA:e[s],ObjectB:null}),r.pop();else e.constructor!=Function&&e!=t&&n.push({Property:r.join(""),ObjectA:e,ObjectB:t})}(e,t),n}}}),define("storymaps/common/builder/PortalVersionTest",["esri/arcgis/utils","dojo/Deferred"],function(e,t){function n(){return e.arcgisUrl.split("/sharing/")[0]}return{run:function(){var e=new t,r=null;app.portal.hasMyStories=null;var i=new Image,s=app.isProduction?n()+"/apps/":"../";return i.src=s+"MyStories/assets/my-stories-portal-detector.png",i.onload=function(){app.portal.hasMyStories=!0,r&&clearTimeout(r),e.resolve()},i.onerror=i.onabort=function(){app.portal.hasMyStories=!1,r&&clearTimeout(r),e.reject()},r=setTimeout(function(){e.reject()},2e3),e}}}),define("storymaps/common/builder/MyStoriesWrapper",["./PortalVersionTest","esri/IdentityManager","storymaps/common/utils/CommonHelper","dojo/topic"],function(e,t,n,r){function i(){e.run().then(function(){app.isProduction&&!f()?s():o()},s)}function s(){$(".check-story").hide()}function o(){window.myStoriesInit=u,r.publish("MYSTORIES_SCAN","start");var e="../MyStories/index.html?fromBuilder";e+="&locale="+dojo.locale,setTimeout(function(){$("#my-stories-frame").attr("src",e)},1e3)}function u(){var e=$("#my-stories-frame")[0].contentWindow;if(!e||!e.init||!e.check||!e.share){console.error("Failed to load My Stories");return}if(!app.data.getStoryLength()){console.log("Skipping the initialization of My Stories until the story has content");return}app.mystories={init:e.init,check:e.check,share:e.share,isChecking:!1,hasCheckErrors:!1,hasScanErrors:!1},app.mystories.init(app.isInBuilder?t.toJson():null,app.isDirectCreationFirstSave||app.isGalleryCreation?null:app.data.getWebAppItem(),app.cfg.TPL_ID,function(e,t,n){r.publish("MY-STORIES-EDIT-MEDIA",{index:e,type:t,actionId:n})},function(e){r.publish("MY-STORIES-EDIT-MAP",{id:e})},function(){app.mystories.hasCheckErrors=!1,r.publish("MY-STORIES-REFRESH")},function(e){e=e||{completed:!1,ignoreAllIssues:!1},app.mystories.hasCheckErrors=!e.ignoreAllIssues,app.mystories.forcedIgnoreIssues=e.ignoreAllIssues,r.publish("MY-STORIES-REFRESH")}).then(a,function(){console.error("Failed to initialize My Stories")})}function a(){if(!app.mystories)return;app.mystories.isChecking=!0,app.mystories.hasCheckErrors=!1,r.publish("MYSTORIES_SCAN","start"),app.mystories.check(app.data.getWebAppData().get()).then(function(e){e=e||{ignoreAllIssues:!1},app.mystories.isChecking=!1,app.mystories.hasCheckErrors=!1,app.mystories.forcedIgnoreIssues=e.ignoreAllIssues,r.publish("MYSTORIES_SCAN","success"),$("#sharePopup").is(":visible")&&app.builder.openSharePopup()},function(e){e=e||{completed:!1,ignoreAllIssues:!1},app.mystories.isChecking=!1,app.mystories.hasCheckErrors=!0,app.mystories.forcedIgnoreIssues=e.ignoreAllIssues,r.publish("MYSTORIES_SCAN","error"),$("#sharePopup").is(":visible")&&app.builder.openSharePopup()})}function f(){var e=n.getPortalURL().split("//").slice(-1)[0],t=e.split("."),r=document.location.host,i=r.split(".");return e==r||e.split("/").length>1&&e.split("/")[0]==r?!0:i.length<3?r==e:i.slice(1).join(".")==t.slice(-2).join(".")}return{loadMyStories:i,scanStory:a,myStoriesIsSameDomain:f}});if("undefined"==typeof jQuery)throw new Error("Bootstrap's JavaScript requires jQuery");+function(e){"use strict";var t=e.fn.jquery.split(" ")[0].split(".");if(t[0]<2&&t[1]<9||1==t[0]&&9==t[1]&&t[2]<1)throw new Error("Bootstrap's JavaScript requires jQuery version 1.9.1 or higher")}(jQuery),+function(e){"use strict";function t(t){var n=t.attr("data-target");n||(n=t.attr("href"),n=n&&/#[A-Za-z]/.test(n)&&n.replace(/.*(?=#[^\s]*$)/,""));var r=n&&e(n);return r&&r.length?r:t.parent()}function n(n){n&&3===n.which||(e(i).remove(),e(s).each(function(){var r=e(this),i=t(r),s={relatedTarget:this};i.hasClass("open")&&(n&&"click"==n.type&&/input|textarea/i.test(n.target.tagName)&&e.contains(i[0],n.target)||(i.trigger(n=e.Event("hide.bs.dropdown",s)),n.isDefaultPrevented()||(r.attr("aria-expanded","false"),i.removeClass("open").trigger("hidden.bs.dropdown",s))))}))}function r(t){return this.each(function(){var n=e(this),r=n.data("bs.dropdown");r||n.data("bs.dropdown",r=new o(this)),"string"==typeof t&&r[t].call(n)})}var i=".dropdown-backdrop",s='[data-toggle="dropdown"]',o=function(t){e(t).on("click.bs.dropdown",this.toggle)};o.VERSION="3.3.5",o.prototype.toggle=function(r){var i=e(this);if(!i.is(".disabled, :disabled")){var s=t(i),o=s.hasClass("open");if(n(),!o){"ontouchstart"in document.documentElement&&!s.closest(".navbar-nav").length&&e(document.createElement("div")).addClass("dropdown-backdrop").insertAfter(e(this)).on("click",n);var u={relatedTarget:this};if(s.trigger(r=e.Event("show.bs.dropdown",u)),r.isDefaultPrevented())return;i.trigger("focus").attr("aria-expanded","true"),s.toggleClass("open").trigger("shown.bs.dropdown",u)}return!1}},o.prototype.keydown=function(n){if(/(38|40|27|32)/.test(n.which)&&!/input|textarea/i.test(n.target.tagName)){var r=e(this);if(n.preventDefault(),n.stopPropagation(),!r.is(".disabled, :disabled")){var i=t(r),o=i.hasClass("open");if(!o&&27!=n.which||o&&27==n.which)return 27==n.which&&i.find(s).trigger("focus"),r.trigger("click");var u=" li:not(.disabled):visible a",a=i.find(".dropdown-menu"+u);if(a.length){var f=a.index(n.target);38==n.which&&f>0&&f--,40==n.which&&f<a.length-1&&f++,~f||(f=0),a.eq(f).trigger("focus")}}}};var u=e.fn.dropdown;e.fn.dropdown=r,e.fn.dropdown.Constructor=o,e.fn.dropdown.noConflict=function(){return e.fn.dropdown=u,this},e(document).on("click.bs.dropdown.data-api",n).on("click.bs.dropdown.data-api",".dropdown form",function(e){e.stopPropagation()}).on("click.bs.dropdown.data-api",s,o.prototype.toggle).on("keydown.bs.dropdown.data-api",s,o.prototype.keydown).on("keydown.bs.dropdown.data-api",".dropdown-menu",o.prototype.keydown)}(jQuery),+function(e){"use strict";function t(t,r){return this.each(function(){var s=e(this),u=s.data("bs.modal"),a=e.extend({},n.DEFAULTS,s.data(),"object"==typeof t&&t);u||s.data("bs.modal",u=new n(this,a)),"string"==typeof t?u[t](r):a.show&&u.show(r)})}var n=function(t,n){this.options=n,this.$body=e(document.body),this.$element=e(t),this.$dialog=this.$element.find(".modal-dialog"),this.$backdrop=null,this.isShown=null,this.originalBodyPad=null,this.scrollbarWidth=0,this.ignoreBackdropClick=!1,this.options.remote&&this.$element.find(".modal-content").load(this.options.remote,e.proxy(function(){this.$element.trigger("loaded.bs.modal")},this))};n.VERSION="3.3.5",n.TRANSITION_DURATION=300,n.BACKDROP_TRANSITION_DURATION=150,n.DEFAULTS={backdrop:!0,keyboard:!0,show:!0},n.prototype.toggle=function(e){return this.isShown?this.hide():this.show(e)},n.prototype.show=function(t){var r=this,s=e.Event("show.bs.modal",{relatedTarget:t});this.$element.trigger(s),this.isShown||s.isDefaultPrevented()||(this.isShown=!0,this.checkScrollbar(),this.setScrollbar(),this.$body.addClass("modal-open"),this.escape(),this.resize(),this.$element.on("click.dismiss.bs.modal",'[data-dismiss="modal"]',e.proxy(this.hide,this)),this.$dialog.on("mousedown.dismiss.bs.modal",function(){r.$element.one("mouseup.dismiss.bs.modal",function(t){e(t.target).is(r.$element)&&(r.ignoreBackdropClick=!0)})}),this.backdrop(function(){var s=e.support.transition&&r.$element.hasClass("fade");r.$element.parent().length||r.$element.appendTo(r.$body),r.$element.show().scrollTop(0),r.adjustDialog(),s&&r.$element[0].offsetWidth,r.$element.addClass("in"),r.enforceFocus();var u=e.Event("shown.bs.modal",{relatedTarget:t});s?r.$dialog.one("bsTransitionEnd",function(){r.$element.trigger("focus").trigger(u)}).emulateTransitionEnd(n.TRANSITION_DURATION):r.$element.trigger("focus").trigger(u)}))},n.prototype.hide=function(t){t&&t.preventDefault(),t=e.Event("hide.bs.modal"),this.$element.trigger(t),this.isShown&&!t.isDefaultPrevented()&&(this.isShown=!1,this.escape(),this.resize(),e(document).off("focusin.bs.modal"),this.$element.removeClass("in").off("click.dismiss.bs.modal").off("mouseup.dismiss.bs.modal"),this.$dialog.off("mousedown.dismiss.bs.modal"),e.support.transition&&this.$element.hasClass("fade")?this.$element.one("bsTransitionEnd",e.proxy(this.hideModal,this)).emulateTransitionEnd(n.TRANSITION_DURATION):this.hideModal())},n.prototype.enforceFocus=function(){e(document).off("focusin.bs.modal").on("focusin.bs.modal",e.proxy(function(e){this.$element[0]===e.target||this.$element.has(e.target).length||this.$element.trigger("focus")},this))},n.prototype.escape=function(){this.isShown&&this.options.keyboard?this.$element.on("keydown.dismiss.bs.modal",e.proxy(function(e){27==e.which&&this.hide()},this)):this.isShown||this.$element.off("keydown.dismiss.bs.modal")},n.prototype.resize=function(){this.isShown?e(window).on("resize.bs.modal",e.proxy(this.handleUpdate,this)):e(window).off("resize.bs.modal")},n.prototype.hideModal=function(){var e=this;this.$element.hide(),this.backdrop(function(){e.$body.removeClass("modal-open"),e.resetAdjustments(),e.resetScrollbar(),e.$element.trigger("hidden.bs.modal")})},n.prototype.removeBackdrop=function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},n.prototype.backdrop=function(t){var r=this,s=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var o=e.support.transition&&s;if(this.$backdrop=e(document.createElement("div")).addClass("modal-backdrop "+s).appendTo(this.$body),this.$element.on("click.dismiss.bs.modal",e.proxy(function(e){return this.ignoreBackdropClick?void (this.ignoreBackdropClick=!1):void (e.target===e.currentTarget&&("static"==this.options.backdrop?this.$element[0].focus():this.hide()))},this)),o&&this.$backdrop[0].offsetWidth,this.$backdrop.addClass("in"),!t)return;o?this.$backdrop.one("bsTransitionEnd",t).emulateTransitionEnd(n.BACKDROP_TRANSITION_DURATION):t()}else if(!this.isShown&&this.$backdrop){this.$backdrop.removeClass("in");var u=function(){r.removeBackdrop(),t&&t()};e.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one("bsTransitionEnd",u).emulateTransitionEnd(n.BACKDROP_TRANSITION_DURATION):u()}else t&&t()},n.prototype.handleUpdate=function(){this.adjustDialog()},n.prototype.adjustDialog=function(){var e=this.$element[0].scrollHeight>document.documentElement.clientHeight;this.$element.css({paddingLeft:!this.bodyIsOverflowing&&e?this.scrollbarWidth:"",paddingRight:this.bodyIsOverflowing&&!e?this.scrollbarWidth:""})},n.prototype.resetAdjustments=function(){this.$element.css({paddingLeft:"",paddingRight:""})},n.prototype.checkScrollbar=function(){var e=window.innerWidth;if(!e){var t=document.documentElement.getBoundingClientRect();e=t.right-Math.abs(t.left)}this.bodyIsOverflowing=document.body.clientWidth<e,this.scrollbarWidth=this.measureScrollbar()},n.prototype.setScrollbar=function(){var e=parseInt(this.$body.css("padding-right")||0,10);this.originalBodyPad=document.body.style.paddingRight||"",this.bodyIsOverflowing&&this.$body.css("padding-right",e+this.scrollbarWidth)},n.prototype.resetScrollbar=function(){this.$body.css("padding-right",this.originalBodyPad)},n.prototype.measureScrollbar=function(){var e=document.createElement("div");e.className="modal-scrollbar-measure",this.$body.append(e);var t=e.offsetWidth-e.clientWidth;return this.$body[0].removeChild(e),t};var r=e.fn.modal;e.fn.modal=t,e.fn.modal.Constructor=n,e.fn.modal.noConflict=function(){return e.fn.modal=r,this},e(document).on("click.bs.modal.data-api",'[data-toggle="modal"]',function(n){var r=e(this),i=r.attr("href"),s=e(r.attr("data-target")||i&&i.replace(/.*(?=#[^\s]+$)/,"")),o=s.data("bs.modal")?"toggle":e.extend({remote:!/#/.test(i)&&i},s.data(),r.data());r.is("a")&&n.preventDefault(),s.one("show.bs.modal",function(e){e.isDefaultPrevented()||s.one("hidden.bs.modal",function(){r.is(":visible")&&r.trigger("focus")})}),t.call(s,o,this)})}(jQuery),+function(e){"use strict";function t(t){return this.each(function(){var r=e(this),s=r.data("bs.tooltip"),o="object"==typeof t&&t;(s||!/destroy|hide/.test(t))&&(s||r.data("bs.tooltip",s=new n(this,o)),"string"==typeof t&&s[t]())})}var n=function(e,t){this.type=null,this.options=null,this.enabled=null,this.timeout=null,this.hoverState=null,this.$element=null,this.inState=null,this.init("tooltip",e,t)};n.VERSION="3.3.5",n.TRANSITION_DURATION=150,n.DEFAULTS={animation:!0,placement:"top",selector:!1,template:'<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',trigger:"hover focus",title:"",delay:0,html:!1,container:!1,viewport:{selector:"body",padding:0}},n.prototype.init=function(t,n,r){if(this.enabled=!0,this.type=t,this.$element=e(n),this.options=this.getOptions(r),this.$viewport=this.options.viewport&&e(e.isFunction(this.options.viewport)?this.options.viewport.call(this,this.$element):this.options.viewport.selector||this.options.viewport),this.inState={click:!1,hover:!1,focus:!1},this.$element[0]instanceof document.constructor&&!this.options.selector)throw new Error("`selector` option must be specified when initializing "+this.type+" on the window.document object!");for(var i=this.options.trigger.split(" "),s=i.length;s--;){var o=i[s];if("click"==o)this.$element.on("click."+this.type,this.options.selector,e.proxy(this.toggle,this));else if("manual"!=o){var u="hover"==o?"mouseenter":"focusin",a="hover"==o?"mouseleave":"focusout";this.$element.on(u+"."+this.type,this.options.selector,e.proxy(this.enter,this)),this.$element.on(a+"."+this.type,this.options.selector,e.proxy(this.leave,this))}}this.options.selector?this._options=e.extend({},this.options,{trigger:"manual",selector:""}):this.fixTitle()},n.prototype.getDefaults=function(){return n.DEFAULTS},n.prototype.getOptions=function(t){return t=e.extend({},this.getDefaults(),this.$element.data(),t),t.delay&&"number"==typeof t.delay&&(t.delay={show:t.delay,hide:t.delay}),t},n.prototype.getDelegateOptions=function(){var t={},n=this.getDefaults();return this._options&&e.each(this._options,function(e,r){n[e]!=r&&(t[e]=r)}),t},n.prototype.enter=function(t){var n=t instanceof this.constructor?t:e(t.currentTarget).data("bs."+this.type);return n||(n=new this.constructor(t.currentTarget,this.getDelegateOptions()),e(t.currentTarget).data("bs."+this.type,n)),t instanceof e.Event&&(n.inState["focusin"==t.type?"focus":"hover"]=!0),n.tip().hasClass("in")||"in"==n.hoverState?void (n.hoverState="in"):(clearTimeout(n.timeout),n.hoverState="in",n.options.delay&&n.options.delay.show?void (n.timeout=setTimeout(function(){"in"==n.hoverState&&n.show()},n.options.delay.show)):n.show())},n.prototype.isInStateTrue=function(){for(var e in this.inState)if(this.inState[e])return!0;return!1},n.prototype.leave=function(t){var n=t instanceof this.constructor?t:e(t.currentTarget).data("bs."+this.type);return n||(n=new this.constructor(t.currentTarget,this.getDelegateOptions()),e(t.currentTarget).data("bs."+this.type,n)),t instanceof e.Event&&(n.inState["focusout"==t.type?"focus":"hover"]=!1),n.isInStateTrue()?void 0:(clearTimeout(n.timeout),n.hoverState="out",n.options.delay&&n.options.delay.hide?void (n.timeout=setTimeout(function(){"out"==n.hoverState&&n.hide()},n.options.delay.hide)):n.hide())},n.prototype.show=function(){var t=e.Event("show.bs."+this.type);if(this.hasContent()&&this.enabled){this.$element.trigger(t);var r=e.contains(this.$element[0].ownerDocument.documentElement,this.$element[0]);if(t.isDefaultPrevented()||!r)return;var s=this,o=this.tip(),u=this.getUID(this.type);this.setContent(),o.attr("id",u),this.$element.attr("aria-describedby",u),this.options.animation&&o.addClass("fade");var a="function"==typeof this.options.placement?this.options.placement.call(this,o[0],this.$element[0]):this.options.placement,f=/\s?auto?\s?/i,l=f.test(a);l&&(a=a.replace(f,"")||"top"),o.detach().css({top:0,left:0,display:"block"}).addClass(a).data("bs."+this.type,this),this.options.container?o.appendTo(this.options.container):o.insertAfter(this.$element),this.$element.trigger("inserted.bs."+this.type);var c=this.getPosition(),h=o[0].offsetWidth,p=o[0].offsetHeight;if(l){var d=a,v=this.getPosition(this.$viewport);a="bottom"==a&&c.bottom+p>v.bottom?"top":"top"==a&&c.top-p<v.top?"bottom":"right"==a&&c.right+h>v.width?"left":"left"==a&&c.left-h<v.left?"right":a,o.removeClass(d).addClass(a)}var m=this.getCalculatedOffset(a,c,h,p);this.applyPlacement(m,a);var g=function(){var e=s.hoverState;s.$element.trigger("shown.bs."+s.type),s.hoverState=null,"out"==e&&s.leave(s)};e.support.transition&&this.$tip.hasClass("fade")?o.one("bsTransitionEnd",g).emulateTransitionEnd(n.TRANSITION_DURATION):g()}},n.prototype.applyPlacement=function(t,n){var r=this.tip(),i=r[0].offsetWidth,s=r[0].offsetHeight,o=parseInt(r.css("margin-top"),10),u=parseInt(r.css("margin-left"),10);isNaN(o)&&(o=0),isNaN(u)&&(u=0),t.top+=o,t.left+=u,e.offset.setOffset(r[0],e.extend({using:function(e){r.css({top:Math.round(e.top),left:Math.round(e.left)})}},t),0),r.addClass("in");var a=r[0].offsetWidth,f=r[0].offsetHeight;"top"==n&&f!=s&&(t.top=t.top+s-f);var l=this.getViewportAdjustedDelta(n,t,a,f);l.left?t.left+=l.left:t.top+=l.top;var c=/top|bottom/.test(n),h=c?2*l.left-i+a:2*l.top-s+f,p=c?"offsetWidth":"offsetHeight";r.offset(t),this.replaceArrow(h,r[0][p],c)},n.prototype.replaceArrow=function(e,t,n){this.arrow().css(n?"left":"top",50*(1-e/t)+"%").css(n?"top":"left","")},n.prototype.setContent=function(){var e=this.tip(),t=this.getTitle();e.find(".tooltip-inner")[this.options.html?"html":"text"](t),e.removeClass("fade in top bottom left right")},n.prototype.hide=function(t){function r(){"in"!=s.hoverState&&o.detach(),s.$element.removeAttr("aria-describedby").trigger("hidden.bs."+s.type),t&&t()}var s=this,o=e(this.$tip),u=e.Event("hide.bs."+this.type);return this.$element.trigger(u),u.isDefaultPrevented()?void 0:(o.removeClass("in"),e.support.transition&&o.hasClass("fade")?o.one("bsTransitionEnd",r).emulateTransitionEnd(n.TRANSITION_DURATION):r(),this.hoverState=null,this)},n.prototype.fixTitle=function(){var e=this.$element;(e.attr("title")||"string"!=typeof e.attr("data-original-title"))&&e.attr("data-original-title",e.attr("title")||"").attr("title","")},n.prototype.hasContent=function(){return this.getTitle()},n.prototype.getPosition=function(t){t=t||this.$element;var n=t[0],r="BODY"==n.tagName,i=n.getBoundingClientRect();null==i.width&&(i=e.extend({},i,{width:i.right-i.left,height:i.bottom-i.top}));var s=r?{top:0,left:0}:t.offset(),o={scroll:r?document.documentElement.scrollTop||document.body.scrollTop:t.scrollTop()},u=r?{width:e(window).width(),height:e(window).height()}:null;return e.extend({},i,o,u,s)},n.prototype.getCalculatedOffset=function(e,t,n,r){return"bottom"==e?{top:t.top+t.height,left:t.left+t.width/2-n/2}:"top"==e?{top:t.top-r,left:t.left+t.width/2-n/2}:"left"==e?{top:t.top+t.height/2-r/2,left:t.left-n}:{top:t.top+t.height/2-r/2,left:t.left+t.width}},n.prototype.getViewportAdjustedDelta=function(e,t,n,r){var i={top:0,left:0};if(!this.$viewport)return i;var s=this.options.viewport&&this.options.viewport.padding||0,o=this.getPosition(this.$viewport);if(/right|left/.test(e)){var u=t.top-s-o.scroll,a=t.top+s-o.scroll+r;u<o.top?i.top=o.top-u:a>o.top+o.height&&(i.top=o.top+o.height-a)}else{var f=t.left-s,l=t.left+s+n;f<o.left?i.left=o.left-f:l>o.right&&(i.left=o.left+o.width-l)}return i},n.prototype.getTitle=function(){var e,t=this.$element,n=this.options;return e=t.attr("data-original-title")||("function"==typeof n.title?n.title.call(t[0]):n.title)},n.prototype.getUID=function(e){do e+=~~(1e6*Math.random());while(document.getElementById(e));return e},n.prototype.tip=function(){if(!this.$tip&&(this.$tip=e(this.options.template),1!=this.$tip.length))throw new Error(this.type+" `template` option must consist of exactly 1 top-level element!");return this.$tip},n.prototype.arrow=function(){return this.$arrow=this.$arrow||this.tip().find(".tooltip-arrow")},n.prototype.enable=function(){this.enabled=!0},n.prototype.disable=function(){this.enabled=!1},n.prototype.toggleEnabled=function(){this.enabled=!this.enabled},n.prototype.toggle=function(t){var n=this;t&&(n=e(t.currentTarget).data("bs."+this.type),n||(n=new this.constructor(t.currentTarget,this.getDelegateOptions()),e(t.currentTarget).data("bs."+this.type,n))),t?(n.inState.click=!n.inState.click,n.isInStateTrue()?n.enter(n):n.leave(n)):n.tip().hasClass("in")?n.leave(n):n.enter(n)},n.prototype.destroy=function(){var e=this;clearTimeout(this.timeout),this.hide(function(){e.$element.off("."+e.type).removeData("bs."+e.type),e.$tip&&e.$tip.detach(),e.$tip=null,e.$arrow=null,e.$viewport=null})};var r=e.fn.tooltip;e.fn.tooltip=t,e.fn.tooltip.Constructor=n,e.fn.tooltip.noConflict=function(){return e.fn.tooltip=r,this}}(jQuery),+function(e){"use strict";function t(t){return this.each(function(){var r=e(this),s=r.data("bs.popover"),o="object"==typeof t&&t;(s||!/destroy|hide/.test(t))&&(s||r.data("bs.popover",s=new n(this,o)),"string"==typeof t&&s[t]())})}var n=function(e,t){this.init("popover",e,t)};if(!e.fn.tooltip)throw new Error("Popover requires tooltip.js");n.VERSION="3.3.5",n.DEFAULTS=e.extend({},e.fn.tooltip.Constructor.DEFAULTS,{placement:"right",trigger:"click",content:"",template:'<div class="popover" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'}),n.prototype=e.extend({},e.fn.tooltip.Constructor.prototype),n.prototype.constructor=n,n.prototype.getDefaults=function(){return n.DEFAULTS},n.prototype.setContent=function(){var e=this.tip(),t=this.getTitle(),n=this.getContent();e.find(".popover-title")[this.options.html?"html":"text"](t),e.find(".popover-content").children().detach().end()[this.options.html?"string"==typeof n?"html":"append":"text"](n),e.removeClass("fade top bottom left right in"),e.find(".popover-title").html()||e.find(".popover-title").hide()},n.prototype.hasContent=function(){return this.getTitle()||this.getContent()},n.prototype.getContent=function(){var e=this.$element,t=this.options;return e.attr("data-content")||("function"==typeof t.content?t.content.call(e[0]):t.content)},n.prototype.arrow=function(){return this.$arrow=this.$arrow||this.tip().find(".arrow")};var r=e.fn.popover;e.fn.popover=t,e.fn.popover.Constructor=n,e.fn.popover.noConflict=function(){return e.fn.popover=r,this}}(jQuery),+function(e){"use strict";function t(t){return this.each(function(){var r=e(this),i=r.data("bs.tab");i||r.data("bs.tab",i=new n(this)),"string"==typeof t&&i[t]()})}var n=function(t){this.element=e(t)};n.VERSION="3.3.5",n.TRANSITION_DURATION=150,n.prototype.show=function(){var t=this.element,n=t.closest("ul:not(.dropdown-menu)"),r=t.data("target");if(r||(r=t.attr("href"),r=r&&r.replace(/.*(?=#[^\s]*$)/,"")),!t.parent("li").hasClass("active")){var i=n.find(".active:last a"),s=e.Event("hide.bs.tab",{relatedTarget:t[0]}),o=e.Event("show.bs.tab",{relatedTarget:i[0]});if(i.trigger(s),t.trigger(o),!o.isDefaultPrevented()&&!s.isDefaultPrevented()){var u=e(r);this.activate(t.closest("li"),n),this.activate(u,u.parent(),function(){i.trigger({type:"hidden.bs.tab",relatedTarget:t[0]}),t.trigger({type:"shown.bs.tab",relatedTarget:i[0]})})}}},n.prototype.activate=function(t,r,i){function s(){o.removeClass("active").find("> .dropdown-menu > .active").removeClass("active").end().find('[data-toggle="tab"]').attr("aria-expanded",!1),t.addClass("active").find('[data-toggle="tab"]').attr("aria-expanded",!0),u?(t[0].offsetWidth,t.addClass("in")):t.removeClass("fade"),t.parent(".dropdown-menu").length&&t.closest("li.dropdown").addClass("active").end().find('[data-toggle="tab"]').attr("aria-expanded",!0),i&&i()}var o=r.find("> .active"),u=i&&e.support.transition&&(o.length&&o.hasClass("fade")||!!r.find("> .fade").length);o.length&&u?o.one("bsTransitionEnd",s).emulateTransitionEnd(n.TRANSITION_DURATION):s(),o.removeClass("in")};var r=e.fn.tab;e.fn.tab=t,e.fn.tab.Constructor=n,e.fn.tab.noConflict=function(){return e.fn.tab=r,this};var i=function(n){n.preventDefault(),t.call(e(this),"show")};e(document).on("click.bs.tab.data-api",'[data-toggle="tab"]',i).on("click.bs.tab.data-api",'[data-toggle="pill"]',i)}(jQuery),+function(e){"use strict";function t(t){var n,r=t.attr("data-target")||(n=t.attr("href"))&&n.replace(/.*(?=#[^\s]+$)/,"");return e(r)}function n(t){return this.each(function(){var n=e(this),i=n.data("bs.collapse"),s=e.extend({},r.DEFAULTS,n.data(),"object"==typeof t&&t);!i&&s.toggle&&/show|hide/.test(t)&&(s.toggle=!1),i||n.data("bs.collapse",i=new r(this,s)),"string"==typeof t&&i[t]()})}var r=function(t,n){this.$element=e(t),this.options=e.extend({},r.DEFAULTS,n),this.$trigger=e('[data-toggle="collapse"][href="#'+t.id+'"],[data-toggle="collapse"][data-target="#'+t.id+'"]'),this.transitioning=null,this.options.parent?this.$parent=this.getParent():this.addAriaAndCollapsedClass(this.$element,this.$trigger),this.options.toggle&&this.toggle()};r.VERSION="3.3.5",r.TRANSITION_DURATION=350,r.DEFAULTS={toggle:!0},r.prototype.dimension=function(){var e=this.$element.hasClass("width");return e?"width":"height"},r.prototype.show=function(){if(!this.transitioning&&!this.$element.hasClass("in")){var t,i=this.$parent&&this.$parent.children(".panel").children(".in, .collapsing");if(!(i&&i.length&&(t=i.data("bs.collapse"),t&&t.transitioning))){var s=e.Event("show.bs.collapse");if(this.$element.trigger(s),!s.isDefaultPrevented()){i&&i.length&&(n.call(i,"hide"),t||i.data("bs.collapse",null));var u=this.dimension();this.$element.removeClass("collapse").addClass("collapsing")[u](0).attr("aria-expanded",!0),this.$trigger.removeClass("collapsed").attr("aria-expanded",!0),this.transitioning=1;var a=function(){this.$element.removeClass("collapsing").addClass("collapse in")[u](""),this.transitioning=0,this.$element.trigger("shown.bs.collapse")};if(!e.support.transition)return a.call(this);var f=e.camelCase(["scroll",u].join("-"));this.$element.one("bsTransitionEnd",e.proxy(a,this)).emulateTransitionEnd(r.TRANSITION_DURATION)[u](this.$element[0][f])}}}},r.prototype.hide=function(){if(!this.transitioning&&this.$element.hasClass("in")){var t=e.Event("hide.bs.collapse");if(this.$element.trigger(t),!t.isDefaultPrevented()){var n=this.dimension();this.$element[n](this.$element[n]())[0].offsetHeight,this.$element.addClass("collapsing").removeClass("collapse in").attr("aria-expanded",!1),this.$trigger.addClass("collapsed").attr("aria-expanded",!1),this.transitioning=1;var i=function(){this.transitioning=0,this.$element.removeClass("collapsing").addClass("collapse").trigger("hidden.bs.collapse")};return e.support.transition?void this.$element[n](0).one("bsTransitionEnd",e.proxy(i,this)).emulateTransitionEnd(r.TRANSITION_DURATION):i.call(this)}}},r.prototype.toggle=function(){this[this.$element.hasClass("in")?"hide":"show"]()},r.prototype.getParent=function(){return e(this.options.parent).find('[data-toggle="collapse"][data-parent="'+this.options.parent+'"]').each(e.proxy(function(n,r){var i=e(r);this.addAriaAndCollapsedClass(t(i),i)},this)).end()},r.prototype.addAriaAndCollapsedClass=function(e,t){var n=e.hasClass("in");e.attr("aria-expanded",n),t.toggleClass("collapsed",!n).attr("aria-expanded",n)};var i=e.fn.collapse;e.fn.collapse=n,e.fn.collapse.Constructor=r,e.fn.collapse.noConflict=function(){return e.fn.collapse=i,this},e(document).on("click.bs.collapse.data-api",'[data-toggle="collapse"]',function(r){var i=e(this);i.attr("data-target")||r.preventDefault();var s=t(i),o=s.data("bs.collapse"),u=o?"toggle":i.data();n.call(s,u)})}(jQuery),+function(e){"use strict";function t(){var e=document.createElement("bootstrap"),t={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(var n in t)if(void 0!==e.style[n])return{end:t[n]};return!1}e.fn.emulateTransitionEnd=function(t){var n=!1,r=this;e(this).one("bsTransitionEnd",function(){n=!0});var i=function(){n||e(r).trigger(e.support.transition.end)};return setTimeout(i,t),this},e(function(){e.support.transition=t(),e.support.transition&&(e.event.special.bsTransitionEnd={bindType:e.support.transition.end,delegateType:e.support.transition.end,handle:function(t){return e(t.target).is(this)?t.handleObj.handler.apply(this,arguments):void 0}})})}(jQuery),define("lib-app/bootstrap/js/bootstrap.min",function(){}),typeof JSON!="object"&&(JSON={}),function(){"use strict";function f(e){return e<10?"0"+e:e}function quote(e){return escapable.lastIndex=0,escapable.test(e)?'"'+e.replace(escapable,function(e){var t=meta[e];return typeof t=="string"?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function str(e,t){var n,r,i,s,o=gap,u,a=t[e];a&&typeof a=="object"&&typeof a.toJSON=="function"&&(a=a.toJSON(e)),typeof rep=="function"&&(a=rep.call(t,e,a));switch(typeof a){case"string":return quote(a);case"number":return isFinite(a)?String(a):"null";case"boolean":case"null":return String(a);case"object":if(!a)return"null";gap+=indent,u=[];if(Object.prototype.toString.apply(a)==="[object Array]"){s=a.length;for(n=0;n<s;n+=1)u[n]=str(n,a)||"null";return i=u.length===0?"[]":gap?"[\n"+gap+u.join(",\n"+gap)+"\n"+o+"]":"["+u.join(",")+"]",gap=o,i}if(rep&&typeof rep=="object"){s=rep.length;for(n=0;n<s;n+=1)typeof rep[n]=="string"&&(r=rep[n],i=str(r,a),i&&u.push(quote(r)+(gap?": ":":")+i))}else for(r in a)Object.prototype.hasOwnProperty.call(a,r)&&(i=str(r,a),i&&u.push(quote(r)+(gap?": ":":")+i));return i=u.length===0?"{}":gap?"{\n"+gap+u.join(",\n"+gap)+"\n"+o+"}":"{"+u.join(",")+"}",gap=o,i}}typeof Date.prototype.toJSON!="function"&&(Date.prototype.toJSON=function(e){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(e){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;typeof JSON.stringify!="function"&&(JSON.stringify=function(e,t,n){var r;gap="",indent="";if(typeof n=="number")for(r=0;r<n;r+=1)indent+=" ";else typeof n=="string"&&(indent=n);rep=t;if(!t||typeof t=="function"||typeof t=="object"&&typeof t.length=="number")return str("",{"":e});throw new Error("JSON.stringify")}),typeof JSON.parse!="function"&&(JSON.parse=function(text,reviver){function walk(e,t){var n,r,i=e[t];if(i&&typeof i=="object")for(n in i)Object.prototype.hasOwnProperty.call(i,n)&&(r=walk(i,n),r!==undefined?i[n]=r:delete i[n]);return reviver.call(e,t,i)}var j;text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),typeof reviver=="function"?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),function(e,t){"use strict";var n=e.History=e.History||{};if(typeof n.Adapter!="undefined")throw new Error("History.js Adapter has already been loaded...");n.Adapter={handlers:{},_uid:1,uid:function(e){return e._uid||(e._uid=n.Adapter._uid++)},bind:function(e,t,r){var i=n.Adapter.uid(e);n.Adapter.handlers[i]=n.Adapter.handlers[i]||{},n.Adapter.handlers[i][t]=n.Adapter.handlers[i][t]||[],n.Adapter.handlers[i][t].push(r),e["on"+t]=function(e,t){return function(r){n.Adapter.trigger(e,t,r)}}(e,t)},trigger:function(e,t,r){r=r||{};var i=n.Adapter.uid(e),s,o;n.Adapter.handlers[i]=n.Adapter.handlers[i]||{},n.Adapter.handlers[i][t]=n.Adapter.handlers[i][t]||[];for(s=0,o=n.Adapter.handlers[i][t].length;s<o;++s)n.Adapter.handlers[i][t][s].apply(this,[r])},extractEventData:function(e,n){var r=n&&n[e]||t;return r},onDomLoad:function(t){var n=e.setTimeout(function(){t()},2e3);e.onload=function(){clearTimeout(n),t()}}},typeof n.init!="undefined"&&n.init()}(window),function(e,t){"use strict";var n=e.document,r=e.setTimeout||r,i=e.clearTimeout||i,s=e.setInterval||s,o=e.History=e.History||{};if(typeof o.initHtml4!="undefined")throw new Error("History.js HTML4 Support has already been loaded...");o.initHtml4=function(){if(typeof o.initHtml4.initialized!="undefined")return!1;o.initHtml4.initialized=!0,o.enabled=!0,o.savedHashes=[],o.isLastHash=function(e){var t=o.getHashByIndex(),n;return n=e===t,n},o.isHashEqual=function(e,t){return e=encodeURIComponent(e).replace(/%25/g,"%"),t=encodeURIComponent(t).replace(/%25/g,"%"),e===t},o.saveHash=function(e){return o.isLastHash(e)?!1:(o.savedHashes.push(e),!0)},o.getHashByIndex=function(e){var t=null;return typeof e=="undefined"?t=o.savedHashes[o.savedHashes.length-1]:e<0?t=o.savedHashes[o.savedHashes.length+e]:t=o.savedHashes[e],t},o.discardedHashes={},o.discardedStates={},o.discardState=function(e,t,n){var r=o.getHashByState(e),i;return i={discardedState:e,backState:n,forwardState:t},o.discardedStates[r]=i,!0},o.discardHash=function(e,t,n){var r={discardedHash:e,backState:n,forwardState:t};return o.discardedHashes[e]=r,!0},o.discardedState=function(e){var t=o.getHashByState(e),n;return n=o.discardedStates[t]||!1,n},o.discardedHash=function(e){var t=o.discardedHashes[e]||!1;return t},o.recycleState=function(e){var t=o.getHashByState(e);return o.discardedState(e)&&delete o.discardedStates[t],!0},o.emulated.hashChange&&(o.hashChangeInit=function(){o.checkerFunction=null;var t="",r,i,u,a,f=Boolean(o.getHash());return o.isInternetExplorer()?(r="historyjs-iframe",i=n.createElement("iframe"),i.setAttribute("id",r),i.setAttribute("src","#"),i.style.display="none",n.body.appendChild(i),i.contentWindow.document.open(),i.contentWindow.document.close(),u="",a=!1,o.checkerFunction=function(){if(a)return!1;a=!0;var n=o.getHash(),r=o.getHash(i.contentWindow.document);return n!==t?(t=n,r!==n&&(u=r=n,i.contentWindow.document.open(),i.contentWindow.document.close(),i.contentWindow.document.location.hash=o.escapeHash(n)),o.Adapter.trigger(e,"hashchange")):r!==u&&(u=r,f&&r===""?o.back():o.setHash(r,!1)),a=!1,!0}):o.checkerFunction=function(){var n=o.getHash()||"";return n!==t&&(t=n,o.Adapter.trigger(e,"hashchange")),!0},o.intervalList.push(s(o.checkerFunction,o.options.hashChangeInterval)),!0},o.Adapter.onDomLoad(o.hashChangeInit)),o.emulated.pushState&&(o.onHashChange=function(t){var n=t&&t.newURL||o.getLocationHref(),r=o.getHashByUrl(n),i=null,s=null,u=null,a;return o.isLastHash(r)?(o.busy(!1),!1):(o.doubleCheckComplete(),o.saveHash(r),r&&o.isTraditionalAnchor(r)?(o.Adapter.trigger(e,"anchorchange"),o.busy(!1),!1):(i=o.extractState(o.getFullUrl(r||o.getLocationHref()),!0),o.isLastSavedState(i)?(o.busy(!1),!1):(s=o.getHashByState(i),a=o.discardedState(i),a?(o.getHashByIndex(-2)===o.getHashByState(a.forwardState)?o.back(!1):o.forward(!1),!1):(o.pushState(i.data,i.title,encodeURI(i.url),!1),!0))))},o.Adapter.bind(e,"hashchange",o.onHashChange),o.pushState=function(t,n,r,i){r=encodeURI(r).replace(/%25/g,"%");if(o.getHashByUrl(r))throw new Error("History.js does not support states with fragment-identifiers (hashes/anchors).");if(i!==!1&&o.busy())return o.pushQueue({scope:o,callback:o.pushState,args:arguments,queue:i}),!1;o.busy(!0);var s=o.createStateObject(t,n,r),u=o.getHashByState(s),a=o.getState(!1),f=o.getHashByState(a),l=o.getHash(),c=o.expectedStateId==s.id;return o.storeState(s),o.expectedStateId=s.id,o.recycleState(s),o.setTitle(s),u===f?(o.busy(!1),!1):(o.saveState(s),c||o.Adapter.trigger(e,"statechange"),!o.isHashEqual(u,l)&&!o.isHashEqual(u,o.getShortUrl(o.getLocationHref()))&&o.setHash(u,!1),o.busy(!1),!0)},o.replaceState=function(t,n,r,i){r=encodeURI(r).replace(/%25/g,"%");if(o.getHashByUrl(r))throw new Error("History.js does not support states with fragment-identifiers (hashes/anchors).");if(i!==!1&&o.busy())return o.pushQueue({scope:o,callback:o.replaceState,args:arguments,queue:i}),!1;o.busy(!0);var s=o.createStateObject(t,n,r),u=o.getHashByState(s),a=o.getState(!1),f=o.getHashByState(a),l=o.getStateByIndex(-2);return o.discardState(a,s,l),u===f?(o.storeState(s),o.expectedStateId=s.id,o.recycleState(s),o.setTitle(s),o.saveState(s),o.Adapter.trigger(e,"statechange"),o.busy(!1)):o.pushState(s.data,s.title,s.url,!1),!0}),o.emulated.pushState&&o.getHash()&&!o.emulated.hashChange&&o.Adapter.onDomLoad(function(){o.Adapter.trigger(e,"hashchange")})},typeof o.init!="undefined"&&o.init()}(window),function(e,t){"use strict";var n=e.console||t,r=e.document,i=e.navigator,s=!1,o=e.setTimeout,u=e.clearTimeout,a=e.setInterval,f=e.clearInterval,l=e.JSON,c=e.alert,h=e.History=e.History||{},p=e.history;try{s=e.sessionStorage,s.setItem("TEST","1"),s.removeItem("TEST")}catch(d){s=!1}l.stringify=l.stringify||l.encode,l.parse=l.parse||l.decode;if(typeof h.init!="undefined")throw new Error("History.js Core has already been loaded...");h.init=function(e){return typeof h.Adapter=="undefined"?!1:(typeof h.initCore!="undefined"&&h.initCore(),typeof h.initHtml4!="undefined"&&h.initHtml4(),!0)},h.initCore=function(d){if(typeof h.initCore.initialized!="undefined")return!1;h.initCore.initialized=!0,h.options=h.options||{},h.options.hashChangeInterval=h.options.hashChangeInterval||100,h.options.safariPollInterval=h.options.safariPollInterval||500,h.options.doubleCheckInterval=h.options.doubleCheckInterval||500,h.options.disableSuid=h.options.disableSuid||!1,h.options.storeInterval=h.options.storeInterval||1e3,h.options.busyDelay=h.options.busyDelay||250,h.options.debug=h.options.debug||!1,h.options.initialTitle=h.options.initialTitle||r.title,h.options.html4Mode=h.options.html4Mode||!1,h.options.delayInit=h.options.delayInit||!1,h.intervalList=[],h.clearAllIntervals=function(){var e,t=h.intervalList;if(typeof t!="undefined"&&t!==null){for(e=0;e<t.length;e++)f(t[e]);h.intervalList=null}},h.debug=function(){(h.options.debug||!1)&&h.log.apply(h,arguments)},h.log=function(){var e=typeof n!="undefined"&&typeof n.log!="undefined"&&typeof n.log.apply!="undefined",t=r.getElementById("log"),i,s,o,u,a;e?(u=Array.prototype.slice.call(arguments),i=u.shift(),typeof n.debug!="undefined"?n.debug.apply(n,[i,u]):n.log.apply(n,[i,u])):i="\n"+arguments[0]+"\n";for(s=1,o=arguments.length;s<o;++s){a=arguments[s];if(typeof a=="object"&&typeof l!="undefined")try{a=l.stringify(a)}catch(f){}i+="\n"+a+"\n"}return t?(t.value+=i+"\n-----\n",t.scrollTop=t.scrollHeight-t.clientHeight):e||c(i),!0},h.getInternetExplorerMajorVersion=function(){var e=h.getInternetExplorerMajorVersion.cached=typeof h.getInternetExplorerMajorVersion.cached!="undefined"?h.getInternetExplorerMajorVersion.cached:function(){var e=3,t=r.createElement("div"),n=t.getElementsByTagName("i");while((t.innerHTML="<!--[if gt IE "+ ++e+"]><i></i><![endif]-->")&&n[0]);return e>4?e:!1}();return e},h.isInternetExplorer=function(){var e=h.isInternetExplorer.cached=typeof h.isInternetExplorer.cached!="undefined"?h.isInternetExplorer.cached:Boolean(h.getInternetExplorerMajorVersion());return e},h.options.html4Mode?h.emulated={pushState:!0,hashChange:!0}:h.emulated={pushState:!Boolean(e.history&&e.history.pushState&&e.history.replaceState&&!/ Mobile\/([1-7][a-z]|(8([abcde]|f(1[0-8]))))/i.test(i.userAgent)&&!/AppleWebKit\/5([0-2]|3[0-2])/i.test(i.userAgent)),hashChange:Boolean(!("onhashchange"in e||"onhashchange"in r)||h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<8)},h.enabled=!h.emulated.pushState,h.bugs={setHash:Boolean(!h.emulated.pushState&&i.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(i.userAgent)),safariPoll:Boolean(!h.emulated.pushState&&i.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(i.userAgent)),ieDoubleCheck:Boolean(h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<8),hashEscape:Boolean(h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<7)},h.isEmptyObject=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},h.cloneObject=function(e){var t,n;return e?(t=l.stringify(e),n=l.parse(t)):n={},n},h.getRootUrl=function(){var e=r.location.protocol+"//"+(r.location.hostname||r.location.host);if(r.location.port||!1)e+=":"+r.location.port;return e+="/",e},h.getBaseHref=function(){var e=r.getElementsByTagName("base"),t=null,n="";return e.length===1&&(t=e[0],n=t.href.replace(/[^\/]+$/,"")),n=n.replace(/\/+$/,""),n&&(n+="/"),n},h.getBaseUrl=function(){var e=h.getBaseHref()||h.getBasePageUrl()||h.getRootUrl();return e},h.getPageUrl=function(){var e=h.getState(!1,!1),t=(e||{}).url||h.getLocationHref(),n;return n=t.replace(/\/+$/,"").replace(/[^\/]+$/,function(e,t,n){return/\./.test(e)?e:e+"/"}),n},h.getBasePageUrl=function(){var e=h.getLocationHref().replace(/[#\?].*/,"").replace(/[^\/]+$/,function(e,t,n){return/[^\/]$/.test(e)?"":e}).replace(/\/+$/,"")+"/";return e},h.getFullUrl=function(e,t){var n=e,r=e.substring(0,1);return t=typeof t=="undefined"?!0:t,/[a-z]+\:\/\//.test(e)||(r==="/"?n=h.getRootUrl()+e.replace(/^\/+/,""):r==="#"?n=h.getPageUrl().replace(/#.*/,"")+e:r==="?"?n=h.getPageUrl().replace(/[\?#].*/,"")+e:t?n=h.getBaseUrl()+e.replace(/^(\.\/)+/,""):n=h.getBasePageUrl()+e.replace(/^(\.\/)+/,"")),n.replace(/\#$/,"")},h.getShortUrl=function(e){var t=e,n=h.getBaseUrl(),r=h.getRootUrl();return h.emulated.pushState&&(t=t.replace(n,"")),t=t.replace(r,"/"),h.isTraditionalAnchor(t)&&(t="./"+t),t=t.replace(/^(\.\/)+/g,"./").replace(/\#$/,""),t},h.getLocationHref=function(e){return e=e||r,e.URL===e.location.href?e.location.href:e.location.href===decodeURIComponent(e.URL)?e.URL:e.location.hash&&decodeURIComponent(e.location.href.replace(/^[^#]+/,""))===e.location.hash?e.location.href:e.URL.indexOf("#")==-1&&e.location.href.indexOf("#")!=-1?e.location.href:e.URL||e.location.href},h.store={},h.idToState=h.idToState||{},h.stateToId=h.stateToId||{},h.urlToId=h.urlToId||{},h.storedStates=h.storedStates||[],h.savedStates=h.savedStates||[],h.normalizeStore=function(){h.store.idToState=h.store.idToState||{},h.store.urlToId=h.store.urlToId||{},h.store.stateToId=h.store.stateToId||{}},h.getState=function(e,t){typeof e=="undefined"&&(e=!0),typeof t=="undefined"&&(t=!0);var n=h.getLastSavedState();return!n&&t&&(n=h.createStateObject()),e&&(n=h.cloneObject(n),n.url=n.cleanUrl||n.url),n},h.getIdByState=function(e){var t=h.extractId(e.url),n;if(!t){n=h.getStateString(e);if(typeof h.stateToId[n]!="undefined")t=h.stateToId[n];else if(typeof h.store.stateToId[n]!="undefined")t=h.store.stateToId[n];else{for(;;){t=(new Date).getTime()+String(Math.random()).replace(/\D/g,"");if(typeof h.idToState[t]=="undefined"&&typeof h.store.idToState[t]=="undefined")break}h.stateToId[n]=t,h.idToState[t]=e}}return t},h.normalizeState=function(e){var t,n;if(!e||typeof e!="object")e={};if(typeof e.normalized!="undefined")return e;if(!e.data||typeof e.data!="object")e.data={};return t={},t.normalized=!0,t.title=e.title||"",t.url=h.getFullUrl(e.url?e.url:h.getLocationHref()),t.hash=h.getShortUrl(t.url),t.data=h.cloneObject(e.data),t.id=h.getIdByState(t),t.cleanUrl=t.url.replace(/\??\&_suid.*/,""),t.url=t.cleanUrl,n=!h.isEmptyObject(t.data),(t.title||n)&&h.options.disableSuid!==!0&&(t.hash=h.getShortUrl(t.url).replace(/\??\&_suid.*/,""),/\?/.test(t.hash)||(t.hash+="?"),t.hash+="&_suid="+t.id),t.hashedUrl=h.getFullUrl(t.hash),(h.emulated.pushState||h.bugs.safariPoll)&&h.hasUrlDuplicate(t)&&(t.url=t.hashedUrl),t},h.createStateObject=function(e,t,n){var r={data:e,title:t,url:n};return r=h.normalizeState(r),r},h.getStateById=function(e){e=String(e);var n=h.idToState[e]||h.store.idToState[e]||t;return n},h.getStateString=function(e){var t,n,r;return t=h.normalizeState(e),n={data:t.data,title:e.title,url:e.url},r=l.stringify(n),r},h.getStateId=function(e){var t,n;return t=h.normalizeState(e),n=t.id,n},h.getHashByState=function(e){var t,n;return t=h.normalizeState(e),n=t.hash,n},h.extractId=function(e){var t,n,r,i;return e.indexOf("#")!=-1?i=e.split("#")[0]:i=e,n=/(.*)\&_suid=([0-9]+)$/.exec(i),r=n?n[1]||e:e,t=n?String(n[2]||""):"",t||!1},h.isTraditionalAnchor=function(e){var t=!/[\/\?\.]/.test(e);return t},h.extractState=function(e,t){var n=null,r,i;return t=t||!1,r=h.extractId(e),r&&(n=h.getStateById(r)),n||(i=h.getFullUrl(e),r=h.getIdByUrl(i)||!1,r&&(n=h.getStateById(r)),!n&&t&&!h.isTraditionalAnchor(e)&&(n=h.createStateObject(null,null,i))),n},h.getIdByUrl=function(e){var n=h.urlToId[e]||h.store.urlToId[e]||t;return n},h.getLastSavedState=function(){return h.savedStates[h.savedStates.length-1]||t},h.getLastStoredState=function(){return h.storedStates[h.storedStates.length-1]||t},h.hasUrlDuplicate=function(e){var t=!1,n;return n=h.extractState(e.url),t=n&&n.id!==e.id,t},h.storeState=function(e){return h.urlToId[e.url]=e.id,h.storedStates.push(h.cloneObject(e)),e},h.isLastSavedState=function(e){var t=!1,n,r,i;return h.savedStates.length&&(n=e.id,r=h.getLastSavedState(),i=r.id,t=n===i),t},h.saveState=function(e){return h.isLastSavedState(e)?!1:(h.savedStates.push(h.cloneObject(e)),!0)},h.getStateByIndex=function(e){var t=null;return typeof e=="undefined"?t=h.savedStates[h.savedStates.length-1]:e<0?t=h.savedStates[h.savedStates.length+e]:t=h.savedStates[e],t},h.getCurrentIndex=function(){var e=null;return h.savedStates.length<1?e=0:e=h.savedStates.length-1,e},h.getHash=function(e){var t=h.getLocationHref(e),n;return n=h.getHashByUrl(t),n},h.unescapeHash=function(e){var t=h.normalizeHash(e);return t=decodeURIComponent(t),t},h.normalizeHash=function(e){var t=e.replace(/[^#]*#/,"").replace(/#.*/,"");return t},h.setHash=function(e,t){var n,i;return t!==!1&&h.busy()?(h.pushQueue({scope:h,callback:h.setHash,args:arguments,queue:t}),!1):(h.busy(!0),n=h.extractState(e,!0),n&&!h.emulated.pushState?h.pushState(n.data,n.title,n.url,!1):h.getHash()!==e&&(h.bugs.setHash?(i=h.getPageUrl(),h.pushState(null,null,i+"#"+e,!1)):r.location.hash=e),h)},h.escapeHash=function(t){var n=h.normalizeHash(t);return n=e.encodeURIComponent(n),h.bugs.hashEscape||(n=n.replace(/\%21/g,"!").replace(/\%26/g,"&").replace(/\%3D/g,"=").replace(/\%3F/g,"?")),n},h.getHashByUrl=function(e){var t=String(e).replace(/([^#]*)#?([^#]*)#?(.*)/,"$2");return t=h.unescapeHash(t),t},h.setTitle=function(e){var t=e.title,n;t||(n=h.getStateByIndex(0),n&&n.url===e.url&&(t=n.title||h.options.initialTitle));try{r.getElementsByTagName("title")[0].innerHTML=t.replace("<","&lt;").replace(">","&gt;").replace(" & "," &amp; ")}catch(i){}return r.title=t,h},h.queues=[],h.busy=function(e){typeof e!="undefined"?h.busy.flag=e:typeof h.busy.flag=="undefined"&&(h.busy.flag=!1);if(!h.busy.flag){u(h.busy.timeout);var t=function(){var e,n,r;if(h.busy.flag)return;for(e=h.queues.length-1;e>=0;--e){n=h.queues[e];if(n.length===0)continue;r=n.shift(),h.fireQueueItem(r),h.busy.timeout=o(t,h.options.busyDelay)}};h.busy.timeout=o(t,h.options.busyDelay)}return h.busy.flag},h.busy.flag=!1,h.fireQueueItem=function(e){return e.callback.apply(e.scope||h,e.args||[])},h.pushQueue=function(e){return h.queues[e.queue||0]=h.queues[e.queue||0]||[],h.queues[e.queue||0].push(e),h},h.queue=function(e,t){return typeof e=="function"&&(e={callback:e}),typeof t!="undefined"&&(e.queue=t),h.busy()?h.pushQueue(e):h.fireQueueItem(e),h},h.clearQueue=function(){return h.busy.flag=!1,h.queues=[],h},h.stateChanged=!1,h.doubleChecker=!1,h.doubleCheckComplete=function(){return h.stateChanged=!0,h.doubleCheckClear(),h},h.doubleCheckClear=function(){return h.doubleChecker&&(u(h.doubleChecker),h.doubleChecker=!1),h},h.doubleCheck=function(e){return h.stateChanged=!1,h.doubleCheckClear(),h.bugs.ieDoubleCheck&&(h.doubleChecker=o(function(){return h.doubleCheckClear(),h.stateChanged||e(),!0},h.options.doubleCheckInterval)),h},h.safariStatePoll=function(){var t=h.extractState(h.getLocationHref()),n;if(!h.isLastSavedState(t))return n=t,n||(n=h.createStateObject()),h.Adapter.trigger(e,"popstate"),h;return},h.back=function(e){return e!==!1&&h.busy()?(h.pushQueue({scope:h,callback:h.back,args:arguments,queue:e}),!1):(h.busy(!0),h.doubleCheck(function(){h.back(!1)}),p.go(-1),!0)},h.forward=function(e){return e!==!1&&h.busy()?(h.pushQueue({scope:h,callback:h.forward,args:arguments,queue:e}),!1):(h.busy(!0),h.doubleCheck(function(){h.forward(!1)}),p.go(1),!0)},h.go=function(e,t){var n;if(e>0)for(n=1;n<=e;++n)h.forward(t);else{if(!(e<0))throw new Error("History.go: History.go requires a positive or negative integer passed.");for(n=-1;n>=e;--n)h.back(t)}return h};if(h.emulated.pushState){var v=function(){};h.pushState=h.pushState||v,h.replaceState=h.replaceState||v}else h.onPopState=function(t,n){var r=!1,i=!1,s,o;return h.doubleCheckComplete(),s=h.getHash(),s?(o=h.extractState(s||h.getLocationHref(),!0),o?h.replaceState(o.data,o.title,o.url,!1):(h.Adapter.trigger(e,"anchorchange"),h.busy(!1)),h.expectedStateId=!1,!1):(r=h.Adapter.extractEventData("state",t,n)||!1,r?i=h.getStateById(r):h.expectedStateId?i=h.getStateById(h.expectedStateId):i=h.extractState(h.getLocationHref()),i||(i=h.createStateObject(null,null,h.getLocationHref())),h.expectedStateId=!1,h.isLastSavedState(i)?(h.busy(!1),!1):(h.storeState(i),h.saveState(i),h.setTitle(i),h.Adapter.trigger(e,"statechange"),h.busy(!1),!0))},h.Adapter.bind(e,"popstate",h.onPopState),h.pushState=function(t,n,r,i){if(h.getHashByUrl(r)&&h.emulated.pushState)throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(i!==!1&&h.busy())return h.pushQueue({scope:h,callback:h.pushState,args:arguments,queue:i}),!1;h.busy(!0);var s=h.createStateObject(t,n,r);return h.isLastSavedState(s)?h.busy(!1):(h.storeState(s),h.expectedStateId=s.id,p.pushState(s.id,s.title,s.url),h.Adapter.trigger(e,"popstate")),!0},h.replaceState=function(t,n,r,i){if(h.getHashByUrl(r)&&h.emulated.pushState)throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(i!==!1&&h.busy())return h.pushQueue({scope:h,callback:h.replaceState,args:arguments,queue:i}),!1;h.busy(!0);var s=h.createStateObject(t,n,r);return h.isLastSavedState(s)?h.busy(!1):(h.storeState(s),h.expectedStateId=s.id,p.replaceState(s.id,s.title,s.url),h.Adapter.trigger(e,"popstate")),!0};if(s){try{h.store=l.parse(s.getItem("History.store"))||{}}catch(m){h.store={}}h.normalizeStore()}else h.store={},h.normalizeStore();h.Adapter.bind(e,"unload",h.clearAllIntervals),h.saveState(h.storeState(h.extractState(h.getLocationHref(),!0))),s&&(h.onUnload=function(){var e,t,n;try{e=l.parse(s.getItem("History.store"))||{}}catch(r){e={}}e.idToState=e.idToState||{},e.urlToId=e.urlToId||{},e.stateToId=e.stateToId||{};for(t in h.idToState){if(!h.idToState.hasOwnProperty(t))continue;e.idToState[t]=h.idToState[t]}for(t in h.urlToId){if(!h.urlToId.hasOwnProperty(t))continue;e.urlToId[t]=h.urlToId[t]}for(t in h.stateToId){if(!h.stateToId.hasOwnProperty(t))continue;e.stateToId[t]=h.stateToId[t]}h.store=e,h.normalizeStore(),n=l.stringify(e);try{s.setItem("History.store",n)}catch(i){if(i.code!==DOMException.QUOTA_EXCEEDED_ERR)throw i;s.length&&(s.removeItem("History.store"),s.setItem("History.store",n))}},h.intervalList.push(a(h.onUnload,h.options.storeInterval)),h.Adapter.bind(e,"beforeunload",h.onUnload),h.Adapter.bind(e,"unload",h.onUnload));if(!h.emulated.pushState){h.bugs.safariPoll&&h.intervalList.push(a(h.safariStatePoll,h.options.safariPollInterval));if(i.vendor==="Apple Computer, Inc."||(i.appCodeName||"")==="Mozilla")h.Adapter.bind(e,"hashchange",function(){h.Adapter.trigger(e,"popstate")}),h.getHash()&&h.Adapter.onDomLoad(function(){h.Adapter.trigger(e,"hashchange")})}},(!h.options||!h.options.delayInit)&&h.init()}(window),define("lib-app/history.min",function(){}),define("storymaps/common/Core",["lib-build/css!lib-app/bootstrap/css/bootstrap.min","lib-build/css!storymaps/common/ui/Modal.css","lib-build/css!./Core","./utils/Polyfills","esri/map","esri/arcgis/Portal","esri/arcgis/utils","./utils/CommonHelper","esri/urlUtils","./builder/MyStoriesWrapper","dojo/has","esri/IdentityManager","esri/arcgis/OAuthInfo","esri/config","esri/tasks/GeometryService","esri/request","dojo/topic","dojo/on","dojo/_base/lang","dojo/_base/array","dojo/Deferred","dojo/DeferredList","dojo/query","lib-app/bootstrap/js/bootstrap.min","lib-app/history.min"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S){function C(e,t){var n=!1,r=!1;console.log("common.core.Core - init",t),T=e,Z(),t!=null&&(n=N.fromScratch!=null||N.fromscratch!=null,r=N.fromGallery!=null),!u.browserSupportHistory()&&(n||r)&&N.ieredirected==null&&(window.location=document.location.protocol+"//"+document.location.host+document.location.pathname+"#"+document.location.search+"&ieredirected"),u.isArcGISHosted()?app.indexCfg={}:!et();if(!T.checkConfigFileIsOK()){j("invalidConfig");return}document.title=app.cfg.TPL_NAME,l("touch")&&$("body").addClass("hasTouch"),window!=window.top&&$("body").addClass("isEmbed"),y.mixin(app,{map:null,maps:{},portal:null,builder:t,isDirectCreation:n,isGalleryCreation:r,isDirectCreationFirstSave:n,isLoading:!0,loadingTimeout:null,ui:{}}),app.appCfg.useStandardHeader&&require(["storymaps/common/ui/header/Desktop"],function(e){app.ui.headerDesktop=new e($("#headerDesktop"),app.isInBuilder)});if(!T.init(this))return;!et()&&app.indexCfg.username&&app.indexCfg.password&&g(c,"dialog-create",function(){g(c.dialog,"show",function(){c.dialog.txtUser_.set("value",app.indexCfg.username),c.dialog.txtPwd_.set("value",app.indexCfg.password),c.dialog.btnSubmit_.onClick()})}),Q();if(!app.indexCfg.sharingurl){var i=document.location.pathname.indexOf("/apps/");i==-1&&(i=document.location.pathname.indexOf("/home/"));if(i!=-1){var a=location.pathname.substr(0,i);app.indexCfg.sharingurl="//"+location.host+a+"/sharing/content/items",app.indexCfg.proxyurl="//"+location.host+a+"/sharing/proxy"}else app.indexCfg.sharingurl=app.cfg.DEFAULT_SHARING_URL}app.indexCfg.sharingurl.match(/^http/)?o.arcgisUrl=app.indexCfg.sharingurl:o.arcgisUrl=location.protocol+app.indexCfg.sharingurl,app.indexCfg.proxyurl||(app.indexCfg.proxyurl=app.cfg.DEFAULT_PROXY_URL),p.defaults.io.proxyUrl=location.protocol+app.indexCfg.proxyurl,c&&c.setProtocolErrorHandler(function(){return!0}),app.isInBuilder&&app.cfg.CORS_SERVER&&$.each(app.cfg.CORS_SERVER,function(e,t){p.defaults.io.corsEnabledServers.push(t)}),p.defaults.io.timeout=app.isInBuilder?app.cfg.TIMEOUT_BUILDER_REQUEST:app.cfg.TIMEOUT_VIEWER_REQUEST,$.fn.modal.Constructor.prototype.enforceFocus=function(){},T.initLocalization(),$(window).resize(z),$("form").bind("keydown",function(e){if(e.keyCode==13)return!1}),g(c,"dialog-create",X),m.subscribe("CORE_UPDATE_UI",R),m.subscribe("CORE_RESIZE",z),m.subscribe("CORE_UPDATE_EXTENT",I),app.portal=new s.Portal(app.indexCfg.sharingurl.split("/sharing/")[0]),app.portal.on("load",function(){tt();if(app.indexCfg.oAuthAppId){var e=new h({appId:app.indexCfg.oAuthAppId,popup:!1});c.registerOAuthInfos([e]),c.checkSignInStatus(e.portalUrl).then(function(){t?O().then(k):O().then(k)},function(){c.getCredential(e.portalUrl)})}else k()})}function k(){console.log("common.core.Core - initStep2");var e=u.getAppID(et()),t=u.getWebmapID(et()),n=app.appCfg?!!app.appCfg.supportWebmapPreviewAGOL:!0;if(e){L(e);return}var r=u.getUrlParams().webmap;if(app.isDirectCreation&&(t||r)){O().then(function(){P(),app.isInitializing=!1;var e={title:"",creaDate:Date.now(),status:"PUBLISHED",media:{type:"webmap",webmap:{id:t||r,extent:null,layers:null,popup:null,legend:{enable:!1,openByDefault:!1}}},description:""};app.data.setStoryStorage("WEBAPP"),app.data.addStorySection(e),app.data.getWebAppData().setLayout({id:"tab"}),app.data.getWebAppData().setDefaultLayoutOptions(),app.data.setCurrentSectionIndex(0),m.publish("story-update-entries"),m.publish("BUILDER_INCREMENT_COUNTER",1);var n=m.subscribe("story-loaded-map",function(t){var r=app.maps[t.id].response.itemInfo.item;n.remove(),app.data.getWebAppData().setTitle(r.title),e.title=r.title,e.description=r.description,app.data.editSection(0,e),H(),m.publish("CORE_UPDATE_UI"),m.publish("story-update-entries"),B()})});return}if(t&&!n){u.isArcGISHosted()?D():M(t);return}if(app.isDirectCreation){O().then(function(){P(),T.startFromScratch()});return}u.isArcGISHosted()?D():N.appid||N.webmap&&(!app.indexCfg.authorizedOwners||!app.indexCfg.authorizedOwners[0])?j("unspecifiedConfigOwner"):j("invalidConfigNoApp")}function L(e){console.log("common.core.Core - loadWebMappingApp - appId:",e);var t=N.forceLogin!==undefined;t||app.isInBuilder?O().then(function(){A(e)},function(){j("notAuthorized")}):A(e)}function A(e){o.getItem(e).then(function(e){if(!e){j("appLoadingFail");return}var t=e.item,n={values:e.itemData.values};app.data.getWebAppItem().id||app.data.setWebAppItem(t),app.data.getWebAppData().set(n);if(app.indexCfg.authorizedOwners&&app.indexCfg.authorizedOwners.length>0&&app.indexCfg.authorizedOwners[0]){var r=t.owner,i=!1;r&&(i=$.inArray(r,app.indexCfg.authorizedOwners)!=-1),!i&&app.indexCfg.authorizedOwners[0]=="*"&&(i=!0);if(!i){j("invalidConfigOwner");return}}if(t&&t.appProxies){var s=b.map(t.appProxies,function(e){return{url:e.sourceUrl,mixin:{url:e.proxyUrl}}});app.data.setAppProxies(s)}if(app.isInBuilder&&et()&&!app.data.userIsAppOwner()){j("notAuthorized");return}T.webAppConfigLoaded();var o=app.appCfg?!!app.appCfg.useWebmapInApp:!0,a=app.data.getWebAppData().getWebmap()||u.getWebmapID(et());a&&o&&!app.data.getWebAppData().isBlank()?M(a):app.data.getWebAppData().isBlank()?(P(),T.loadWebmapFromData()):u.getPortalUser()||!et()&&app.data.getWebAppData().isBlank()?redirectToBuilderFromGallery():app.data.getWebAppData().isBlank()?j("appLoadingFail"):M(app.data.getWebAppData().getViews()[0].cfg.webmap.id)},function(e){e&&e.httpCode==400?j("invalidApp"):e&&e.httpCode==403?j("notAuthorized"):j("appLoadingFail")})}function O(){var e=new w;return g(c,"dialog-create",V),app.portal.signIn().then(function(){tt(),e.resolve()},function(){e.reject()}),e}function M(e){T.loadFirstWebmap(e).then(y.hitch(this,function(e){_(e)}),y.hitch(this,function(){j("createMap")}))}function _(e){console.log("common.core.Core - webMapInitCallback",e,"TEST"),app.maps[e.itemInfo.item.id]=T.getMapConfig(e),app.map=e.map,app.data.setWebMap(e.itemInfo),app.data.setResponse(e),app.map.disableKeyboardNavigation(),P(),T.firstWebmapLoaded()}function D(){window.location=app.isPortal&&app.cfg.HELP_URL_PORTAL?app.cfg.HELP_URL_PORTAL:app.cfg.HELP_URL}function P(){var e=app.indexCfg.title||app.data.getWebAppData().getTitle(),t=app.indexCfg.subtitle||app.data.getWebAppData().getSubtitle(),n=app.data.getWebAppData().getColors();app.ui.headerDesktop&&app.ui.headerDesktop.init(!app.isInBuilder&&(app.cfg.EMBED||N.embed||N.embed===""),e,t,U(),n,W(),app.appCfg.headerCompactByDefault),app.appCfg.useAppTitleAsPageTitle&&(document.title=e?$("<div>"+e+"</div>").text():app.cfg.TPL_NAME)}function H(e){console.log("common.core.Core - initApp"),z(),location.hash&&u.browserSupportHistory()&&(location.hash="map"),window.onhashchange=function(){T.prepareMobileViewSwitch(),T.onHashChange()},T.appInitComplete(),app.builder&&app.builder.appInitComplete(e);if(app.isInBuilder||app.data.userIsAppOwner())l("ff")&&$(".builderShare #my-stories-frame").remove(),(l("ff")||!app.isInBuilder)&&$("body").append('<div id="my-stories-hidden-container"><iframe id="my-stories-frame"></iframe></div>'),f.loadMyStories()}function B(){app.isLoading=!1,$("#headerDesktop").removeAttr("aria-hidden"),$("#loadingIndicator, #loadingMessage").addClass("fadeOut").fadeOut(400),$("#loadingOverlay").fadeOut(800)}function j(e,t,n){var r=i18n.viewer.errors[e];G(),$("#loadingIndicator").hide(),r=r.replace(/%TPL_NAME%/g,app.cfg.TPL_NAME),e=="notAuthorized"&&app.indexCfg.oAuthAppId&&(r+='<div><button class="btn btn-sm btn-default" onclick="esri.id.destroyCredentials(); window.location.reload();">'+i18n.viewer.errors.signOut+"</button></div>"),e=="appLoadingFail"?$("#loadingMessage").html('<div id="loadingRetry"> <button type="button" class="btn btn-naked btn-sm" onclick="document.location.reload()">'+i18n.viewer.loading.failButton+" </button>"+"</div>").hide().fadeIn(1200,function(){$("#loadingMessage").addClass("loaded")}):$("#loadingMessage").hide(),l("ie")==8&&($("#fatalError-icon").css({filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(src='_resources/icons/warning-icon.png', sizingMethod='scale')",backgroundPosition:"2px 3px",width:78}),$("#fatalError-msg").css({paddingLeft:5})),$("#fatalError .error-msg").html(r),n||$("#fatalError").show()}function F(e){$("#fatalError .error-msg").html(i18n.viewer.errors[e])}function I(e,t){t=t||app.map;if(!e||!e.spatialReference||!t||!t.extent.spatialReference||!t.spatialReference){var n=new w;return n.resolve(),n}if(t.spatialReference.wkid==e.spatialReference.wkid)return t.setExtent(T.getLayoutExtent(e,!1));var r=new w;return p.defaults.geometryService.project([e],t.spatialReference,function(e){if(!e||!e[0])return;t.setExtent(T.getLayoutExtent(e[0],!1)),r.resolve()}),r}function q(e,t){e?app.map.spatialReference.wkid!=102100&&app.map.spatialReference.wkid!=4326?p.defaults.geometryService.project([t],app.map.spatialReference,function(e){if(!e||!e[0])return;app.map.extent.contains(e[0])||app.map.centerAt(e[0])}):app.map.extent.contains(t)||app.map.centerAt(t):($(".mainMediaContainer.active .mapLocationMsg").html(i18n.viewer.locatorFromCommon.error),$(".mainMediaContainer.active .mapLocationError").fadeIn(),setTimeout(function(){$(".mainMediaContainer.active .mapLocationError").fadeOut()},5e3))}function R(){console.log("common.core.Core - updateUI");var e=app.data.getWebAppData().getColors();app.ui.headerDesktop&&(app.ui.headerDesktop.setTitleAndSubtitle(app.data.getWebAppData().getTitle()||(app.data.getWebMap()?app.data.getWebMap().item.title:""),app.data.getWebAppData().getSubtitle()||(app.data.getWebMap()?app.data.getWebMap().item.snippet:"")),app.ui.headerDesktop.update(U(),e,app.appCfg.headerCompactByDefault)),T.updateUI(),z()}function U(e){return{logoURL:app.data.getWebAppData().getLogoURL(e&&e.useMobileLogo),logoTarget:app.data.getWebAppData().getLogoTarget(),linkText:app.data.getWebAppData().getHeaderLinkText(),linkURL:app.data.getWebAppData().getHeaderLinkURL(),socialBtn:app.data.getWebAppData().getSocial(),compactSize:app.data.getWebAppData().getHeaderCompactSize()}}function z(){var e=$("body").width(),t=$("body").height(),n=0,r=0,i=N.forceDesktop!==undefined||app.indexCfg.forceDesktop,s=N.forceMobile!==undefined||app.indexCfg.forceMobile,o=e<=768||s,u=$(".centerLink").length?$(".centerLink").hasClass("current"):!0;i&&(o=!1),o?$("body").addClass("mobile-view"):$("body").removeClass("mobile-view"),$(".mainViewAboveMap, .mainViewBelowMap").each(function(e,t){var r=$(t);n+=r.is(":visible")?r.outerHeight():0}),$(".mainViewSideMap").each(function(e,t){var n=$(t);r+=n.is(":visible")?n.outerWidth():0}),app.ui.headerDesktop&&app.ui.headerDesktop.resize(e),app.initScreenIsOpen&&($("#header").css("display",o?"none":"block"),$("#fatalError").css("display",o?"block":"none")),app.initScreenIsOpen||$("#contentPanel").height(t-n),T.resize({isMobileView:o,isOnMobileMapView:u,width:e,height:t-n}),app.isInBuilder&&app.builder.resize({isMobileView:o});if(app.map&&(!o||o&&u))try{app.map.resize(!!app.appCfg.mapsImmediateResize)}catch(a){}o?$(".mapContainer .esriControlsBR > div").first().removeClass("logo-med").addClass("logo-sm"):$(".mapContainer .esriControlsBR > div").first().removeClass("logo-sm").addClass("logo-med")}function W(){return!app.isInBuilder&&(!et()&&!!u.getAppID(et())||et()&&app.data.userIsAppOwner())}function X(){$(".esriSignInDialog td label").siblings("br").css("display","none"),$(".esriSignInDialog .dijitDialogPaneContentArea div:nth(1)").css("display","none"),$(".esriSignInDialog .dijitReset.dijitInputInner").css("padding","0px"),$(".esriSignInDialog .dijitReset.dijitInputInner").css("margin-bottom","0px"),$(".esriSignInDialog .dijitReset.dijitInputInner").css("border","none"),$(".esriSignInDialog .dijitReset.dijitInputInner").css("border-radius","0px"),$(".esriSignInDialog .dijitReset.dijitInputInner").css("-webkit-border-radius","0px"),$(".esriSignInDialog .dijitReset.dijitInputInner").css("-moz-border-radius","0px"),$(".esriSignInDialog .dijitReset.dijitInputInner").css("box-shadow","none"),$(".esriSignInDialog .dijitReset.dijitInputInner").css("-webkit-box-shadow","none"),$(".esriSignInDialog .dijitReset.dijitInputInner").css("-moz-box-shadow","none"),$(".esriSignInDialog .dijitReset.dijitValidationContainer").css("display","none"),$(".esriSignInDialog .esriErrorMsg").css("margin-top","10px"),$(".esriSignInDialog").find(".dijitDialogTitleBar").find(".dijitDialogTitle").first().html(i18n.viewer.signin.title),c._arcgisUrl&&($(".esriSignInDialog").find(".dijitDialogPaneContentArea:first-child").find(":first-child").first().css("display","none"),$(".esriSignInDialog").find(".dijitDialogPaneContentArea:first-child").find(":first-child").first().after("<div id='dijitDialogPaneContentAreaLoginText'>"+i18n.viewer.signin.explainViewer.replace("%PORTAL_LINK%","<a href='http://"+c._arcgisUrl+"' title='"+c._arcgisUrl+"' target='_blank'>"+c._arcgisUrl+"</a>")+"</div>"))}function V(){c._arcgisUrl&&$(".esriSignInDialog").find("#dijitDialogPaneContentAreaLoginText").html(i18n.viewer.signin.explainBuilder.replace("%PORTAL_LINK%","<a href='http://"+c._arcgisUrl+"' title='"+c._arcgisUrl+"' target='_blank'>"+c._arcgisUrl+"</a>"))}function J(){$("#header").css("display","inherit"),$(".mobileView").css("display","inherit"),$("#fatalError").css("display","none"),$("#loadingOverlay").css("top","0px"),Q(),z()}function K(){console.log("REDIRECT ",o.arcgisUrl.split("/sharing/")[0]+"/home/signin.html?returnUrl="+encodeURIComponent(document.location.href)),window.location=o.arcgisUrl.split("/sharing/")[0]+"/home/signin.html?returnUrl="+encodeURIComponent(document.location.href)}function Q(){app.loadingTimeout=setTimeout(Y,app.cfg.TIMEOUT_VIEWER_LOAD)}function G(){typeof app!="undefined"&&app.loadingTimeout&&(clearTimeout(app.loadingTimeout),app.loadingTimeout=null)}function Y(){if(c&&c.dialog&&c.dialog._alreadyInitialized&&!c.loadingTimeoutAlreadyFired){clearTimeout(app.loadingTimeout),Q(),c._busy||(c.loadingTimeoutAlreadyFired=!0);return}$("#loadingMessage").html('<div class="mainMessage">'+i18n.viewer.loading.long+"<br />"+i18n.viewer.loading.long2+"</div>").fadeIn("slow",function(){$("#loadingMessage").addClass("loaded")})}function Z(){S("#fatalError .error-title")[0].innerHTML=i18n.viewer.errors.boxTitle}function et(){return x.environment!=["TPL","ENV","DEV"].join("_")}function tt(){console.log("common.core.Core - parsePortalConfig");if(!app.portal)return;!app.cfg.HELPER_SERVICES.geocode.length&&app.portal.helperServices&&app.portal.helperServices.geocode&&app.portal.helperServices.geocode.length&&app.portal.helperServices.geocode[0].url&&$.each(app.portal.helperServices.geocode,function(e,t){app.cfg.HELPER_SERVICES.geocode.push(t)});var e;app.cfg.HELPER_SERVICES.geometry&&app.cfg.HELPER_SERVICES.geometry.url?e=app.cfg.HELPER_SERVICES.geometry.url:app.portal.helperServices.geometry&&app.portal.helperServices.geometry.url&&(e=app.portal.helperServices.geometry.url),p.defaults.geometryService=new d(e),!app.cfg.BING_MAPS_KEY&&app.portal.bingKey&&(app.cfg.BING_MAPS_KEY=app.portal.bingKey),app.portal.isPortal&&app.cfg&&app.cfg.AUTHORIZED_IMPORT_SOURCE&&(app.cfg.AUTHORIZED_IMPORT_SOURCE.featureService=!1),app.isPortal=!!app.portal.isPortal;if(app.isPortal&&app.portal.helpBase&&app.portal.portalHostname&&!app.cfg.HELP_URL_PORTAL.match("^//")){var t=app.portal.portalHostname.split("/")[0];app.cfg.HELP_URL_PORTAL="//"+t+app.portal.helpBase+app.cfg.HELP_URL_PORTAL}}function nt(){G(),app.isInitializing=!0,app.initScreenIsOpen=!0,j("notConfiguredMobile",null,!0),setTimeout(z,50)}function rt(){$("#initPopup").modal("hide"),app.initScreenIsOpen=!1}function it(){F("notConfiguredDesktop"),$("#loadingOverlay").css("top","0px"),$("#header").css("display","inherit"),$("#fatalError").css("display","block"),app.initScreenIsOpen=!1,z()}var x={environment:"TPL_ENV_PRODUCTION"},T=null,N=u.getUrlParams();return r.apply(),{init:C,isProd:et,appInitComplete:H,displayApp:B,loadWebMap:M,handleWindowResize:z,hasSwitchBuilderButton:W,initPopupPrepare:nt,initPopupComplete:rt,initPopupFail:it,setMapExtent:I,zoomToDeviceLocation:q,getHeaderUserCfg:U,cleanLoadingTimeout:G,initError:j,prepareAppForWebmapReload:J,replaceInitErrorMessage:F,portalLogin:O}}),define("lib-build/css!storymaps/common/ui/header/Desktop",[],function(){}),define("text",{load:function(e){throw new Error("Dynamic load not allowed: "+e)}}),define("lib-build/tpl",{load:function(e){throw new Error("Dynamic load not allowed: "+e)}}),define("lib-build/tpl!storymaps/common/ui/share/ShareDialog",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="modal-dialog">\r\n	<div class="modal-content">\r\n		<div class="modal-logo"></div>\r\n		<div class="modal-header">\r\n			<h4 class="modal-title"></h4>\r\n		</div>\r\n\r\n		<div class="modal-body">\r\n			<div class="social-container">\r\n				<i class="shareIcon blackHover share_facebook icon-facebook-squared"></i>\r\n				<i class="shareIcon blackHover share_twitter icon-twitter"></i>\r\n			</div>\r\n			\r\n			<div class="share-url-panel"></div>\r\n			\r\n			<div class="embed-title"></div>\r\n			<div class="share-embed-panel"></div>\r\n		</div>\r\n\r\n		<div class="modal-footer">\r\n			<button type="button" class="btn btnCancel btn-naked btn-close" data-dismiss="modal"></button>\r\n		</div>\r\n	</div>\r\n</div>';return __p}}),define("lib-build/css!storymaps/common/ui/share/ShareDialog",[],function(){}),define("lib-build/tpl!storymaps/common/ui/share/ShareURLPanel",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="share-url-container">\r\n	<span class="share-btn share-clipboard"></span>\r\n	<input type="text" class="form-control bitlylink" readonly="true"/>\r\n	<a class="btn btn-primary btn-bitlylink-open" target="_blank"></a>\r\n	<div class="share-status-wrapper"><span class="share-status"></span></div>\r\n</div>';return __p}}),define("lib-build/css!storymaps/common/ui/share/ShareURLPanel",[],function(){}),function(e,t){"use strict";var n=e,r=n.document,i=n.navigator,s=n.setTimeout,o=n.encodeURIComponent,u=n.ActiveXObject,a=n.Error,f=n.Number.parseInt||n.parseInt,l=n.Number.parseFloat||n.parseFloat,c=n.Number.isNaN||n.isNaN,h=n.Math.round,p=n.Date.now,d=n.Object.keys,v=n.Object.defineProperty,m=n.Object.prototype.hasOwnProperty,g=n.Array.prototype.slice,y=function(e){return g.call(e,0)},b=function(){var e,n,r,i,s,o,u=y(arguments),a=u[0]||{};for(e=1,n=u.length;e<n;e++)if((r=u[e])!=null)for(i in r)m.call(r,i)&&(s=a[i],o=r[i],a!==o&&o!==t&&(a[i]=o));return a},w=function(e){var t,n,r,i;if(typeof e!="object"||e==null)t=e;else if(typeof e.length=="number"){t=[];for(n=0,r=e.length;n<r;n++)m.call(e,n)&&(t[n]=w(e[n]))}else{t={};for(i in e)m.call(e,i)&&(t[i]=w(e[i]))}return t},E=function(e,t){var n={};for(var r=0,i=t.length;r<i;r++)t[r]in e&&(n[t[r]]=e[t[r]]);return n},S=function(e,t){var n={};for(var r in e)t.indexOf(r)===-1&&(n[r]=e[r]);return n},x=function(e){if(e)for(var t in e)m.call(e,t)&&delete e[t];return e},T=function(e,t){if(e&&e.nodeType===1&&e.ownerDocument&&t&&(t.nodeType===1&&t.ownerDocument&&t.ownerDocument===e.ownerDocument||t.nodeType===9&&!t.ownerDocument&&t===e.ownerDocument))do{if(e===t)return!0;e=e.parentNode}while(e);return!1},N=function(e){var t;return typeof e=="string"&&e&&(t=e.split("#")[0].split("?")[0],t=e.slice(0,e.lastIndexOf("/")+1)),t},C=function(e){var t,n;return typeof e=="string"&&e&&(n=e.match(/^(?:|[^:@]*@|.+\)@(?=http[s]?|file)|.+?\s+(?: at |@)(?:[^:\(]+ )*[\(]?)((?:http[s]?|file):\/\/[\/]?.+?\/[^:\)]*?)(?::\d+)(?::\d+)?/),n&&n[1]?t=n[1]:(n=e.match(/\)@((?:http[s]?|file):\/\/[\/]?.+?\/[^:\)]*?)(?::\d+)(?::\d+)?/),n&&n[1]&&(t=n[1]))),t},k=function(){var e,t;try{throw new a}catch(n){t=n}return t&&(e=t.sourceURL||t.fileName||C(t.stack)),e},L=function(){var e,n,i;if(r.currentScript&&(e=r.currentScript.src))return e;n=r.getElementsByTagName("script");if(n.length===1)return n[0].src||t;if("readyState"in n[0])for(i=n.length;i--;)if(n[i].readyState==="interactive"&&(e=n[i].src))return e;return r.readyState==="loading"&&(e=n[n.length-1].src)?e:(e=k())?e:t},A=function(){var e,n,i,s=r.getElementsByTagName("script");for(e=s.length;e--;){if(!(i=s[e].src)){n=null;break}i=N(i);if(n==null)n=i;else if(n!==i){n=null;break}}return n||t},O=function(){var e=N(L())||A()||"";return e+"ZeroClipboard.swf"},M={bridge:null,version:"0.0.0",pluginType:"unknown",disabled:null,outdated:null,unavailable:null,deactivated:null,overdue:null,ready:null},_="11.0.0",D={},P,H={},B=null,j={ready:"Flash communication is established",error:{"flash-disabled":"Flash is disabled or not installed","flash-outdated":"Flash is too outdated to support ZeroClipboard","flash-unavailable":"Flash is unable to communicate bidirectionally with JavaScript","flash-deactivated":"Flash is too outdated for your browser and/or is configured as click-to-activate","flash-overdue":"Flash communication was established but NOT within the acceptable time limit"}},F={swfPath:O(),trustedDomains:e.location.host?[e.location.host]:[],cacheBust:!0,forceEnhancedClipboard:!1,flashLoadTimeout:3e4,autoActivate:!0,bubbleEvents:!0,containerId:"global-zeroclipboard-html-bridge",containerClass:"global-zeroclipboard-container",swfObjectId:"global-zeroclipboard-flash-bridge",hoverClass:"zeroclipboard-is-hover",activeClass:"zeroclipboard-is-active",forceHandCursor:!1,title:null,zIndex:999999999},I=function(e){if(typeof e=="object"&&e!==null)for(var t in e)if(m.call(e,t))if(/^(?:forceHandCursor|title|zIndex|bubbleEvents)$/.test(t))F[t]=e[t];else if(M.bridge==null)if(t==="containerId"||t==="swfObjectId"){if(!et(e[t]))throw new Error("The specified `"+t+"` value is not valid as an HTML4 Element ID");F[t]=e[t]}else F[t]=e[t];if(typeof e=="string"&&e){if(m.call(F,e))return F[e];return}return w(F)},q=function(){return{browser:E(i,["userAgent","platform","appName"]),flash:S(M,["bridge"]),zeroclipboard:{version:At.version,config:At.config()}}},R=function(){return!!(M.disabled||M.outdated||M.unavailable||M.deactivated)},U=function(e,t){var n,r,i,s={};if(typeof e=="string"&&e)i=e.toLowerCase().split(/\s+/);else if(typeof e=="object"&&e&&typeof t=="undefined")for(n in e)m.call(e,n)&&typeof n=="string"&&n&&typeof e[n]=="function"&&At.on(n,e[n]);if(i&&i.length){for(n=0,r=i.length;n<r;n++)e=i[n].replace(/^on/,""),s[e]=!0,D[e]||(D[e]=[]),D[e].push(t);s.ready&&M.ready&&At.emit({type:"ready"});if(s.error){var o=["disabled","outdated","unavailable","deactivated","overdue"];for(n=0,r=o.length;n<r;n++)if(M[o[n]]===!0){At.emit({type:"error",name:"flash-"+o[n]});break}}}return At},z=function(e,t){var n,r,i,s,o;if(arguments.length===0)s=d(D);else if(typeof e=="string"&&e)s=e.split(/\s+/);else if(typeof e=="object"&&e&&typeof t=="undefined")for(n in e)m.call(e,n)&&typeof n=="string"&&n&&typeof e[n]=="function"&&At.off(n,e[n]);if(s&&s.length)for(n=0,r=s.length;n<r;n++){e=s[n].toLowerCase().replace(/^on/,""),o=D[e];if(o&&o.length)if(t){i=o.indexOf(t);while(i!==-1)o.splice(i,1),i=o.indexOf(t,i)}else o.length=0}return At},W=function(e){var t;return typeof e=="string"&&e?t=w(D[e])||null:t=w(D),t},X=function(e){var t,n,r;e=tt(e);if(!e)return;if(ut(e))return;return e.type==="ready"&&M.overdue===!0?At.emit({type:"error",name:"flash-overdue"}):(t=b({},e),ot.call(this,t),e.type==="copy"&&(r=pt(H),n=r.data,B=r.formatMap),n)},V=function(){typeof M.ready!="boolean"&&(M.ready=!1);if(!At.isFlashUnusable()&&M.bridge===null){var e=F.flashLoadTimeout;typeof e=="number"&&e>=0&&s(function(){typeof M.deactivated!="boolean"&&(M.deactivated=!0),M.deactivated===!0&&At.emit({type:"error",name:"flash-deactivated"})},e),M.overdue=!1,ct()}},$=function(){At.clearData(),At.blur(),At.emit("destroy"),ht(),At.off()},J=function(e,t){var n;if(typeof e=="object"&&e&&typeof t=="undefined")n=e,At.clearData();else{if(typeof e!="string"||!e)return;n={},n[e]=t}for(var r in n)typeof r=="string"&&r&&m.call(n,r)&&typeof n[r]=="string"&&n[r]&&(H[r]=n[r])},K=function(e){typeof e=="undefined"?(x(H),B=null):typeof e=="string"&&m.call(H,e)&&delete H[e]},Q=function(e){if(typeof e=="undefined")return w(H);if(typeof e=="string"&&m.call(H,e))return H[e]},G=function(e){if(!e||e.nodeType!==1)return;P&&(Et(P,F.activeClass),P!==e&&Et(P,F.hoverClass)),P=e,wt(e,F.hoverClass);var t=e.getAttribute("title")||F.title;if(typeof t=="string"&&t){var n=lt(M.bridge);n&&n.setAttribute("title",t)}var r=F.forceHandCursor===!0||St(e,"cursor")==="pointer";Ct(r),Nt()},Y=function(){var e=lt(M.bridge);e&&(e.removeAttribute("title"),e.style.left="0px",e.style.top="-9999px",e.style.width="1px",e.style.top="1px"),P&&(Et(P,F.hoverClass),Et(P,F.activeClass),P=null)},Z=function(){return P||null},et=function(e){return typeof e=="string"&&e&&/^[A-Za-z][A-Za-z0-9_:\-\.]*$/.test(e)},tt=function(e){var t;typeof e=="string"&&e?(t=e,e={}):typeof e=="object"&&e&&typeof e.type=="string"&&e.type&&(t=e.type);if(!t)return;b(e,{type:t.toLowerCase(),target:e.target||P||null,relatedTarget:e.relatedTarget||null,currentTarget:M&&M.bridge||null,timeStamp:e.timeStamp||p()||null});var n=j[e.type];return e.type==="error"&&e.name&&n&&(n=n[e.name]),n&&(e.message=n),e.type==="ready"&&b(e,{target:null,version:M.version}),e.type==="error"&&(/^flash-(disabled|outdated|unavailable|deactivated|overdue)$/.test(e.name)&&b(e,{target:null,minimumVersion:_}),/^flash-(outdated|unavailable|deactivated|overdue)$/.test(e.name)&&b(e,{version:M.version})),e.type==="copy"&&(e.clipboardData={setData:At.setData,clearData:At.clearData}),e.type==="aftercopy"&&(e=dt(e,B)),e.target&&!e.relatedTarget&&(e.relatedTarget=nt(e.target)),e=rt(e),e},nt=function(e){var t=e&&e.getAttribute&&e.getAttribute("data-clipboard-target");return t?r.getElementById(t):null},rt=function(e){if(e&&/^_(?:click|mouse(?:over|out|down|up|move))$/.test(e.type)){var i=e.target,s=e.type==="_mouseover"&&e.relatedTarget?e.relatedTarget:t,o=e.type==="_mouseout"&&e.relatedTarget?e.relatedTarget:t,u=Tt(i),a=n.screenLeft||n.screenX||0,f=n.screenTop||n.screenY||0,l=r.body.scrollLeft+r.documentElement.scrollLeft,c=r.body.scrollTop+r.documentElement.scrollTop,h=u.left+(typeof e._stageX=="number"?e._stageX:0),p=u.top+(typeof e._stageY=="number"?e._stageY:0),d=h-l,v=p-c,m=a+d,g=f+v,y=typeof e.movementX=="number"?e.movementX:0,w=typeof e.movementY=="number"?e.movementY:0;delete e._stageX,delete e._stageY,b(e,{srcElement:i,fromElement:s,toElement:o,screenX:m,screenY:g,pageX:h,pageY:p,clientX:d,clientY:v,x:d,y:v,movementX:y,movementY:w,offsetX:0,offsetY:0,layerX:0,layerY:0})}return e},it=function(e){var t=e&&typeof e.type=="string"&&e.type||"";return!/^(?:(?:before)?copy|destroy)$/.test(t)},st=function(e,t,n,r){r?s(function(){e.apply(t,n)},0):e.apply(t,n)},ot=function(e){if(typeof e!="object"||!e||!e.type)return;var t=it(e),r=D["*"]||[],i=D[e.type]||[],s=r.concat(i);if(s&&s.length){var o,u,a,f,l,c=this;for(o=0,u=s.length;o<u;o++)a=s[o],f=c,typeof a=="string"&&typeof n[a]=="function"&&(a=n[a]),typeof a=="object"&&a&&typeof a.handleEvent=="function"&&(f=a,a=a.handleEvent),typeof a=="function"&&(l=b({},e),st(a,f,[l],t))}return this},ut=function(e){var t=e.target||P||null,n=e._source==="swf";delete e._source;var r=["flash-disabled","flash-outdated","flash-unavailable","flash-deactivated","flash-overdue"];switch(e.type){case"error":r.indexOf(e.name)!==-1&&b(M,{disabled:e.name==="flash-disabled",outdated:e.name==="flash-outdated",unavailable:e.name==="flash-unavailable",deactivated:e.name==="flash-deactivated",overdue:e.name==="flash-overdue",ready:!1});break;case"ready":var i=M.deactivated===!0;b(M,{disabled:!1,outdated:!1,unavailable:!1,deactivated:!1,overdue:i,ready:!i});break;case"copy":var s,o,u=e.relatedTarget;!H["text/html"]&&!H["text/plain"]&&u&&(o=u.value||u.outerHTML||u.innerHTML)&&(s=u.value||u.textContent||u.innerText)?(e.clipboardData.clearData(),e.clipboardData.setData("text/plain",s),o!==s&&e.clipboardData.setData("text/html",o)):!H["text/plain"]&&e.target&&(s=e.target.getAttribute("data-clipboard-text"))&&(e.clipboardData.clearData(),e.clipboardData.setData("text/plain",s));break;case"aftercopy":At.clearData(),t&&t!==bt()&&t.focus&&t.focus();break;case"_mouseover":At.focus(t),F.bubbleEvents===!0&&n&&(t&&t!==e.relatedTarget&&!T(e.relatedTarget,t)&&at(b({},e,{type:"mouseenter",bubbles:!1,cancelable:!1})),at(b({},e,{type:"mouseover"})));break;case"_mouseout":At.blur(),F.bubbleEvents===!0&&n&&(t&&t!==e.relatedTarget&&!T(e.relatedTarget,t)&&at(b({},e,{type:"mouseleave",bubbles:!1,cancelable:!1})),at(b({},e,{type:"mouseout"})));break;case"_mousedown":wt(t,F.activeClass),F.bubbleEvents===!0&&n&&at(b({},e,{type:e.type.slice(1)}));break;case"_mouseup":Et(t,F.activeClass),F.bubbleEvents===!0&&n&&at(b({},e,{type:e.type.slice(1)}));break;case"_click":case"_mousemove":F.bubbleEvents===!0&&n&&at(b({},e,{type:e.type.slice(1)}))}if(/^_(?:click|mouse(?:over|out|down|up|move))$/.test(e.type))return!0},at=function(e){if(!e||typeof e.type!="string"||!e)return;var t,i=e.target||null,s=i&&i.ownerDocument||r,o={view:s.defaultView||n,canBubble:!0,cancelable:!0,detail:e.type==="click"?1:0,button:typeof e.which=="number"?e.which-1:typeof e.button=="number"?e.button:s.createEvent?0:1},u=b(o,e);if(!i)return;s.createEvent&&i.dispatchEvent&&(u=[u.type,u.canBubble,u.cancelable,u.view,u.detail,u.screenX,u.screenY,u.clientX,u.clientY,u.ctrlKey,u.altKey,u.shiftKey,u.metaKey,u.button,u.relatedTarget],t=s.createEvent("MouseEvents"),t.initMouseEvent&&(t.initMouseEvent.apply(t,u),t._source="js",i.dispatchEvent(t)))},ft=function(){var e=r.createElement("div");return e.id=F.containerId,e.className=F.containerClass,e.style.position="absolute",e.style.left="0px",e.style.top="-9999px",e.style.width="1px",e.style.height="1px",e.style.zIndex=""+kt(F.zIndex),e},lt=function(e){var t=e&&e.parentNode;while(t&&t.nodeName==="OBJECT"&&t.parentNode)t=t.parentNode;return t||null},ct=function(){var e,t=M.bridge,i=lt(t);if(!t){var s=yt(n.location.host,F),o=s==="never"?"none":"all",u=mt(F),a=F.swfPath+vt(F.swfPath,F);i=ft();var f=r.createElement("div");i.appendChild(f),r.body.appendChild(i);var l=r.createElement("div"),c=M.pluginType==="activex";l.innerHTML='<object id="'+F.swfObjectId+'" name="'+F.swfObjectId+'" '+'width="100%" height="100%" '+(c?'classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"':'type="application/x-shockwave-flash" data="'+a+'"')+">"+(c?'<param name="movie" value="'+a+'"/>':"")+'<param name="allowScriptAccess" value="'+s+'"/>'+'<param name="allowNetworking" value="'+o+'"/>'+'<param name="menu" value="false"/>'+'<param name="wmode" value="transparent"/>'+'<param name="flashvars" value="'+u+'"/>'+"</object>",t=l.firstChild,l=null,t.ZeroClipboard=At,i.replaceChild(t,f)}return t||(t=r[F.swfObjectId],t&&(e=t.length)&&(t=t[e-1]),!t&&i&&(t=i.firstChild)),M.bridge=t||null,t},ht=function(){var e=M.bridge;if(e){var t=lt(e);t&&(M.pluginType==="activex"&&"readyState"in e?(e.style.display="none",function n(){if(e.readyState===4){for(var r in e)typeof e[r]=="function"&&(e[r]=null);e.parentNode&&e.parentNode.removeChild(e),t.parentNode&&t.parentNode.removeChild(t)}else s(n,10)}()):(e.parentNode&&e.parentNode.removeChild(e),t.parentNode&&t.parentNode.removeChild(t))),M.ready=null,M.bridge=null,M.deactivated=null}},pt=function(e){var t={},n={};if(typeof e!="object"||!e)return;for(var r in e)if(r&&m.call(e,r)&&typeof e[r]=="string"&&e[r])switch(r.toLowerCase()){case"text/plain":case"text":case"air:text":case"flash:text":t.text=e[r],n.text=r;break;case"text/html":case"html":case"air:html":case"flash:html":t.html=e[r],n.html=r;break;case"application/rtf":case"text/rtf":case"rtf":case"richtext":case"air:rtf":case"flash:rtf":t.rtf=e[r],n.rtf=r;break;default:}return{data:t,formatMap:n}},dt=function(e,t){if(typeof e!="object"||!e||typeof t!="object"||!t)return e;var n={};for(var r in e)if(m.call(e,r)){if(r!=="success"&&r!=="data"){n[r]=e[r];continue}n[r]={};var i=e[r];for(var s in i)s&&m.call(i,s)&&m.call(t,s)&&(n[r][t[s]]=i[s])}return n},vt=function(e,t){var n=t==null||t&&t.cacheBust===!0;return n?(e.indexOf("?")===-1?"?":"&")+"noCache="+p():""},mt=function(e){var t,r,i,s,u="",a=[];e.trustedDomains&&(typeof e.trustedDomains=="string"?s=[e.trustedDomains]:typeof e.trustedDomains=="object"&&"length"in e.trustedDomains&&(s=e.trustedDomains));if(s&&s.length)for(t=0,r=s.length;t<r;t++)if(m.call(s,t)&&s[t]&&typeof s[t]=="string"){i=gt(s[t]);if(!i)continue;if(i==="*"){a.length=0,a.push(i);break}a.push.apply(a,[i,"//"+i,n.location.protocol+"//"+i])}return a.length&&(u+="trustedOrigins="+o(a.join(","))),e.forceEnhancedClipboard===!0&&(u+=(u?"&":"")+"forceEnhancedClipboard=true"),typeof e.swfObjectId=="string"&&e.swfObjectId&&(u+=(u?"&":"")+"swfObjectId="+o(e.swfObjectId)),u},gt=function(e){if(e==null||e==="")return null;e=e.replace(/^\s+|\s+$/g,"");if(e==="")return null;var t=e.indexOf("//");e=t===-1?e:e.slice(t+2);var n=e.indexOf("/");return e=n===-1?e:t===-1||n===0?null:e.slice(0,n),e&&e.slice(-4).toLowerCase()===".swf"?null:e||null},yt=function(){var e=function(e){var t,n,r,i=[];typeof e=="string"&&(e=[e]);if(typeof e!="object"||!e||typeof e.length!="number")return i;for(t=0,n=e.length;t<n;t++)if(m.call(e,t)&&(r=gt(e[t]))){if(r==="*"){i.length=0,i.push("*");break}i.indexOf(r)===-1&&i.push(r)}return i};return function(t,n){var r=gt(n.swfPath);r===null&&(r=t);var i=e(n.trustedDomains),s=i.length;if(s>0){if(s===1&&i[0]==="*")return"always";if(i.indexOf(t)!==-1)return s===1&&t===r?"sameDomain":"always"}return"never"}}(),bt=function(){try{return r.activeElement}catch(e){return null}},wt=function(e,t){if(!e||e.nodeType!==1)return e;if(e.classList)return e.classList.contains(t)||e.classList.add(t),e;if(t&&typeof t=="string"){var n=(t||"").split(/\s+/);if(e.nodeType===1)if(!e.className)e.className=t;else{var r=" "+e.className+" ",i=e.className;for(var s=0,o=n.length;s<o;s++)r.indexOf(" "+n[s]+" ")<0&&(i+=" "+n[s]);e.className=i.replace(/^\s+|\s+$/g,"")}}return e},Et=function(e,t){if(!e||e.nodeType!==1)return e;if(e.classList)return e.classList.contains(t)&&e.classList.remove(t),e;if(typeof t=="string"&&t){var n=t.split(/\s+/);if(e.nodeType===1&&e.className){var r=(" "+e.className+" ").replace(/[\n\t]/g," ");for(var i=0,s=n.length;i<s;i++)r=r.replace(" "+n[i]+" "," ");e.className=r.replace(/^\s+|\s+$/g,"")}}return e},St=function(e,t){var r=n.getComputedStyle(e,null).getPropertyValue(t);return t!=="cursor"||!!r&&r!=="auto"||e.nodeName!=="A"?r:"pointer"},xt=function(){var e,t,n,i=1;return typeof r.body.getBoundingClientRect=="function"&&(e=r.body.getBoundingClientRect(),t=e.right-e.left,n=r.body.offsetWidth,i=h(t/n*100)/100),i},Tt=function(e){var t={left:0,top:0,width:0,height:0};if(e.getBoundingClientRect){var i=e.getBoundingClientRect(),s,o,u;"pageXOffset"in n&&"pageYOffset"in n?(s=n.pageXOffset,o=n.pageYOffset):(u=xt(),s=h(r.documentElement.scrollLeft/u),o=h(r.documentElement.scrollTop/u));var a=r.documentElement.clientLeft||0,f=r.documentElement.clientTop||0;t.left=i.left+s-a,t.top=i.top+o-f,t.width="width"in i?i.width:i.right-i.left,t.height="height"in i?i.height:i.bottom-i.top}return t},Nt=function(){var e;if(P&&(e=lt(M.bridge))){var t=Tt(P);b(e.style,{width:t.width+"px",height:t.height+"px",top:t.top+"px",left:t.left+"px",zIndex:""+kt(F.zIndex)})}},Ct=function(e){M.ready===!0&&(M.bridge&&typeof M.bridge.setHandCursor=="function"?M.bridge.setHandCursor(e):M.ready=!1)},kt=function(e){if(/^(?:auto|inherit)$/.test(e))return e;var t;return typeof e=="number"&&!c(e)?t=e:typeof e=="string"&&(t=kt(f(e,10))),typeof t=="number"?t:"auto"},Lt=function(e){function f(e){var t=e.match(/[\d]+/g);return t.length=3,t.join(".")}function c(e){return!!e&&(e=e.toLowerCase())&&(/^(pepflashplayer\.dll|libpepflashplayer\.so|pepperflashplayer\.plugin)$/.test(e)||e.slice(-13)==="chrome.plugin")}function h(e){e&&(s=!0,e.version&&(a=f(e.version)),!a&&e.description&&(a=f(e.description)),e.filename&&(u=c(e.filename)))}var t,n,r,s=!1,o=!1,u=!1,a="";if(i.plugins&&i.plugins.length)t=i.plugins["Shockwave Flash"],h(t),i.plugins["Shockwave Flash 2.0"]&&(s=!0,a="2.0.0.11");else if(i.mimeTypes&&i.mimeTypes.length)r=i.mimeTypes["application/x-shockwave-flash"],t=r&&r.enabledPlugin,h(t);else if(typeof e!="undefined"){o=!0;try{n=new e("ShockwaveFlash.ShockwaveFlash.7"),s=!0,a=f(n.GetVariable("$version"))}catch(p){try{n=new e("ShockwaveFlash.ShockwaveFlash.6"),s=!0,a="6.0.21"}catch(d){try{n=new e("ShockwaveFlash.ShockwaveFlash"),s=!0,a=f(n.GetVariable("$version"))}catch(v){o=!1}}}}M.disabled=s!==!0,M.outdated=a&&l(a)<l(_),M.version=a||"0.0.0",M.pluginType=u?"pepper":o?"activex":s?"netscape":"unknown"};Lt(u);var At=function(){if(!(this instanceof At))return new At;typeof At._createClient=="function"&&At._createClient.apply(this,y(arguments))};try{v(At,"version",{value:"2.1.3",writable:!1,configurable:!0,enumerable:!0})}catch(Ot){}At.config=function(){return I.apply(this,y(arguments))},At.state=function(){return q.apply(this,y(arguments))},At.isFlashUnusable=function(){return R.apply(this,y(arguments))},At.on=function(){return U.apply(this,y(arguments))},At.off=function(){return z.apply(this,y(arguments))},At.handlers=function(){return W.apply(this,y(arguments))},At.emit=function(){return X.apply(this,y(arguments))},At.create=function(){return V.apply(this,y(arguments))},At.destroy=function(){return $.apply(this,y(arguments))},At.setData=function(){return J.apply(this,y(arguments))},At.clearData=function(){return K.apply(this,y(arguments))},At.getData=function(){return Q.apply(this,y(arguments))},At.focus=At.activate=function(){return G.apply(this,y(arguments))},At.blur=At.deactivate=function(){return Y.apply(this,y(arguments))},At.activeElement=function(){return Z.apply(this,y(arguments))};var Mt=0,_t={},Dt=0,Pt={},Ht={};b(F,{autoActivate:!0});var Bt=function(e){var t=this;t.id=""+Mt++,_t[t.id]={instance:t,elements:[],handlers:{}},e&&t.clip(e),At.on("*",function(e){return t.emit(e)}),At.on("destroy",function(){t.destroy()}),At.create()},jt=function(e,t){var n,r,i,s={},o=_t[this.id]&&_t[this.id].handlers;if(typeof e=="string"&&e)i=e.toLowerCase().split(/\s+/);else if(typeof e=="object"&&e&&typeof t=="undefined")for(n in e)m.call(e,n)&&typeof n=="string"&&n&&typeof e[n]=="function"&&this.on(n,e[n]);if(i&&i.length){for(n=0,r=i.length;n<r;n++)e=i[n].replace(/^on/,""),s[e]=!0,o[e]||(o[e]=[]),o[e].push(t);s.ready&&M.ready&&this.emit({type:"ready",client:this});if(s.error){var u=["disabled","outdated","unavailable","deactivated","overdue"];for(n=0,r=u.length;n<r;n++)if(M[u[n]]){this.emit({type:"error",name:"flash-"+u[n],client:this});break}}}return this},Ft=function(e,t){var n,r,i,s,o,u=_t[this.id]&&_t[this.id].handlers;if(arguments.length===0)s=d(u);else if(typeof e=="string"&&e)s=e.split(/\s+/);else if(typeof e=="object"&&e&&typeof t=="undefined")for(n in e)m.call(e,n)&&typeof n=="string"&&n&&typeof e[n]=="function"&&this.off(n,e[n]);if(s&&s.length)for(n=0,r=s.length;n<r;n++){e=s[n].toLowerCase().replace(/^on/,""),o=u[e];if(o&&o.length)if(t){i=o.indexOf(t);while(i!==-1)o.splice(i,1),i=o.indexOf(t,i)}else o.length=0}return this},It=function(e){var t=null,n=_t[this.id]&&_t[this.id].handlers;return n&&(typeof e=="string"&&e?t=n[e]?n[e].slice(0):[]:t=w(n)),t},qt=function(e){if(Xt.call(this,e)){typeof e=="object"&&e&&typeof e.type=="string"&&e.type&&(e=b({},e));var t=b({},tt(e),{client:this});Vt.call(this,t)}return this},Rt=function(e){e=$t(e);for(var t=0;t<e.length;t++)if(m.call(e,t)&&e[t]&&e[t].nodeType===1){e[t].zcClippingId?Pt[e[t].zcClippingId].indexOf(this.id)===-1&&Pt[e[t].zcClippingId].push(this.id):(e[t].zcClippingId="zcClippingId_"+Dt++,Pt[e[t].zcClippingId]=[this.id],F.autoActivate===!0&&Jt(e[t]));var n=_t[this.id]&&_t[this.id].elements;n.indexOf(e[t])===-1&&n.push(e[t])}return this},Ut=function(e){var t=_t[this.id];if(!t)return this;var n=t.elements,r;typeof e=="undefined"?e=n.slice(0):e=$t(e);for(var i=e.length;i--;)if(m.call(e,i)&&e[i]&&e[i].nodeType===1){r=0;while((r=n.indexOf(e[i],r))!==-1)n.splice(r,1);var s=Pt[e[i].zcClippingId];if(s){r=0;while((r=s.indexOf(this.id,r))!==-1)s.splice(r,1);s.length===0&&(F.autoActivate===!0&&Kt(e[i]),delete e[i].zcClippingId)}}return this},zt=function(){var e=_t[this.id];return e&&e.elements?e.elements.slice(0):[]},Wt=function(){this.unclip(),this.off(),delete _t[this.id]},Xt=function(e){if(!e||!e.type)return!1;if(e.client&&e.client!==this)return!1;var t=_t[this.id]&&_t[this.id].elements,n=!!t&&t.length>0,r=!e.target||n&&t.indexOf(e.target)!==-1,i=e.relatedTarget&&n&&t.indexOf(e.relatedTarget)!==-1,s=e.client&&e.client===this;return r||i||s?!0:!1},Vt=function(e){if(typeof e!="object"||!e||!e.type)return;var t=it(e),r=_t[this.id]&&_t[this.id].handlers["*"]||[],i=_t[this.id]&&_t[this.id].handlers[e.type]||[],s=r.concat(i);if(s&&s.length){var o,u,a,f,l,c=this;for(o=0,u=s.length;o<u;o++)a=s[o],f=c,typeof a=="string"&&typeof n[a]=="function"&&(a=n[a]),typeof a=="object"&&a&&typeof a.handleEvent=="function"&&(f=a,a=a.handleEvent),typeof a=="function"&&(l=b({},e),st(a,f,[l],t))}return this},$t=function(e){return typeof e=="string"&&(e=[]),typeof e.length!="number"?[e]:e},Jt=function(e){if(!e||e.nodeType!==1)return;var t=function(e){if(!e&&!(e=n.event))return;e._source!=="js"&&(e.stopImmediatePropagation(),e.preventDefault()),delete e._source},r=function(r){if(!r&&!(r=n.event))return;t(r),At.focus(e)};e.addEventListener("mouseover",r,!1),e.addEventListener("mouseout",t,!1),e.addEventListener("mouseenter",t,!1),e.addEventListener("mouseleave",t,!1),e.addEventListener("mousemove",t,!1),Ht[e.zcClippingId]={mouseover:r,mouseout:t,mouseenter:t,mouseleave:t,mousemove:t}},Kt=function(e){if(!e||e.nodeType!==1)return;var t=Ht[e.zcClippingId];if(typeof t!="object"||!t)return;var n,r,i=["move","leave","enter","out","over"];for(var s=0,o=i.length;s<o;s++)n="mouse"+i[s],r=t[n],typeof r=="function"&&e.removeEventListener(n,r,!1);delete Ht[e.zcClippingId]};At._createClient=function(){Bt.apply(this,y(arguments))},At.prototype.on=function(){return jt.apply(this,y(arguments))},At.prototype.off=function(){return Ft.apply(this,y(arguments))},At.prototype.handlers=function(){return It.apply(this,y(arguments))},At.prototype.emit=function(){return qt.apply(this,y(arguments))},At.prototype.clip=function(){return Rt.apply(this,y(arguments))},At.prototype.unclip=function(){return Ut.apply(this,y(arguments))},At.prototype.elements=function(){return zt.apply(this,y(arguments))},At.prototype.destroy=function(){return Wt.apply(this,y(arguments))},At.prototype.setText=function(e){return At.setData("text/plain",e),this},At.prototype.setHtml=function(e){return At.setData("text/html",e),this},At.prototype.setRichText=function(e){return At.setData("application/rtf",e),this},At.prototype.setData=function(){return At.setData.apply(this,y(arguments)),this},At.prototype.clearData=function(){return At.clearData.apply(this,y(arguments)),this},At.prototype.getData=function(){return At.getData.apply(this,y(arguments))},typeof define=="function"&&define.amd?define("lib-app/ZeroClipboard/ZeroClipboard.min",[],function(){return At}):typeof module=="object"&&module&&typeof module.exports=="object"&&module.exports?module.exports=At:e.ZeroClipboard=At}(function(){return this||window}()),define("lib-build/css!storymaps/common/_resources/font/builder-share/css/share-font",[],function(){}),define("storymaps/common/ui/share/ShareURLPanel",["lib-build/tpl!./ShareURLPanel","lib-build/css!./ShareURLPanel","../../utils/SocialSharing","dojo/has","lib-app/ZeroClipboard/ZeroClipboard.min","lib-build/css!storymaps/common/_resources/font/builder-share/css/share-font.css"],function(e,t,n,r,i){return function(s){function u(e,t){o.val(e),s.find(".btn-bitlylink-open").attr("href",e),n.requestBitly(e).then(function(e){o.val(e),(t===undefined||t===!0)&&o.select()}),i.config({swfPath:(app.isProduction?"resources/lib/":"lib-app")+"/ZeroClipboard/ZeroClipboard.swf"});var r=new i(s.find(".share-btn"));r.on("copy",function(e){var t=e.clipboardData;t.setData("text/plain",s.find(".bitlylink").val()),s.find(".share-btn").removeClass("share-clipboard").addClass("share-ok"),s.find(".share-status").show(),s.find(".bitlylink")[0].selectionStart=s.find(".bitlylink")[0].selectionEnd=-1,s.find(".bitlylink").focus(),setTimeout(function(){s.find(".share-btn").addClass("share-clipboard").removeClass("share-ok"),s.find(".share-status").hide()},2e3)})}function a(){s.find(".bitlylink").click(function(){this.setSelectionRange(0,this.value.length)})}s.append(e({}));var o=s.find(".bitlylink");a(),this.present=function(e,t){u(e,t),s.find(".btn-bitlylink-open").html(i18n.viewer.shareFromCommon.open),s.find(".share-url-container").toggleClass("touch",!!r("touch")),s.find(".share-btn").attr("title",i18n.viewer.shareFromCommon.copy),s.find(".share-status").html(i18n.viewer.shareFromCommon.copied)},this.focus=function(){o.select()}}}),define("lib-build/tpl!storymaps/common/ui/share/ShareEmbedPanel",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="share-embed-container">\r\n	<div class="embed-explain"></div>\r\n\r\n	<div class="share-embed-wrapper">\r\n		<div class="share-btn share-clipboard"></div>	\r\n		<textarea class="form-control embedTextarea" readonly="true"></textarea>\r\n	</div>\r\n	<div class="share-status-wrapper"><span class="share-status"></span></div>\r\n	\r\n	<div>\r\n		<span class="embed-lbl-size"></span>\r\n		<div class="btn-group">\r\n			<button class="btn btn-default btn-sm dropdown-toggle" type="button" data-toggle="dropdown">\r\n				<span class="embed-sizes-btn"></span>&nbsp;<span class="caret"></span>\r\n			</button>\r\n			<ul class="dropdown-menu embed-sizes" role="menu"></ul>\r\n		</div>\r\n	</div>\r\n</div>\r\n';return __p}}),define("lib-build/css!storymaps/common/ui/share/ShareEmbedPanel",[],function(){}),define("storymaps/common/ui/share/ShareEmbedPanel",["lib-build/tpl!./ShareEmbedPanel","lib-build/css!./ShareEmbedPanel","dojo/has","lib-app/ZeroClipboard/ZeroClipboard.min","lib-build/css!storymaps/common/_resources/font/builder-share/css/share-font.css"],function(e,t,n,r){return function(i){function a(){$.each(o,function(e,t){i.find(".embed-sizes").append('<li><a data-width="'+t.width+'" data-height="'+t.height+'">'+t.width+" / "+t.height+"</a></li>")}),i.find(".embed-sizes a").click(function(){var e=$(this);e.parents(".btn-group").find(".embed-sizes-btn").text(e.text()),f(e.data("width"),e.data("height"))})}function f(e,t){i.find(".embedTextarea").val(s.replace("%URL%",u).replace("%WIDTH%",e).replace("%HEIGHT%",t)),r.config({swfPath:(app.isProduction?"resources/lib/":"lib-app")+"/ZeroClipboard/ZeroClipboard.swf"});var n=new r(i.find(".share-btn"));n.on("copy",function(e){var t=e.clipboardData;t.setData("text/plain",i.find(".embedTextarea").val()),i.find(".share-btn").removeClass("share-clipboard").addClass("share-ok"),i.find(".share-status").show(),i.find(".embedTextarea")[0].selectionStart=i.find(".embedTextarea")[0].selectionEnd=-1,i.find(".bitlylink").focus(),setTimeout(function(){i.find(".share-btn").addClass("share-clipboard").removeClass("share-ok"),i.find(".share-status").hide()},2e3)})}function l(){i.find(".embedTextarea").click(function(){this.setSelectionRange(0,this.value.length)})}var s='<iframe width="%WIDTH%" height="%HEIGHT%" src="%URL%" frameborder="0" scrolling="no"></iframe>',o=[{width:"100%",height:"800px"},{width:"100%",height:"640px"},{width:"800px",height:"600px"},{width:"640px",height:"480px"}],u=null;i.append(e({})),a(),l(),this.present=function(e){u=e,i.find(".embed-explain").html(i18n.viewer.shareFromCommon.embedExplain),i.find(".embed-lbl-size").html(i18n.viewer.shareFromCommon.size),i.find(".embed-sizes a").eq(0).click(),i.find(".share-embed-wrapper").toggleClass("touch",!!n("touch")),i.find(".share-clipboard").attr("title",i18n.viewer.shareFromCommon.copy),i.find(".share-status").html(i18n.viewer.shareFromCommon.copied)}}}),define("storymaps/common/ui/share/ShareDialog",["lib-build/tpl!./ShareDialog","lib-build/css!./ShareDialog","./ShareURLPanel","./ShareEmbedPanel","../../utils/SocialSharing"],function(e,t,n,r,i){return function(s){function a(e){var t=$("<div>"+app.data.getWebAppData().getTitle()+"</div>").text();s.find(".share_facebook").toggle(e.facebook),e.facebook&&s.find(".share_facebook").off("click").click(function(){i.shareFacebook("","",null,$(this).data("url"))}),s.find(".share_twitter").toggle(e.twitter),e.twitter&&s.find(".share_twitter").off("click").click(function(){i.shareTwitter(t,$(this).data("url"))})}s.append(e({}));var o=new n(s.find(".share-url-panel")),u=new r(s.find(".share-embed-panel"));s.on("shown.bs.modal",function(){o.focus()}),this.present=function(e,t){t=t||{facebook:!1,twitter:!1},s.find(".social-container").toggle(t.facebook||t.twitter),a(t),o.present(e),u.present(e),s.find(".modal-title").html(i18n.viewer.headerFromCommon.share),s.find(".embed-title").html(i18n.viewer.shareFromCommon.embed),s.find(".btn-close").html(i18n.viewer.common.close),s.modal({keyboard:!0})}}}),define("storymaps/common/utils/HeaderHelper",["./SocialSharing","../ui/share/ShareDialog"],function(e,t){function r(e){e.find(".linkContainer").parent().length&&e.find(".linkContainer").css("width",(e.find(".logoContainer").position()||{left:186}).left-e.find(".linkContainer").parent().position().left-e.find(".shareBtns").outerWidth()-($(".logoContainer").width()>1?14:4))}var n=new t($("#shareDialog"));return{setLogo:function(e,t,n){!t.logoURL||t.logoURL=="NO_LOGO"?(e.find(".logoImg").hide(),r(e)):(e.find(".logoLink").css("cursor",t.logoTarget?"pointer":"default"),t.logoTarget&&e.find(".logoLink").attr("href",t.logoTarget),r(e),e.find(".logoImg")[0].onload=function(){r(e),n&&typeof n=="function"&&n()},e.find(".logoImg")[0].onerror=function(){r(e)},e.find(".logoImg").attr("src",t.logoURL).show())},setLink:function(e,t){t.linkURL&&t.linkText?e.find(".linkContainer").html('<a href="'+t.linkURL+'" class="link" target="_blank" tabindex="-1">'+t.linkText+"</a>"):e.find(".linkContainer").html(t.linkText)},setSocial:function(e,t){var n=app.cfg.HEADER_SOCIAL,r=t.socialBtn,i=n&&n.facebook&&(!r||r.facebook),s=n&&n.twitter&&(!r||r.twitter),o=n&&n.bitly&&n.bitly.enable&&n.bitly.login&&n.bitly.key&&(!r||r.bitly);e.find(".share_facebook").toggleClass("active",i),e.find(".share_twitter").toggleClass("active",s),e.find(".share_bitly").toggleClass("active",o),e.find(".share-all").data("share-facebook",i).data("share-twitter",s).toggleClass("active",i||s||o)},toggleSocialBtnAppSharing:function(e,t){t&&e.find(".shareIcon").attr("title",""),e.find(".shareIcon").toggleClass("disabled",!!t).tooltip(t?{title:i18n.commonCore?i18n.commonCore.builderPanel.tooltipNotShared:"",container:"body"}:"destroy")},initEvents:function(t){t.find(".share_facebook").off("click").click(function(){if($(this).hasClass("disabled"))return;var t=$("<div>"+(app.data.getWebAppData().getTitle()||"")+"</div>").text(),n=$("<div>"+(app.data.getWebAppData().getSubtitle()||"")+"</div>").text();e.shareFacebook(t,n,null,$(this).data("url"))}),t.find(".share_twitter").off("click").click(function(){if($(this).hasClass("disabled"))return;var t=$("<div>"+(app.data.getWebAppData().getTitle()||app.data.getWebMap().item.title||"")+"</div>").text();e.shareTwitter(t,$(this).data("url"))}),t.find(".share_bitly").off("click").click(function(){if($(this).hasClass("disabled"))return;var t=$(this).data("url")||document.location.href;n.present(e.cleanURL(t,!0))}),t.find(".share-all").off("click").click(function(){if($(this).hasClass("disabled"))return;var t=$(this).data("url")||document.location.href;n.present(e.cleanURL(t,!0),{facebook:!!$(this).data("share-facebook"),twitter:!!$(this).data("share-twitter")})}),t.find(".shareIcon, .share-all").off("keypress").keypress(function(e){if(e.which==13)return $(this).click(),!1}),t.find(".share_facebook").attr("title",i18n.viewer.headerFromCommon.facebookTooltip),t.find(".share_twitter").attr("title",i18n.viewer.headerFromCommon.twitterTooltip),t.find(".share_bitly").attr("title",i18n.viewer.headerFromCommon.bitlyTooltip),$(window).resize(function(){r(t)})}}}),define("lib-build/css!storymaps/common/builder/InlineFieldEdit",[],function(){}),define("storymaps/common/builder/InlineFieldEdit",["lib-build/css!./InlineFieldEdit","dojo/has"],function(e,t){return function(n,r,i){function o(e,t,n){if(!e||!t||!n)return;typeof r=="function"&&r(),s=n,t.parent().parent().addClass("isEditing"),t.hide(),e.hide(),n.val(t.html()),n.show(),n.select()}function u(e){if(!e||!e.get(0))return;s=null;var n=e.get(0).value,r=e.parent().find(".text_edit_label"),o=e.parent().find(".text_edit_icon"),u=r.parent().first();n===""&&(n=i18n.commonCore.inlineFieldEdit.editMe),n=n.replace(/<\/?script>/g,""),r.parent().parent().removeClass("isEditing"),r.html(n),r.show(),e.hide(),o.css("display","inline-block"),t("ios")&&document.activeElement.blur(),typeof i=="function"&&i(u,n)}var s=null;n.find(".text_edit_icon").click(function(){o($(this),$(this).parent().find(".text_edit_label"),$(this).parent().find(".text_edit_input"))}),n.find(".text_edit_label").click(function(){o($(this).parent().find(".text_edit_icon"),$(this),$(this).parent().find(".text_edit_input"))}),n.find(".text_edit_input").blur(function(){u($(this))}),t("ios")&&$("body").bind("touchstart",function(e){s&&e.target!=s.get(0)&&u(s)}),n.find(".text_edit_input").keypress(function(e){var t=e.keyCode?e.keyCode:e.which;t=="13"&&u($(this))})}}),define("storymaps/common/ui/header/Desktop",["lib-build/css!./Desktop","../../utils/HeaderHelper","../../builder/InlineFieldEdit","../../utils/CommonHelper","dojo/has","dojo/topic"],function(e,t,n,r,i,s){return function(o,u){function f(){$("#headerDesktop .subtitle:visible").length?$("#headerDesktop .subtitle")[0].focus():$("#headerDesktop .title")[0].focus()}function l(e){o.css("background-color",e.header),o.find(".textArea").css("color",e.headerTitle),o.find(".rightArea").css("color",e.headerText)}function c(e,n){var r=e.compactSize===undefined?n:e.compactSize;t.setLogo(o,e,a.resize),t.setLink(o,e),t.setSocial(o,e),t.initEvents(o,"bottom"),o.toggleClass("compact",r),r&&(o.find(".rightArea").hide(),setTimeout(function(){o.find(".rightArea").show()},0))}function h(e){var t=o.find(".check-story");e=="start"?t.html('<span class="small-loader"></span>'+i18n.viewer.headerFromCommon.checking).css("cursor","default"):e=="error"?t.html(i18n.viewer.headerFromCommon.fix).css("cursor","pointer").click(r.switchToBuilder).show().removeClass("btn-warning").addClass("btn-danger"):t.html(i18n.viewer.headerFromCommon.noerrors).removeClass("btn-warning").addClass("btn-success")}function p(){}function d(e,t){setTimeout(function(){s.publish("HEADER_EDITED",{src:$(e).attr("class").split(" ")[0],value:t}),$(e).removeClass("error")},i("ios")||i("ie")>=10?700:0),app.builder.hideSaveConfirmation()}var a=this;this.init=function(e,t,i,a,f,v,m){l(f);if(e){o.addClass("hideDesktop");return}u&&(o.addClass("isBuilder"),t="<div class='text_edit_label'>"+(t||i18n.commonCore.inlineFieldEdit.editMe)+"</div>",t+="<div class='text_edit_icon' title='"+i18n.commonCore.header.title.replace("%TPL_NAME%",app.cfg.TPL_NAME)+"'></div>",t+="<textarea rows='1' class='text_edit_input form-control' type='text' spellcheck='true'></textarea>",i="<span class='text_edit_label'>"+(i||i18n.commonCore.inlineFieldEdit.editMe)+"</span>",i+="<div class='text_edit_icon' title='"+i18n.commonCore.header.subtitle.replace("%TPL_NAME%",app.cfg.TPL_NAME)+"'></div>",i+="<textarea rows='3' class='text_edit_input form-control' type='text' spellcheck='true'></textarea>"),o.find(".title").html(t),o.find(".subtitle").html(i),u&&new n(o,p,d);if(!u&&!i){var g=a.compactSize===undefined?m:a.compactSize;g||(o.find(".title").css({paddingTop:30,height:90}),o.find(".subtitle").css("height",32).attr("tabindex","-1"))}v&&o.find(".switchBuilder").html('<span class="glyphicon glyphicon-cog"></span>'+i18n.viewer.headerFromCommon.builderButton).click(r.switchToBuilder).show(),!app.isInBuilder&&app.data.userIsAppOwner()&&(o.find(".error-status").addClass("enabled"),s.subscribe("MYSTORIES_SCAN",h)),c(a,m)},this.resize=function(e){e||(e=$(document).width());var t=Math.max(o.find(".logoImg").outerWidth()+50,o.find(".rightArea").outerWidth()+20);o.find(".textArea").width(e-t-15)},this.update=function(e,t,n){l(t),c(e,n)},this.getTitle=function(){return u?o.find(".title .text_edit_label").html():o.find(".title").html()},this.getSubtitle=function(){return u?o.find(".subtitle .text_edit_label").html():o.find(".subtitle").html()},this.setTitleAndSubtitle=function(e,t){e&&app.data.getWebAppData().setTitle(e),t&&app.data.getWebAppData().setSubtitle(t);var n=u?i18n.commonCore.inlineFieldEdit.editMe:"";o.find(".title"+(u?" .text_edit_label":"")).html(e||n),o.find(".subtitle"+(u?" .text_edit_label":"")).html(t||n)},this.toggleSocialBtnAppSharing=function(e){t.toggleSocialBtnAppSharing(o,e)},this.focus=function(e){!e||e.area=="social"?($("#headerDesktop .shareIcon").attr("tabindex","0"),$("#headerDesktop .linkContainer a").length?$("#headerDesktop .linkContainer a").attr("tabindex","0")[0].focus():$("#headerDesktop .linkContainer").length?$("#headerDesktop .linkContainer").attr("tabindex","0")[0].focus():$("#headerDesktop .shareIcon:visible").length?$("#headerDesktop .shareIcon")[0].focus():f()):f()},this.setTitleError=function(){o.find(".title").addClass("error")},this.initLocalization=function(){}}}),define("lib-build/css!storymaps/tpl/core/MainView",[],function(){}),define("storymaps/tpl/core/Config",[],function(){var e="resources/tpl/viewer/icons/esri-logo-white.png",t="http://www.esri.com",n="A story map",r="http://storymaps.arcgis.com";return app.appCfg={supportWebmapPreviewAGOL:!1,useWebmapInApp:!0,useStandardHeader:!0,useAppTitleAsPageTitle:!0,headerCompactOpt:!0,headerCompactByDefault:!1,mapsImmediateResize:!0,mapCommandLargerTouch:!1},{checkConfigFileIsOK:function(){return app.cfg.HEADER_LOGO_URL=e,app.cfg.HEADER_LOGO_TARGET=t,app.cfg.HEADER_LINK_TEXT=n,app.cfg.HEADER_LINK_URL=r,app.cfg&&app.cfg.HEADER_LOGO_URL!==undefined&&app.cfg.HEADER_LOGO_TARGET!==undefined&&app.cfg.HEADER_LINK_TEXT!==undefined&&app.cfg.HEADER_LINK_URL!==undefined&&app.cfg.HEADER_SOCIAL&&app.cfg.TIMEOUT_VIEWER_LOAD&&app.cfg.TIMEOUT_VIEWER_REQUEST&&app.cfg.TIMEOUT_BUILDER_REQUEST&&app.cfg.HELP_URL&&app.cfg.HELP_URL_PORTAL&&app.cfg.TPL_NAME&&app.cfg.WEBAPP_TAG&&app.cfg.WEBAPP_KEYWORD_GENERIC&&app.cfg.WEBAPP_KEYWORD_APP&&app.cfg.AUTHORIZED_IMPORT_SOURCE&&app.cfg.FLICKR_API_KEY&&app.cfg.FACEBOOK_APP_ID&&app.cfg.YOUTUBE_DISABLE_ON_PORTAL!==undefined&&app.cfg.YOUTUBE_API_KEY&&app.cfg.CORS_SERVER&&app.cfg.DEFAULT_SHARING_URL&&app.cfg.DEFAULT_PROXY_URL}}}),define("storymaps/tpl/core/WebApplicationData",["dojo/_base/lang"],function(e){var t={},n={values:{tabs:[]}};return{set:function(r){t=e.clone(r);if(!r||!r.values)return;n=r},get:function(){var t=e.clone(n);return t.values.template=t.values.template||{},t.values.template={name:t.values.template.name||app.cfg.TPL_NAME,createdWith:t.values.template.createdWith||app.version,editedWith:app.version},t},getOriginalData:function(){return t},isBlank:function(){return Object.keys(n.values).length<=2},getBlank:function(){return{values:{webmap:t.values.webmap}}},getSourceWebmap:function(){return t&&t.values?t.values.webmap:null},cleanWebAppAfterInitialization:function(){return!1},restoreOriginalData:function(){this.set(t)},updateAfterSave:function(){t=e.clone(n)},getTemplateVersion:function(){return n.values.template?n.values.template.editedWith:null},getTemplateCreation:function(){return n.values.template?n.values.template.creaedWith:null},getDoNotWarnTitle:function(){return n.values.doNotWarnTitle||!1},setDoNotWarnTitle:function(e){n.values.doNotWarnTitle=e},getWebmap:function(){return n.values.webmap},setWebmap:function(e){n.values.webmap=e},getResponse:function(){return n.values.response},setResponse:function(e){n.values.response=e},getOriginalWebmap:function(){return n.values.originalWebmap},setOriginalWebmap:function(e){n.values.originalWebmap=e},getTitle:function(){return n.values.title},setTitle:function(e){n.values.title=e},getSubtitle:function(){return n.values.subtitle},setSubtitle:function(e){n.values.subtitle=e},getSettings:function(){return n.values.settings||{}},getLayoutId:function(){return"shortlist-classic"},getLayers:function(){return n.values.layers},setLayers:function(e){n.values.layers||(n.values.layers=[]),n.values.layers.push(e)},getShortlistLayerId:function(){return n.values.shortlistLayerId},setShortlistLayerId:function(e){n.values.shortlistLayerId=e},getTabs:function(){return n.values.tabs},setTabs:function(e){n.values.tabs=e},clearLayers:function(){n.values.layers=[]},reverseContentLayers:function(){n.values.contentLayers.reverse()},getSupportLayers:function(){return n.values.supportLayers},setSupportLayers:function(e){n.values.supportLayers||(n.values.supportLayers=[]),n.values.supportLayers.push(e)},getStoryTestPanel:function(){return n.values.testPanel},setStoryTestPanel:function(e){n.values.testPanel=e},getLocateBtn:function(){return!0},getGeneralOptions:function(){var t=e.clone(this.getSettings().generalOptions)||{};return t},setGeneralOptions:function(e){n.values.settings=n.values.settings||{},n.values.settings.generalOptions=e},setDefaultGeneralOptions:function(){this.setGeneralOptions({numberedIcons:!1,mapsSync:!1,filterByExtent:!0,moreInfoLink:!1,moreInfoLinkAlias:"More info"})},getMapOptions:function(){var t=e.clone(this.getSettings().mapOptions)||{};return t},setMapOptions:function(e){n.values.settings=n.values.settings||{},n.values.settings.mapOptions=e},setDefaultMapOptions:function(){this.setMapOptions({locateBtn:!1,geocoder:!1,bookmarks:!1})},getLayoutOptions:function(){var t=e.clone(this.getSettings().layoutOptions)||{};return t},setLayoutOptions:function(e){n.values.settings=n.values.settings||{},n.values.settings.layoutOptions=e},setDefaultLayoutOptions:function(){this.setLayoutOptions({description:!0})},getColors:function(){return{}},getHeader:function(){return this.getSettings().header||{}},setHeader:function(e){n.values.settings=n.values.settings||{},n.values.settings.header=e},getHeaderLinkText:function(){return this.getHeader().linkText===undefined?app.cfg.HEADER_LINK_TEXT:this.getHeader().linkText},getHeaderLinkURL:function(){return this.getHeader().linkURL===undefined?app.cfg.HEADER_LINK_URL:this.getHeader().linkURL},getLogoURL:function(e){var t=this.getHeader().logoURL?this.getHeader().logoURL:app.cfg.HEADER_LOGO_URL;return t==app.cfg.HEADER_LOGO_URL&&this.getColors()&&(e?this.getColors().esriLogoMobile=="white"&&(t="resources/tpl/viewer/icons/esri-logo-white.png"):this.getColors().esriLogo=="white"&&(t="resources/tpl/viewer/icons/esri-logo-white.png")),t},getLogoTarget:function(){return!this.getHeader().logoURL||this.getHeader().logoURL==app.cfg.HEADER_LOGO_URL?app.cfg.HEADER_LOGO_TARGET:this.getHeader().logoTarget},getSocial:function(){return this.getHeader().social},getHeaderCompactSize:function(){return this.getHeader().compactSize}}}),define("storymaps/tpl/core/Data",["./WebApplicationData","storymaps/common/utils/CommonHelper"],function(e,t){return function(){var r=null,i=null,s=null,o=null,u={};this.getWebMap=function(){return r},this.setWebMap=function(e){r=e},this.getShortlistLayerId=function(){return o},this.setShortlistLayerId=function(e){o=e},this.getWebAppItem=function(){return i||{}},this.setWebAppItem=function(e){i=e},this.getResponse=function(){return s},this.setResponse=function(e){s=e},this.getWebAppData=function(){return e},this.updateAfterSave=function(){e.updateAfterSave()},this.userIsAppOwner=function(){return app.portal&&app.portal.getPortalUser()&&app.portal.getPortalUser().username==this.getWebAppItem().owner||t.getPortalUser()!=null&&t.getPortalUser()==this.getWebAppItem().owner},this.userIsOrgaPublisher=function(){var e=app.portal?app.portal.getPortalUser():null;return e&&e.orgId&&(e.role=="org_admin"||e.role=="org_publisher")},this.isOrga=function(){return!app.portal||!app.portal.getPortalUser()?!1:!!app.portal.getPortalUser().orgId},this.debug=function(){},this.getStory=function(){return u},this.setStory=function(e,t,n,r){e in u||(u[e]={title:"",id:e,color:null,extent:null}),t&&(u[e].title=t),n&&(u[e].color=n),r&&(u[e].extent=r)},this.clearStory=function(){u={}},this.getStoryByIndex=function(e){return u[e]},this.getStoryLength=function(){return app.data.getShortlistLayerId()&&app.map.getLayer(app.data.getShortlistLayerId())&&app.map.getLayer(app.data.getShortlistLayerId()).graphics.length?!!app.map.getLayer(app.data.getShortlistLayerId()).graphics.length:!1}}}),define("storymaps/tpl/core/Helper",[],function(){return function(){this.isMobile=function(){var e=navigator.userAgent.match(/Android/i)?!0:!1,t=navigator.userAgent.match(/BlackBerry/i)?!0:!1,n=navigator.userAgent.match(/iPhone|iPad|iPod/i)?!0:!1,r=navigator.userAgent.match(/IEMobile/i)?!0:!1;return e||t||n||r},this.isIE=function(){return navigator.appVersion.indexOf("MSIE")>-1||navigator.userAgent.match(/Trident.*rv\:11\./)},this.isIE8=function(){return parseInt(navigator.userAgent.toLowerCase().split("msie")[1])<9},this.getValueCI=function(e){var t,n;return $.each(this,function(n){if(e.length>1){if(n.toUpperCase()==e[0].toUpperCase()||n.toUpperCase()==e[1].toUpperCase())return t=n,!1}else if(n.toUpperCase()==e[0].toUpperCase())return t=n,!1}),n=this[t],$.trim(n).length===0&&(n=null),n},this.prependURLHTTP=function(e){return!e||e===""||e.match(/^mailto:/)?e:/^(https?:\/\/)|^(\/\/)/i.test(e)?e:"http://"+e}}}),define("lib-build/tpl!storymaps/tpl/ui/desktop/TestPanel",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="userInput"></div>';return __p}}),define("lib-build/css!storymaps/tpl/ui/desktop/TestPanel",[],function(){}),define("lib-build/css!storymaps/tpl/ui/desktop/Common",[],function(){}),define("storymaps/tpl/ui/desktop/TestPanel",["lib-build/tpl!./TestPanel","lib-build/css!./TestPanel","lib-build/css!./Common"],function(e){return function(n,r,i){function s(){n.find(".userInput").attr("contenteditable","true")}function o(){r&&n.find(".userInput").blur(function(){i($(this).html())})}this.init=function(t){t=t||{},n.html(e({})),n.show(),r&&s(),o()},this.update=function(e){e=e||{},n.find(".userInput").html(e.data)},this.resize=function(){},this.showEntryIndex=function(){},this.destroy=function(){}}}),define("lib-build/tpl!storymaps/tpl/ui/desktop/TilePanel",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div id="paneLeft">\r\n	<ul id="myList" class="tilelist"></ul>\r\n	<div class="noFeature">\r\n		<span class="noFeatureText">\r\n			None of these places are in your current map extent.\r\n			Zoom out to see places.\r\n		</span>\r\n	</div>\r\n</div>\r\n';return __p}}),define("lib-build/css!storymaps/tpl/ui/desktop/TilePanel",[],function(){}),define("storymaps/tpl/ui/desktop/TilePanel",["esri/geometry/screenUtils","../../core/Helper","lib-build/tpl!./TilePanel","lib-build/css!./TilePanel","../../core/WebApplicationData"],function(e,t,n,r){return function(r,i,s,o){function l(e){if($("body").hasClass("organizeFeatures"))return;e.which==1||e.which==2||e.which==3?u.tileClick=!0:u.tileClick=!1;var t=$(this).data("shortlist-id");a.preSelection(),a.selected=$.grep(app.layerCurrent.graphics,function(e){return e.attributes.getValueCI(app.cfg.FIELDNAME_ID)==t})[0],a.postSelection(),$("#mobileTitlePage").css("display","none"),a.themeSelected||app.ui.mobileFeatureList.selectTheme(0),a.themeSelected=!0}var u=this,a=i,f=new t;this.tileClick=!0,$(document).bind("cbox_complete",function(){$(".details .rightDiv").height($(".details").height()-$(".detailsTitle").height()-20)}),this.init=function(){$(r).prepend(n({}))},this.resize=function(e){$("#paneLeft").width(e),$(".tilelist").width(e)},this.createTab=function(e,t){$("#tabs").append('<div class="tab" tabindex="0">'+t.title+"</div>")},this.setTabClick=function(){$.each($(".entry"),function(e){$(this).click(function(){a.selected=null,a.activateLayer(e),$(".detailContainer").hide(),app.mapTips&&app.mapTips.clean()})})},this.clearTilePanel=function(){$("#myList").empty()},this.buildTilePanel=function(){u.clearTilePanel();var e,t,n,r,i,o,a=!1;if(!app.layerCurrent||!app.layerCurrent.graphics)return;app.layerCurrent.graphics.sort(function(e,t){return parseInt(e.attributes.number)-parseInt(t.attributes.number)}),$.each(app.layerCurrent.graphics,function(u,f){app.map.extent.contains(f.geometry)?(e="block",a=!0):app.data.getWebAppData().getGeneralOptions().filterByExtent&&!app.isInBuilder&&(e="none"),t=$('<li tabindex="0" id="item'+f.attributes.getValueCI(app.cfg.FIELDNAME_ID)+'" style="display:'+e+'">'),n=$('<div class="tileImage"></div>'),f.attributes.getValueCI(app.cfg.FIELDNAME_THUMBURL)?$(n).css("background-image","url("+f.attributes.getValueCI(app.cfg.FIELDNAME_THUMBURL)+")"):$(n).css("background-image","url("+f.attributes.getValueCI(app.cfg.FIELDNAME_IMAGEURL)+")"),r=$('<div class="footer"></div>');var l=f.attributes.getValueCI(app.cfg.FIELDNAME_TITLE)||"Place Name";o=$('<div class="blurb">'+l+"</div>"),s.getMapOptions().numberedIcons&&(f.attributes.getValueCI(app.cfg.FIELDNAME_NUMBER)<100?i=$('<div class="num" style="background-color:'+app.layerCurrent.color+'">'+f.attributes.getValueCI(app.cfg.FIELDNAME_NUMBER)+"</div>"):(i=$('<div class="num longNum" style="background-color:'+app.layerCurrent.color+'">'+f.attributes.getValueCI(app.cfg.FIELDNAME_NUMBER)+"</div>"),o=$('<div class="blurb longNumBlurb">'+f.attributes.getValueCI(app.cfg.FIELDNAME_TITLE)+"</div>")),$(r).append(i)),$(r).append(o),$(t).append(r),$(t).data("shortlist-id",f.attributes.getValueCI(app.cfg.FIELDNAME_ID)),app.ui.mobileFeatureList.buildList(u,f,t),$(t).append(n),app.isInBuilder&&(f.attributes.locationSet?$(t).addClass("located"):$(t).find(".tileImage").append('<div class="unlocated" style="outline: none;"></div>')),$("#myList").append(t)}),u.setTileEvents(),$("ul.tilelist").animate({scrollTop:0},{duration:200}),!a&&app.data.getWebAppData().getGeneralOptions().filterByExtent&&!app.isInBuilder?$(".noFeature").css("display","block"):$(".noFeature").css("display","none"),s.getMapOptions().numberedIcons||$("ul.tilelist .blurb").addClass("unNumBlurb")},this.findTile=function(e){return $.grep($(r).find($("ul.tilelist li")),function(t){return t.id=="item"+e})[0]},this.findMobileTile=function(e){return $.grep($("ul.mobileTileList li"),function(t){return t.id=="item"+e})[0]},this.setTileEvents=function(){console.log("SET TILE EVENTS"),$("ul.tilelist li").mouseover(u.tile_onMouseOver),$("ul.tilelist li").mouseout(u.tile_onMouseOut),$("ul.tilelist li").click(l),$("#mobilePaneList ul.mobileTileList li").on("tap",l),$("#mobilePaneList ul.mobileTileList li").on("click",l)},this.refreshList=function(){var e,t,n=!1;app.layerCurrent&&app.layerCurrent.graphics.length&&setTimeout(function(){$.each(app.layerCurrent.graphics,function(r,i){e=u.findTile(i.attributes.getValueCI(app.cfg.FIELDNAME_ID)),t=u.findMobileTile(i.attributes.getValueCI(app.cfg.FIELDNAME_ID)),app.data.getWebAppData().getGeneralOptions().filterByExtent&&!app.isInBuilder&&(app.map.extent.contains(i.geometry)?($(e).css("display")=="none"&&$(e).stop().fadeIn(),n=!0):$(e).css("display")!="none"&&$(e).stop().fadeOut(1e3))}),!n&&app.data.getWebAppData().getGeneralOptions().filterByExtent&&!app.isInBuilder?$(".noFeature").css("display","block"):$(".noFeature").css("display","none")},100)},this.initSortable=function(){$("#myList").sortable({update:function(){app.addFeatureBar.updateNumber()}}),$("#myList").addClass("organize")},this.destroySortable=function(){$("#myList").sortable("destroy"),$("#myList").css("background-color","#C7C7C7"),$("body").removeClass("organizeFeatures"),$("#myList").removeClass("organize")},this.tile_onMouseOver=function(){var e=this,t=$.grep(app.layerCurrent.graphics,function(t){return t.attributes.getValueCI(app.cfg.FIELDNAME_ID)==$(e).data("shortlist-id")});t[0].symbol.setWidth(app.cfg.lutIconSpecs.medium.getWidth()),t[0].symbol.setHeight(app.cfg.lutIconSpecs.medium.getHeight()),t[0].symbol.setOffset(app.cfg.lutIconSpecs.medium.getOffsetX(),app.cfg.lutIconSpecs.medium.getOffsetY()),t[0].draw(),f.isIE()||a.moveGraphicToFront(t[0]),a.buildMapHoverTips(t[0].attributes.getValueCI(app.cfg.FIELDNAME_TITLE),t[0])},this.tile_onMouseOut=function(){if(a.selected!=null){var e=parseInt($(this).attr("id").substring(4));if(a.selected.attributes.getValueCI(app.cfg.FIELDNAME_ID)==e)return}var t=this,n=$.grep(app.layerCurrent.graphics,function(e){return e.attributes.getValueCI(app.cfg.FIELDNAME_ID)==$(t).data("shortlist-id")});n[0].symbol.setWidth(app.cfg.lutIconSpecs.tiny.getWidth()),n[0].symbol.setHeight(app.cfg.lutIconSpecs.tiny.getHeight()),n[0].symbol.setOffset(app.cfg.lutIconSpecs.tiny.getOffsetX(),app.cfg.lutIconSpecs.tiny.getOffsetY()),n[0].draw(),app.mapTips&&app.mapTips.clean(!0)}}}),define("lib-build/tpl!storymaps/tpl/ui/desktop/DetailPanel",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="detailContainer swiper-container">\r\n	<button type="button" class=\'detailClose ion-android-close\' style=""></button>\r\n	<div class="detail-btn-container detail-btn-left">\r\n		<div class="detail-btn ion-chevron-left" style="outline: none;"></div>\r\n	</div>\r\n	<div class="detail-btn-container detail-btn-right">\r\n		<div class="detail-btn ion-chevron-right" style="outline: none;"></div>\r\n	</div>\r\n	<div class="detailView swiper-wrapper"></div>\r\n</div>\r\n';return __p}}),define("lib-build/css!storymaps/tpl/ui/desktop/DetailPanel",[],function(){}),define("storymaps/tpl/ui/desktop/DetailPanel",["../../core/Helper","lib-build/tpl!./DetailPanel","lib-build/css!./DetailPanel"],function(e,t){return function(r,i,s,o,u){function y(){var e=$(".entry.active").index();e<0&&(e=0),setTimeout(function(){$(".detailContainer").show(),d[e].slideNext(),d[e].slidePrev(),l.resize(),$(".detailContainer").hide()},0)}function b(){r.find(".userInput").attr("contenteditable","true")}function w(){i&&r.find(".userInput").blur(function(){s($(this).html())})}var a=o,f,l=this,c=new e,h=0,p=!1,d=[],v={},m=!1,g=u;l.loaded=!1,l.viewed=!1,this.init=function(e){e=e||{},$(r).show(),i&&b(),w()},this.buildFeatureViews=function(){var e=$(".entry.active").index();e<0&&(e=0);var n=[],i=app.map.getLayer(app.data.getShortlistLayerId());$.each(i.graphics,function(e,t){t.attributes.getValueCI=c.getValueCI;if(!n[t.attributes.tab_id]){var r={title:"tab "+(n.length+1),features:[]};n.push(r)}t.attributes.locationSet&&n[t.attributes.tab_id].features.push(t)}),p||$.each(n,function(e){if(e===0)$(r).prepend(t({}));else{var n=$(r).find(" .detailContainer")[e-1];$(n).after(t({}))}var i=$(".detailView")[e];$(i).attr("id","detailView"+e),d[e]={},v[String(e)]=[]}),p=!0;if(v[String(e)].length)return;$(".detailContainer").css("z-index","0");var s=$(".detailContainer")[e];$(s).css("z-index","99"),h=0,l.buildSlides(n)},this.buildSlides=function(e){l.loaded=!1,f=e;var t=$(".entry.active").index();t<0&&(t=0);var n=f[t],i=n.features,s=app.cfg.COLOR_ORDER.split(","),o=$("<div></div");for(;h<i.length;h++){var u=i[h].attributes;u.getValueCI||(u.getValueCI=c.getValueCI);var p=u.getValueCI(app.cfg.FIELDNAME_TITLE),b=u.getValueCI(app.cfg.FIELDNAME_SHORTDESC),w=u.getValueCI(app.cfg.FIELDNAME_IMAGEURL),E=c.prependURLHTTP(u.getValueCI(app.cfg.FIELDNAME_WEBSITE)),S=$("<div class='swiper-slide'></div>"),x,T=$("<div class='detailHeader'></div>");if(g.getMapOptions().numberedIcons){var N=$('<div class="detailFeatureNum" style="background-color:'+app.layerCurrent.color+'">'+u.getValueCI(app.cfg.FIELDNAME_NUMBER)+"</div>");$(T).append(N)}else $(".detailFeatureTitle").addClass("notNumbered");p&&$(T).append($("<div class='detailFeatureTitle'></div>").html(p)),$(S).append(T);var C=$('<div class="detailTextContainer"</div>');w&&(x=$("<div></div>").addClass("detailPictureDiv"),$(x).append("<img data-src="+w+' class="swiper-lazy"/>'),$(C).append(x)),b&&$(C).append($("<div class='detailFeatureSubtitle'></div>").html(b));if(!app.cfg.DETAILS_PANEL){var k=u.getValueCI(app.cfg.FIELDNAME_DESC1);k&&$(C).append($("<div class='detailFeatureDesc'></div>").html(k)),E&&$(C).append($('<div class="detailFeatureDesc website"><a class="website" href="'+E+'" target="_blank">'+app.data.getWebAppData().getGeneralOptions().moreInfoLinkAlias+"</a></div>").css("padding-top",10))}else{var L=[app.cfg.FIELDNAME_DESC1,app.cfg.FIELDNAME_DESC2,app.cfg.FIELDNAME_DESC3,app.cfg.FIELDNAME_DESC4,app.cfg.FIELDNAME_DESC5],A;$.each(L,function(e,t){A=u.getValueCI(t),A&&($(C).append('<div class="detailFeatureDesc">'+A+"</div>"),$(C).children().length>0)});var O=u.getValueCI(app.cfg.FIELDNAME_ADDRESS);O&&$(C).append($('<div class="detailFeatureAddress">'+O+"</div>"));var M=u.getValueCI(app.cfg.FIELDNAME_HOURS);M&&$(C).append($('<div class="detailFeatureAddress">'+M+"</div>")),E&&($(C).append('<div class="detailFeatureAddress"><a class="website" href="'+E+'" target="_blank">'+app.data.getWebAppData().getGeneralOptions().moreInfoLinkAlias+"</a></div>"),$(".website").show()),$(C).append('<div style="margin-bottom: 20px;"></div>')}$(S).append(C),$(S).data("shortlist-id",u.getValueCI(app.cfg.FIELDNAME_NUMBER)),$("#detailView"+t).append(S),v[String(t)].push(S);if(h%10===0&&h+1<i.length)return setTimeout(function(){h++,l.buildSlides(e)},0),!1;if(h+1==i.length){var _=new Swiper($(".detailContainer")[t],{speed:0,setWrapperSize:!0,lazyLoading:!0,lazyLoadingInPrevNext:!0});d[t]=_,_.init(),_.update(),_.on("onSlideChangeEnd",function(e){m||a.preSelection();var t=$(".entry.active").index();t<0&&(t=0);if(l.viewed){var n=_.slides[_.activeIndex],r=$(n).data("shortlist-id"),i=$.grep(app.layerCurrent.graphics,function(e){return e.attributes.getValueCI(app.cfg.FIELDNAME_ID)==r})[0];a.selected=i,(!app.map.extent.contains(a.selected.geometry)&&!app.data.getWebAppData().getGeneralOptions().filterByExtent||app.isInBuilder)&&app.map.centerAt(a.selected.geometry)}var s=!0;setTimeout(function(){a.buildMapTips()},0);if($(".showOnce").length){var o=$(".showOnce")[0];$(o).hasClass("swiper-slide-active")||($(".swiper-slide").removeClass("showOnce"),d[t].removeSlide(d[t].previousIndex),d[t].update())}d[t].slides.length==1?$(".detail-btn-container").hide():$(".detail-btn-container").show(),l.resize(),_.update()}),r.find(".detail-btn-left").mouseover(function(){$(".detail-btn-left").css("opacity",1),$(".detail-btn-right").css("opacity",.8)}),r.find(".detail-btn-right").mouseover(function(){$(".detail-btn-right").css("opacity",1),$(".detail-btn-left").css("opacity",.8)}),r.find(".detail-btn-left").mouseout(function(){$(".detail-btn-left").css("opacity",.8)}),r.find(".detail-btn-right").mouseout(function(){$(".detail-btn-right").css("opacity",.8)}),r.find(".detailClose").click(function(){r.find(".detailContainer").hide(),app.ui.mobileIntro.screenSize=="small"&&app.ui.mobileFeatureList.showMobileList(),a.unselect()}),r.find($(".detail-btn-left")[t]).click(function(){d[t].activeIndex===0?d[t].slideTo(d[t].slides.length-1,0):d[t].slidePrev()}),r.find($(".detail-btn-right")[t]).click(function(){d[t].activeIndex==d[t].slides.length-1?d[t].slideTo(0,0):d[t].slideNext()});var D=$.grep(app.cfg.COLOR_SCHEMES,function(e){return e.name==s[t]});$(".detailHeader").css("border-top-color",D[0].color),r.find(".detailPictureDiv img").click(function(){d[t].activeIndex==d[t].slides.length-1?d[t].slideTo(0,0):d[t].slideNext()}),l.refreshSlides(),d[t].update(),y(),l.resize()}}l.loaded=!0,l.viewed=!1},this.showDetails=function(e){l.resize();if(e==null)return;var t=$(".entry.active").index();t<0&&(t=0);var n=$(".detailContainer")[t];$(n).show(),$("#mobilePaneList").css("visibility","hidden");var r;$.each($("#detailView"+t).find($(".swiper-slide")),function(t,n){parseInt($(n).data("shortlist-id"))==e.attributes.getValueCI(app.cfg.FIELDNAME_NUMBER)&&(r=t)}),g.getMapOptions().numberedIcons||$(".detailFeatureTitle").addClass("notNumbered"),r>-1&&setTimeout(function(){d[t].slideTo(r,0),$(n).css("z-index",99)},0),d[t].slides.length==1?$(".detail-btn-container").hide():$(".detail-btn-container").show(),d[t].update();if($(".swiper-slide-active img").width()==0){var i=$(".swiper-slide-active img")[0],s=$(i).attr("data-src");$(i).attr("src",s)}l.viewed=!0},this.refreshSlides=function(){m=!0;if(!app.data.getWebAppData().getGeneralOptions().filterByExtent&&!app.isInBuilder)return;var e=$(".entry.active").index();e<0&&(e=0),$(".detailContainer").css("z-index","0");var t=$(".detailContainer")[e];$(t).css("z-index","99");if(!f)return;var n=f[e],r=n.graphics,i=null;d[e].removeAllSlides(),$.each(r,function(t,n){app.map.extent.contains(n.geometry)&&$.each(v[String(e)],function(t,r){parseInt($(r).data("shortlist-id"))==n.attributes.getValueCI(app.cfg.FIELDNAME_NUMBER)&&(d[e].appendSlide($(r)[0]),a.selected&&parseInt($(r).data("shortlist-id"))==a.selected.attributes.getValueCI(app.cfg.FIELDNAME_NUMBER)&&(i=parseInt(t)))}),a.selected&&!app.map.extent.contains(a.selected.geometry)&&$.each(v[String(e)],function(t,n){parseInt($(n).data("shortlist-id"))==a.selected.attributes.getValueCI(app.cfg.FIELDNAME_NUMBER)&&(d[e].appendSlide($(n)[0]),$(n).addClass("showOnce"))})}),a.selected&&$.each($("#detailView"+e).find($(".swiper-slide")),function(e,t){parseInt($(t).data("shortlist-id"))==a.selected.attributes.getValueCI(app.cfg.FIELDNAME_NUMBER)&&(i=parseInt(e))}),d[e].update(),i!=null&&d[e].slideTo(i,0),d[e].slides.length==1?$(".detail-btn-container").hide():$(".detail-btn-container").show(),m=!1},this.update=function(e){e=e||{},r.find(".detailContainer").html(e.data)},this.resize=function(){setTimeout(function(){var e=35;app.ui.mobileIntro.screenSize=="small"&&($("#paneLeft").css("height",$("#contentPanel").height()-$("#map").height()+10),$("#paneLeft").css("width","100%"),$("#paneLeft").css({top:$("#map").height()-10}),e=20);var t=$(".entry.active").index();t<0&&(t=0);if(!$.isEmptyObject(d[t]))var n=d[t],r=n.slides[n.activeIndex];$(r).height($("#paneLeft").outerHeight()-5);var i=$(r).find(".detailHeader").outerHeight();$(".detailTextContainer").css({"margin-top":"10px"}),$(".detailTextContainer").height($("#paneLeft").outerHeight()-i-e+"px"),$(".detailPictureDiv img").css("max-width",$("#paneLeft").outerWidth());var s=$("#paneLeft").outerHeight()-i-60<$("#paneLeft").outerHeight()*.6?$("#paneLeft").outerHeight()-i-60:$("#paneLeft").outerHeight()*.6;$(".detailPictureDiv img").css("max-height",parseInt(s)+"px"),$(".detailContainer").width($("#paneLeft").outerWidth()),$(".detailContainer").height($("#paneLeft").outerHeight())},0)},this.showEntryIndex=function(){},this.destroy=function(){}}}),define("lib-build/tpl!storymaps/tpl/ui/desktop/NavBar",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="nav-bar">\r\n	<div class="entries">\r\n		<ul class="nav nav-tabs">\r\n			<!--\r\n				tabs and the more button are injected here\r\n			-->\r\n		</ul>\r\n	</div>\r\n	<div class="builder-content-panel inline">\r\n		<span class="builder-content-panel-group builder-edit btn btn-sm btn-default">\r\n			<div class="builder-btn"></div>\r\n			<div class="builder-lbl"></div>\r\n		</span>\r\n\r\n		<span class="builder-content-panel-group builder-add btn btn-sm btn-default">\r\n			<div class="builder-btn"></div>\r\n			<div class="builder-lbl"></div>\r\n		</span>\r\n		<span class="builder-content-panel-group builder-organize btn btn-sm btn-default">\r\n			<div class="builder-btn"></div>\r\n			<div class="builder-lbl"></div>\r\n		</span>\r\n	</div>\r\n	<div class="builder-mask"></div>\r\n	<div id="bookmarksCon">\r\n		<div id="bookmarksButton"></div>\r\n		<div id="bookmarksToggle"> <!--tabindex="0"-->\r\n			<span id="bookmarksTogText"></span>\r\n		</div>\r\n		<div id="bookmarksDiv"></div>\r\n	</div>\r\n</div>\r\n';return __p}}),define("lib-build/css!storymaps/tpl/ui/desktop/NavBar",[],function(){}),define("lib-build/tpl!storymaps/tpl/ui/desktop/NavBarEntry",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<li class="entry '+((__t=optHtmlClass)==null?"":__t)+'" data-title="'+((__t=tooltip)==null?"":__t)+'">\r\n	<a class="entryLbl" tabindex="0">'+((__t=value)==null?"":__t)+"</a>\r\n</li>\r\n";return __p}}),define("lib-build/tpl!storymaps/tpl/ui/desktop/NavBarEntryMore",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<li class="dropdown pull-right"> <!-- tabindex="0" -->\r\n	<a class="dropdown-toggle" data-toggle="dropdown">\r\n		<span class="glyphicon glyphicon-th-list"></span> <span class="caret"></span>\r\n	</a>\r\n	<ul class="dropdown-menu">\r\n		<!--\r\n			tabs are injected here a second time\r\n			that way they are just toggled and not moved around\r\n		-->\r\n		'+((__t=entries)==null?"":__t)+"\r\n	</ul>\r\n</li>\r\n";return __p}}),define("storymaps/tpl/ui/desktop/NavBar",["lib-build/tpl!./NavBar","lib-build/css!./NavBar","lib-build/tpl!./NavBarEntry","lib-build/tpl!./NavBarEntryMore","storymaps/common/utils/CommonHelper","dojo/topic","dojo/has"],function(e,t,n,r,i,s,o){return function(o,u,a){function p(e,t){l=l||[],d(e),$(".nav-bar").addClass("isTab");var i=l.length,u="";$.each(l,function(e,t){var r=t.title;u+=n({value:r,tooltip:"",optHtmlClass:""})}),o.find(".nav-tabs").html(u+r({entries:u})),o.find(".entry").click(v),o.find(".entryLbl").on("keydown",function(e){if(e.keyCode===9)return s.publish("story-tab-navigation",{from:"nav",direction:e.shiftKey?"backward":"forward"}),!1}),o.find(".entryLbl").eq(0).focus(function(){!$(this).data("mouseDown")&&!$(this).parent(".entry").hasClass("active")&&$(this).parent(".entry").click()}).mousedown(function(){$(this).data("mouseDown",!0)}).mouseup(function(){$(this).removeData("mouseDown")}),$("#nav-bar").show(),app.isInBuilder&&app.addFeatureBar.updateLocatedFeatures(t),f.resize()}function d(e){o.css("background-color",e.header),i.addCSSRule(".nav-bar .nav > .entry .entryLbl, 					.nav-bar .dropdown-toggle { 						color: "+e.tabText+"; 						background-color: "+e.tab+" !important; 					}","NavBarTab"),i.addCSSRule(".nav-bar .entry.active > .entryLbl, 					.nav-bar .dropdown.active .dropdown-toggle { 						color: "+e.tabTextActive+"; 						background-color: "+e.tabActive+" !important; 					}","NavBarActive"),i.addCSSRule(".nav-bar .dropdown:not(.active):hover .dropdown-toggle, 					.nav-bar li:not(.active) .entryLbl:hover { 						color: "+e.tabTextHover+"; 						background-color: "+e.tabHover+" !important; 					}","NavBarHover"),i.addCSSRule(".nav-bar .dropdown-menu, 					.nav-bar .dropdown-menu .entryLbl { 						color: "+e.tabText+" !important; 						background-color: "+e.header+" !important; 					}","NavBarMore")}function v(){if($("body").hasClass("organizeFeatures"))return;var e=$(this).index();a(e),app.isInBuilder&&(app.addFeatureBar.updateLocatedFeatures(),app.addFeatureBar.exitOrganizeMode())}function m(){o.find(".builder-content-panel").css("display","inline-block"),o.find(".builder-edit").off("click").click(g).find(".builder-lbl").html("Edit Tab"),o.find(".builder-add").off("click").click(f.onClickAdd).find(".builder-lbl").html("Add tab")}function g(){if($("body").hasClass("organizeFeatures"))return;app.builder.openEditPopup({entryIndex:f.getEntryIndex()})}function y(e,t,n){return e.hasOwnProperty(t)&&e[t]===n}function b(){}var f=this,l=null,c=null,h=null;o.html(e({})),this.init=function(e,t,n,r){l=e,c=null,h=r,p(n,t),this.showEntryIndex(t),b(),u&&m()},this.update=function(e){p(e),this.showEntryIndex(c)},this.resize=function(){o.find(".nav-tabs > li").addClass("visible"),o.find(".nav-tabs .dropdown").removeClass("visible"),o.find(".nav-tabs .dropdown-menu li").removeClass("visible");var e=0,t=0,n=!1,r=o.find(".nav-tabs > li:not(.dropdown)"),i=o.find("li.dropdown").outerWidth(),s=o.width()-o.find(".builder-content-panel:visible").outerWidth()-30-4;r.each(function(){t++,e+=$(this).outerWidth();if(e>s||e+i>s&&t<r.length)n=!0,$(this).removeClass("visible"),o.find(".nav-tabs .dropdown-menu li").eq($(this).index()).addClass("visible")});var u=o.find(".nav-tabs > .entry.active"),a=o.find(".nav-tabs .dropdown-menu li.active");u.length&&!u.hasClass("visible")?(u.removeClass("active"),o.find(".nav-tabs .dropdown-menu li").eq(u.index()).addClass("active"),o.find(".nav-tabs > .dropdown").addClass("active")):a.length&&!a.hasClass("visible")&&(a.removeClass("active"),o.find(".nav-tabs > .entry").eq(a.index()).addClass("active"),o.find(".nav-tabs > .dropdown").removeClass("active")),n&&o.find(".nav-tabs .dropdown").addClass("visible")},this.showEntryIndex=function(e){var t=o.find(".nav-tabs > .entry.visible").length;o.find("li").removeClass("active"),e<t?(o.find(".entry").eq(e).addClass("active"),app.isLoading||(o.find(".entry").eq(e).find(".entryLbl").focus(),o.find(".dropdown").hasClass("open")&&o.find(".dropdown-toggle").click())):(o.find(".dropdown").addClass("active"),o.find(".dropdown .entry").eq(e).addClass("active"),app.isLoading||(o.find(".dropdown").hasClass("open")||o.find(".dropdown-toggle").click(),o.find(".dropdown .entry").eq(e).focus())),app.isInBuilder&&setTimeout(function(){f.resize()},50),c=e},this.getEntryIndex=function(){return c},this.destroy=function(){o.hide()},this.initBookmarks=function(){app.data.getResponse().itemInfo.itemData.bookmarks&&(app.cfg.BOOKMARKS=!0,$("#bookmarksCon").show(),$("#bookmarksTogText").html(app.cfg.BOOKMARKS_ALIAS+" &#x25BC;"),$("#mobileBookmarksTogText").html(app.cfg.BOOKMARKS_ALIAS+" &#x25BC;"),$("#bookmarksToggle").addClass("closed"),$("#mobileBookmarksToggle").addClass("closed"),$("#bookmarksToggle").click(function(){$("#bookmarksDiv").css("display")=="none"?($("#bookmarksTogText").html(app.cfg.BOOKMARKS_ALIAS+" &#x25B2;"),$("#bookmarksDiv").css("display","inline-block"),$("#bookmarksToggle").removeClass("closed"),$("#bookmarksToggle").addClass("open")):($("#bookmarksTogText").html(app.cfg.BOOKMARKS_ALIAS+" &#x25BC;"),$("#bookmarksDiv").css("display","none"),$("#bookmarksToggle").removeClass("open"),$("#bookmarksToggle").addClass("closed")),$("#mobileBookmarksTogText").html(app.cfg.BOOKMARKS_ALIAS+" &#x25BC;")}),$("#mobileBookmarksToggle").click(function(){$("#mobileBookmarksDiv").css("display")=="none"?($("#mobileBookmarksDiv").css("display","inline-block"),$("#mobileBookmarksTogText").html(app.cfg.BOOKMARKS_ALIAS+" &#x25B2;"),$("#mobileBookmarksToggle").removeClass("closed"),$("#mobileBookmarksToggle").addClass("open")):($("#mobileBookmarksDiv").css("display","none"),$("#mobileBookmarksTogText").html(app.cfg.BOOKMARKS_ALIAS+" &#x25BC;"),$("#mobileBookmarksToggle").removeClass("open"),$("#mobileBookmarksToggle").addClass("closed"))}),$.each(app.data.getResponse().itemInfo.itemData.bookmarks,function(e,t){$("#bookmarksDiv").append("<p><a tabindex='0'>"+t.name+"</a></p>"),$("#mobileBookmarksDiv").append("<p><a>"+t.name+"</a></p>")}),$("#bookmarksDiv a").click(function(){var e=$(this).html(),t=new esri.geometry.Extent($.grep(app.data.getResponse().itemInfo.itemData.bookmarks,function(t){return t.name==e})[0].extent);app.map.setExtent(t),$("#bookmarksTogText").html(app.cfg.BOOKMARKS_ALIAS+" &#x25BC;"),$("#bookmarksDiv").css("display","none"),$("#bookmarksToggle").removeClass("open"),$("#bookmarksToggle").addClass("closed")}),$("#mobileBookmarksDiv a").click(function(){var e=$(this).html(),t=new esri.geometry.Extent($.grep(app.data.getResponse().itemInfo.itemData.bookmarks,function(t){return t.name==e})[0].extent);app.map.setExtent(t),$("#mobileBookmarksTogText").html(app.cfg.BOOKMARKS_ALIAS+" &#x25BC;"),$("#mobileBookmarksToggle").removeClass("open"),$("#mobileBookmarksToggle").addClass("closed"),$("#mobileBookmarksDiv").css("display","none")}))},this.onClickAdd=function(e){if($("body").hasClass("organizeFeatures"))return;app.detailPanelBuilder.hideSearch();var t=o.find(".nav-tabs .entry.visible").length,n={id:t,title:e?e:"Tab "+(t+1),features:[]};y(l,"id",t)||(l[t]=n);var r=app.cfg.COLOR_ORDER.split(","),i=$.grep(app.cfg.COLOR_SCHEMES,function(e){return e.name==r[t]});n.color=i,$("#paneLeft").css("border-top-color",i[0].color),app.ui.tilePanel.clearTilePanel();var u={header:"#444",tabText:"#d8d8d8",tab:"#666",tabTextActive:"#fff",tabActive:i[0].color,tabTextHover:"#fff",tabHover:"#666"};app.migration&&app.data.getStory()[0].title&&(l[0].title=app.data.getStory()[0].title),f.init(l,o.find(".nav-tabs .entry.visible").length,u,h);var c=app.map.getLayer(app.data.getShortlistLayerId());$.each(c.graphics,function(e,t){t.hide()});var p=new esri.layers.GraphicsLayer,d=i[0].color;p.color=d,app.layerCurrent=p,app.detailPanelBuilder.addDetailPanelSwiper(t),app.addFeatureBar.exitOrganizeMode();var v=h.getMapOptions().mapsSync?app.data.getStory()[0].extent:null;app.data.setStory(t,n.title,d,v),a(t),h.getTitle()&&s.publish("INCREMENT_SAVE_COUNTER")}}}),define("storymaps/tpl/ui/desktop/MultiTips",["dojo/dom-style","dojo/dom-construct","dojo/_base/lang","dojo/on","dojo/_base/array","dojo/query","dojo/dom","dojo/has"],function(e,t,n,r,i,s,o,u){return function(f){function p(e){l=n.mixin({pointArray:[],map:null,attributeLabelField:"",content:"",selected:!1,zoomToPoints:!1,backgroundColor:"#000000",borderColor:"#000000",pointerColor:"#000000",textColor:"#ffffff",minWidth:"",labelDirection:"auto",offsetTop:8,offsetSide:3,offsetBottom:8,mapAuthorizedMinWidth:-1,mapAuthorizedWidth:-1,mapAuthorizedHeight:-1,visible:!0},e),e.mapAuthorizedWidth==-1&&(l.mapAuthorizedWidth=l.map.width),e.mapAuthorizedHeight==-1&&(l.mapAuthorizedHeight=l.map.height),d(e.map.container)}function d(n,o){v();var u=r(l.map,"zoom-start",function(){y()}),a=r(l.map,"zoom-end",function(e){c||m(e.extent,!0)}),f=r(l.map,"pan",function(e){if(!e||!e.delta.x&&!e.delta.y)return;c||g(e.extent,e.delta)}),p=r(l.map,"extent-change",function(e){if(e&&e.delta&&e.delta.x===0&&e.delta.y===0)return;c||m(e.extent,!0)});o&&(l.visible=!0),l.selected&&(l.pointArray.push(l.selected),l.pointArray.reverse(),l.selected.geometry.x==l.pointArray[1].geometry.x&&l.selected.geometry.y==l.pointArray[1].geometry.y&&l.pointArray.splice(1,1)),i.forEach(l.pointArray,function(r,i){t.place("<div id='arrow"+i+"' class='mtArrow'></div><div id='multiTip"+i+"' class='multiTip'></div>",n,"last"),s("#multiTip"+i)[0].innerHTML=i===0&&l.selected?l.selected.attributes.getValueCI(app.cfg.FIELDNAME_TITLE):l.content;var o=$("#multiTip"+i),u=$("#arrow"+i);i===0&&l.selected?$(o).addClass("selected"):null,i===0&&l.selected?$(u).addClass("selected"):null,e.set("multiTip"+i,{backgroundColor:i===0&&l.selected?app.cfg.SELECTED_POPUP_BACKGROUND_COLOR:l.backgroundColor,borderColor:i===0&&l.selected?app.cfg.SELECTED_POPUP_BORDER_COLOR:l.borderColor,color:l.textColor,padding:"5px",position:"absolute"}),l.minWidth&&e.set("multiTip"+i,"minWidth",l.minWidth+"px"),e.set("arrow"+i,{pointerColor:i===0&&l.selected?app.cfg.SELECTED_POPUP_ARROW_COLOR:l.pointerColor,position:"absolute",width:"0px",height:"0px"});if(l.map.extent.contains(r.geometry)){var a=l.map.toScreen(r.geometry);E(a,i,l)}}),h=[u,a,f,p]}function v(e){c=!1,i.forEach(h,function(e){e.remove()}),e?(s(".multiTip").forEach(function(e){$(e).remove()}),s(".mtArrow").forEach(function(e){$(e).remove()}),c=!0):(s(".multiTip").forEach(function(e){$(e).hasClass("selected")||$(e).remove()}),s(".mtArrow").forEach(function(e){$(e).hasClass("selected")||$(e).remove()}))}function m(e,t){i.forEach(l.pointArray,function(n,r){e.contains(n.geometry)&&(w(r)||t)?E(l.map.toScreen(n.geometry),r,l):b(r)})}function g(e,t){i.forEach(l.pointArray,function(n,r){if(e.contains(n.geometry)){var i=l.map.toScreen(n.geometry);i.x+=t.x,i.y+=t.y,E(i,r,l)}else b(r)})}function y(){s(".multiTip, .mtArrow").forEach(function(e){$(e).hasClass("selected")||(e.style.display="none")})}function b(t){if(!o.byId("multiTip"+t))return;if(e.get(o.byId("multiTip"+t),"display")=="none")return;e.set(o.byId("multiTip"+t),"display","none"),e.set(o.byId("arrow"+t),"display","none")}function w(t){if(o.byId("multiTip"+t))return e.get(o.byId("multiTip"+t),"display")=="block"}function E(t,n,r){if(!o.byId("multiTip"+n))return;if(t.x>r.mapAuthorizedWidth||t.y>r.mapAuthorizedHeight){b(n);return}var i=n===0&&r.selected?44:r.offsetTop;if(u("ie")>0||/Trident\/7\./.test(navigator.userAgent))i+=10;var s=e.get("multiTip"+n,"width"),a=e.get("multiTip"+n,"height");u("ie")==8&&(s-=7,a-=14);if(!s||!a)e.set(o.byId("multiTip"+n),"display",r.visible?"block":"none"),e.set(o.byId("arrow"+n),"display",r.visible?"block":"none"),s=e.get("multiTip"+n,"width"),a=e.get("multiTip"+n,"height");r.minWidth&&s<r.minWidth&&(s=r.minWidth);if(r.labelDirection!="auto")r.labelDirection=="left"?N(t,n,r,s,a):r.labelDirection=="right"?T(t,n,r,s,a):r.labelDirection=="down"?S(t,n,r,s,a):x(t,n,r,s,a,i);else if(t.x<s/2+25+r.offsetSide+r.topLeftNotAuthorizedArea[0]&&t.y<r.topLeftNotAuthorizedArea[1]+a){if(t.y<a-15||t.x<35+r.topLeftNotAuthorizedArea[0]&&t.y<r.topLeftNotAuthorizedArea[1]){b(n);return}T(t,n,r,s,a)}else if(t.x<s/2+25+r.offsetSide){if(t.y<a-15||t.y>r.mapAuthorizedHeight-a/2-10){b(n);return}T(t,n,r,s,a)}else if(t.x>r.mapAuthorizedWidth-s/2-10){if(t.y<a-15||t.y>r.mapAuthorizedHeight-a/2-10){b(n);return}N(t,n,r,s,a)}else if(t.x<r.mapAuthorizedMinWidth+s/2){if(t.y<a-15||t.y>r.mapAuthorizedHeight-a/2-10||t.x<r.mapAuthorizedMinWidth){b(n);return}T(t,n,r,s,a)}else t.y>a+25+i?x(t,n,r,s,a,i):S(t,n,r,s,a);e.set(o.byId("multiTip"+n),"display",r.visible?"block":"none"),e.set(o.byId("arrow"+n),"display",r.visible?"block":"none")}function S(t,n,r,i){e.set("multiTip"+n,{top:t.y+3+r.offsetBottom+"px",left:t.x-i/2-5+"px"}),e.set("arrow"+n,{left:t.x-10+"px",top:t.y+r.offsetBottom-5+"px",borderLeft:"10px solid transparent",borderRight:"10px solid transparent",borderBottom:"10px solid",borderBottomColor:n===0&&r.selected?app.cfg.SELECTED_POPUP_ARROW_COLOR:r.pointerColor,borderTop:"none"})}function x(t,n,r,i,s,o){e.set("multiTip"+n,{top:t.y-s-10-o+"px",left:t.x-i/2+0+"px"});if(u("ie")>0||/Trident\/7\./.test(navigator.userAgent))o-=10;e.set("arrow"+n,{left:t.x-10+"px",top:t.y-10-o+"px",borderLeft:"10px solid transparent",borderRight:"10px solid transparent",borderTop:"10px solid",borderTopColor:n===0&&r.selected?app.cfg.SELECTED_POPUP_ARROW_COLOR:r.pointerColor,borderBottom:"none"})}function T(t,n,r,i,s){var o=n===0&&r.selected?5:0;e.set("multiTip"+n,{top:t.y-22-o-(s-10)/2+"px",left:t.x+17+r.offsetSide+"px"}),e.set("arrow"+n,{left:t.x+8+r.offsetSide+"px",top:t.y-26-o+"px",borderTop:"10px solid transparent",borderBottom:"10px solid transparent",borderRight:"10px solid",borderRightColor:n===0&&r.selected?app.cfg.SELECTED_POPUP_ARROW_COLOR:r.pointerColor,borderLeft:"none"})}function N(t,n,r,i,s){var o=n===0&&r.selected?5:0;e.set("multiTip"+n,{top:t.y-22-o-(s-10)/2+"px",left:t.x-18-i-r.offsetSide+"px"}),e.set("arrow"+n,{left:t.x-18-r.offsetSide+"px",top:t.y-26-o+"px",borderTop:"10px solid transparent",borderBottom:"10px solid transparent",borderLeft:"10px solid",borderLeftColor:n===0&&r.selected?app.cfg.SELECTED_POPUP_ARROW_COLOR:r.pointerColor,borderRight:"none"})}var l=null,c=!1,h=[];p(f),this.current=function(){return l.pointArray},this.clean=function(e){l=null,v(e)},this.hide=function(){c=!0,y()},this.show=function(){if(!l)return;c=!1,l.visible=!0,m(l.map.extent,!0)}}}),define("lib-build/css!storymaps/tpl/ui/mobile/Header",[],function(){}),define("storymaps/tpl/ui/mobile/Header",["lib-build/css!./Header"],function(){return function(t){function n(){}this.init=function(e){e=e||{},t.find(".title").html(e.title)},this.update=function(){},n()}}),define("lib-build/tpl!storymaps/tpl/ui/mobile/MobileIntro",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div id="mobileIntro"></div>\r\n';return __p}}),define("lib-build/css!storymaps/tpl/ui/mobile/MobileIntro",[],function(){}),define("storymaps/tpl/ui/mobile/MobileIntro",["lib-build/tpl!./MobileIntro","lib-build/css!./MobileIntro","dojo/on"],function(e){return function(n,r,i,s){function a(){app.map.on("click",function(){$("#mobileIntro").css("display","none")})}var o=s,u=this;this.screenSize="desktop",this.init=function(){$(n).prepend(e({}))},this.hide=function(){$("#mobileIntro").hide()},this.setTitle=function(){var e=app.data.getResponse().itemInfo.item;$("#mobileIntro").append('<div class="mobileTitle">'+e.title+"</div>"),$("#mobileIntro").append('<div class="mobileSnippet"></div>'),e.snippet&&$(".mobileSnippet").html(e.snippet),a()},this.fillList=function(e,t,n){e===0&&$("#mobileIntro").append('<ul id="mobileThemeList" style=" height: 80px; line-height: 80px;" class="mobileTileList introList">');var r=$('<li class="mobileTitleThemes">').append('<span style="width: 100%;margin-left: 30px; margin-right: 30px; vertical-align: middle; line-height: 20px; display: inline-block;">'+t.title+"</span>");r.on("click",function(){u.selectMobileTheme(e,n)}),e===0&&$(r).css("border-width","2px 0px 1px 0px"),e==n.length-1&&$(r).css("border-width","1px 0px 2px 0px"),$("#mobileThemeList").append(r)},this.resizeMobileElements=function(){u.screenSize=="desktop"&&!o.selected&&app.ui.mobileFeatureList.showMobileList(),$("#mobilePaneList").css("height","52%").css("height","-=20px"),$("#mobileThemeBar").css("top","48%").css("top",$("#mobileThemeBar").position().top-20+"px");var e=$(".mobileThemeTitle").length;$("#mobileThemeBarSlider").width($(window).width()*e),$("#returnHiddenBar").css("width","100%").css("width","-=80px"),$("#mobilePaneList").css("height","52%").css("height","-=20px"),$(".mobileTileList.blurb").css("width","100%").css("width","-=125px"),$("#map").css("height","100%").css("height","48%").css("height","-=20px"),$("#map").css("width","100%"),$("#mainStage").height($("#map").height()),$("#map").css({top:0}),$("#map").css({left:0}),u.screenSize="small",setTimeout(function(){app.ui.detailPanel.resize()},0)},this.selectMobileTheme=function(e,t){e!==0&&o.activateLayer(e),$("#contentPanel").css("display","block"),$("#mobileIntro").css("display","none"),$(window).resize(),app.ui.mobileFeatureList.selectTheme(e),o.themeSelected=!0}}}),define("lib-build/css!storymaps/tpl/ui/mobile/MobileFeatureList",[],function(){}),define("storymaps/tpl/ui/mobile/MobileFeatureList",["../../core/WebApplicationData","dojo/on","lib-build/css!./MobileFeatureList"],function(e){return function(t,n,r,i){function f(){$("#navThemeRight").on("click",function(){u.slideNext()}),$("#navThemeLeft").on("click",function(){u.slidePrev()})}function l(e){e===0&&u.slides.length>1?($("#navThemeLeft").css("display","none"),$("#navThemeRight").css("display","block")):e==u.slides.length-1?($("#navThemeRight").css("display","none"),$("#navThemeLeft").css("display","block")):($("#navThemeLeft").css("display","block"),$("#navThemeRight").css("display","block"))}function c(e){return $.grep($("ul.mobileTileList li"),function(t,n){return t.id=="item"+e})[0]}var s=i,o=!0,u=null,a=$("#mobileThemeBarSlider");app.scrollList,this.init=function(){u=new Swiper("#mobileThemeSliderContainer",{speed:0,direction:"horizontal"}),u.on("onSlideChangeEnd",function(e){$("#mobileThemeBar").css("visibility")=="visible"&&s.activateLayer(u.activeIndex),l(u.activeIndex),$("#mobileThemeBar").css("background-color",app.layerCurrent.color)}),f()},this.addTheme=function(e,t){var n='<div class="mobileThemeTitle swiper-slide"><p style="margin-top: 7px;">'+e.title+"</p></div>";$(a).append(n),u.update(),t&&($("#mobileThemeBar .swiper-container").css("display","none"),$("#navThemeLeft").css("display","none"),$("#navThemeRight").css("display","none"))},this.showMobileList=function(){$("#mobileFeature").css("visibility","hidden"),$("#mobileSupportedLayersView").css("visibility","hidden"),$("#mobileThemeBarSlider").css("display","block"),$("#mobilePaneList").css("visibility","visible"),$("#returnIcon").css("display","none"),$("#returnHiddenBar").css("display","none"),$("#centerMapIconContainer").css("display","none"),$("#navThemeLeft").css("visibility","visible"),$("#navThemeRight").css("visibility","visible"),s.selected&&(s.selected.symbol.setWidth(app.cfg.lutIconSpecs.tiny.getWidth()),s.selected.symbol.setHeight(app.cfg.lutIconSpecs.tiny.getHeight()),s.selected.symbol.setOffset(app.cfg.lutIconSpecs.tiny.getOffsetX(),app.cfg.lutIconSpecs.tiny.getOffsetY()),s.selected.draw()),s.selected=null,app.mapTips&&app.mapTips.clean(!0),$(".detailContainer").hide(),u.update()},this.selectTheme=function(e){o?u.slideTo(e,0):(u.slideTo(e,0),$("#mobileTitlePage").css("display","none")),o=!1,$("#mobileThemeBar").css("background-color",app.layerCurrent.color),l(e)},this.buildList=function(e,t,n){e===0&&$("#mobileList").empty();var r=$(n).clone(),i=t.attributes.getValueCI(app.cfg.FIELDNAME_THUMBURL)?t.attributes.getValueCI(app.cfg.FIELDNAME_THUMBURL):t.attributes.getValueCI(app.cfg.FIELDNAME_IMAGEURL),s=$('<div style="height: 75px; margin-bottom: 8px;"><img src="'+i+'"></div>');$(r).append(s),$("#mobileList").append(r)},this.setColor=function(){if(app.isInBuilder)return;$("#mobileThemeBar").css("background-color",app.layerCurrent.color)},this.refreshMobileList=function(){var e,t=!1;app.layerCurrent&&app.layerCurrent.graphics.length&&setTimeout(function(){$.each(app.layerCurrent.graphics,function(n,r){e=c(r.attributes.getValueCI(app.cfg.FIELDNAME_ID)),app.map.extent.contains(r.geometry)?($(e).css("display")=="none"&&$(e).css("display","block"),t=!0):$(e).css("display")!="none"&&$(e).css("display","none")}),$("#mobilePaneList").scrollTop(0),t?$(".noFeature").css("display","none"):$(".noFeature").css("display","block")},100)}}}),define("lib-build/css!storymaps/common/mapcontrols/command/MapCommand",[],function(){}),define("storymaps/common/mapcontrols/command/MapCommand",["lib-build/css!./MapCommand","dojo/has","esri/geometry/Point","dojo/on","esri/symbols/PictureMarkerSymbol","esri/layers/GraphicsLayer","esri/graphic","esri/config"],function(e,t,n,r,i,s,o,u){return function(a,f,l,c){function m(e){if(e)$(a.container).find(".mapCommandHomeBtn").addClass("loading"),h=Date.now();else{var t=Date.now()-h,n=0;t<450&&(n=450-t),setTimeout(function(){$(a.container).find(".mapCommandHomeBtn").removeClass("loading"),h=0},n)}}function g(){console.log("getDeviceLocation");var e=1e4,t=!1;setTimeout(function(){t||$(a.container).find(".mapCommandLocation").addClass("loading")},300),navigator.geolocation.getCurrentPosition(function(e){t=!0,$(a.container).find(".mapCommandLocation").removeClass("loading");var r=new n(e.coords.longitude,e.coords.latitude);l&&typeof l=="function"&&l(!0,r,e);if(a.spatialReference.wkid!=102100&&a.spatialReference.wkid!=4326){u.defaults.geometryService.project([r],a.spatialReference,function(e){if(!e||!e[0])return;y(e[0])});return}y(r)},function(e){t=!0,b(e)},{enableHighAccuracy:!0,maximumAge:12e4,timeout:e}),setTimeout(function(){t||b()},e)}function y(e){v.clear(),v.add(new o(e,d)),setTimeout(function(){$("#locateLayer_layer image").fadeOut({duration:800})},1e4)}function b(e){console.log("getDeviceLocationError",e),$(a.container).find(".mapCommandLocation").removeClass("loading"),l(!1,null)}var h=0,p=$('<div class="esriSimpleSliderIncrementButton"><div class="mapCommandHomeBtn"></div></div>'),d=new i("resources/common/icons/mapcommand-location-marker.png",21,21),v=new s({id:"locateLayer"});p.click(function(){if(h!==0&&$("body").hasClass("mobile-view"))return;f&&typeof f=="function"?f(a._params.extent):a.setExtent(a._params.extent)}),$(a.container).find(".esriSimpleSlider div:nth-child(1)").after(p),r(a,"update-start",function(){h===0&&m(!0)}),r(a,"update-end",function(){m(!1)}),this.setMobile=function(e){$(".esriSimpleSlider, .mapCommandHomeBtn",a.container).toggleClass("touch",!!e)},this.destroy=function(){$(a.container).find(".esriSimpleSliderIncrementButton").remove(),$(a.container).find(".mapCommandLocation").remove()},this.startLoading=function(){m(!0)},this.stopLoading=function(){m(!1)},this.enableLocationButton=function(e){$(a.container).toggleClass("has-locator",e),$(".mapCommandLocation",a.container).toggleClass("hidden",!e)},navigator&&navigator.geolocation&&app.cfg.GEOLOCATOR&&($(".esriSimpleSlider",a.container).after('<div class="esriSimpleSlider esriSimpleSliderVertical mapCommandLocation"></div>'),$(".mapCommandLocation",a.container).click(g),this.enableLocationButton(c),a.addLayer(v)),this.setMobile(app.appCfg.mapCommandLargerTouch||app.appCfg.mapCommandLargerTouch===undefined&&t("touch"))}}),define("lib-build/tpl!storymaps/common/mapcontrols/legend/Legend",[],function(){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<div class="legendContainer mapControls">\r\n	<div class="titleBtn">\r\n		<span class="collapseBtn">\r\n			<div class="glyphicon glyphicon-chevron-down"></div>\r\n			<div class="glyphicon glyphicon-chevron-up"></div>\r\n		</span>\r\n		'+((__t=title)==null?"":__t)+'\r\n	</div>\r\n	\r\n	<div class="content">\r\n		<div class="legendDijitContainer"></div>\r\n		',isInBuilder&&(__p+='\r\n			<div class="settingsGear glyphicon glyphicon-wrench"></div>\r\n			<div class="settingsOverlay">\r\n				<div class="settings-title">'+((__t=settings)==null?"":__t)+'</div>\r\n				<div class="settings-content">\r\n					<!-- Open by default -->\r\n					<div class="checkbox">\r\n						<label>\r\n							<input type="checkbox" class="expandStartup" />\r\n							'+((__t=openDefault)==null?"":__t)+"\r\n						</label>\r\n					</div>\r\n				</div>\r\n			</div>\r\n		"),__p+="\r\n	</div>\r\n</div>";return __p}}),define("lib-build/css!storymaps/common/mapcontrols/legend/Legend",[],function(){}),define("lib-build/css!storymaps/common/mapcontrols/Common",[],function(){}),define("storymaps/common/mapcontrols/legend/Legend",["lib-build/tpl!./Legend","lib-build/css!./Legend","lib-build/css!../Common","storymaps/common/utils/CommonHelper","esri/dijit/Legend","esri/arcgis/utils","dojo/topic"],function(e,t,n,r,i,s,o){return function(n,u,a){function d(){h.find(".legendDijitContainer").html('<div class="legendDijit"></div>'),l=new i({map:n.map,layerInfos:s.getLegendLayers(n)},h.find(".legendDijit")[0]),l.startup()}function v(){l&&l.destroy(),l=null}function m(){h.find(".legendContainer").toggleClass("collapsed"),h.find(".settingsOverlay").hide()}function g(){h.find(".titleBtn").click(m),h.find(".settingsGear").click(function(){h.find(".settingsOverlay").is(":visible")?h.off("mouseleave"):h.mouseleave(function(){h.find(".settingsOverlay").toggle(),h.off("mouseleave"),h.find(".content").removeClass("settingsOpen")}),h.find(".settingsOverlay").toggle(),h.find(".content").toggleClass("settingsOpen")}),h.find(".expandStartup").change(y),f.updatePlacementSettings(a)}function y(){c.openByDefault=h.find(".expandStartup").prop("checked"),o.publish("BUILDER_INCREMENT_COUNTER",1)}var f=this,l=null,c=null,h=a.container,p={isInBuilder:u,title:i18n.viewer.legendFromCommon.title};u&&(p.settings=i18n.commonMapControls.common.settings,p.openDefault=i18n.commonMapControls.common.openDefault),h.html(e(p)),this.toggle=function(e){h.toggle(!!e),e&&!l?d():e||v()},this.toggleExpanded=function(e){h.find(".legendContainer").toggleClass("collapsed",!e)},this.setColors=function(e){h.find(".legendContainer").css({backgroundColor:e.dotNav||e.mapControls,color:e.text}),h.find(".titleBtn").css("color",e.softText),h.find(".settingsGear, .collapseBtn").css("color",e.softBtn),r.addCSSRule(".mainMediaContainer .legendContainer ::-webkit-scrollbar-thumb { background-color:"+e.header+"; }","MapControlLegendDropdownScrollbar")},this.updatePlacementSettings=function(e){h.find(".legendContainer").toggleClass("isInlined",e.mode=="panel"),e.container[0]!=h[0]&&(e.container.html(h.find(".legendContainer")),h=e.container)},this.setSettings=function(e){c=e,h.find(".expandStartup").prop("checked",c.openByDefault)},g()}}),define("lib-build/tpl!storymaps/common/mapcontrols/overview/Overview",[],function(){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<div class="overviewContainer mapControls">\r\n	<div class="titleBtn">\r\n		<span class="collapseBtn">\r\n			<div class="glyphicon glyphicon-chevron-down"></div>\r\n			<div class="glyphicon glyphicon-chevron-up"></div>\r\n		</span>\r\n		'+((__t=title)==null?"":__t)+'\r\n	</div>\r\n	\r\n	<div class="content">\r\n		<div class="overviewMapContainer">\r\n			<!-- Map is injected here -->\r\n		</div>\r\n		',isInBuilder&&(__p+='\r\n			<div class="settingsGear glyphicon glyphicon-wrench"></div>\r\n			<div class="settingsOverlay">\r\n				<div class="settings-title">'+((__t=settings)==null?"":__t)+'</div>\r\n				<div class="settings-content">\r\n					<!-- Open by default -->\r\n					<div class="checkbox">\r\n						<label>\r\n							<input type="checkbox" class="expandStartup" />\r\n							'+((__t=openDefault)==null?"":__t)+'\r\n						</label>\r\n					</div>\r\n					\r\n					<!-- Basemap -->\r\n					<div class="btn-group dropup basemap-dropdown">\r\n						<button type="button" class="btn btn-default btn-sm dropdown-toggle basemapBtn" data-toggle="dropdown">\r\n							'+((__t=basemapGalleryBtnLabel)==null?"":__t)+' <span class="caret"></span>\r\n						</button>\r\n						<ul class="dropdown-menu basemaps dropdown-menu-form pull-right" role="menu"></ul>\r\n					</div>\r\n					<div id="basemapGallery"></div>\r\n			\r\n					<!-- Expand factor -->\r\n					<div class="spinnerLabel">\r\n						<label for="expandFactorSpinner">'+((__t=expandFactorLabel)==null?"":__t)+'</label>\r\n						<a class="locateBtnHelp" data-original-title="" title="">\r\n							<img src="resources/tpl/builder/icons/builder-help.png" style="vertical-align: -5px;">\r\n						</a>\r\n					</div>\r\n					\r\n					<div class="input-group expandFactorSpinner">\r\n						<input type="text" class="form-control input-small input-xs" id="expandFactorSpinner" value="2">\r\n						<div class="input-group-btn-vertical">\r\n							<button class="btn btn-default btn-xs"><i class="glyphicon glyphicon-chevron-up"></i></button>\r\n							<button class="btn btn-default btn-xs"><i class="glyphicon glyphicon-chevron-down"></i></button>\r\n						</div>\r\n					</div>\r\n				</div>\r\n			</div>\r\n		'),__p+="\r\n	</div>\r\n</div>";return __p}}),define("lib-build/css!storymaps/common/mapcontrols/overview/Overview",[],function(){}),define("storymaps/common/mapcontrols/overview/Overview",["lib-build/tpl!./Overview","lib-build/css!./Overview","lib-build/css!../Common","esri/dijit/OverviewMap","esri/dijit/BasemapGallery","esri/layers/ArcGISTiledMapServiceLayer","esri/arcgis/utils","dojo/Deferred","dojo/dom","dojo/on","dojo/topic"],function(e,t,n,r,i,s,o,u,a,f,l){return function(n,i,s){function c(e){i.find(".overviewMapContainer").html('<div class="overviewMap"></div>'),o=new r({map:n,visible:!0,color:"transparent",opacity:1},i.find(".overviewMap")[0]),o.startup();var t=e?e.dotNav||e.header:a;t&&i.find(".ovwHighlight").css("border","3px solid "+t)}function h(){o&&o.destroy(),o=null}function p(){i.find(".overviewContainer").toggleClass("collapsed"),i.find(".settingsOverlay").hide()}function d(){i.find(".titleBtn").click(p),i.find(".settingsGear").click(function(){i.find(".settingsOverlay").is(":visible")?i.off("mouseleave"):i.mouseleave(function(){i.find(".settingsOverlay").toggle(),i.off("mouseleave")}),i.find(".settingsOverlay").toggle()}),i.find(".expandStartup").change(v)}function v(){u.openByDefault=i.find(".expandStartup").prop("checked"),l.publish("BUILDER_INCREMENT_COUNTER",1)}var o=null,u=null,a=null,f={isInBuilder:s,title:i18n.viewer.overviewFromCommon.title,overlayHeader:"",basemapGalleryBtnLabel:"",expandFactorLabel:""};s&&(f.settings=i18n.commonMapControls.common.settings,f.openDefault=i18n.commonMapControls.common.openDefault,f.basemapGalleryBtnLabel=i18n.commonMapControls.overview.basemapGalleryBtnLabel,f.expandFactorLabel=i18n.commonMapControls.overview.expandFactorLabel),i.append(e(f)),this.toggle=function(e,t){i.toggle(!!e),e&&!o?c(t):e||h()},this.toggleExpanded=function(e){i.find(".overviewContainer").toggleClass("collapsed",!e)},this.setColors=function(e){a=e.dotNav||e.mapControls,i.find(".overviewContainer").css({backgroundColor:a,color:e.text}),i.find(".titleBtn").css("color",e.softText),i.find(".settingsGear, .collapseBtn").css("color",e.softBtn),i.find(".ovwHighlight").css("border","3px solid "+a)},this.setSettings=function(e){u=e,i.find(".expandStartup").prop("checked",u.openByDefault)},d()}}),define("lib-build/tpl!storymaps/common/mapcontrols/geocoder/Geocoder",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="geocoderBtn">\r\n	<div class="geocoderContainer"></div>\r\n</div>';return __p}}),define("lib-build/css!storymaps/common/mapcontrols/geocoder/Geocoder",[],function(){}),define("storymaps/common/mapcontrols/geocoder/Geocoder",["lib-build/tpl!./Geocoder","lib-build/css!./Geocoder","../../utils/CommonHelper"],function(e,t,n){return function(r,i,s){function a(){$(r.container).find(".esriSimpleSlider").last().after(e({})),o.toggle(s)}var o=this,u=null;this.toggle=function(e){var t=$(r.container).find(".geocoderBtn");u||n.createGeocoder({map:r,domNode:t.find(".geocoderContainer")[0],enableButtonMode:!0}).then(function(e){u=e,t.find(".esriGeocoderContainer input, .esriGeocoderSearch").attr("tabindex","-1")}),$(r.container).toggleClass("has-geocoder",e),t.toggle(e)},a()}}),define("lib-build/css!storymaps/common/utils/SocialSharing",[],function(){}),define("lib-build/css!storymaps/common/ui/loadingIndicator/LoadingIndicator",[],function(){}),define("lib-build/css!storymaps/tpl/ui/Common",[],function(){}),define("lib-build/css!storymaps/tpl/ui/mobile/Common",[],function(){}),define("lib-build/css!storymaps/tpl/ui/Responsive",[],function(){}),define("lib-build/css!storymaps/tpl/ui/desktop/MultiTips",[],function(){}),define("storymaps/tpl/core/MainView",["lib-build/css!./MainView","./Config","./Data","./WebApplicationData","./Helper","../ui/desktop/TestPanel","../ui/desktop/TilePanel","../ui/desktop/DetailPanel","../ui/desktop/NavBar","../ui/desktop/MultiTips","../ui/mobile/Header","../ui/mobile/MobileIntro","../ui/mobile/MobileFeatureList","storymaps/common/mapcontrols/command/MapCommand","storymaps/common/mapcontrols/legend/Legend","storymaps/common/mapcontrols/overview/Overview","storymaps/common/mapcontrols/geocoder/Geocoder","lib-build/css!storymaps/common/ui/Modal.css","lib-build/css!storymaps/common/utils/SocialSharing.css","lib-build/css!storymaps/common/ui/loadingIndicator/LoadingIndicator.css","storymaps/common/utils/CommonHelper","dojo/has","dojo/topic","dojo/on","dojo/dom","dojo/DeferredList","dojo/_base/lang","esri/arcgis/utils","esri/geometry/Point","esri/geometry/screenUtils","esri/geometry/Extent","lib-build/css!../ui/Common","lib-build/css!../ui/mobile/Common","lib-build/css!../ui/Responsive","lib-build/css!../ui/desktop/MultiTips"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O){return function(s){function N(){I();if(!app.map)return;r.getTabs()&&$.each(r.getTabs(),function(e,t){app.data.setStory(e,t.title,t.color,t.extent)});var e=$.grep(app.map.graphicsLayerIds,function(e){return e.split("_").slice(0,-1).join("_")==r.getShortlistLayerId()?e:e==r.getShortlistLayerId()?e:!1});app.data.setShortlistLayerId(e[0]),app.map||setTimeout(function(){},500),app.map.loaded?L():app.map.on("load",function(){L()})}function L(){app.map.resize(),app.map.on("click",function(e){app.mapTips&&(e.graphic?m.selected&&(m.selected.hidden=!1):(app.mapTips.clean(!0),m.selected&&(m.selected.hidden=!0)))});var e=[];$.each(r.getTabs(),function(t,n){e.push({features:[],title:n.title,color:n.color,extent:n.extent})});var t=app.map.getLayer(app.data.getShortlistLayerId());$.each(t.graphics,function(t,n){n.attributes.getValueCI||(n.attributes.getValueCI=v.getValueCI),n.attributes.locationSet&&!app.isInBuilder?e[n.attributes.tab_id].features.push(n):app.isInBuilder&&e[n.attributes.tab_id].features.push(n)}),t.on("mouse-over",m.layer_onMouseOver),t.on("mouse-out",m.layer_onMouseOut),t.on("click",m.layer_onClick);if(e.length>1||app.isInBuilder&&!app.isDirectCreationFirstSave){$("#divStrip").height("35px"),$.each(e,function(e,t){app.ui.tilePanel.createTab(e,t),app.ui.mobileFeatureList.addTheme(t);var n=app.cfg.COLOR_ORDER.split(","),r=$.grep(app.cfg.COLOR_SCHEMES,function(t){return t.name.toLowerCase()==$.trim(n[e].toLowerCase())})[0],i=t.color||r.color;m.buildLayer(t.features.sort(z),i);if(app.isInBuilder){app.data.setStory(e,t.title,r.color,t.extent);var s=C.clone(app.data.getStory());$.each(s,function(e,n){n.title=t.title,n.color=i}),app.detailPanelBuilder.addDetailPanelSwiper(e)}app.data.setStory(e,t.title,t.color)});if(!app.isDirectCreationFirstSave){var n={header:"#444",tabText:"#d8d8d8",tab:"#666",tabTextActive:"#fff",tabActive:"#999",tabTextHover:"#fff",tabHover:"#666"},i=0;app.ui.navBar.init(e,i,n,r),app.ui.tilePanel.setTabClick()}}else{if(e.length<1)return!1;$.each(e,function(e,t){app.ui.tilePanel.createTab(e,t),app.ui.mobileFeatureList.addTheme(t);var n=app.cfg.COLOR_ORDER.split(","),r=$.grep(app.cfg.COLOR_SCHEMES,function(t){return t.name.toLowerCase()==$.trim(n[e].toLowerCase())})[0],i=t.color||r.color;m.buildLayer(t.features.sort(z),i);if(app.isInBuilder){app.data.setStory(e,t.title,r.color,t.index);var s=C.clone(app.data.getStory());$.each(s,function(e,n){n.title=t.title,n.color=i}),app.detailPanelBuilder.addDetailPanelSwiper(e)}}),$(".tab").css("display","none"),$("#mobileIntro").append("<br><hr></hr>"),$("#mobileIntro").append('<ul id="mobileThemeList" class="mobileTileList">');var s=$('<li class="mobileTitleTheme" onclick="app.ui.mobileIntro.selectMobileTheme(0)">').append('<div class="startButton"> Start </div>');$("#mobileThemeList").append(s),$("#navThemeLeft").addClass("hideButtons"),$("#navThemeRight").addClass("hideButtons"),$("#nav-bar").show(),$("#nav-bar .entries").hide(),$("#bookmarksCon").css({top:0})}d.handleWindowResize(),m.activateLayer(0),app.isInBuilder&&app.detailPanelBuilder.buildSlides(),$(".entryLbl").css("outline-style","none"),$("#zoomToggle").css("visibility","visible"),$("#whiteOut").fadeOut("slow"),$("body").width()>768?($("#paneLeft").height($("#contentPanel").height()-$("#tabs").height()),$("#paneLeft").css("top",$("#divStrip").height()),$("#map").height($("#contentPanel").height()),$("#map").css("top",0),$(".tilelist").height($("#paneLeft").height()-25)):app.ui.mobileIntro.resizeMobileElements(),d.appInitComplete(r),$("body").on("mousedown","*",function(e){($(this).is(":focus")||$(this).is(e.target))&&$(this).css("outline-style")=="none"&&($(this).css("outline","none").on("blur",function(){$(this).off("blur").css("outline","")}),$(this).parents("#bookmarksToggle").length&&$(this).parents("#bookmarksToggle").css("outline","none").on("blur",function(){$(this).off("blur").css("outline","")}))}),app.map.disableKeyboardNavigation(),$("body").keypress(function(e){e.which==13&&$(document.activeElement).click(),e.which==43&&(app.map.setLevel(app.map.getLevel()+1),$("#zoomIn").focus(),m.hideBookmarks()),e.which==45&&(app.map.setLevel(app.map.getLevel()-1),$("#zoomOut").focus(),m.hideBookmarks())})}function M(){if(m.selected.symbol.width==app.cfg.lutIconSpecs.large.getWidth())return;m.selected.symbol.setWidth(app.cfg.lutIconSpecs.large.getWidth()),m.selected.symbol.setHeight(app.cfg.lutIconSpecs.large.getHeight()),m.selected.symbol.setOffset(app.cfg.lutIconSpecs.large.getOffsetX(),app.cfg.lutIconSpecs.large.getOffsetY()),m.selected.draw(),setTimeout(function(){try{m.selected.getShape().moveToFront()}catch(e){console.log("problem with 'moveToFront()'...")}},10)}function _(e,t){var n=t*4,r=e.data;return[r[n],r[n+1],r[n+2],r[n+3]]}function D(e){var t=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;e=e.replace(t,function(e,t,n,r){return t+t+n+n+r+r});var n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return n?{r:parseInt(n[1],16),g:parseInt(n[2],16),b:parseInt(n[3],16)}:null}function P(e,t,n){var r=(new esri.symbol.PictureMarkerSymbol(t.toDataURL(),n.getWidth(),n.getHeight())).setOffset(n.getOffsetX(),n.getOffsetY());return r}function H(e){if(v.isMobile())return;app.map.setMapCursor("pointer");var t=e.graphic;t.attributes.getValueCI||(t.attributes.getValueCI=getValueCI);var n={};n.geometry=A.toMapPoint(app.map.extent,app.map.width,app.map.height,e.screenPoint),m.buildMapSupportHoverTips(t.attributes.getValueCI(app.cfg.FIELDNAME_TITLE),n)}function B(){if(v.isMobile())return;app.map.setMapCursor("default"),app.mapTips.clean()}function j(e){m.selected=null,$("#mobileTitlePage").css("display","none");var t=$(".esriPopup")[0];if(app.ui.mobileIntro.screenSize!="small")$(t).show(),app.mapTips.clean();else{$(t).hide();var n=e.graphic;n.attributes.getValueCI||(n.attributes.getValueCI=getValueCI);var r={};r.geometry=A.toMapPoint(app.map.extent,app.map.width,app.map.height,e.screenPoint),m.buildMapSupportHoverTips(n.attributes.getValueCI(app.cfg.FIELDNAME_TITLE),r)}}function F(){var e=[],t=[];$.each(app.map.graphicsLayerIds,function(t,n){e.push(app.map.getLayer(n))});var n=[],i=[],o,u=null,a;$.each(e,function(e,r){r.layerType?a=r.layerType:a=r.type,r.geometryType=="esriGeometryPoint"&&t.push(r),r.url&&(a==="ArcGISFeatureLayer"||a==="Feature Layer")&&!r.id.match(/^csv_/)&&(o=!0,u=r,n.push(r.url),i.push(e))}),t.length?($.each(t,function(t,n){var r=e.indexOf(n);e.splice(r,1)}),s.openMigrationPopup(t,e),$("#loadingIndicator").hide(),clearTimeout(app.loadingTimeout),app.loadingTimeout=null):d.appInitComplete(r)}function I(){if(!r.isBlank())d.appInitComplete(r);else if(app.isInBuilder&&app.data.getWebAppData().getWebmap()){var e=m.loadWebmap(app.data.getWebAppData().getWebmap(),"map");e.then(function(t){app.data.setResponse(t),app.map=e.results[0].map,app.data.setWebMap(e.results[0].itemInfo),s.updateUI(),F()}),d.isProd()||d.portalLogin().then()}else w.getAppID(d.isProd())&&(app.data.userIsAppOwner()?w.switchToBuilder():d.initError("notConfiguredDesktop"));if(s&&!app.data.getWebAppData().getWebmap()){var e=m.loadWebmap(s.buildWebMap(),"map");e.then(function(){app.map=e.results[0].map,app.data.setWebMap(e.results[0].itemInfo),s.updateUI(),d.appInitComplete(r)})}}function q(e){var t={objectIdField:"__OBJECTID",geometryType:"esriGeometryPoint",drawingInfo:{renderer:{type:"simple",symbol:{type:"esriPMS",url:"http://static.arcgis.com/images/Symbols/Shapes/GreenDiamondLargeB.png",width:15,height:15}}},fields:e};return t}function R(e){return e.url?e.featureCollection.featureSet:e.featureCollection.layers[0].featureSet}function U(e){return e.url?e.id:e.id}function z(e,t){var n=e.attributes.getValueCI(app.cfg.FIELDNAME_NUMBER)||e.attributes.shortlist_id,r=t.attributes.getValueCI(app.cfg.FIELDNAME_NUMBER)||t.attributes.shortlist_id;return n<r?-1:n>r?1:0}function W(){S.publish("CORE_UPDATE_EXTENT",app.map._params.extent)}var d=null,v=new i,m=this,g=!1,y,b,x,T=0;this.init=function(e){d=e;if(app.isInBuilder&&E("ie")&&E("ie")<10)return i18n.viewer.errors.noBuilderIE=i18n.viewer.errors.noBuilderIE.replace("%VERSION%",10).replace("%UPGRADE%",i18n.viewer.errors.upgradeBrowser),d.initError("noBuilderIE"),!1;if(E("ie")&&E("ie")<=8)return i18n.viewer.errors.noViewerIE=i18n.viewer.errors.noViewerIE.replace("%VERSION%",9).replace("%UPGRADE%",i18n.viewer.errors.upgradeBrowser),d.initError("noViewerIE"),!1;app.data=new n,x=document.createElement("canvas"),y=x.getContext("2d"),b=new Image,b.src=app.cfg.ICON_SRC,b.onload=function(){y.drawImage(b,0,0),y.font=x.width/2+"pt Calibri"},m.themeSelected=!1,app.ui.tilePanel=new o($("#contentPanel"),m,r,app.isInBuilder),setTimeout(function(){app.ui.detailPanel=new u($("#paneLeft"),app.isInBuilder,r,m,r),app.ui.detailPanel.init()},100),app.ui.navBar=new a($("#nav-bar"),app.isInBuilder,m.activateLayer),app.ui.tilePanel.init(),app.ui.mobileHeader=new l($("#headerMobile"),app.isInBuilder,function(){}),app.ui.mobileIntro=new c($("body"),app.isInBuilder,function(){},m),app.ui.mobileFeatureList=new h($("#contentPanel"),app.isInBuilder,function(){},m),app.ui.mobileIntro.init(),app.ui.mobileFeatureList.init();var t={},i=esri.urlToObject(document.location.href).query;return i&&$.each(i,function(e,n){t[e.toLowerCase()]=n}),$("body").on("mousedown","*",function(e){($(this).is(":focus")||$(this).is(e.target))&&$(this).css("outline-style")=="none"&&$(this).css("outline","none").on("blur",function(){$(this).off("blur").css("outline","")})}),!0},this.webAppConfigLoaded=function(){app.isGalleryCreation=!app.data.getWebAppData().getOriginalData()||!Object.keys(app.data.getWebAppData().getOriginalData().values).length},this.loadFirstWebmap=function(e){return this.loadWebmap(e,$("#map")[0])},this.loadWebmapFromData=function(){N()},this.loadWebmap=function(e,t,n){console.log("tpl.core.MainView - loadWebMap - webmapId:",e);var r=new esri.dijit.Popup({highlight:!1},dojo.create("div"));return k.createMap(e,t,{mapOptions:{slider:!0,autoResize:!1,showAttribution:!0,infoWindow:r,extent:n,wrapAround180:!1},usePopupManager:!0,bingMapsKey:app.cfg.BING_MAPS_KEY,editable:!1})},this.firstWebmapLoaded=function(){N()},this.startFromScratch=function(){I()},this.getMapConfig=function(e){return{response:e,mapCommand:new p(e.map,W,d.zoomToDeviceLocation,app.data.getWebAppData().getLocateBtn())}},this.activateLayer=function(e){var t=[];app.data.getStory()[e]&&app.data.getStory()[e].extent&&app.map.setExtent(new O(app.data.getStory()[e].extent));var n=app.map.getLayer(app.data.getShortlistLayerId());$.each(n.graphics,function(n,r){r.attributes.tab_id==e?r.attributes.locationSet?(r.show(),t.push(r)):(app.isInBuilder&&t.push(r),r.hide()):r.hide()});var i=new esri.layers.GraphicsLayer;i.graphics=t;var s=app.data.getStory()[e].color;i.color=s,app.layerCurrent=i,app.layerCurrent.color=app.data.getStory()[e].color,n.redraw(),app.ui.mobileFeatureList.setColor(),app.mapTips&&app.mapTips.clean(!0),m.preSelection(),m.selected=null,m.postSelection();if(!$.isEmptyObject(app.cfg.TAB_SPECIFIC_SUPPORT_LAYERS)){var o=r.getSupportLayers(),u="tab"+String(e+1),a=app.cfg.TAB_SPECIFIC_SUPPORT_LAYERS[u];$.each(o,function(e,t){a&&a.indexOf(t.name)>-1?t.setVisibility(!0):t.setVisibility(!1)})}$(".detailContainer").hide(),app.ui.tilePanel.buildTilePanel(),app.ui.navBar.showEntryIndex(e),w.addCSSRule(".nav-bar .entry.active > .entryLbl, 					.nav-bar .dropdown.active .dropdown-toggle { 						background-color: "+app.data.getStory()[e].color+" !important; 					}","NavBarActive"),$("#paneLeft").css("border-top-color",app.data.getStory()[e].color),$(".detailHeader").css("border-top-color",app.data.getStory()[e].color);var f=e==0?500:100;setTimeout(function(){app.isInBuilder||app.ui.detailPanel.buildFeatureViews()},f),app.isInBuilder&&app.addFeatureBar.updateLocatedFeatures()},this.unselect=function(){m.preSelection(),m.selected=null,m.postSelection()},this.preSelection=function(){m.selected&&m.selected.symbol&&m.selected.symbol.setWidth&&(m.selected.symbol.setWidth(app.cfg.lutIconSpecs.tiny.getWidth()),m.selected.symbol.setHeight(app.cfg.lutIconSpecs.tiny.getHeight()),m.selected.symbol.setOffset(app.cfg.lutIconSpecs.tiny.getOffsetX(),app.cfg.lutIconSpecs.tiny.getOffsetY()),m.selected.draw(),app.mapTips&&app.mapTips.clean(!0))},this.postSelection=function(){if(m.selected==null)app.map.infoWindow.hide();else{if(!m.selected.attributes.locationSet&&!app.isInBuilder)return;!app.map.extent.contains(m.selected.geometry)&&m.selected.attributes.locationSet&&app.map.centerAt(m.selected.geometry),setTimeout(function(){m.buildMapTips()},250),app.isInBuilder?app.detailPanelBuilder.showSlide(m.selected.attributes.getValueCI(app.cfg.FIELDNAME_ID)):app.ui.detailPanel.showDetails(m.selected),app.ui.mobileIntro.hide(),app.ui.mobileFeatureList.setColor()}},this.buildMapTips=function(e){setTimeout(function(){if(!m.selected||!m.selected.attributes||m.selected.hidden||!m.selected.attributes.locationSet){app.mapTips&&app.mapTips.clean(!0);return}if(app.mapTips&&!app.map.extent.contains(m.selected.geometry)&&app.data.getWebAppData().getGeneralOptions().filterByExtent&&!app.isInBuilder){app.mapTips.clean(!0);return}if($("body").hasClass("mobile-view")){app.mapTips&&app.mapTips.clean(!0),m.selected&&M();return}e&&app.mapTips.clean(!0);var t=e?e:m.selected.attributes.getValueCI(app.cfg.FIELDNAME_TITLE);app.mapTips=new f({map:app.map,content:t,selected:m.selected&&m.selected.hidden!==!0?m.selected:null,pointArray:[m.selected],labelDirection:"auto",backgroundColor:app.cfg.SELECTED_POPUP_BACKGROUND_COLOR,borderColor:app.cfg.SELECTED_POPUP_BORDER_COLOR,pointerColor:app.cfg.SELECTED_POPUP_ARROW_COLOR,textColor:"#ffffff",offsetTop:44,topLeftNotAuthorizedArea:[40,180],mapAuthorizedMinWidth:-1,mapAuthorizedWidth:-1,mapAuthorizedHeight:-1,visible:!0}),M()},100)},this.buildMapHoverTips=function(e,t){if(app.mapTips&&($("body").hasClass("mobile-view")||!t.attributes.locationSet)){app.mapTips.clean(!0);return}var n=t==m.selected?44:33;app.mapTips=new f({map:app.map,content:e,selected:m.selected&&m.selected.hidden!==!0?m.selected:null,pointArray:[t],labelDirection:"auto",backgroundColor:app.cfg.POPUP_BACKGROUND_COLOR,borderColor:app.cfg.POPUP_BORDER_COLOR,pointerColor:app.cfg.POPUP_ARROW_COLOR,textColor:"#ffffff",offsetTop:n,topLeftNotAuthorizedArea:[40,180],mapAuthorizedMinWidth:-1,mapAuthorizedWidth:-1,mapAuthorizedHeight:-1,visible:!0})},this.buildMapSupportHoverTips=function(e,t){if(app.mapTips&&$("body").hasClass("mobile-view")){app.mapTips.clean(!0);return}app.mapTips=new f({map:app.map,content:e,selected:m.selected&&m.selected.hidden!==!0?m.selected:null,pointArray:[t],labelDirection:"auto",backgroundColor:app.cfg.POPUP_BACKGROUND_COLOR,borderColor:app.cfg.POPUP_BORDER_COLOR,pointerColor:app.cfg.POPUP_ARROW_COLOR,textColor:"#ffffff",offsetTop:5,topLeftNotAuthorizedArea:[40,180],mapAuthorizedMinWidth:-1,mapAuthorizedWidth:-1,mapAuthorizedHeight:-1,visible:!0})},this.moveGraphicToFront=function(e){var t=e.getDojoShape();t&&t.moveToFront()},this.buildLayer=function(e,t){var n=app.cfg.lutIconSpecs.tiny,i;$.each(e,function(e,s){var o=document.createElement("canvas");o.width=b.width,o.height=b.height;var u=o.getContext("2d");u.font="bold "+o.width/3.8+"pt Calibri",u.drawImage(x,0,0);var a=t;if(!i){var f=u.getImageData(0,0,x.width,x.height),l=_(f,4804);if(l[0]!=D(a).r&&l[1]!=D(a).g&&l[1]!=D(a).b){for(var c=0;c<f.data.length;c+=4)f.data[c]==l[0]&&f.data[c+1]==l[1]&&f.data[c+2]==l[2]&&(f.data[c]=D(a).r,f.data[c+1]=D(a).g,f.data[c+2]=D(a).b);u.putImageData(f,0,0)}i=f}e>0&&u.putImageData(i,0,0);if(r.getMapOptions().numberedIcons){var h=s.attributes.getValueCI(app.cfg.FIELDNAME_NUMBER);u.textAlign="center",u.fillStyle="white",u.fillText(h,o.width/3.2,o.height/2)}s.setSymbol(P(e,o,n))})},this.layer_onClick=function(e){if($("body").hasClass("pickLocation"))return;g=!0,m.preSelection(),m.selected=null,m.selected=e.graphic,m.postSelection(),$("#mobileTitlePage").css("display","none");var t=$(".esriPopup")[0];$(t).hide(),setTimeout(function(){g=!1},500),m.themeSelected||app.ui.mobileFeatureList.selectTheme(0),m.themeSelected=!0},this.layer_onMouseOver=function(e){if(g||$("body").hasClass("pickLocation"))return;if(v.isMobile())return;app.map.setMapCursor("pointer");var t=e.graphic,n=app.map.toScreen(t.geometry);if(t==m.selected&&m.selected.hidden!==!0&&$("#header").css("display")=="block")return;t.attributes.getValueCI||(t.attributes.getValueCI=getValueCI);if(t!=m.selected||m.selected.hidden!==!0)t.symbol.setWidth(app.cfg.lutIconSpecs.medium.getWidth()),t.symbol.setHeight(app.cfg.lutIconSpecs.medium.getHeight()),t.symbol.setOffset(app.cfg.lutIconSpecs.medium.getOffsetX(),app.cfg.lutIconSpecs.medium.getOffsetY()),t.draw(),v.isIE()||m.moveGraphicToFront(t);m.buildMapHoverTips(t.attributes.getValueCI(app.cfg.FIELDNAME_TITLE),t)},this.layer_onMouseOut=function(e){if($("body").hasClass("pickLocation"))return;if(v.isMobile())return;app.map.setMapCursor("default");var t=e.graphic;t!=m.selected&&(t.symbol.setWidth(app.cfg.lutIconSpecs.tiny.getWidth()),t.symbol.setHeight(app.cfg.lutIconSpecs.tiny.getHeight()),t.symbol.setOffset(app.cfg.lutIconSpecs.tiny.getOffsetX(),app.cfg.lutIconSpecs.tiny.getOffsetY()),t.draw()),app.mapTips&&app.mapTips.clean()},this.updateUI=function(){},this.resize=function(e){e.isMobileView?(app.ui.mobileIntro.resizeMobileElements(),app.cfg.BOOKMARKS&&$("#mobileBookmarksCon").show(),$("#header").height("0"),app.mapTips&&app.mapTips.hide(),(T<2||$("#mobileIntro").css("display")=="block")&&W()):(app.ui.mobileIntro.screenSize="desktop",$("#navThemeLeft").css("visibility","hidden"),$("#navThemeRight").css("visibility","hidden"),$("#mobileBookmarksCon").hide(),$("#paneLeft").height($("#contentPanel").height()-$("#tabs").height()),$("#header").height("110px"),$(".tilelist").height($("#paneLeft").height()-(app.isInBuilder?60:25)),$(".tilelist").css("top",app.isInBuilder?60:38),$("#paneLeft .noFeature").width($("#paneLeft").width()),$("#paneLeft").width()==app.cfg.LEFT_PANE_WIDTH_TWO_COLUMN?$("#paneLeft .noFeatureText").css("margin-left","50px"):$("#paneLeft .noFeatureText").css("margin-left","150px"),$("#map").height(e.height),$("#map").css("top",0),app.ui.navBar.resize(),e.width<=app.cfg.TWO_COLUMN_THRESHOLD||e.width<=1024&&e.height<=768?(setTimeout(function(){$("#map").width(e.width-(app.cfg.LEFT_PANE_WIDTH_TWO_COLUMN+16)),$("#map").css("left",app.cfg.LEFT_PANE_WIDTH_TWO_COLUMN+16),app.map&&app.map.resize(),m.selected&&!app.map.extent.contains(m.selected.geometry)&&app.mapTips.clean(!0)},0),app.ui.tilePanel.resize(app.cfg.LEFT_PANE_WIDTH_TWO_COLUMN),app.ui.detailPanel.resize(),app.isInBuilder&&app.detailPanelBuilder.resize()):e.width<=app.cfg.THREE_COLUMN_THRESHOLD&&e.width>=app.cfg.TWO_COLUMN_THRESHOLD?(setTimeout(function(){$("#map").width(e.width-(app.cfg.LEFT_PANE_WIDTH_THREE_COLUMN+16)),$("#map").css("left",app.cfg.LEFT_PANE_WIDTH_THREE_COLUMN+16),app.map&&app.map.resize()},0),app.ui.tilePanel.resize(app.cfg.LEFT_PANE_WIDTH_THREE_COLUMN),app.ui.detailPanel.resize(),app.isInBuilder&&app.detailPanelBuilder.resize()):(setTimeout(function(){$("#map").width(e.width-(app.cfg.LEFT_PANE_WIDTH_FOUR_COLUMN+16)),$("#map").css("left",app.cfg.LEFT_PANE_WIDTH_FOUR_COLUMN+16),app.map&&app.map.resize()},0),app.ui.tilePanel.resize(app.cfg.LEFT_PANE_WIDTH_FOUR_COLUMN),app.ui.detailPanel.resize(),app.isInBuilder&&app.detailPanelBuilder.resize())),T++},this.setMapExtent=function(e,t){return d.setMapExtent(e,t)},this.getLayoutExtent=function(e){return e},this.checkConfigFileIsOK=function(){return t.checkConfigFileIsOK()},this.appInitComplete=function(){this.updateUI(),d.cleanLoadingTimeout(),$(window).resize();var e=app.data.getWebAppData().isBlank()||app.data.getWebAppItem().access=="private";app.ui.headerDesktop&&app.ui.headerDesktop.toggleSocialBtnAppSharing(e),setTimeout(function(){if(app.data.getWebAppData().getTabs()&&app.data.getWebAppData().getTabs()[0]&&app.data.getWebAppData().getTabs()[0].extent){var e=new O(app.data.getWebAppData().getTabs()[0].extent);app.map.setExtent(e)}app.isDirectCreationFirstSave&&app.map.centerAndZoom([0,0],3),app.map.on("extent-change",function(){setTimeout(function(){app.data.getWebAppData().getGeneralOptions().filterByExtent&&!app.isInBuilder?(app.ui.tilePanel.refreshList(),app.ui.mobileFeatureList.refreshMobileList(),app.ui.detailPanel.loaded&&(app.ui.detailPanel.refreshSlides(),m.selected&&setTimeout(function(){app.ui.detailPanel.loaded&&app.ui.detailPanel.showDetails(m.selected)},0))):app.ui.detailPanel.loaded&&m.selected&&setTimeout(function(){app.ui.detailPanel.loaded&&app.ui.detailPanel.showDetails(m.selected)},0)},0)}),app.isDirectCreation||setTimeout(function(){d.displayApp()},500)},750),S.publish("tpl-ready")},this.onHashChange=function(){},this.prepareMobileViewSwitch=function(){},this.initLocalization=function(){}}}),define("lib-build/css!storymaps/common/builder/Builder",[],function(){}),define("lib-build/tpl!storymaps/common/builder/BuilderPanel",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<h3 class="appTitle"><!--'+((__t=title)==null?"":__t)+'--></h3>\r\n<div class="buttons btn-group">\r\n	<div class="builder-cmd builder-settings">'+((__t=btnSettings)==null?"":__t)+'</div>\r\n	<div class="builder-cmd builder-share" data-title="'+((__t=tooltipFirstSave)==null?"":__t)+'" data-placement="bottom">'+((__t=btnShare)==null?"":__t)+'</div>\r\n	<div class="builder-cmd builder-preview" data-title="'+((__t=tooltipNotShared)==null?"":__t)+'" data-placement="bottom">View Story</div>\r\n	<!--<div class="builder-cmd builder-preview" data-title="'+((__t=tooltipNotShared)==null?"":__t)+'" data-placement="bottom">'+((__t=btnPreview)==null?"":__t)+'</div>-->\r\n	<div class="builder-cmd builder-help">'+((__t=btnHelp)==null?"":__t)+'</div>\r\n</div>\r\n<div class="status-bar">\r\n	<div class="status-bar-info">\r\n		<span class="status-msg"></span>\r\n		<span class="status-btns">\r\n			<button class="btn btn-warning check-story"></button>\r\n			<button type="button" class="btn btn-default builder-save disabled" tabindex="-1">'+((__t=btnSave)==null?"":__t)+'</button>\r\n		</span>\r\n	</div>\r\n</div>\r\n<div class="builder-mask"></div>\r\n';return __p}}),define("lib-build/css!storymaps/common/builder/BuilderPanel",[],function(){}),define("lib-build/tpl!storymaps/common/builder/SaveErrorPopup",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="modal-dialog">\r\n	<div class="modal-content">\r\n		<div class="modal-logo"></div>\r\n		<div class="modal-header">\r\n			<h4 class="modal-title">'+((__t=title)==null?"":__t)+'</h4>\r\n		</div>\r\n\r\n		<div class="modal-body">\r\n			'+((__t=content)==null?"":__t)+'\r\n		</div>\r\n\r\n		<div class="modal-footer">\r\n			<button type="button" class="btn btn-primary" data-dismiss="modal">'+((__t=btnOk)==null?"":__t)+"</button>\r\n		</div>\r\n	</div>\r\n</div>";return __p}}),define("lib-build/css!storymaps/common/builder/SaveErrorPopup",[],function(){}),define("storymaps/common/builder/SaveErrorPopup",["lib-build/tpl!./SaveErrorPopup","lib-build/css!./SaveErrorPopup","../utils/CommonHelper","dojo/Deferred","dojo/i18n!commonResources/nls/core.js?v="+app.version],function(e,t,n,r,i){return function(n){n.append(e({title:i.commonCore.saveError.title,content:i.commonCore.saveError.err1Div1+"<br /><br />"+i.commonCore.saveError.err1Div2,btnOk:i.commonCore.saveError.btnOk})),this.present=function(){var e=new r;return n.on("hide.bs.modal",function(){e.resolve()}),n.modal({keyboard:!0}),e}}}),define("storymaps/common/builder/BuilderPanel",["lib-build/tpl!./BuilderPanel","lib-build/css!./BuilderPanel","dojo/i18n!commonResources/nls/core.js?v="+app.version,"storymaps/common/utils/CommonHelper","./SaveErrorPopup","dojo/topic"],function(e,t,n,r,i,s){return function(o,u,a,f){function p(){console.log("common.builder.Builder - save");if(o.find(".builder-save").hasClass("disabled")&&!app.isDirectCreationFirstSave)return;o.find(".builder-save").addClass("saving").html('<span class="small-loader"></span>'+n.commonCore.builderPanel.buttonSaving),S(!1);if(app.isDirectCreationFirstSave){var e=app.data.getWebAppData().getTitle(),t=app.data.getWebAppData().getSubtitle();if(!e){l.saveFailed("NONAME");return}app.portal.getPortalUser().getItems().then(function(r){var i=!1;r&&$.each(r,function(t,n){n.title&&n.title.toLowerCase()==e.toLowerCase()&&(i=!0)}),i?(o.find(".builder-save").removeClass("saving").html(n.commonCore.common.save),h.present().then(function(){app.appCfg.useStandardHeader?app.ui.headerDesktop.setTitleError():app.builder.openEditPopup({sectionIndex:0,displayTab:"main-stage"})})):a(e,t)})}else if(app.migration||app.appCfg.useWebmapInApp&&app.isGalleryCreation)f();else{var r="",i="";app.data.getWebAppData().getTitle()&&(r=app.data.getWebAppData().getTitle().trim()),app.data.getWebAppItem()&&app.data.getWebAppItem().title&&(i=app.data.getWebAppItem().title.trim());if(!app.builder.titleMatchOnLoad&&app.data.getWebAppItem().access=="public"&&r!=i)app.builder.titleMatchDialogDisplayed?u(app.builder.titleFromItem):(app.builder.titleMatchDialogDisplayed=!0,u(app.builder.titleFromItem));else{var s=!1;u(s)}}}function d(){b(),c.openSettingPopup(!1)}function v(){b(),s.publish("OPEN_HELP")}function m(){$(this).hasClass("disabled")||window.open(r.getAppViewModeURL(),"_blank")}function g(){$(this).hasClass("disabled")||app.builder.openSharePopup(!1)}function y(){o.find(".save-counter").removeClass("pendingChanges").html(n.commonCore.builderPanel.noPendingChange),o.find(".builder-save").addClass("disabled")}function b(){o.find(".builder-save").tooltip("hide")}function w(){var e="#"+o.attr("id");o.find(".builder-save").tooltip("destroy"),o.find(".builder-save").tooltip({html:!0,trigger:"manual",placement:"left",title:'<script>$("'+e+' .builder-save").next(".tooltip").addClass("save-fail-popover");'+'$("'+e+' .builder-save").next(".tooltip").find(".stepHidden").css("display", "none");'+"</script>"+'<div class="stepHidden stepFailed" style="color: red; width: 180px;">'+""+" "+'<button type="button" class="btn btn-xs" onclick="app.builder.hideSaveConfirmation()" style="vertical-align: 1px;">close</button> '+"</div>"+'<div class="stepHidden stepFailed2" style="color: red; width: 180px;">'+""+" "+'<button type="button" class="btn btn-default btn-xs" onclick="app.builder.hideSaveConfirmation()" style="vertical-align: 1px;">ok</button> '+"</div>"+'<div class="stepHidden stepFailed3" style="color: red; width: 180px;">'+"Please enter a title for your Shortlist"+" "+'<button type="button" class="btn btn-default btn-xs btn-danger" onclick="app.builder.hideSaveConfirmation()" style="vertical-align: 1px;">ok</button> '+"</div>"})}function E(){o.find(".builder-save").tooltip("hide")}function S(e){o.find(".builder-cmd").attr("disabled",!e),l.resize()}function x(){o.find(".status-msg").show(),app.isDirectCreationFirstSave||app.isGalleryCreation?o.find(".status-msg").html(n.commonCore.builderPanel.status6):app.mystories&&app.mystories.hasCheckErrors?app.data.getWebAppItem().access=="public"?o.find(".status-msg").html(n.commonCore.builderPanel.status1):app.data.getWebAppItem().access=="account"?o.find(".status-msg").html(n.commonCore.builderPanel.status1):o.find(".status-msg").html(n.commonCore.builderPanel.status2):app.data.getWebAppItem().access=="public"?o.find(".status-msg").html(n.commonCore.builderPanel.status3):app.data.getWebAppItem().access=="account"?o.find(".status-msg").html(n.commonCore.builderPanel.status4):o.find(".status-msg").html(n.commonCore.builderPanel.status5),l.resize()}function T(){app.builder.openSharePopup()}function N(e){var t=o.find(".check-story");app.data.getStoryLength()?e=="start"?(t.html('<span class="small-loader"></span>'+n.commonCore.builderPanel.checking).show().css("cursor","default").off("click"),o.find(".status-msg").hide()):e=="error"?(t.html(n.commonCore.builderPanel.fix).show().css("cursor","pointer").click(T),l.updateSharingStatus()):(t.hide(),l.updateSharingStatus()):t.hide()}function C(){}o.append(e({title:n.commonCore.builderPanel.panelHeader.replace("%TPL_NAME%",app.cfg.TPL_NAME),btnSave:n.commonCore.common.save,btnShare:n.commonCore.builderPanel.buttonShare,btnSettings:n.commonCore.builderPanel.buttonSettings,btnHelp:n.commonCore.builderPanel.buttonHelp,btnPreview:n.commonCore.builderPanel.buttonPreview,tooltipFirstSave:n.commonCore.builderPanel.tooltipFirstSave,tooltipNotShared:n.commonCore.builderPanel.tooltipNotShared,saveCounter:n.commonCore.builderPanel.noPendingChange}));var l=this,c=null,h=null;this.init=function(e){c=e,h=new i($("#saveErrorPopup")),C(),o.removeClass("hide"),app.builder.hideSaveConfirmation=E,o.find(".builder-save").click(p),o.find(".builder-share").click(g),o.find(".builder-settings").click(d),o.find(".builder-help").click(v),o.find(".builder-preview").click(m),$(window).bind("keydown",function(e){(e.ctrlKey||e.metaKey)&&String.fromCharCode(e.which).toLowerCase()=="s"&&!o.find(".builder-save").attr("disabled")&&!app.initScreenIsOpen&&(e.preventDefault(),p())}),w(),s.subscribe("MYSTORIES_SCAN",N),s.subscribe("INCREMENT_SAVE_COUNTER",l.incrementSaveCounter),N("start")},this.saveSucceeded=function(){(app.isDirectCreationFirstSave||app.isGalleryCreation)&&app.builder.openSharePopup(!0),y(),S(!0),o.find(".builder-save").html('<span class="glyphicon glyphicon-ok"></span> '+n.commonCore.builderPanel.buttonSaved),setTimeout(function(){o.find(".builder-save").removeClass("saving").html(n.commonCore.common.save)},3500)},this.saveFailed=function(e,t){o.find(".builder-save").removeClass("saving").html(n.commonCore.common.save),o.find(".builder-save").tooltip("show");if(e=="NONAME"){o.find(".builder-save").next(".tooltip").find(".stepFailed3").css("display","block"),$("#headerDesktop .title").addClass("titleEmpty"),o.find(".builder-save").attr("disabled",!1),o.find(".builder-settings").attr("disabled",!1),o.find(".builder-help").attr("disabled",!1);return}o.find(".builder-save").next(".tooltip").find(".stepFailed").css("display","block"),S(!0)},this.hasPendingChange=function(){return!o.find(".builder-save").hasClass("disabled")},this.incrementSaveCounter=function(){var e="";e=n.commonCore.builderPanel.unSavedChangePlural,o.find(".save-counter").addClass("pendingChanges").html(e),o.find(".builder-save").toggleClass("disabled",!app.data.getWebAppData().getTitle()),app.isDirectCreationFirstSave&&o.find(".status-bar").removeClass("hideCounterAndSharing")},this.updateSharingStatus=function(){var e=app.isDirectCreationFirstSave||app.isGalleryCreation,t=app.data.getWebAppData().getTitle(),r=app.data.getWebAppItem().access=="private";o.find(".builder-share").toggleClass("disabled",e),o.find(".builder-preview").toggleClass("disabled",t||!r),e?o.find(".builder-share").tooltip({trigger:"hover"}):o.find(".builder-share").tooltip("destroy"),e?o.find(".builder-preview").addClass("disabled").tooltip({trigger:"hover",title:n.commonCore.builderPanel.tooltipFirstSave}):t||r?o.find(".builder-preview").tooltip({trigger:"hover",title:n.commonCore.builderPanel.tooltipNotShared}):o.find(".builder-preview").tooltip("destroy"),app.ui.headerDesktop&&app.ui.headerDesktop.toggleSocialBtnAppSharing(t),x()},this.resize=function(){o.find(".status-msg").css("max-width",$(window).width()-(o.find(".buttons").position().left+o.find(".buttons").outerWidth()+o.find(".status-btns").outerWidth()+20))}}}),define("lib-build/tpl!storymaps/common/builder/settings/SettingsPopup",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="modal-dialog">\r\n	<div class="modal-content">\r\n		<div class="modal-logo"></div>\r\n		<div class="modal-header">\r\n			<h3 class="modal-title"></h3>\r\n		</div>\r\n		<ul class="settingsPopupHeader modal-tabs nav nav-tabs">\r\n			<!-- Tab injected here -->\r\n		</ul>\r\n		<div class="modal-body">\r\n			<!-- Views injected here -->\r\n		</div>\r\n		<div class="modal-footer">\r\n			<span class="error"></span>\r\n			<button class="btnSave btn btn-primary" data-dismiss="modal"></button>\r\n			<button class="btnClose btn btn-naked btn-close" data-dismiss="modal" aria-hidden="true"></button>\r\n		</div>\r\n	</div>\r\n</div>';return __p}}),define("lib-build/css!storymaps/common/builder/settings/SettingsPopup",[],function(){}),define("storymaps/common/builder/settings/SettingsPopup",["lib-build/tpl!./SettingsPopup","lib-build/css!./SettingsPopup","storymaps/common/utils/CommonHelper","dojo/topic"],function(e,t,n,r){var i=null;return function(s){function c(){if($(this).hasClass("disabled"))return;p($(this).index())}function h(){var e=[],t=-1;$.each(o,function(n,r){var i=r.save();i===!1&&(t=n),e.push(i)});if(t!=-1)return p(t),!1;r.publish("SETTINGS_POPUP_SAVE",{settings:e})}function p(e){u.removeClass("active disabled"),a.hide(),u.eq(e).addClass("active"),o[e].show(),a.eq(e).show(),i=e}s.append(e({}));var o=[],u=null,a=s.find(".tab-content"),f=s.find(".btnSave"),l=s.find(".btnClose");this.init=function(e){o=e.getSettingsTab(),s.find(".settingsPopupHeader").empty(),s.find(".modal-body").empty(),$.each(o,function(){s.find(".settingsPopupHeader").append('<li class="tab"><a></a></li>'),s.find(".modal-body").append('<div class="tab-content"></div>')}),u=s.find(".tab"),a=s.find(".tab-content"),$.each(o,function(e,t){t.init(u.eq(e).find("a"),a.eq(e)),t.initLocalization()}),u.click(c),f.click(h)},this.present=function(e,t){var r=0,a=!app.isProduction&&n.getUrlParams().debugParam?n.getUrlParams().debugParam:null;u.removeClass("disabled"),l.removeAttr("disabled"),$(".error-msg",s).hide(),$(".modal-header .close",s).attr("data-dismiss","modal"),$(".modal-footer .error",s).hide(),$.each(o,function(n,r){r.present(e[n],n==t)}),t?r=t:a?r=a:i&&(r=i),p(r),t&&(u.addClass("disabled"),u.eq(t).removeClass("disabled"),l.attr("disabled","disabled"),$(".modal-header .close",s).attr("data-dismiss","none")),s.modal({keyboard:!t})},this.initLocalization=function(){s.find(".modal-title").html(i18n.commonCore.settings.header),s.find(".btnClose").html(i18n.commonCore.common.cancel),s.find(".btnSave").html(i18n.commonCore.common.apply),s.find(".error").html(i18n.commonCore.settings.tabError)}}}),define("storymaps/common/builder/BuilderHelper",[],function(){return{getNewLayerJSON:function(e){return{id:"shortlist-layer"+(new Date).getTime(),title:"Shortlist layer",visibility:!0,opacity:1,featureCollection:{layers:[e],showLegend:!0}}},getFeatureCollectionTemplate:function(e){var t={layerDefinition:null,featureSet:{features:[],geometryType:"esriGeometryPoint"}};return t.layerDefinition={geometryType:"esriGeometryPoint",objectIdField:"__OBJECTID",name:"Shortlist-layer",type:"Feature Layer",typeIdField:"",drawingInfo:{renderer:{type:"simple",symbol:{type:"esriPMS",url:"http://static.arcgis.com/images/Symbols/Basic/RedSphere.png",imageData:"iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAGXRFWHRTb2Z0d2FyZQBQYWludC5ORVQgdjMuNS4xTuc4+QAAB3VJREFUeF7tmPlTlEcexnve94U5mANQbgQSbgiHXHINlxpRIBpRI6wHorLERUmIisKCQWM8cqigESVQS1Kx1piNi4mW2YpbcZONrilE140RCTcy3DDAcL/zbJP8CYPDL+9Ufau7uqb7eZ7P+/a8PS8hwkcgIBAQCAgEBAICAYGAQEAgIBAQCAgEBAICAYGAQEAgIBAQCDx/AoowKXFMUhD3lQrioZaQRVRS+fxl51eBTZUTdZ41U1Rox13/0JF9csGJ05Qv4jSz/YPWohtvLmSKN5iTGGqTm1+rc6weICOBRbZs1UVnrv87T1PUeovxyNsUP9P6n5cpHtCxu24cbrmwKLdj+osWiqrVKhI0xzbmZ7m1SpJ+1pFpvE2DPvGTomOxAoNLLKGLscZYvB10cbYYjrJCb7A5mrxleOBqim+cWJRakZY0JfnD/LieI9V1MrKtwokbrAtU4Vm0A3TJnphJD4B+RxD0u0LA7w7FTE4oprOCMbklEGNrfdGf4IqnQTb4wc0MFTYibZqM7JgjO8ZdJkpMln/sKu16pHZGb7IfptIWg389DPp9kcChWODoMuDdBOhL1JgpisbUvghM7AqFbtNiaFP80RLnhbuBdqi0N+1dbUpWGde9gWpuhFi95yL7sS7BA93JAb+Fn8mh4QujgPeTgb9kAZf3Apd2A+fXQ38yHjOHozB1IAJjOSEY2RSIwVUv4dd4X9wJccGHNrJ7CYQ4GGjLeNNfM+dyvgpzQstKf3pbB2A6m97uBRE0/Ergcxr8hyqg7hrwn0vAtRIKIRX6Y2pMl0RhIj8co9nBGFrvh55l3ngU7YObng7IVnFvGS+BYUpmHziY/Ls2zgP9SX50by/G9N5w6I+ogYvpwK1SoOlHQNsGfWcd9Peqof88B/rTyzF9hAIopAByQzC0JQB9ST5oVnvhnt+LOGsprvUhxNIwa0aY7cGR6Cp7tr8+whkjawIxkRWC6YJI6N+lAKq3Qf/Tx+B77oGfaQc/8hB8w2Xwtw9Bf3kzZspXY/JIDEbfpAB2BKLvVV90Jvjgoac9vpRxE8kciTVCBMMkNirJ7k/tRHyjtxwjKV4Yp3t/6s+R4E+/DH3N6+BrS8E314Dvvg2+/Sb4hxfBf5sP/up2TF3ZhonK1zD6dhwGdwail26DzqgX8MRKiq9ZBpkSkmeYOyPM3m9Jjl+1Z9D8AgNtlAq6bZ70qsZi+q+bwV/7I/hbB8D/dAr8Axq89iz474p/G5++koHJy1sx/lkGdBc2YjA3HF0rHNHuboomuQj/5DgclIvOGCGCYRKFFuTMV7YUAD3VDQaLMfyqBcZORGPy01QKYSNm/rYV/Nd/Av9NHvgbueBrsjDzRQamKKDxT9Kgq1iLkbIUDOSHoiNcgnYHgnYZi+9ZExSbiSoMc2eE2flKcuJLa4KGRQz6/U0wlGaP0feiMH4uFpMXEjBVlYjp6lWY+SSZtim0kulYMiYuJEJXuhTDJ9UYPByOvoIwdCxfgE4bAo0Jh39xLAoVpMwIEQyTyFCQvGpLon9sJ0K3J4OBDDcMH1dj9FQsxkrjMPFRPCbOx2GyfLal9VEcxstioTulxjAFNfROJPqLl6Bnfyg6V7ugz5yBhuHwrZjBdiU5YJg7I8wOpifAKoVIW7uQ3rpOBH2b3ekVjYT2WCRG3o+mIGKgO0OrlIaebU/HYOQDNbQnojB4NJyGD0NPfjA0bwTRE6Q7hsUcWhkWN8yZqSQlWWGECAZLmJfJmbrvVSI8taK37xpbdB/wQW8xPee/8xIGjvlj8IQ/hk4G0JbWcX8MHPVDX4kveoq8ocn3xLM33NCZRcPHOGJYZIKfpQyq7JjHS6yJjcHujLHADgkpuC7h8F8zEVqXSNC2awE69lqhs8AamkO26HrbDt2H7dBVQov2NcW26CiwQtu+BWjdY4n2nZboTbfCmKcCnRyDO/YmyLPnDlHvjDH8G6zhS9/wlEnYR7X00fWrFYuWdVI0ZpuhcbcczW/R2qdAcz6t/bRov4mONeaaoYl+p22rHF0bVNAmKtBvweIXGxNcfFH8eNlC4m6wMWMusEnKpn5hyo48pj9gLe4SNG9QoGGLAk8z5XiaJUd99u8122/IpBA2K9BGg2vWWKAvRYVeLzEa7E1R422m2+MsSTem97nSYnfKyN6/mzATv7AUgqcMrUnmaFlLX3ysM0fj+t/b5lQLtK22QEfyAmiSLKFZpUJ7kBRPXKW4HqCYynWVHKSG2LkyZex1uO1mZM9lKem9Tx9jjY5iNEYo0bKMhn7ZAu0r6H5PpLXCAq0rKJClSjSGynE/QIkrQYqBPe6S2X+AJsY2Ped6iWZk6RlL0c2r5szofRsO9R5S1IfQLRCpQL1aifoYFerpsbkuTImaUJXuXIDiH6/Ys8vm3Mg8L2i20YqsO7fItKLcSXyn0kXccclVqv3MS6at9JU/Ox+ouns+SF6Z4cSupz7l8+z1ucs7LF1AQjOdxfGZzmx8Iu1TRcfnrioICAQEAgIBgYBAQCAgEBAICAQEAgIBgYBAQCAgEBAICAQEAv8H44b/6ZiGvGAAAAAASUVORK5CYII=",contentType:"image/png",width:15,height:15}}},fields:[{name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1,domain:null}],types:[],capabilities:"Query"},e?t.layerDefinition.fields=[{name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1,domain:null},{name:"name",type:"esriFieldTypeString",alias:"Name",domain:null,editable:!0,nullable:!0,length:254},{name:"description",type:"esriFieldTypeString",alias:"Description",domain:null,editable:!0,nullable:!0,length:1e3},{name:"pic_url",type:"esriFieldTypeString",alias:"Picture URL",domain:null,editable:!0,nullable:!0,length:254},{name:"thumb_url",type:"esriFieldTypeString",alias:"Thumbnail URL",domain:null,editable:!0,nullable:!0,length:254},{name:"website",type:"esriFieldTypeString",alias:"Website",domain:null,editable:!0,nullable:!0,length:254},{name:"shortlist_id",type:"esriFieldTypeInteger",alias:"Shortlist Id",domain:null,editable:!0,nullable:!0,length:254},{name:"number",type:"esriFieldTypeInteger",alias:"Number",domain:null,editable:!0,nullable:!0,length:254},{name:"tab_id",type:"esriFieldTypeInteger",alias:"Tab index",domain:null,editable:!0,nullable:!0,length:254},{name:"set",type:"esriFieldTypeInteger",alias:"Location Set",domain:null,editable:!0,nullable:!0,length:254}]:t.layerDefinition.fields=[{name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1,domain:null}],t},serializeGraphicsLayerToFeatureCollection:function(e,t,n){var r={layers:[{featureSet:{features:[],geometryType:e.geometryType},layerDefinition:{geometryType:e.geometryType,objectIdField:e.objectIdField,name:e.name,type:e.type,typeIdField:e.typeIdField,drawingInfo:{renderer:{type:"simple",symbol:{type:"esriPMS",url:"http://static.arcgis.com/images/Symbols/Basic/RedSphere.png",imageData:"iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAGXRFWHRTb2Z0d2FyZQBQYWludC5ORVQgdjMuNS4xTuc4+QAAB3VJREFUeF7tmPlTlEcexnve94U5mANQbgQSbgiHXHINlxpRIBpRI6wHorLERUmIisKCQWM8cqigESVQS1Kx1piNi4mW2YpbcZONrilE140RCTcy3DDAcL/zbJP8CYPDL+9Ufau7uqb7eZ7P+/a8PS8hwkcgIBAQCAgEBAICAYGAQEAgIBAQCAgEBAICAYGAQEAgIBAQCDx/AoowKXFMUhD3lQrioZaQRVRS+fxl51eBTZUTdZ41U1Rox13/0JF9csGJ05Qv4jSz/YPWohtvLmSKN5iTGGqTm1+rc6weICOBRbZs1UVnrv87T1PUeovxyNsUP9P6n5cpHtCxu24cbrmwKLdj+osWiqrVKhI0xzbmZ7m1SpJ+1pFpvE2DPvGTomOxAoNLLKGLscZYvB10cbYYjrJCb7A5mrxleOBqim+cWJRakZY0JfnD/LieI9V1MrKtwokbrAtU4Vm0A3TJnphJD4B+RxD0u0LA7w7FTE4oprOCMbklEGNrfdGf4IqnQTb4wc0MFTYibZqM7JgjO8ZdJkpMln/sKu16pHZGb7IfptIWg389DPp9kcChWODoMuDdBOhL1JgpisbUvghM7AqFbtNiaFP80RLnhbuBdqi0N+1dbUpWGde9gWpuhFi95yL7sS7BA93JAb+Fn8mh4QujgPeTgb9kAZf3Apd2A+fXQ38yHjOHozB1IAJjOSEY2RSIwVUv4dd4X9wJccGHNrJ7CYQ4GGjLeNNfM+dyvgpzQstKf3pbB2A6m97uBRE0/Ergcxr8hyqg7hrwn0vAtRIKIRX6Y2pMl0RhIj8co9nBGFrvh55l3ngU7YObng7IVnFvGS+BYUpmHziY/Ls2zgP9SX50by/G9N5w6I+ogYvpwK1SoOlHQNsGfWcd9Peqof88B/rTyzF9hAIopAByQzC0JQB9ST5oVnvhnt+LOGsprvUhxNIwa0aY7cGR6Cp7tr8+whkjawIxkRWC6YJI6N+lAKq3Qf/Tx+B77oGfaQc/8hB8w2Xwtw9Bf3kzZspXY/JIDEbfpAB2BKLvVV90Jvjgoac9vpRxE8kciTVCBMMkNirJ7k/tRHyjtxwjKV4Yp3t/6s+R4E+/DH3N6+BrS8E314Dvvg2+/Sb4hxfBf5sP/up2TF3ZhonK1zD6dhwGdwail26DzqgX8MRKiq9ZBpkSkmeYOyPM3m9Jjl+1Z9D8AgNtlAq6bZ70qsZi+q+bwV/7I/hbB8D/dAr8Axq89iz474p/G5++koHJy1sx/lkGdBc2YjA3HF0rHNHuboomuQj/5DgclIvOGCGCYRKFFuTMV7YUAD3VDQaLMfyqBcZORGPy01QKYSNm/rYV/Nd/Av9NHvgbueBrsjDzRQamKKDxT9Kgq1iLkbIUDOSHoiNcgnYHgnYZi+9ZExSbiSoMc2eE2flKcuJLa4KGRQz6/U0wlGaP0feiMH4uFpMXEjBVlYjp6lWY+SSZtim0kulYMiYuJEJXuhTDJ9UYPByOvoIwdCxfgE4bAo0Jh39xLAoVpMwIEQyTyFCQvGpLon9sJ0K3J4OBDDcMH1dj9FQsxkrjMPFRPCbOx2GyfLal9VEcxstioTulxjAFNfROJPqLl6Bnfyg6V7ugz5yBhuHwrZjBdiU5YJg7I8wOpifAKoVIW7uQ3rpOBH2b3ekVjYT2WCRG3o+mIGKgO0OrlIaebU/HYOQDNbQnojB4NJyGD0NPfjA0bwTRE6Q7hsUcWhkWN8yZqSQlWWGECAZLmJfJmbrvVSI8taK37xpbdB/wQW8xPee/8xIGjvlj8IQ/hk4G0JbWcX8MHPVDX4kveoq8ocn3xLM33NCZRcPHOGJYZIKfpQyq7JjHS6yJjcHujLHADgkpuC7h8F8zEVqXSNC2awE69lqhs8AamkO26HrbDt2H7dBVQov2NcW26CiwQtu+BWjdY4n2nZboTbfCmKcCnRyDO/YmyLPnDlHvjDH8G6zhS9/wlEnYR7X00fWrFYuWdVI0ZpuhcbcczW/R2qdAcz6t/bRov4mONeaaoYl+p22rHF0bVNAmKtBvweIXGxNcfFH8eNlC4m6wMWMusEnKpn5hyo48pj9gLe4SNG9QoGGLAk8z5XiaJUd99u8122/IpBA2K9BGg2vWWKAvRYVeLzEa7E1R422m2+MsSTem97nSYnfKyN6/mzATv7AUgqcMrUnmaFlLX3ysM0fj+t/b5lQLtK22QEfyAmiSLKFZpUJ7kBRPXKW4HqCYynWVHKSG2LkyZex1uO1mZM9lKem9Tx9jjY5iNEYo0bKMhn7ZAu0r6H5PpLXCAq0rKJClSjSGynE/QIkrQYqBPe6S2X+AJsY2Ped6iWZk6RlL0c2r5szofRsO9R5S1IfQLRCpQL1aifoYFerpsbkuTImaUJXuXIDiH6/Ys8vm3Mg8L2i20YqsO7fItKLcSXyn0kXccclVqv3MS6at9JU/Ox+ouns+SF6Z4cSupz7l8+z1ucs7LF1AQjOdxfGZzmx8Iu1TRcfnrioICAQEAgIBgYBAQCAgEBAICAQEAgIBgYBAQCAgEBAICAQEAv8H44b/6ZiGvGAAAAAASUVORK5CYII=",contentType:"image/png",width:15,height:15}}},fields:[{name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1,domain:null},{name:"name",type:"esriFieldTypeString",alias:"Name",domain:null,editable:!0,nullable:!0,length:254},{name:"description",type:"esriFieldTypeString",alias:"Description",domain:null,editable:!0,nullable:!0,length:1e3},{name:"pic_url",type:"esriFieldTypeString",alias:"Picture URL",domain:null,editable:!0,nullable:!0,length:254},{name:"thumb_url",type:"esriFieldTypeString",alias:"Thumbnail URL",domain:null,editable:!0,nullable:!0,length:254},{name:"website",type:"esriFieldTypeString",alias:"Website",domain:null,editable:!0,nullable:!0,length:254},{name:"shortlist_id",type:"esriFieldTypeInteger",alias:"Shortlist Id",domain:null,editable:!0,nullable:!0,length:254},{name:"number",type:"esriFieldTypeInteger",alias:"Number",domain:null,editable:!0,nullable:!0,length:254},{name:"tab_id",type:"esriFieldTypeInteger",alias:"Tab index",domain:null,editable:!0,nullable:!0,length:254},{name:"set",type:"esriFieldTypeInteger",alias:"Location Set",domain:null,editable:!0,nullable:!0,length:254}],types:[],capabilities:e.capabilities}}],showLegend:!0};return $.each(e.fields,function(e,t){r.layers[0].layerDefinition.fields.push({name:t.name,alias:t.alias,type:t.type,editable:t.editable,domain:null})}),$.each(n,function(e,t){r.layers[0].featureSet.features.push({attributes:t.attributes,geometry:t.geometry})}),r},getBlankAppJSON:function(){return{itemType:"text",guid:null,name:null,type:"Web Mapping Application",typeKeywords:app.cfg.WEBAPP_KEYWORD_GENERIC.concat(app.cfg.WEBAPP_KEYWORD_APP),description:null,tags:app.cfg.WEBAPP_TAG,snippet:null,thumbnail:"thumbnail/ago_downloaded.png",documentation:null,extent:[],lastModified:-1,spatialReference:null,accessInformation:null,licenseInfo:null,culture:"en-us",properties:null,size:116,appCategories:[],industries:[],languages:[],largeThumbnail:null,banner:null,screenshots:[],listed:!1,ownerFolder:null,commentsEnabled:!0,numComments:0,numRatings:0,avgRating:0,numViews:1}},getBlankWebmapJSON:function(){return{item:{id:"",guid:null,name:null,type:"Web Map",typeKeywords:["ArcGIS Online","Explorer Web Map","Map","Online Map","Web Map","Story Maps","Shortlist"],description:null,tags:["map"],snippet:null,thumbnail:"thumbnail/ago_downloaded.png",documentation:null,extent:[[-180,-90],[180,90]],spatialReference:null,accessInformation:null,licenseInfo:null,culture:"en-us",properties:null,url:null,size:233,appCategories:[],industries:[],languages:[],largeThumbnail:null,banner:null,screenshots:[],listed:!1,ownerFolder:null,commentsEnabled:!0,numComments:0,numRatings:0,avgRating:0,numViews:1},itemData:{operationalLayers:[],baseMap:{baseMapLayers:[{id:"defaultBasemap",opacity:1,visibility:!0,url:"http://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Light_Gray_Base/MapServer"}],title:"Topographic"},version:"1.9"}}}}}),define("storymaps/common/utils/WebMapHelper",["esri/request","esri/renderers/jsonUtils","dojo/Deferred","dojo/_base/lang","dojo/_base/array"],function(e,t,n,r,i){return{findLayerTypeById:function(e,t){var n="";return i.forEach(e.operationalLayers,function(e){e.id==t&&(n=e.type)}),n},saveWebmap:function(e,t){var i=new n;this.prepareWebmapItemForCloning(e);var s=r.clone(e.item),o=r.clone(e.itemData);s.tags=s.tags?s.tags.join(","):"",s.typeKeywords=s.typeKeywords?s.typeKeywords.join(","):"";var u=t.getPortalUser(),a=this.getSharingURL(t)+"content/users/"+u.credential.userId+(s.ownerFolder?"/"+s.ownerFolder:"")+"/addItem",f={item:s.item,title:s.title,tags:s.tags,extent:JSON.stringify(s.extent),text:JSON.stringify(o),type:s.type,typeKeywords:s.typeKeywords,overwrite:!0,thumbnailURL:s.thumbnailURL};return this.request(a,f,!0).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i},serializeGraphicsLayerToFeatureCollection:function(e){return this._serializeGraphicsLayerToFeatureCollection(e,e.visible,e.graphics)},_serializeGraphicsLayerToFeatureCollection:function(e,t,n){var r={layers:[{featureSet:{features:[],geometryType:e.geometryType},id:e.id,layerDefinition:{geometryType:e.geometryType,objectIdField:e.objectIdField,name:e.name,type:e.type,typeIdField:e.typeIdField,drawingInfo:{renderer:{type:"simple",symbol:{type:"esriPMS",url:"http://static.arcgis.com/images/Symbols/Basic/RedSphere.png",imageData:"iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAGXRFWHRTb2Z0d2FyZQBQYWludC5ORVQgdjMuNS4xTuc4+QAAB3VJREFUeF7tmPlTlEcexnve94U5mANQbgQSbgiHXHINlxpRIBpRI6wHorLERUmIisKCQWM8cqigESVQS1Kx1piNi4mW2YpbcZONrilE140RCTcy3DDAcL/zbJP8CYPDL+9Ufau7uqb7eZ7P+/a8PS8hwkcgIBAQCAgEBAICAYGAQEAgIBAQCAgEBAICAYGAQEAgIBAQCDx/AoowKXFMUhD3lQrioZaQRVRS+fxl51eBTZUTdZ41U1Rox13/0JF9csGJ05Qv4jSz/YPWohtvLmSKN5iTGGqTm1+rc6weICOBRbZs1UVnrv87T1PUeovxyNsUP9P6n5cpHtCxu24cbrmwKLdj+osWiqrVKhI0xzbmZ7m1SpJ+1pFpvE2DPvGTomOxAoNLLKGLscZYvB10cbYYjrJCb7A5mrxleOBqim+cWJRakZY0JfnD/LieI9V1MrKtwokbrAtU4Vm0A3TJnphJD4B+RxD0u0LA7w7FTE4oprOCMbklEGNrfdGf4IqnQTb4wc0MFTYibZqM7JgjO8ZdJkpMln/sKu16pHZGb7IfptIWg389DPp9kcChWODoMuDdBOhL1JgpisbUvghM7AqFbtNiaFP80RLnhbuBdqi0N+1dbUpWGde9gWpuhFi95yL7sS7BA93JAb+Fn8mh4QujgPeTgb9kAZf3Apd2A+fXQ38yHjOHozB1IAJjOSEY2RSIwVUv4dd4X9wJccGHNrJ7CYQ4GGjLeNNfM+dyvgpzQstKf3pbB2A6m97uBRE0/Ergcxr8hyqg7hrwn0vAtRIKIRX6Y2pMl0RhIj8co9nBGFrvh55l3ngU7YObng7IVnFvGS+BYUpmHziY/Ls2zgP9SX50by/G9N5w6I+ogYvpwK1SoOlHQNsGfWcd9Peqof88B/rTyzF9hAIopAByQzC0JQB9ST5oVnvhnt+LOGsprvUhxNIwa0aY7cGR6Cp7tr8+whkjawIxkRWC6YJI6N+lAKq3Qf/Tx+B77oGfaQc/8hB8w2Xwtw9Bf3kzZspXY/JIDEbfpAB2BKLvVV90Jvjgoac9vpRxE8kciTVCBMMkNirJ7k/tRHyjtxwjKV4Yp3t/6s+R4E+/DH3N6+BrS8E314Dvvg2+/Sb4hxfBf5sP/up2TF3ZhonK1zD6dhwGdwail26DzqgX8MRKiq9ZBpkSkmeYOyPM3m9Jjl+1Z9D8AgNtlAq6bZ70qsZi+q+bwV/7I/hbB8D/dAr8Axq89iz474p/G5++koHJy1sx/lkGdBc2YjA3HF0rHNHuboomuQj/5DgclIvOGCGCYRKFFuTMV7YUAD3VDQaLMfyqBcZORGPy01QKYSNm/rYV/Nd/Av9NHvgbueBrsjDzRQamKKDxT9Kgq1iLkbIUDOSHoiNcgnYHgnYZi+9ZExSbiSoMc2eE2flKcuJLa4KGRQz6/U0wlGaP0feiMH4uFpMXEjBVlYjp6lWY+SSZtim0kulYMiYuJEJXuhTDJ9UYPByOvoIwdCxfgE4bAo0Jh39xLAoVpMwIEQyTyFCQvGpLon9sJ0K3J4OBDDcMH1dj9FQsxkrjMPFRPCbOx2GyfLal9VEcxstioTulxjAFNfROJPqLl6Bnfyg6V7ugz5yBhuHwrZjBdiU5YJg7I8wOpifAKoVIW7uQ3rpOBH2b3ekVjYT2WCRG3o+mIGKgO0OrlIaebU/HYOQDNbQnojB4NJyGD0NPfjA0bwTRE6Q7hsUcWhkWN8yZqSQlWWGECAZLmJfJmbrvVSI8taK37xpbdB/wQW8xPee/8xIGjvlj8IQ/hk4G0JbWcX8MHPVDX4kveoq8ocn3xLM33NCZRcPHOGJYZIKfpQyq7JjHS6yJjcHujLHADgkpuC7h8F8zEVqXSNC2awE69lqhs8AamkO26HrbDt2H7dBVQov2NcW26CiwQtu+BWjdY4n2nZboTbfCmKcCnRyDO/YmyLPnDlHvjDH8G6zhS9/wlEnYR7X00fWrFYuWdVI0ZpuhcbcczW/R2qdAcz6t/bRov4mONeaaoYl+p22rHF0bVNAmKtBvweIXGxNcfFH8eNlC4m6wMWMusEnKpn5hyo48pj9gLe4SNG9QoGGLAk8z5XiaJUd99u8122/IpBA2K9BGg2vWWKAvRYVeLzEa7E1R422m2+MsSTem97nSYnfKyN6/mzATv7AUgqcMrUnmaFlLX3ysM0fj+t/b5lQLtK22QEfyAmiSLKFZpUJ7kBRPXKW4HqCYynWVHKSG2LkyZex1uO1mZM9lKem9Tx9jjY5iNEYo0bKMhn7ZAu0r6H5PpLXCAq0rKJClSjSGynE/QIkrQYqBPe6S2X+AJsY2Ped6iWZk6RlL0c2r5szofRsO9R5S1IfQLRCpQL1aifoYFerpsbkuTImaUJXuXIDiH6/Ys8vm3Mg8L2i20YqsO7fItKLcSXyn0kXccclVqv3MS6at9JU/Ox+ouns+SF6Z4cSupz7l8+z1ucs7LF1AQjOdxfGZzmx8Iu1TRcfnrioICAQEAgIBgYBAQCAgEBAICAQEAgIBgYBAQCAgEBAICAQEAv8H44b/6ZiGvGAAAAAASUVORK5CYII=",contentType:"image/png",width:15,height:15}}},fields:[],types:[],capabilities:e.capabilities},layerObject:null,opacity:e.opacity,visibility:t}],showLegend:!0};return $.each(e.fields,function(e,t){r.layers[0].layerDefinition.fields.push({name:t.name,alias:t.alias,type:t.type,editable:t.editable,domain:null})}),$.each(n,function(e,t){r.layers[0].featureSet.features.push({attributes:t.attributes,geometry:t.geometry})}),r},request:function(t,n,i,s){var o=i||!1;return n=n||{},s=s||"",e({url:t,content:r.mixin(n,{f:"json",token:s}),callbackParamName:"callback",handleAs:"json"},{usePost:o})},prepareWebmapItemForCloning:function(e){i.forEach(e.itemData.baseMap.baseMapLayers,function(e){delete e.errors,delete e.layerObject,delete e.resourceInfo}),i.forEach(e.itemData.operationalLayers,function(e){delete e.errors,delete e.layerObject,delete e.resourceInfo,e.featureCollection&&e.featureCollection.layers&&i.forEach(e.featureCollection.layers,function(e){delete e.layerObject}),e.featureCollection&&e.featureCollection.featureSet&&e.featureCollection.featureSet.features&&i.forEach(e.featureCollection.featureSet.features,function(e){delete e._shape,delete e._graphicsLayer}),e.type=="CSV"&&e.featureCollection&&delete e.featureCollection,i.forEach(e.layers,function(e){delete e.drawingInfo,e.layerDefinition&&e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer&&(e.layerDefinition.drawingInfo.renderer=t.fromJson(e.layerDefinition.drawingInfo.renderer).toJson())}),e.layerDefinition&&e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer&&(e.layerDefinition.drawingInfo.renderer=t.fromJson(e.layerDefinition.drawingInfo.renderer).toJson())})},getSharingURL:function(e){var t=e.portalUrl;return t.match("/sharing/rest/$")?t=t.split("/").slice(0,-2).join("/")+"/":t.match("/sharing/rest$")?t=t.split("/").slice(0,-1).join("/")+"/":t.match("/sharing$")&&(t+="/"),t}}}),define("storymaps/common/builder/Builder",["lib-build/css!./Builder","esri/arcgis/Portal","./BuilderPanel","./settings/SettingsPopup","./BuilderHelper","./MyStoriesWrapper","../utils/CommonHelper","../utils/WebMapHelper","dojo/_base/lang","dojo/_base/array","dojo/has","esri/arcgis/utils","esri/IdentityManager","esri/request","dojo/topic","lib-app/history.min"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d){function w(e,t,n){v=e,m=t,b=new r($("#settingsPopup")),console.log("common.builder.Builder - init");if(!o.getAppID(v.isProd())&&!app.isDirectCreation){console.error("common.builder.Builder - abort builder initialization, no appid supplied");return}app.isDirectCreation?console.log("common.builder.Builder - Builder start in direct creation mode"):app.isGalleryCreation&&console.log("common.builder.Builder - Builder start in gallery creation mode"),$("body").addClass("builder-mode"),m.init(b,n),y.init(m),b.init(m),b.initLocalization(),d.subscribe("BUILDER_INCREMENT_COUNTER",y.incrementSaveCounter),d.subscribe("HEADER_EDITED",x),d.subscribe("BUILDER-MY-STORIES-CHECK",s.scanStory),window.onbeforeunload=function(e){e=e||window.event;if(!y.hasPendingChange())return;return e&&(e.returnValue=i18n.commonCore.builderPanel.closeWithPendingChange),i18n.commonCore.builderPanel.closeWithPendingChange},app.builder.cleanApp=H}function E(e){y.updateSharingStatus(),m.appInitComplete(k),g=e}function S(e){y.resize(),m.resize(e)}function x(e){if(!e.src)return;e.value==i18n.commonCore.inlineFieldEdit.editMe&&(e.value=""),e.src=="title"?!app.data.getWebMap()||e.value!=app.data.getWebMap().item.title?e.value!=app.data.getWebAppData().getTitle()&&(app.data.getWebAppData().setTitle(e.value),y.incrementSaveCounter()):app.data.getWebAppData().setTitle(""):e.src=="subtitle"&&(!app.data.getWebMap()||e.value!=app.data.getWebMap().item.snippet?e.value!=app.data.getWebAppData().getSubtitle()&&(app.data.getWebAppData().setSubtitle(e.value),g.setSubtitle(e.value),y.incrementSaveCounter()):app.data.getWebAppData().setSubtitle(""))}function T(e){if(!app.portal){console.error("Fatal error - not signed in"),_("APP");return}app.portal.signIn().then(function(){k(e,function(e){if(!e||!e.success){_("APP");return}L(function(e){if(!e||!e.success){_("WEBMAP");return}M({success:!0})})})},function(e){_("APP",e)})}function N(e,t){if(!app.portal){console.error("Fatal error - not signed in"),_("APP");return}var n=h.findCredential(D()).userId;app.data.setWebAppItem(a.mixin(i.getBlankAppJSON(),{title:e,snippet:t,uploaded:Date.now(),modified:Date.now(),owner:n,access:"private"}));var r=app.data.getWebMap();a.mixin(r.item,{title:e,snippet:t,uploaded:Date.now(),modified:Date.now(),owner:n,access:"private"}),app.portal.signIn().then(function(){L(function(e){if(!e||!e.success){_("WEBMAP");return}app.data.getWebAppData().setWebmap(e.id);var t=app.data.getWebMap();a.mixin(t.item,{id:e.id,item:e.item}),k(!1,function(t){if(!t||!t.success){_("APP");return}app.data.setWebAppItem(a.mixin(app.data.getWebAppItem(),{id:t.id,item:t.item,url:document.location.protocol+"//"+document.location.host+document.location.pathname+"?appid="+t.id})),k(!1,function(t){if(!t||!t.success){_("APP");return}console.log("common.builder.Builder - firstSaveForDirectCreation - appid:",t.id," webmap:",typeof e!="undefined"?e.id:null),M({success:!0}),app.isDirectCreationFirstSave=!1,y.updateSharingStatus(),History.replaceState({},"","?appid="+t.id+"&edit")})})})},function(e){_("APP",e)})}function C(){if(!app.portal){console.error("Fatal error - not signed in"),_("APP");return}var e=h.findCredential(D()).userId,t=app.data.getWebMap();a.mixin(t.item,{title:app.data.getWebMap().item.title,uploaded:Date.now(),modified:Date.now(),owner:e}),app.data.getWebAppItem().ownerFolder&&(t.item.ownerFolder=app.data.getWebAppItem().ownerFolder),app.portal.signIn().then(function(){L(function(e){if(!e||!e.success||!e.id){_("WEBMAP");return}app.data.getWebAppData().setWebmap(e.id);var t=app.data.getWebMap();a.mixin(t.item,{id:e.id,item:e.item}),app.migration=!1,k(!1,function(t){if(!t||!t.success){_("APP");return}var n=function(){console.log("common.builder.Builder - builderGalleryCreationFirstSave - appid:",t.id," webmap:",e.id),M({success:!0}),app.isGalleryCreation=!1,y.updateSharingStatus(),History.replaceState({},"","?appid="+t.id+"&edit")},r=app.data.getWebAppItem().access;if(r!="private"){var i=[app.data.getWebMap().item.id];O(i.join(","),r).then(function(e){var t=e&&e.results&&e.results.length==i.length;t?($.each(e.results,function(e,n){n.success||(t=!1)}),t?n():_("WEBMAP")):_("WEBMAP")})}else n()})})},function(e){_("APP",e)})}function k(e,t){var n=D(),r=a.clone(app.data.getWebAppItem()),i=r.owner||h.findCredential(n).userId,s=h.findCredential(n).token;delete r.avgRating,delete r.modified,delete r.numComments,delete r.numRatings,delete r.numViews,delete r.size,r.typeKeywords||(r.typeKeywords=[]),r.typeKeywords=r.typeKeywords.concat(app.cfg.WEBAPP_KEYWORD_APP),r.typeKeywords=r.typeKeywords.concat(app.cfg.WEBAPP_KEYWORD_GENERIC);var o=$.map(app.cfg.LAYOUTS,function(e){return"layout-"+e.id});r.typeKeywords=$.grep(r.typeKeywords,function(e){return $.inArray(e,o)==-1}),r.typeKeywords.push("layout-"+app.data.getWebAppData().getLayoutId()),r.typeKeywords=$.grep(r.typeKeywords,function(e,t){return t==$.inArray(e,r.typeKeywords)}),r.tags=r.tags?r.tags.join(","):"",r.typeKeywords=r.typeKeywords.join(","),r.serviceProxyParams=JSON.stringify(r.serviceProxyParams),e||(r.title=app.data.getWebAppData().getTitle()),r.properties&&(r.properties=JSON.stringify(r.properties)),r.url&&r.url.match(/apps\/[a-zA-Z]+\/\?appid=/)&&(r.url=r.url.replace("/?appid=","/index.html?appid=")),r=a.mixin(r,{f:"json",token:s,overwrite:!0,text:JSON.stringify(app.data.getWebAppData().get())});var u=n+"/sharing/content/users/"+i+(r.ownerFolder?"/"+r.ownerFolder:"");r.id?u+="/items/"+r.id+"/update":u+="/addItem";var f=p({url:u,handleAs:"json",content:r},{usePost:!0});f.then(t,_)}function L(e){var t=app.map.getLayer(app.data.getShortlistLayerId()),n=$.grep(app.data.getWebMap().itemData.operationalLayers,function(e){return e.id==g.getShortlistLayerId()});n[0].featureCollection=u.serializeGraphicsLayerToFeatureCollection(t),u.saveWebmap(app.data.getWebMap(),app.portal).then(function(t){e(t)},_)}function A(e,t){e!="public"&&e!="account"&&(e="public");var n=[];e=="account"?(app.data.getWebMap()&&app.data.getWebMap().item.access=="private"&&app.data.getWebMap().item.owner==app.portal.getPortalUser().username&&n.push(app.data.getWebMap().item.id),app.data.getWebAppItem().access=="private"&&n.push(app.data.getWebAppItem().id)):(app.data.getWebMap()&&app.data.getWebMap().item.access!="public"&&app.data.getWebMap().item.owner==app.portal.getPortalUser().username&&n.push(app.data.getWebMap().item.id),app.data.getWebAppItem().access!="public"&&n.push(app.data.getWebAppItem().id)),O(n.join(","),e).then(function(r){var i=r&&r.results&&r.results.length==n.length;i&&($.each(r.results,function(e,t){t.success||(i=!1)}),app.data.getWebMap()&&(app.data.getWebMap().item.access=e),app.data.getWebAppItem().access=e,y.updateSharingStatus()),t(i)})}function O(e,t){var n=D(),r=h.findCredential(n).userId,i=h.findCredential(n).token,s={f:"json",token:i,items:e,groups:"",everyone:"",account:""};return t=="public"&&(s.everyone=!0),t=="account"&&(s.account=!0),p({url:n+"/sharing/content/users/"+r+"/shareItems",handleAs:"json",content:s},{usePost:!0})}function M(e){e&&e.success?(y.saveSucceeded(),app.data.updateAfterSave(),app.isGalleryCreation||app.isDirectCreationFirstSave?(app.isDirectCreationFirstSave=!1,app.isGalleryCreation=!1,setTimeout(window.myStoriesInit,200)):s.scanStory(),y.updateSharingStatus()):_()}function _(e,t){y.saveFailed(e,t)}function D(){return c.arcgisUrl.split("/sharing/")[0]}function P(){m.buildWebMap()}function H(){if(!app.portal){console.error("Fatal error - not signed in");return}return app.portal.signIn().then(function(){var e=D(),t=h.findCredential(e).userId,n=h.findCredential(e).token,r=a.clone(app.data.getWebAppItem());delete r.avgRating,delete r.modified,delete r.numComments,delete r.numRatings,delete r.numViews,delete r.size,r=a.mixin(r,{f:"json",token:n,overwrite:!0,text:JSON.stringify(app.data.getWebAppData().getBlank())});var i=p({url:e+"/sharing/content/users/"+t+(r.ownerFolder?"/"+r.ownerFolder:"")+"/addItem",handleAs:"json",content:r},{usePost:!0});i.then(function(){console.log("Web Application data cleaned successfully")},function(){console.log("Web Application data cleaning has failed")})},function(e){console.error("Web Application data cleaning has failed",e)}),"Cleaning ..."}var v=null,m=null,g=null,y=new n($("#builderPanel"),T,N,C),b=null;return{init:w,resize:S,appInitComplete:E,shareAppAndWebmap:A,buildWebMap:P}}),define("lib-build/tpl!storymaps/tpl/builder/BuilderView",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="modal fade" id="settingsPopup" role="dialog" data-backdrop="static" tabindex="-1"></div>\r\n<div class="modal" id="initPopup" role="dialog" data-backdrop="static"></div>\r\n\r\n<div class="modal fade builderShare" id="sharePopup" role="dialog" data-backdrop="static" tabindex="-1"></div>\r\n<div class="modal fade builderShareError" id="sharePopupError" role="dialog" data-backdrop="static" tabindex="-1"></div>\r\n\r\n<div class="modal fade saveErrorPopup" id="saveErrorPopup" role="dialog" data-backdrop="static" tabindex="-1"></div>\r\n<div class="modal fade saveErrorPopupSocial" id="saveErrorPopupSocial" role="dialog" data-backdrop="static" tabindex="-1"></div>\r\n\r\n<div class="modal fade addEditPopup" id="addEditPopup" role="dialog" data-backdrop="static" tabindex="-1"></div>\r\n<div class="modal fade editorDialog editorDialogInlineMedia" id="editorDialogInlineMedia" role="dialog" data-backdrop="static" tabindex="-1"></div>\r\n\r\n<div class="modal fade organizePopup" id="organizePopup" role="dialog" data-backdrop="static" tabindex="-1"></div>\r\n<div class="modal fade migrationPopup" id="migrationPopup" role="dialog" data-backdrop="static" tabindex="-1"></div>\r\n';return __p}}),define("lib-build/tpl!storymaps/tpl/builder/BasemapChooser",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div id="basemapChooser">\r\n	<div data-dojo-type="dijit/TitlePane"\r\n		 data-dojo-props="closable:false, open:false">\r\n	<div data-dojo-type="dijit/layout/ContentPane" style="width:380px; height:280px; overflow:auto;">\r\n		<div id="basemapGallery" ></div></div>\r\n	</div>\r\n</div>\r\n';return __p}}),define("lib-build/css!storymaps/tpl/builder/BuilderView",[],function(){}),define("lib-build/css!storymaps/tpl/builder/Common",[],function(){}),define("lib-build/tpl!storymaps/common/builder/Landing",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="builderLanding">\r\n	<div class="landing-add-container">\r\n		<div class="landing-lbl">'+((__t=lblAdd)==null?"":__t)+'</div>\r\n		<div class="add-title-wrapper">\r\n			<input type="text" class="form-control add-title" spellcheck="true" placeholder="'+((__t=phAdd)==null?"":__t)+'"/>\r\n			<span class="landing-btn disabled"></span>\r\n		</div>\r\n	</div>\r\n	\r\n	<div class="btnSeparator">\r\n		<span class="solidline"></span>\r\n		'+((__t=lblOR)==null?"":__t)+'\r\n		<span class="solidline"></span>\r\n	</div>\r\n	\r\n	<div class="landing-tour-container">\r\n		<div class="landing-btn"></div>\r\n		<div class="landing-lbl">'+((__t=lblHelp)==null?"":__t)+"</div>\r\n	</div>\r\n</div>";return __p}}),define("lib-build/css!storymaps/common/builder/Landing",[],function(){}),define("storymaps/common/builder/Landing",["lib-build/tpl!./Landing","lib-build/css!./Landing"],function(e){return function(n,r,i){function o(){return n.find(".landing-add-container .add-title").val()}function u(){n.find(".landing-add-container .landing-btn").toggleClass("disabled",!o())}function a(){$(this).hasClass("disabled")||r(o())}function f(e){e.keyCode==13&&$(this).val()&&a()}function l(){n.find(".landing-add-container .add-title").bind("input propertychange",u).keyup(f),n.find(".landing-add-container .landing-btn").click(a),n.find(".landing-tour-container").click(i),$("#builderQuotes").html('<div style="padding: 0 18%">'+s[Math.floor(Math.random()*s.length)].join("<br />")+"</div>")}var s=[["&ldquo;There's always room for a story that can transport people to another place.&rdquo;","--J.K. Rowling"],["&ldquo;Storytelling is the most powerful way to put ideas into the world today.&rdquo;","--Robert McKee"],["&ldquo;The stories we tell literally make the world. If you want to change the world, you need to change your story. This truth applies both to individuals and institutions.&rdquo;","--Michael Margolis"],["&ldquo;The shortest distance between a human being and the truth is a story.&rdquo;","--Anthony de Mello"],["&ldquo;People don’t want more information. They are up to their eyeballs in information. They want faith–faith in you, your goals, your success, in the story you tell.&rdquo;","--Annette Simmons"],["&ldquo;I truly believe that people are looking for stories that really mean something–stories that are redemptive, inspiring, and bigger than an individual.&rdquo;","--Scott Harrison"],["&ldquo;If you wish to influence an individual or a group to embrace a particular value in their daily lives, tell them a compelling story.&rdquo;","--Annette Simmons"],["&ldquo;If you tell me, it’s an essay. If you show me, it’s a story.&rdquo;","--Barbara Greene"],["&ldquo;If you don’t know the trees you may be lost in the forest, but if you don’t know the stories you may be lost in life.&rdquo;","--Siberian Elder"],["&ldquo;Stories are the creative conversion of life itself into a more powerful, clearer, more meaningful experience. They are the currency of human contact.&rdquo;","--Robert McKee"]];n.append(e({lblAdd:i18n.builder.landing.lblAdd,phAdd:i18n.builder.landing.phAdd,lblOR:i18n.builder.landing.lblOR,lblHelp:i18n.builder.landing.lblHelp})),l(),this.toggle=function(e){i18n.builder.landing.lblAdd.match("%LAYOUT_TITLE%")&&n.find(".landing-add-container .landing-lbl").html(i18n.builder.landing.lblAdd.replace("%LAYOUT_TITLE%",app.data.getCurrentLayoutStaticConfig().title)),!o()&&app.isGalleryCreation&&(n.find(".landing-add-container .add-title").val(app.data.getWebAppItem().title).select(),u()),n.toggle(e),$("#builderQuotes").toggle(e),focus()},this.focus=function(){n.find(".landing-add-container .add-title").focus()}}}),define("lib-build/tpl!storymaps/tpl/builder/InitPopup",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="modal-dialog">\r\n	<div class="modal-content">\r\n		<div class="modal-header">\r\n			<h3 class="modal-title">'+((__t=title)==null?"":__t)+'</h3>\r\n		</div>\r\n		<div class="modal-body">\r\n			Ready?\r\n		</div>\r\n		<div class="modal-footer">\r\n			<span class="modal-footer-left"></span>\r\n			<button class="btnNext btn btn-primary"></button>\r\n		</div>\r\n	</div>\r\n</div>';return __p}}),define("lib-build/css!storymaps/tpl/builder/InitPopup",[],function(){}),define("storymaps/tpl/builder/InitPopup",["lib-build/tpl!./InitPopup","lib-build/css!./InitPopup","dojo/Deferred"],function(e,t,n){return function(r){function o(){console.log("&&&&"),i.resolve({ok:!0,pickWebmap:!1})}function u(e){e.keyCode==13&&o()}function a(){$("body").bind("keydown",u)}r.append(e({title:i18n.builder.initPopup.title+'<span class="builder-logo"></span>'}));var i=null,s=r.find(".btnNext");a(),this.init=function(){},this.present=function(){return i=new n,s.removeAttr("disabled"),s.html(i18n.builder.initPopup.startBtn).show(),s.click(o),r.modal({keyboard:!1}),o(),i},this.initLocalization=function(){}}}),define("lib-build/tpl!storymaps/common/builder/SharePopup",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="modal-dialog">\r\n	<div class="modal-content">\r\n		<div class="modal-logo"></div>\r\n		<div class="modal-header">\r\n			<h3 class="modal-title">'+((__t=title)==null?"":__t)+'</h3>\r\n		</div>\r\n		<div class="modal-body">\r\n			<div class="sharing-container">\r\n				<div class="btn-group app-sharing-container">\r\n					<div class="app-sharing-wrapper">\r\n						<div class="app-sharing-loading"></div>\r\n						<button class="app-sharing-icon glyphicon glyphicon-user" data-sharing="private" title="'+((__t=btnPrivateTooltip)==null?"":__t)+'"><span class="app-sharing-private">'+((__t=btnPrivate)==null?"":__t)+'</span></button>\r\n					</div>\r\n					<div class="app-sharing-wrapper">\r\n						<div class="app-sharing-loading"></div>\r\n						<button class="app-sharing-icon share-group" data-sharing="organization" title="'+((__t=btnOrgTooltip)==null?"":__t)+'">'+((__t=btnOrg)==null?"":__t)+'</button>						\r\n					</div>\r\n					<div class="app-sharing-wrapper">\r\n						<div class="app-sharing-loading"></div>\r\n						<button class="app-sharing-icon share-globe" data-sharing="public" title="'+((__t=btnPublicTooltip)==null?"":__t)+'">'+((__t=btnPublic)==null?"":__t)+'</button>\r\n					</div>\r\n					<span class="preview-container">\r\n						<button class="btn btn-naked btn-link btn-open"></button>\r\n					</span>\r\n				</div>\r\n				<div class="sharing-action-result hide"></div>\r\n			</div>\r\n			\r\n			<div class="story-checked-container hide">\r\n				<div class="story-status"></div>\r\n				\r\n				<div class="views">\r\n					<div class="view view-share active" style="text-align: center">\r\n						<table style="width: 100%">\r\n							<tr style="vertical-align: top;">\r\n								<td style="width: 50%">\r\n									<div class="socialize-title">'+((__t=socialize)==null?"":__t)+'</div>\r\n									<div class="share-url-panel"></div>\r\n									<div class="social-container">\r\n										<i class="shareIcon blackHover share_facebook icon-facebook-squared"></i>\r\n										<i class="shareIcon blackHover share_twitter icon-twitter"></i>\r\n									</div>\r\n								</td>\r\n								<td style="width: 50%">\r\n									<div class="embed-title">'+((__t=embedTitle)==null?"":__t)+'</div>\r\n									<div class="share-embed-panel"></div>\r\n								</td>\r\n							</tr>\r\n							\r\n						</table>\r\n					</div>\r\n					<div class="view view-my-stories">\r\n						<iframe id="my-stories-frame"></iframe>\r\n					</div>\r\n					<div class="view view-private-story">\r\n						<div class="private-story-call-to-action"></div>\r\n					</div>\r\n				</div>\r\n				\r\n				<div class="view-toggle-container">\r\n					<div class="btn btn-default view-toggle-btn">'+((__t=btnToggle)==null?"":__t)+'</div>\r\n				</div>\r\n			</div>\r\n			\r\n			<div class="story-checking-container">\r\n				<div style="margin: 20px 0;">\r\n					<img src="resources/tpl/viewer/icons/loading-light.gif" />\r\n				</div>\r\n				'+((__t=loadingMessage)==null?"":__t)+'\r\n			</div>\r\n		</div>\r\n		<div class="modal-footer">\r\n			<span class="footer-msg"></span>\r\n			<button class="btnClose btn btn-naked btn-close" data-dismiss="modal" aria-hidden="true">'+((__t=close)==null?"":__t)+"</button>\r\n		</div>\r\n	</div>\r\n</div>";return __p}}),define("lib-build/css!storymaps/common/builder/SharePopup",[],function(){}),define("lib-build/tpl!storymaps/common/builder/SharePopupError",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="modal-dialog">\r\n	<div class="modal-content">\r\n		<div class="modal-logo"></div>\r\n		<div class="modal-header">\r\n			<h4 class="modal-title">'+((__t=title)==null?"":__t)+'</h4>\r\n		</div>\r\n\r\n		<div class="modal-body">\r\n			<div class="error-msg"></div>\r\n		</div>\r\n\r\n		<div class="modal-footer">\r\n		<span class="error"></span>\r\n			<button type="button" class="btn btnCancel btn-naked btn-close" data-dismiss="modal">'+((__t=btnClose)==null?"":__t)+"</button>\r\n		</div>\r\n	</div>\r\n</div>";return __p}}),define("lib-build/css!storymaps/common/builder/SharePopupError",[],function(){}),define("storymaps/common/builder/SharePopupError",["lib-build/tpl!./SharePopupError","lib-build/css!./SharePopupError"],function(e){return function(n){n.html(e({title:i18n.commonCore.share.shareTitle,btnClose:i18n.commonCore.common.close})),this.present=function(e){var t="";e.error=="DOMAIN"?t+=i18n.commonCore.share.notavailable1.replace("%PRODUCT%",e.isPortal?"Portal for ArcGIS":"ArcGIS Online"):e.error=="PORTAL"?t+=i18n.commonCore.share.notavailable2:e.error=="DEV"&&(t+=i18n.commonCore.share.notavailable6),t+="<br /><br />",e.error=="DOMAIN"?t+=i18n.commonCore.share.notavailable3.replace("%LINK%",'<a href="'+e.mystoriesURL+'" target="_blank">'+i18n.commonCore.share.notavailable4+"</a>"):(t+=i18n.commonCore.share.notavailable3.replace("%LINK%",'<a href="'+e.itemURL+'" target="_blank">'+i18n.commonCore.share.notavailable5+"</a>"),t+=" ",t+=i18n.commonCore.share.notavailable7.replace("%MYCONTENT%",'<a href="'+e.mycontentURL+'" target="_blank">'+i18n.commonCore.share.notavailable8+"</a>")),n.find(".error-msg").html(t),n.modal({keyboard:!0})}}}),define("storymaps/common/builder/SharePopup",["lib-build/tpl!./SharePopup","lib-build/css!./SharePopup","./SharePopupError","./MyStoriesWrapper","../utils/CommonHelper","../ui/share/ShareURLPanel","../ui/share/ShareEmbedPanel","../utils/HeaderHelper","dojo/topic","dojo/has"],function(e,t,n,r,i,s,o,u,a,f){return function(l){function v(){var e=app.data.getWebAppItem().access=="private";l.find(".views .view-my-stories").hasClass("active")?(e?(l.find(".views .view-share").toggleClass("active",!1),l.find(".views .view-my-stories").toggleClass("active",!1),l.find(".views .view-private-story").toggleClass("active",!0),l.find(".view-toggle-btn").html(i18n.commonCore.share.viewToggle1)):(l.find(".views .view-share").toggleClass("active",!0),l.find(".views .view-my-stories").toggleClass("active",!1),l.find(".views .view-private-story").toggleClass("active",!1),l.find(".view-toggle-btn").html(i18n.commonCore.share.viewToggle1)),f("ff")&&$("#my-stories-hidden-container").removeClass("active")):(l.find(".views .view-share").toggleClass("active",!1),l.find(".views .view-my-stories").toggleClass("active",!0),l.find(".views .view-private-story").toggleClass("active",!1),l.find(".view-toggle-btn").html(i18n.commonCore.share.viewToggle2),c.updateMyStoriesPosition())}function m(){var e=$(this).data("sharing"),t=e=="private"?0:e=="organization"?1:2,n=l.find(".app-sharing-icon.active").index();console.log("Changing sharing level to:",e),l.find(".app-sharing-icon").removeClass("active"),$(this).addClass("active"),l.find(".app-sharing-icon").addClass("locked"),l.find(".sharing-action-result").addClass("hide"),l.find(".app-sharing-wrapper").eq(t).find(".app-sharing-loading").show(),l.find(".btn-open").addClass("disabled"),app.mystories.share(e).then(g,function(e){e.needsUserInput&&e.delayPromise?(app.mystories.hasCheckErrors=!0,e.delayPromise.then(g,function(e){y(e,n)}),b({postSharing:!0,previousLevelIndex:n,targetLevelIndex:t,needsUserInput:!0})):y(e,n)})}function g(e){console.log(e),app.mystories.hasCheckErrors=!e.allClear,l.find(".app-sharing-icon").removeClass("locked"),l.find(".app-sharing-loading").hide(),l.find(".btn-open").removeClass("disabled"),e.storyAndContent&&l.find(".sharing-action-result").removeClass("hide").addClass("status-ok").html(e.message),e.targetAccess=="private"?app.data.getWebAppItem().access="private":e.targetAccess=="organization"?app.data.getWebAppItem().access="account":e.targetAccess=="public"&&(app.data.getWebAppItem().access="public"),b()}function y(e,t){console.error("sharing failed"),app.mystories.hasCheckErrors=!e.allClear,l.find(".app-sharing-icon").removeClass("locked active"),l.find(".app-sharing-icon").eq(t).addClass("active"),l.find(".app-sharing-loading").hide(),l.find(".btn-open").removeClass("disabled"),l.find(".sharing-action-result").removeClass("hide status-ok").html(e.message)}function b(e){var t=app.data.getWebAppItem().access=="private",n=app.data.getWebAppItem().access=="account",r=app.isDirectCreationFirstSave||app.isGalleryCreation,i=t?0:n?1:2,s="";e=e||{},l.find(".story-checked-container").toggleClass("hide",app.mystories.isChecking),l.find(".story-checking-container").toggleClass("hide",!app.mystories.isChecking),l.find(".app-sharing-icon").removeClass("locked active"),r?l.find(".app-sharing-icon").addClass("locked"):t||e.needsUserInput&&e.targetLevelIndex===0?l.find(".app-sharing-icon").eq(0).addClass("active"):n||e.needsUserInput&&e.targetLevelIndex===1?l.find(".app-sharing-icon").eq(1).addClass("active"):l.find(".app-sharing-icon").eq(2).addClass("active");var o;!r&&!app.mystories.forcedIgnoreIssues&&(e.needsUserInput?(o=e.targetLevelIndex,l.find(".app-sharing-loading").hide(),o==2?l.find(".app-sharing-icon").eq(2).toggleClass("locked",!0):o==1?(l.find(".app-sharing-icon").eq(2).toggleClass("locked",!0),l.find(".app-sharing-icon").eq(1).toggleClass("locked",!0)):o===0&&l.find(".app-sharing-icon").eq(0).toggleClass("locked",!0)):app.mystories.hasCheckErrors?(o=e.postSharing?e.previousLevelIndex:i,o==2?l.find(".app-sharing-icon").toggleClass("locked",!1):o==1?(l.find(".app-sharing-icon").toggleClass("locked",!0),l.find(".app-sharing-icon").eq(0).toggleClass("locked",!1)):o===0&&l.find(".app-sharing-icon").toggleClass("locked",!0)):l.find(".app-sharing-icon").toggleClass("locked",app.mystories.isChecking));if(!app.mystories.isChecking){if(app.mystories.hasCheckErrors||app.mystories.forcedIgnoreIssues)s+=i18n.commonCore.share.statusError;l.find(".story-status").hide();if(app.mystories.hasCheckErrors||app.mystories.forcedIgnoreIssues){l.find(".story-status").html(s).show();if(t){var u=i18n.commonCore.share.statusPrivate;u+="<br />",u+=i18n.commonCore.share.statusNoErrPrivate,l.find(".private-story-call-to-action").html(u)}}else t&&(s+=i18n.commonCore.share.statusPrivate,s+="<br />",s+=i18n.commonCore.share.statusNoErrPrivate,l.find(".private-story-call-to-action").html(s));if(!e.isRefresh||app.mystories.forcedIgnoreIssues){var h=!!(app.mystories.hasCheckErrors&&!app.mystories.forcedIgnoreIssues||e.needsUserInput||r);l.find(".views .view-share").toggleClass("active",(!app.mystories.hasCheckErrors||!!app.mystories.forcedIgnoreIssues)&&!e.needsUserInput&&!t&&!r),l.find(".views .view-my-stories").toggleClass("active",h),l.find(".views .view-private-story").toggleClass("active",(!app.mystories.hasCheckErrors||app.mystories.forcedIgnoreIssues)&&!e.needsUserInput&&t),f("ff")&&($("#my-stories-hidden-container").toggleClass("active",h),h&&c.updateMyStoriesPosition())}}l.find(".btn-open").toggle(!r),l.find(".btn-open").html(t?i18n.commonCore.share.preview:i18n.commonCore.share.viewlive),l.find(".view-toggle-container").toggleClass("hide",app.mystories.hasCheckErrors&&!app.mystories.forcedIgnoreIssues||r),l.find(".view-toggle-btn").html(i18n.commonCore.share.viewToggle1),a.publish("MYSTORIES_SCAN",app.mystories.hasCheckErrors||e.needsUserInput?"error":null)}function w(){l.find(".app-sharing-icon").click(m),l.find(".view-toggle-btn").click(v),l.find(".btn-open").off("click").click(function(){window.open(i.getAppViewModeURL(),"_blank")}),l.on("hide.bs.modal",function(){f("ff")&&$("#my-stories-hidden-container").removeClass("active")}),l.on("shown.bs.modal",function(){f("ff")&&c.updateMyStoriesPosition()})}l.append(e({title:i18n.commonCore.share.shareTitle,btnPrivate:i18n.commonCore.share.btnPrivate,btnPrivateTooltip:i18n.commonCore.share.btnPrivateTooltip,btnOrg:i18n.commonCore.share.btnOrg,btnOrgTooltip:i18n.commonCore.share.btnOrgTooltip,btnPublic:i18n.commonCore.share.btnPublic,btnPublicTooltip:i18n.commonCore.share.btnPublicTooltip,loadingMessage:i18n.commonCore.share.loadingMessage,btnToggle:i18n.commonCore.share.viewToggle1,socialize:i18n.commonCore.share.socialize,embedTitle:i18n.viewer.shareFromCommon.embed,close:i18n.commonCore.common.close}));var c=this,h=new n($("#sharePopupError")),p=new s(l.find(".share-url-panel")),d=new o(l.find(".share-embed-panel"));w(),a.subscribe("MY-STORIES-REFRESH",function(){b({isRefresh:!0})}),this.present=function(e,t){var n=i.getAppViewModeURL();if(!app.portal.hasMyStories||!app.isProduction||!r.myStoriesIsSameDomain()){var s="";!app.isProduction&&!app.portal.hasMyStories?s="DEV":app.isProduction&&app.isPortal&&r.myStoriesIsSameDomain()&&!app.portal.hasMyStories?s="PORTAL":app.isProduction&&(!app.portal.hasMyStories||!r.myStoriesIsSameDomain())&&(s="DOMAIN");if(s){h.present({error:s,isPortal:app.isPortal,itemURL:i.getItemURL(app.data.getWebAppItem().id),mycontentURL:i.getMyContentURL(),mystoriesURL:i.getMyStoriesURL()});return}}p.present(n,!1),d.present(n),u.setSocial(l,t),u.initEvents(l,"bottom");if(app.mystories){l.find(".app-sharing-icon").tooltip({placement:"top",container:".app-sharing-container",trigger:"hover"}),b();var o='<a href="'+i.getMyStoriesURL()+'" target="_blank">'+i18n.commonCore.share.mystoriesinvite+"</a>";l.find(".footer-msg").html(o)}else l.find(".app-sharing-icon").removeClass("active").addClass("locked");l.find(".sharing-action-result").addClass("hide"),l.find(".app-sharing-wrapper").eq(1).toggle(app.portal.isOrganization!==!1),l.modal({keyboard:!0})},this.updateMyStoriesPosition=function(){if(f("ff")){var e=l.find(".view-my-stories")[0].getBoundingClientRect();$("#my-stories-hidden-container").addClass("active").css({top:e.top,left:e.left,width:e.right-e.left,height:l.find(".story-status").is(":visible")?270:300})}}}}),define("storymaps/common/builder/browse-dialog/js/_RefreshMixin",["dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","dojo/on"],function(e,t,n,r){function i(e){typeof e!="object"&&(e=new Error(e)),e.grid=this,r.emit(this.domNode,"dgrid-error",{grid:this,error:e,cancelable:!0,bubbles:!0})&&console.error(e)}var s=e(null,{_trackError:function(e){var s;typeof e=="string"&&(e=t.hitch(this,e));try{s=e()}catch(o){i.call(this,o)}return n.when(s,t.hitch(this,function(){r.emit(this.domNode,"refresh",{cancelable:!0,bubbles:!0})}),t.hitch(this,i))}});return s}),define("storymaps/common/builder/browse-dialog/js/PortalItemStore",["dojo/_base/declare","dojo/_base/lang","esri/arcgis/Portal"],function(e,t,n){return e(null,{idProperty:"id",constructor:function(t){e.safeMixin(this,t),this.portalUrl=this.portal&&this.portal.portalUrl},getIdentity:function(e){return e[this.idProperty]},query:function(e,r){var e=e,i=t.isObject(e)?e:{q:e};if(r){i=t.mixin(i,{num:r.count,start:(r.start||0)+1});if(r.sort&&r.sort.length){var s=r.sort[0];i=t.mixin(i,{sortField:encodeURIComponent(s.attribute==="created"?"uploaded":s.attribute),sortOrder:s.descending?"desc":"asc"})}}if(this.galleryType==="webmap")var o=this.portal.queryItems(i).then(function(e){return e.results.total=e.total,e.results});else var o=this.portal.queryGroups(i).then(function(e){return e.results.total=e.total,e.results});return n.PortalResult(o)}})}),define("storymaps/common/builder/browse-dialog/js/Grid",["dojo/_base/declare","dojo/Evented","dojo/string","dojo/_base/lang","dojo/_base/array","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dgrid/Grid","./_RefreshMixin","dgrid/Selection","dgrid/extensions/Pagination","dojo/query","dojo/store/Memory","dojo/store/Cache","./PortalItemStore","dojo/store/Observable","put-selector/put","dgrid/util/mouse"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y){return e([s,t],{postMixInProperties:function(){this.inherited(arguments),this._supportedViews=["gallery","details"],this._galleryTemplate=this._galleryTemplate||"<div class='itemGrid'><img alt='' src='${thumbnailUrl:_formatThumbnail}'><div class='itemTitle'>${title:_formatTitle}</div><span class='itemOwner'>${owner}</span><p class='itemText snippet' style='display:none;'>${snippet}</p></div>",this._renderers=r.mixin(this._renderers||{},{gallery:r.hitch(this,function(t){t.snippet=t.snippet||t.description||t.title||"";var r=g("div"),i=new(e([s,o,u],{templateString:n.substitute(this._galleryTemplate,t,null,this)}));return r.appendChild(i.domNode),r})})},_formatTitle:function(e){return e||(e=""),e},_formatThumbnail:function(e){return e||"resources/common/icons/browse-dialog/default.png"},buildRendering:function(){this.inherited(arguments);var t=e([a,c,l,f]),n=this.columns||{id:{label:"id"},title:{label:"title"},type:{label:"type"},modified:{label:"last modified"},snippet:{label:"snippet"}};this._view=this.view||"gallery",this._query=this.query,this._queryOptions=this.queryOptions||{sort:this.sort||[{attribute:"title",descending:!1}]},this._store=this.store||new d(new v({portal:this.portal,galleryType:this.galleryType}),new p({data:[]})),this._rowsPerPage=this.rowsPerPage||8,this._sort=this.sort||[{attribute:"title",descending:!1}],this._pagingLinks=this.pagingLinks?3:!1,this._grid=new t({columns:n,showHeader:!1,selectionMode:"single",renderRow:this._renderers[this._view],store:this._store,query:this._query,loadingMessage:"Loading...",noDataMessage:"No results found",showLoadingMessage:!0,firstLastArrows:this._pagingLinks,previousNextArrows:this._pagingLinks,rowsPerPage:this._rowsPerPage,pagingLinks:this._pagingLinks,pagingTextBox:!0,sort:this._sort},this.domNode),this._grid.startup()},postCreate:function(){this.inherited(arguments),this.own(this._grid.on(y.enterRow,r.hitch(this,"_showSnippet",!0)),this._grid.on(y.leaveRow,r.hitch(this,"_showSnippet",!1)),this._grid.on("refresh",r.hitch(this,"_onGridRefresh")),this._grid.on(".dgrid-row:click",r.hitch(this,"_onRowClick")))},_onGridRefresh:function(e){this.emit("onRefresh",{currentPage:this._grid._currentPage}),this._pagingLinks&&(h(".dgrid-navigation")[this._grid._total<=this._grid.rowsPerPage?"addClass":"removeClass"]("hide"),h(".dgrid-pagination")[this._grid._total===0?"addClass":"removeClass"]("hide"))},_onRowClick:function(e){this.emit("onItemClick",{row:this._grid.row(e)})},_showSnippet:function(e,t){var n=this._grid.row(t);n&&(h(".itemGrid .itemTitle",n.element).style("display",e?"none":""),h(".itemGrid .itemOwner",n.element).style("display",e?"none":""),h(".itemGrid > img",n.element).style("display",e?"none":""),h(".itemGrid .snippet",n.element).style("display",e?"":"none"))},_getGridAttr:function(){return this._grid},refresh:function(){this._grid&&this._grid.set("query",this._query,this._queryOptions)},gotoPage:function(e){this._grid.query=this._query,this._grid.queryOptions=this._queryOptions,this._grid._sort=this._queryOptions.sort,this._grid.gotoPage(e)},_setViewAttr:function(e){e=i.indexOf(this._supportedViews,e)===-1?this._view:e,this._view=e,this._grid&&(this._grid.renderRow=this._renderers[e],g(this._grid.domNode,"!gallery!details."+e))},_setStoreAttr:function(e){this._store=e},_setQueryAttr:function(e,t){this._query=e||this._query,this._queryOptions=t||this._queryOptions},_setItemsAttr:function(e){this._store=this._store||new m(p({data:e})),this._store&&this._store.setData?this._store.setData(e):this._store=new m(p({data:e})),this.set("store",this._store),this.set("view",this._view)}})}),define("text!storymaps/common/builder/browse-dialog/js/templates/BrowseIdDlg.html",[],function(){return'<div class="widgetContent" >\r\n  <div data-dojo-type="dijit/Dialog" id="browse-id-dialog" title="${i18n.title}" execute="">\r\n    <div data-dojo-attach-point="formNode" class="esriItemLinks dijitDialogPaneContentArea">\r\n      <div id="browse-id-box" style="border:#333 1px solid; width:565px; min-height:330px; padding:0; overflow:hidden;">            \r\n        <div class="esriFloatLeading esriLeadingMargin1" style="width:250px; margin-top:10px;">\r\n          <select data-dojo-attach-point="_filterSelect"  data-dojo-type="dijit/form/Select" sortByLabel="false" maxHeight=\'350\' style="width:240px;">\r\n          </select>\r\n        </div>  \r\n        <div class="search esriFloatTrailing esriTrailingMargin1" style="width:250px;">\r\n          <div id="search-form" style="position:relative;">\r\n            <input class="esriSearchBox" type="text" data-dojo-type="dijit/form/TextBox" trim="true" id="browse-id-search-box" data-dojo-attach-point="searchText" data-dojo-attach-event="onKeyPress:_onSearchKeyPress,onFocus:_onSearchBoxFocus,onBlur:_onSearchBoxBlur" alt="${i18n.searchTitle}" title="${i18n.searchTitle}" placeholder="${i18n.placeholder}" />\r\n            <button class="esriLeadingMargin13 esriSearchButton dijitDialogCloseIcon hide" id="clear-box_submit" alt="${i18n.searchTitle}" title="searchTitle" data-dojo-attach-point="clearButton" data-dojo-attach-event="onclick:_onSearchClear" >&nbsp;&nbsp;</button>\r\n          </div>\r\n        </div>\r\n        <div style="position:relative; width:565px;clear:both;" data-dojo-attach-point="gallery"  id="gallery"></div>\r\n      </div>\r\n    </div>\r\n    <div class="submitButtons dijitDialogPaneActionBar esriPositionRight0">\r\n      <input data-dojo-type="dijit/form/Button" name="cancel" class="cancel esriFloatTrailing" type="button" data-dojo-attach-event="onClick:onCancel" label="${i18n.cancel}">\r\n      <input data-dojo-type="dijit/form/Button" name="ok" class="ok esriFloatTrailing calcite blue" type="button" data-dojo-attach-event="onClick:onClose" label="${i18n.ok}">\r\n    </div>\r\n  </div>\r\n</div>\r\n'}),define("storymaps/common/builder/browse-dialog/js/BrowseIdDlg",["require","dojo/_base/declare","dojo/_base/connect","dojo/_base/lang","dojo/_base/event","dojo/dom-class","dojo/keys","dijit/registry","dojo/on","dojo/i18n!commonResources/nls/webmap.js?v="+app.version,"dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","./Grid","esri/arcgis/Portal","text!./templates/BrowseIdDlg.html","dijit/Dialog","dijit/form/Select","dijit/form/Button"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v){return t([l,c,h],{templateString:v,constructor:function(e){r.mixin(this,e)},postMixInProperties:function(){this.inherited(arguments),this.i18n={},this.galleryType==="webmap"?this.i18n=f.configure.mapdlg:this.i18n=f.configure.groupdlg,this.selected=null},postCreate:function(){var e=[];e.push({label:this.i18n.items.contentLabel,value:"content"},{label:this.i18n.items.organizationLabel,value:"org"},{label:this.i18n.items.onlineLabel,value:"online"}),this.galleryType==="webmap"&&e.push({label:this.i18n.items.favoritesLabel,value:"favorites"}),this._filterSelect.set("options",e),this._filterSelectHandler=a(this._filterSelect,"change",r.hitch(this,"doSearch"));var t={},n=this.portal.user;n.username&&(t.q="owner: "+n.username),this.galleryType==="webmap"&&(t.q+=' type:"Web Map" -type:"Web Mapping Application"'),this._grid=new p({portal:this.portal,query:t,pagingLinks:!0,galleryType:this.galleryType,view:"gallery"},"gallery"),this._grid.refresh(),a(this._grid,"onItemClick",r.hitch(this,function(e){var t=e.row;e.row.data&&e.row.data.id&&(this.selected=t.data)})),$("#dijit_form_Button_2_label, .dijitSelectLabel, .dijitButtonText, .dijitButtonContents, .dijitArrowButtonInner, .dijitArrowButtonContainer, .dijitMenuItem, .dijitMenuItemLabel").addClass("needsclick")},destroy:function(){this._filterSelectHandler.remove(),this.inherited(arguments)},doSearch:function(){var e=this._filterSelect.get("value"),t=this.portal.user,n=null,i=[];if(this.searchText.getValue()&&this.searchText.getValue().match(/^[A-Fa-f0-9]{32}$/))i.id=this.searchText.getValue();else{this.searchText.getValue()&&(n=this.searchText.getValue()),e==="org"&&(i.orgid=t.orgId),e==="content"&&(i.owner=t.username),e==="favorites"&&(i.group=t.favGroupId);if(e==="online"&&this.galleryType==="group"){var s=this.searchText.getValue();s===""&&(i.access="public")}}this.galleryType==="webmap"&&(i.type='"Web Map" -type:"Web Mapping Application"');var o="";for(var u in i){var a=i[u];o+=u+":"+a+" "}var f={};n&&(o=n+" "+o),f.q=r.trim(o),console.log(f.q),this._grid.set("query",f),this._grid.refresh()},_onSearchClear:function(e){i.stop(e),e!=null&&e.prefentDefault&&e.preventDefault(),this.searchText.setValue(""),s.add("clear-box_submit","hide"),this.doSearch()},_onSearchBoxFocus:function(e){},_onSearchBoxBlur:function(e){this.searchText.getValue()==""},_onSearchKeyPress:function(e){e.keyCode==o.ENTER&&(i.stop(e),this.doSearch()),e.keyCode==8&&this.searchText.getValue().length==1?s.add("clear-box_submit","hide"):s.remove("clear-box_submit","hide"),this.onSearchFieldKeyPress(e)},onSearchFieldKeyPress:function(e){},onClose:function(){u.byId("browse-id-dialog").hide()},onCancel:function(){this.set("selected",null),u.byId("browse-id-dialog").hide()},show:function(e){u.byId("browse-id-dialog").show(),this._grid.refresh()}})}),define("lib-build/css!storymaps/common/builder/browse-dialog/css/browse-dialog",[],function(){}),define("lib-build/css!storymaps/common/builder/browse-dialog/storymaps-override",[],function(){}),define("lib-build/tpl!storymaps/tpl/builder/settings/ViewGeneralOptions",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="settings-generaloptions">\r\n	<div class="checkbox opt-container">\r\n		<label>\r\n			<input type="checkbox" class="opt-checkbox-numbered-icons" />\r\n			Use numbered icons\r\n		</label>\r\n	</div>\r\n	<div class="checkbox opt-container" >\r\n		<label>\r\n			<input type="checkbox" class="opt-checkbox-sync" />\r\n			Synchronize tab locations\r\n			<a href="#" class="help" data-toggle="tooltip" data-placement="right">\r\n				<img class="helpImg" src="resources/tpl/builder/icons/builder-help.png">\r\n			</a>\r\n		</label>\r\n	</div>\r\n	<div class="checkbox opt-container">\r\n		<label>\r\n			<input type="checkbox" class="opt-checkbox-filter-by-extent" />\r\n			Filter features in current map extent\r\n		</label>\r\n	</div>\r\n	<div class="checkbox opt-container">\r\n		<label>\r\n			<input type="checkbox" class="opt-checkbox-more-infoLink" />\r\n			Include a link in a feature\'s description\r\n		</label>\r\n		<div class="opt-more-infoLink-alias-cont">\r\n			<label>\r\n				Text for link\r\n				<input type="text" class="opt-more-infoLink-alias" />\r\n			</label>\r\n		</div>\r\n	</div>\r\n</div>\r\n';return __p}}),define("lib-build/css!storymaps/tpl/builder/settings/ViewGeneralOptions",[],function(){}),define("storymaps/tpl/builder/settings/ViewGeneralOptions",["lib-build/tpl!./ViewGeneralOptions","lib-build/css!./ViewGeneralOptions"],function(e){return function(){var n=null,r=null,i=null;this.init=function(t,i){n=t,r=i,r.append(e({})),r.find(".help").tooltip({trigger:"hover"}),s()},this.present=function(e){e.moreInfoLink?r.find(".opt-more-infoLink-alias-cont").show():r.find(".opt-more-infoLink-alias-cont").hide(),r.find(".opt-checkbox-numbered-icons").prop("checked",e.numberedIcons),r.find(".opt-checkbox-sync").prop("checked",e.mapsSync),r.find(".opt-checkbox-filter-by-extent").prop("checked",e.filterByExtent),r.find(".opt-checkbox-more-infoLink").prop("checked",e.moreInfoLink),r.find(".opt-more-infoLink-alias").val(e.moreInfoLinkAlias),i=e},this.show=function(){},this.save=function(){return{numberedIcons:r.find(".opt-checkbox-numbered-icons").prop("checked"),mapsSync:r.find(".opt-checkbox-sync").prop("checked"),filterByExtent:r.find(".opt-checkbox-filter-by-extent").prop("checked"),moreInfoLink:r.find(".opt-checkbox-more-infoLink").prop("checked"),moreInfoLinkAlias:r.find(".opt-more-infoLink-alias").val()}},this.initLocalization=function(){n.html("General options")};var s=function(){r.find(".opt-checkbox-more-infoLink").on("click",function(){r.find(".opt-more-infoLink-alias-cont").toggle()})}}}),define("lib-build/tpl!storymaps/tpl/builder/settings/ViewMapOptions",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="settings-mapoptions">\r\n	<div class="checkbox">\r\n		<label>\r\n			<input type="checkbox" class="opt-checkbox-locateBtn" />\r\n			Locate Button\r\n			<a href="#" class="help" data-toggle="tooltip" data-placement="right">\r\n				<img class="helpImg" src="resources/tpl/builder/icons/builder-help.png">\r\n			</a>\r\n		</label>\r\n	</div>\r\n	<div class="checkbox">\r\n		<label>\r\n			<input type="checkbox" class="opt-checkbox-place-finder" />\r\n			Address or Place Finder\r\n			<a href="#" class="help" data-toggle="tooltip" data-placement="right">\r\n				<img class="helpImg" src="resources/tpl/builder/icons/builder-help.png">\r\n			</a>\r\n		</label>\r\n	</div>\r\n	<div class="checkbox" >\r\n		<label>\r\n			<input type="checkbox" class="opt-checkbox-bookmarks" />\r\n			Bookmarks\r\n			<a href="#" class="help" data-toggle="tooltip" data-placement="right">\r\n				<img class="helpImg" src="resources/tpl/builder/icons/builder-help.png">\r\n			</a>\r\n		</label>\r\n	</div>\r\n</div>\r\n';return __p}}),define("lib-build/css!storymaps/tpl/builder/settings/ViewMapOptions",[],function(){}),define("storymaps/tpl/builder/settings/ViewMapOptions",["lib-build/tpl!./ViewMapOptions","lib-build/css!./ViewMapOptions"],function(e){return function(){var n=null,r=null,i=null;this.init=function(t,i){n=t,r=i,r.append(e({})),r.find(".help").tooltip({trigger:"hover"})},this.present=function(e){r.find(".opt-checkbox-locateBtn").prop("checked",e.locateBtn&&e.locateBtn.enable),r.find(".opt-checkbox-geocoder").prop("checked",e.geocoder&&e.geocoder.enable),r.find(".opt-checkbox-bookmarks").prop("checked",e.bookmarks),i=e},this.show=function(){},this.save=function(){return{locateBtn:{enable:r.find(".opt-checkbox-locateBtn").prop("checked")},geocoder:{enable:r.find(".opt-checkbox-geocoder").prop("checked")},bookmarks:r.find(".opt-checkbox-bookmarks").prop("checked")}},this.initLocalization=function(){n.html("Map options")}}}),define("lib-build/tpl!storymaps/common/builder/settings/ViewHeader",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="settings-header">\r\n	<div class="settings-simulator">\r\n		<img class="imgLogo"/>\r\n	</div>\r\n	<div class="settings-content">\r\n		<form role="form" class="form1">\r\n			<div class="form-group form-inline form-horizontal">\r\n				<div class="radio">\r\n					<label>\r\n						<input type="radio" name="optionsLogo" id="optionsRadios2" value="esri" checked>\r\n						<span class="logoText">'+((__t=logoEsri)==null?"":__t)+'</span>\r\n					</label>\r\n				</div>\r\n				<div class="radio">\r\n					<label>\r\n						<input type="radio" name="optionsLogo" id="optionsRadios1" value="none">\r\n						<span class="logoText">'+((__t=logoNone)==null?"":__t)+'</span>\r\n					</label>\r\n				</div>\r\n				<div class="radio">\r\n					<label>\r\n						<input type="radio" name="optionsLogo" id="optionsRadios2" value="custom">\r\n						<span class="logoText">'+((__t=logoCustom)==null?"":__t)+'</span>\r\n					</label>\r\n				</div>\r\n				<div class="optionsLogoCustom">\r\n					<table class="settings-table">\r\n						<tr>\r\n							<td class="td-lbl">'+((__t=logoCustomlbl)==null?"":__t)+'</td>\r\n							<td class="td-input"><input class="form-control input-sm" id="logoInput" type="text" placeholder="'+((__t=logoCustomHelp)==null?"":__t)+'"></td>\r\n						</tr>\r\n						<tr>\r\n							<td class="td-lbl">'+((__t=logoLinkLbl)==null?"":__t)+'</td>\r\n							<td class="td-input"><input class="form-control input-sm" id="logoTargetInput" type="text" spellcheck="true" placeholder="'+((__t=logoTargetHelp)==null?"":__t)+'"></td>\r\n						</tr>\r\n					</table>\r\n				</div>\r\n			</div>\r\n		</form>\r\n\r\n		<form class="form2">\r\n			<p>'+((__t=socialExplain)==null?"":__t)+'</p>\r\n			<div class="form-group socialConfig">\r\n				<div class="checkbox">\r\n					<label>\r\n						<input type="checkbox" class="enableFB" />\r\n						<span class="social-lbl">Facebook</span>\r\n					</label>\r\n				</div>\r\n				<div class="checkbox">\r\n					<label>\r\n						<input type="checkbox" class="enableTwitter" />\r\n						<span class="social-lbl">Twitter</span>\r\n					</label>\r\n				</div>\r\n				<div class="checkbox">\r\n					<label>\r\n						<input type="checkbox" class="enableBitly" />\r\n						<span class="social-lbl">Share</span>\r\n					</label>\r\n				</div>\r\n			</div>\r\n			<table class="settings-table">\r\n				<tr>\r\n					<td class="td-lbl">'+((__t=socialText)==null?"":__t)+'</td>\r\n					<td class="td-input"><input id="selectSocialText" type="text" class="form-control input-sm" /></td>\r\n				</tr>\r\n				<tr>\r\n					<td class="td-lbl">'+((__t=socialLink)==null?"":__t)+'</td>\r\n					<td class="td-input"><input id="selectSocialLink" type="text" class="form-control input-sm" /></td>\r\n				</tr>\r\n			</table>\r\n		</form>\r\n	</div>\r\n	<form class="form-config-size">\r\n		<div class="checkbox">\r\n			<label>\r\n				<input type="checkbox" class="enableCompact" />\r\n				<span>'+((__t=lblSmallHeader)==null?"":__t)+"</span>\r\n			</label>\r\n		</div>\r\n	</form>\r\n</div>\r\n";return __p}}),define("lib-build/css!storymaps/common/builder/settings/ViewHeader",[],function(){}),define("storymaps/common/builder/settings/ViewHeader",["lib-build/tpl!./ViewHeader","lib-build/css!./ViewHeader","../../utils/CommonHelper"],function(e,t,n){return function(r){function f(){v()}function l(){}function c(){a=!0,s.find(".imgLogo").hide()}function h(e){if(e.keyCode==13)return a=!1,p(),!1;e.keyCode==8&&($("#logoTargetInput").focus(),$("#logoInput").focus())}function p(){var e=$.trim($("#logoInput",s).val());s.find(".imgLogo").attr("src",n.prependURLHTTP(e)).show()}function d(e){e.keyCode==8&&($("#logoInput").focus(),$("#logoTargetInput").focus())}function v(){var e=$("input[name=optionsLogo]:checked",s).val();s.find(".imgLogo").hide(),e=="custom"?p():e=="esri"&&s.find(".imgLogo").attr("src","resources/tpl/viewer/icons/esri-logo.png").show()}var i=null,s=null,o=null,u=null,a=!1;r=r||{},this.init=function(t,n){i=t,s=n,s.append(e({explain:i18n.commonCore.settingsHeader.explain,logoEsri:i18n.commonCore.settingsHeader.logoEsri,logoNone:i18n.commonCore.settingsHeader.logoNone,logoCustom:i18n.commonCore.settingsHeader.logoCustom,logoCustomlbl:"Image:",logoLinkLbl:i18n.commonCore.settingsHeader.logoSocialLink+":",logoCustomHelp:i18n.commonCore.settingsHeader.logoCustomPlaceholder,logoTargetHelp:i18n.commonCore.settingsHeader.logoCustomTargetPlaceholder,socialExplain:i18n.commonCore.settingsHeader.logoSocialExplain,socialText:i18n.commonCore.settingsHeader.logoSocialText+":",socialLink:i18n.commonCore.settingsHeader.logoSocialLink+":",lblSmallHeader:i18n.commonCore.settingsHeader.lblSmallHeader})),o=s.find("#logoInput"),u=s.find("#logoTargetInput"),o.keydown(h),o.focusout(p),u.keydown(d),$("input[type=radio]",s).click(f),$("#imgLogo",s).error(c),$("#imgLogo",s).load(l),s.find(".form-config-size").toggle(r.smallSizeOpt)},this.present=function(e){var t=e.logoURL,n=app.data.getWebAppData().getColors();o.attr("disabled","true"),u.attr("disabled","true"),$("input[name='optionsLogo']",s).change(function(){var e=$("input[name='optionsLogo']:checked",s).val();e=="none"||e=="esri"?(o.attr("disabled","true"),u.attr("disabled","true")):(o.removeAttr("disabled"),u.removeAttr("disabled"))}),$("#headerSimulator",s).css("background-color",n),t==app.cfg.HEADER_LOGO_URL||t==null?($("input[name=optionsLogo]:eq(0)",s).attr("checked","checked"),$("#imgLogo",s).show(),o.val(""),u.val("")):t==="NO_LOGO"?($("input[name=optionsLogo]:eq(1)",s).attr("checked","checked"),o.val(""),u.val("")):($("input[name=optionsLogo]:eq(2)",s).attr("checked","checked"),$("#imgLogo",s).attr("src",t),$("#imgLogo",s).show(),$("#logoInput",s).val(t),u.val(e.logoTarget),o.removeAttr("disabled"),u.removeAttr("disabled")),$("#selectSocialText",s).val(e.linkText===undefined?app.cfg.HEADER_LINK_TEXT:e.linkText),$("#selectSocialLink",s).val(e.linkURL===undefined?app.cfg.HEADER_LINK_URL:e.linkURL),$("#selectSocialText",s).blur(function(){$(window).scrollTop(0)}),$("#selectSocialLink",s).blur(function(){$(window).scrollTop(0)}),$("#logoInput",s).blur(function(){$(window).scrollTop(0)}),u.blur(function(){$(window).scrollTop(0)}),app.cfg.HEADER_SOCIAL.facebook?(!e.social||e.social.facebook)&&$(".enableFB",s).prop("checked",!0):$(".enableFB",s).attr("disabled","disabled").parent().addClass("disabled").attr("title",i18n.commonCore.common.disabledAdmin),app.cfg.HEADER_SOCIAL.twitter?(!e.social||e.social.twitter)&&$(".enableTwitter",s).prop("checked",!0):$(".enableTwitter",s).attr("disabled","disabled").parent().addClass("disabled").attr("title",i18n.commonCore.common.disabledAdmin),!app.cfg.HEADER_SOCIAL.bitly||!app.cfg.HEADER_SOCIAL.bitly.enable||!app.cfg.HEADER_SOCIAL.bitly.login||!app.cfg.HEADER_SOCIAL.bitly.key?$(".enableBitly",s).attr("disabled","disabled").parent().addClass("disabled").attr("title",i18n.commonCore.common.disabledAdmin):(!e.social||e.social.bitly)&&$(".enableBitly",s).prop("checked",!0),v(),s.find(".enableCompact").prop("checked",e.compactSize)},this.show=function(){setTimeout(function(){var e=Math.max.apply(Math,s.find(".td-lbl").map(function(){return $(this).width()}).get());s.find(".td-lbl").css("min-width",e)},200)},this.save=function(){var e=s.find("input[name=optionsLogo]:checked").val(),t,r;e=="none"?(t="NO_LOGO",r=""):e=="esri"?(t=null,r=""):(t=a?app.cfg.HEADER_LOGO_URL:n.prependURLHTTP(s.find(".imgLogo").attr("src")),r=u.val());var i=$("#selectSocialText",s).val()||"";i=i.replace(/<\/?script>/g,"");var o=$("#selectSocialLink",s).val()||"";return o=o.replace(/<\/?script>/g,""),{linkText:i,linkURL:n.prependURLHTTP(o),logoURL:t,logoTarget:n.prependURLHTTP(r),social:{facebook:$(".enableFB").prop("checked"),twitter:$(".enableTwitter").prop("checked"),bitly:$(".enableBitly").prop("checked")},compactSize:s.find(".enableCompact").prop("checked")}},this.initLocalization=function(){i.html(i18n.commonCore.settingsHeader.title)}}}),define("lib-build/tpl!storymaps/tpl/builder/Workflow",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div id="addFeatures" tabindex="-1">\r\n	Would you like to build your shortlist by adding features?\r\n</div>\r\n\r\n<div id="addWebMap" tabindex="-1">\r\n	Or would you like to build your shortlist from an existing web map?\r\n</div>\r\n';return __p}}),define("lib-build/css!storymaps/tpl/builder/Workflow",[],function(){}),define("lib-build/tpl!storymaps/tpl/builder/Data",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div id="oneLayer" tabindex="-1">\r\n	Are all of your features in one layer and need to be split up into different tabs?\r\n</div>\r\n\r\n<div id="multiLayers" tabindex="-1">\r\n	Or do you have several layers that will each make up a tab?\r\n</div>\r\n';return __p}}),define("lib-build/css!storymaps/tpl/builder/Data",[],function(){}),define("storymaps/tpl/builder/Data",["lib-build/tpl!./Data","lib-build/css!./Data"],function(e,t){return function(n){function i(){console.log("$$$")}function s(){n.find(".btnNext").attr("disabled"),n.find(".btnNext").click(i),r=!0}var r=!1;this.present=function(t){n.find(".modal-body").empty(),n.find(".modal-body").append(e()),s()},this.close=function(){}}}),define("storymaps/tpl/builder/Workflow",["lib-build/tpl!./Workflow","lib-build/css!./Workflow","./Data"],function(e,t,n){return function(r){function o(){console.log("$$$"),s.present()}function u(){r.find(".btnNext").attr("disabled"),r.find(".btnNext").click(o),i=!0}var i=!1,s=new n(r);this.present=function(t){r.find(".modal-body").empty(),r.find(".modal-body").append(e()),u()},this.close=function(){}}}),define("lib-build/tpl!storymaps/tpl/builder/AddFeatureBar",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div id="addFeatureBar">\r\n	<button id="addFeature" class="btn btn-success">Add</button>\r\n	<button id="importFeature" class="btn btn-success">Import</button>\r\n	<button id="organizeFeatures" class="btn btn-primary">Organize</button>\r\n	<button id="locateFeatures" class="btn btn-warning">\r\n		<span class="unlocatedFeatures"></span>\r\n	</button>\r\n	<button id="completeOrganization" class="btn btn-success">Done</button>\r\n	<button id="deleteFeatures" class="btn btn-danger disabled">Delete</button>\r\n	<div id="moveFeaturesContainer" class="dropdown">\r\n		<button class="btn btn-default dropdown-toggle disabled" type="button" id="moveFeaturesDropdownMenu" data-toggle="dropdown">\r\n			Move\r\n			<span class="caret"></span>\r\n		</button>\r\n		<ul id="tabSelector" class="dropdown-menu" >\r\n		</ul>\r\n	</div>\r\n</div>\r\n';return __p}}),define("lib-build/css!storymaps/tpl/builder/AddFeatureBar",[],function(){}),define("storymaps/tpl/builder/AddFeatureBar",["lib-build/tpl!./AddFeatureBar","lib-build/css!./AddFeatureBar","../core/WebApplicationData","../core/Helper","../../common/builder/BuilderHelper","esri/geometry/Point","esri/symbols/SimpleMarkerSymbol","esri/SpatialReference","esri/geometry/webMercatorUtils","esri/layers/FeatureLayer","esri/graphic","dojo/topic","dojo/_base/lang"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){return function(h,p){function x(e,t){var n=t*4,r=e.data;return[r[n],r[n+1],r[n+2],r[n+3]]}function T(e){var t=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;e=e.replace(t,function(e,t,n,r){return t+t+n+n+r+r});var n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return n?{r:parseInt(n[1],16),g:parseInt(n[2],16),b:parseInt(n[3],16)}:null}function N(e,t){var n=(new esri.symbol.PictureMarkerSymbol(e.toDataURL(),t.getWidth(),t.getHeight())).setOffset(t.getOffsetX(),t.getOffsetY());return n}function C(){var e={};e.mode="import",g.present(e),$("#editorDialogInlineMedia").show(),$(".modal-backdrop").show()}function k(){console.log("ORGANIZE FEATURES"),$("body").addClass("organizeFeatures"),$(".builder-content-panel .builder-content-panel-group").addClass("disabled"),$(".builder-lbl").addClass("disabled"),$(".builder-content-panel.inline .builder-btn").addClass("disabled"),app.ui.tilePanel.initSortable(),$("#addFeature").hide(),$("#importFeature").hide(),$("#organizeFeatures").hide(),$("#locateFeatures").hide(),$("#deleteFeatures").addClass("disabled"),$("#moveFeaturesDropdownMenu").addClass("disabled"),$("#completeOrganization").show(),$("#deleteFeatures").show();var e=$(".entry.active").index();$(".dropdown-menu .entry").length>1&&($("#tabSelector").empty(),$.each($(".dropdown-menu .entry"),function(t){t==e?$("#tabSelector").append($('<li class="disabledTab"><a href="#">'+app.data.getStory()[t].title+"</a></li>")):$("#tabSelector").append($('<li class="enabledTab"><a href="#">'+app.data.getStory()[t].title+"</a></li>"))}),e===0&&$("#tabSelector option:eq(1)"),$("#moveFeaturesContainer").css("display","inline-block")),h.find("#moveFeaturesContainer li.enabledTab").on("click",A),$("#myList").find("li").on("click",function(){$("body").hasClass("organizeFeatures")&&($(this).toggleClass("selected"),$("#myList").find("li.selected").length?($("#deleteFeatures").removeClass("disabled"),$("#moveFeaturesDropdownMenu").removeClass("disabled")):($("#deleteFeatures").addClass("disabled"),$("#moveFeaturesDropdownMenu").addClass("disabled")))})}function L(){console.log("DELETE FEATURES");var e=$("#myList").find("li.selected"),t=app.map.getLayer(app.data.getShortlistLayerId());$.each(e,function(e,n){var r=$.grep(t.graphics,function(e){return e.attributes.shortlist_id==$(n).data("shortlist-id")});t.remove(r[0])}),v.updateAllFeatures(),app.ui.tilePanel.buildTilePanel(),app.detailPanelBuilder.buildSlides(),v.updateLocatedFeatures(),$("#myList").find("li").on("click",function(){$("body").hasClass("organizeFeatures")&&$(this).toggleClass("selected")}),$("#deleteFeatures").addClass("disabled"),$("#moveFeaturesDropdownMenu").addClass("disabled"),v.exitOrganizeMode()}function A(){console.log("MOVE FEATURES");var e=$(this).index(),t=$("#myList").find("li.selected"),r=app.map.getLayer(app.data.getShortlistLayerId()),i=900;$.each(t,function(t,n){var s=$.grep(r.graphics,function(e){return e.attributes.shortlist_id==$(n).data("shortlist-id")});s[0].attributes.tab_id=e,s[0].attributes.number=i,s[0].attr("number",i),i++}),v.updateAllFeatures();var s=$(".entry.active").index(),o=[];$.each(r.graphics,function(e,t){t.attributes.tab_id==s?(t.show(),o.push(t)):t.hide()}),app.layerCurrent.graphics=o,app.ui.tilePanel.buildTilePanel(),v.updateLocatedFeatures(!0),$("#deleteFeatures").addClass("disabled"),$("#moveFeaturesDropdownMenu").addClass("disabled"),v.exitOrganizeMode(!0),n.getTitle()&&c.publish("INCREMENT_SAVE_COUNTER")}function O(){console.log("SHOW UNLOCATED FEATURES"),$("body").addClass("locateFeatures"),$(".located").hide(),$("#addFeature").hide(),$("#importFeature").hide(),$("#organizeFeatures").hide(),$("#completeOrganization").show(),$("#locateFeatures").hide(),app.detailPanelBuilder.buildSlides(!0)}function M(){d=!0}function _(){h.find("#addFeature").on("click",v.addFeature),h.find("#importFeature").on("click",C),h.find("#organizeFeatures").on("click",k),h.find("#locateFeatures").on("click",O),h.find("#completeOrganization").on("click",v.exitOrganizeMode),h.find("#deleteFeatures").on("click",L)}var d=!1,v=this,m,g=p,y=new r,b,w,E,S;this.loaded=!1,this.init=function(t,n){v.loaded=!0,m=t,S=n,setTimeout(function(){h.find("#paneLeft").prepend(e()),M(),_(),v.updateLocatedFeatures()},0),$("#importFeature").prop("disabled",!0),w=document.createElement("canvas"),E=w.getContext("2d"),b=new Image,b.src=app.cfg.ICON_SRC,b.onload=function(){E.drawImage(b,0,0),E.font=w.width/2+"pt Calibri"},$("#myList").addClass("builder")},this.close=function(){},this.addLayer=function(e){var t=i.getNewLayerJSON(i.getFeatureCollectionTemplate(!0));app.data.getWebMap().itemData.operationalLayers.push(t),n.setShortlistLayerId(t.id);var r=new f(t.featureCollection.layers[0]);r.id=t.id,app.map?app.map.addLayer(r):setTimeout(function(){app.map.addLayer(r)},500),app.data.setShortlistLayerId(t.id),app.layerCurrent=r,r.on("mouse-over",m.layer_onMouseOver),r.on("mouse-out",m.layer_onMouseOut),r.on("click",m.layer_onClick);if(app.isInBuilder&&(app.isDirectCreationFirstSave||e)){app.detailPanelBuilder.addDetailPanelSwiper(0);var s=app.cfg.COLOR_ORDER.split(","),o=$.grep(app.cfg.COLOR_SCHEMES,function(e){return e.name.toLowerCase()==$.trim(s[0].toLowerCase())})[0];app.data.setStory(0,"Tab 1",o.color),n.setTabs(app.data.getStory()),m.activateLayer(0)}},this.addFeature=function(e,t,r){e&&e.type=="click"&&(e=null);var i=$(".entry.active").index();i<0&&(i=0);var f=app.map.getLayer(app.data.getShortlistLayerId()),p=$.grep(f.graphics,function(e){return e.attributes.tab_id==i}),d=p.length,m=app.cfg.COLOR_ORDER.split(","),g=$.grep(app.cfg.COLOR_SCHEMES,function(e){return e.name==m[i]}),b=app.data.getStory()[i].color,w=e&&e.name?e.name:"Place Name",E=e&&e.thumb_url?e.thumb_url:"";E||(E=e&&e.pic_url?e.pic_url:"http://geospatialpr.com/wp-content/uploads/2015/11/esri.png");var S=$('<li tabindex="0" id="item'+(d+1)+'" style="display:block"><div class="footer"><div class="blurb  ">'+w+'</div></div><div class="tileImage" style="outline: none; background-image: url('+E+');"></div></li>');n.getMapOptions().numberedIcons&&$(S).find(".footer").prepend($('<div class="num" style="background-color:'+b+'">'+(d+1)+"</div>")),h.find("#myList").append(S);var x=f.graphics.length+1;$(S).data("shortlist-id",x),h.find("#item"+(p.length+1)).on("click",function(){if($("body").hasClass("organizeFeatures"))return;app.detailPanelBuilder.showSlide($(this).data("shortlist-id"))}),h.find("#item"+p.length).on("mouseover",app.ui.tilePanel.tile_onMouseOver),h.find("#item"+p.length).on("mouseout",app.ui.tilePanel.tile_onMouseOut),app.detailPanelBuilder.addSlide(p.length+1,x,e),app.detailPanelBuilder.showSlide(x);var T,N={__OBJECTID:x,name:e&&e.name?e.name:"feature title",description:e&&e.description?e.description:"feature description",pic_url:e&&e.pic_url?e.pic_url:"http://storymaps.arcgis.com/en/my-stories/assets/images/my-stories/placeholders/desert.png",thumb_url:e&&e.thumb_url?e.thumb_url:"http://geospatialpr.com/wp-content/uploads/2015/11/esri.png",website:e&&e.website?e.website:"www.esri.com",shortlist_id:x,number:p.length+1,tab_id:i,locationSet:r?1:0,getValueCI:y.getValueCI};if(!r){var C=45,k=45,L=0;e&&e.lng&&e.lat?(C=e.lng,k=e.lat,L=1,$(S).addClass("located")):$(S).find(".tileImage").append('<div class="unlocated" style="outline: none;"></div>');var A=new s(C,k,new u({wkid:4326}));T=a.geographicToWebMercator(A),N.locationSet=L}else $(S).addClass("located"),T=r;var O=new o,M=new l(T,O,N),_=v.addMapIcon(M,app.data.getStory()[i].color);f.add(_),app.layerCurrent.add(_),p.push(_),N.locationSet||_.hide(),t&&v.updateLocatedFeatures(),n.getTitle()&&c.publish("INCREMENT_SAVE_COUNTER")},this.updateAllFeatures=function(e){console.log("UPDATE ALL FEATURES",e);var t=0,r=app.map.getLayer(app.data.getShortlistLayerId()),i=r.graphics,s={};$.each(i,function(e,t){t.attributes.tab_id in s||(s[t.attributes.tab_id]=t.attributes.tab_id)});if(e){$.each(e.entries,function(e,t){delete s[t.id]});var o=i.slice(0);$.each(o,function(e,t){t.attributes.tab_id in s&&r.remove(t)});var u=[];$.each(e.entries,function(e,t){u.push($.grep(i,function(e){return e.attributes.tab_id==t.id}))}),$.each(u,function(e,t){$.each(t,function(t,n){n.attributes.tab_id=e}),t.id=e})}var a=[],f=$("#nav-bar").find(".nav-tabs > li:not(.dropdown)");$.each(f,function(){a.push([])}),$.each(i,function(e,t){a[t.attributes.tab_id].push(t)});var l=[],h=[];$.each(a,function(n,r){r.sort(function(e,t){return parseInt(e.attributes.number)-parseInt(t.attributes.number)});var i=e&&e.entries[n].color?e.entries[n].color:app.data.getStory()[n].color,s=e&&e.entries[n].title?e.entries[n].title:app.data.getStory()[n].title;$.each(r,function(e,n){n.attributes.shortlist_id=t,n.attributes.number=e+1;var r=v.addMapIcon(n,i);n.symbol=r.symbol,t++}),l.push(s),h.push(i)}),app.data.clearStory(),$.each(a,function(e){app.data.setStory(e,l[e],h[e])}),n.setTabs(app.data.getStory());var p=$(".entry.active").index();e&&(p=e.sectionIndex),app.layerCurrent.graphics=a[p],app.layerCurrent.color=app.data.getStory()[p].color,r.redraw(),n.getTitle()&&c.publish("INCREMENT_SAVE_COUNTER")},this.exitOrganizeMode=function(e){console.log("EXIT ORGANIZATION"),$("body").hasClass("organizeFeatures")&&app.ui.tilePanel.destroySortable(),$("#myList").find("li").removeClass("selected"),$(".builder-content-panel .builder-content-panel-group").removeClass("disabled"),$(".builder-lbl").removeClass("disabled"),$(".builder-content-panel.inline .builder-btn").removeClass("disabled"),$(".located").show(),$("#addFeature").show(),$("#importFeature").show(),$("#organizeFeatures").show(),v.updateLocatedFeatures(),$("#completeOrganization").hide(),$("#deleteFeatures").hide(),$("#moveFeaturesContainer").hide(),$("#myList").find("li").off(),$("body").removeClass("locateFeatures"),$("#myList").find("li").on("click",function(){if($("body").hasClass("organizeFeatures"))return;app.detailPanelBuilder.showSlide($(this).data("shortlist-id"))}),app.layerCurrent.graphics.length?e?app.detailPanelBuilder.buildAllSlides():app.detailPanelBuilder.buildSlides():($("#locateFeatures").hide(),$("#organizeFeatures").hide())},this.updateLocatedFeatures=function(e){console.log("UPDATE LOCATED FEATURES");var t=[];app.layerCurrent&&(t=app.layerCurrent.graphics);var n=e||$(".entry.active").index();n<0&&(n=0);var r=$.grep(t,function(e){return e.attributes.tab_id==n});r.length&&!$("body").hasClass("organizeFeatures")&&!$("body").hasClass("locateFeatures")?$("#organizeFeatures").show():$("#organizeFeatures").hide();var i=$.grep(r,function(e){return!e.attributes.locationSet});$(".unlocatedFeatures").text(i.length);if(i.length>0&&!$("body").hasClass("organizeFeatures"))$("#locateFeatures").show();else{if(app.isLoading)return;$("#locateFeatures").hide()}i.length===0&&$("#locateFeatures").hide(),t.length===0&&$("#organizeFeatures").hide(),c.publish("INCREMENT_SAVE_COUNTER")},this.updateNumber=function(){console.log("UPDATE NUMBER"),$.each($(".tilelist li"),function(e,t){$(t).attr("id","item"+e),$(t).find(".num").text(e+1),app.layerCurrent.graphics.sort(function(e,t){return e.attributes.Number-t.attributes.Number})}),setTimeout(function(){app.detailPanelBuilder.buildSlides()},500),n.getTitle()&&c.publish("INCREMENT_SAVE_COUNTER")},this.addMapIcon=function(e,t,r){var i=app.cfg.lutIconSpecs.tiny,s,o=t,u=document.createElement("canvas");u.width=b.width,u.height=b.height;var a=u.getContext("2d");a.font="bold "+u.width/3.8+"pt Calibri",a.drawImage(w,0,0);if(!s){var f=a.getImageData(0,0,w.width,w.height),l=x(f,4804);if(l[0]!=T(o).r&&l[1]!=T(o).g&&l[1]!=T(o).b){for(var c=0;c<f.data.length;c+=4)f.data[c]==l[0]&&f.data[c+1]==l[1]&&f.data[c+2]==l[2]&&(f.data[c]=T(o).r,f.data[c+1]=T(o).g,f.data[c+2]=T(o).b);a.putImageData(f,0,0)}s=f}a.putImageData(s,0,0);if(n.getMapOptions().numberedIcons){var h=e.attributes.getValueCI(app.cfg.FIELDNAME_NUMBER);a.textAlign="center",a.fillStyle="white",a.fillText(h,u.width/3.2,u.height/2)}if(!r){var p=new esri.Graphic(new esri.geometry.Point(e.geometry),N(u,i),e.attributes);return p}e.setSymbol(N(u,i))}}}),define("lib-build/tpl!storymaps/tpl/builder/DetailPanelBuilder",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="detailContainer swiper-container">\r\n	<button type="button" class=\'detailClose ion-android-close\' style=""></button>\r\n	<div class="detail-btn-container detail-btn-left">\r\n		<div class="detail-btn ion-chevron-left" style="outline: none;"></div>\r\n	</div>\r\n	<div class="detail-btn-container detail-btn-right">\r\n		<div class="detail-btn ion-chevron-right" style="outline: none;"></div>\r\n	</div>\r\n	<div class="detail-btn-container detail-btn-add">\r\n		<div class="detail-btn" style="outline: none;"> + </div>\r\n	</div>\r\n	<div class="detailView swiper-wrapper"></div>\r\n</div>\r\n';return __p}}),define("lib-build/tpl!storymaps/tpl/builder/DetailPanelBuilderSlide",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class=\'swiper-slide\'>\r\n	<div class=\'detailHeader\'>\r\n		<div class="detailFeatureNum" ></div>\r\n		<div class=\'detailFeatureTitle\'>\r\n		</div>\r\n	</div>\r\n	<div class="detailTextContainer">\r\n		<div class="detailPictureDiv">\r\n			<img style="max-width: 506px; max-height: 493px;" src="http://storymaps.arcgis.com/en/my-stories/assets/images/my-stories/placeholders/desert.png">\r\n		</div>\r\n		<div class=\'description detailFeatureDesc editable\'>\r\n\r\n		</div>\r\n		<div class="website"></div>\r\n	</div>\r\n	<div class="editLocationContainer">\r\n		<button class="editLocation btn btn-primary" >Add Location</button>\r\n	</div>\r\n</div>\r\n';return __p}}),define("lib-build/css!storymaps/tpl/builder/DetailPanelBuilder",[],function(){}),define("storymaps/tpl/builder/MovableGraphic",["dojo/has","dojo/touch","dojo/on","dojo/_base/array","dojo/_base/connect"],function(e,t,n,r,i){return function(o,u,a,f,l){function p(){var r=i.connect(u,"onMouseOver",function(e){e.graphic==a&&o.setMapCursor("move")}),s=i.connect(u,"onMouseOut",function(e){e.graphic==a&&o.setMapCursor("default")}),l=n(u._div.rawNode,t.press,function(t){if(t.graphic==a||e("touch")||e("ie")==10||e("trident")==7)o.disablePan(),c=!0,a.hasBeenMoved=!1}),p=t.release(u._div.rawNode,function(){o.enablePan(),c=!1,f&&a.hasBeenMoved&&f(a,!0)}),v=e("touch")||e("ie")>=10||e("trident")==7?t.move(o.__container,d):i.connect(o,"onMouseDrag",d);h=[r,s,l,p,v]}function d(e){c&&e.mapPoint&&(a.setGeometry(e.mapPoint),l&&!a.hasBeenMoved&&l(a),a.hasBeenMoved=!0)}var c=!1,h=[];p(),this.clean=function(){r.forEach(h,function(e){i.disconnect(e)})}}}),define("storymaps/tpl/builder/DetailPanelBuilder",["lib-build/tpl!./DetailPanelBuilder","lib-build/tpl!./DetailPanelBuilderSlide","lib-build/css!../ui/desktop/DetailPanel","lib-build/css!./DetailPanelBuilder","../core/WebApplicationData","./MovableGraphic","esri/geometry/webMercatorUtils","esri/SpatialReference","esri/graphic","esri/geometry/Point","esri/symbols/SimpleMarkerSymbol","esri/dijit/Search","dojo/topic"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){return function(r,l){function S(e){console.log("OPEN SEARCH WIDGET ",e),$("body").addClass("pickLocation");var t=$.grep(app.layerCurrent.graphics,function(t){return t.attributes.shortlist_id==e}),n=$(".entry.active").index(),r=v[n].slides[v[n].activeIndex];if($(r).find(".editLocation").hasClass("btn-danger")){$(r).find(".editLocation").removeClass("btn-danger"),$(r).find(".editLocation").addClass("btn-primary"),t[0].attributes.locationSet?$(r).find(".editLocation").text("Edit Location"):$(r).find(".editLocation").text("Add Location"),y.hide();return}y.show(),$(r).find(".editLocation").text("Cancel"),$(r).find(".editLocation").removeClass("btn-primary"),$(r).find(".editLocation").addClass("btn-danger");if(!t[0].attributes.locationSet){app.map.setMapCursor("crosshair");var i=app.map.on("click",function(n){t[0].setGeometry(n.mapPoint),t[0].show(),t[0].attributes.locationSet=1,$(r).find(".editLocation").addClass("btn-primary"),$(r).find(".editLocation").removeClass("btn-danger"),y.hide(),app.map.setMapCursor("auto"),$(r).find(".editLocation").text("Edit Location"),i.remove();var s=$.grep($("#myList li"),function(t){return $(t).data("shortlist-id")==e});$(s).find(".unlocated").removeClass("unlocated"),app.addFeatureBar.updateLocatedFeatures();var o=app.map.getLayer(app.data.getShortlistLayerId());o.redraw(),x(t[0]),$("body").removeClass("pickLocation")})}else{t[0].hide();var o=new a(t[0].geometry,t[0].symbol,t[0].attributes);b.add(o),b.graphics[0].show(),w=new s(app.map,b,b.graphics[0],T),E.buildMapTips("Move icon to new location")}}function x(e){var t=$.grep($("#myList li"),function(t){return $(t).data("shortlist-id")==e.attributes.shortlist_id});$(t).addClass("located"),$("body").hasClass("organizeFeatures"),$("body").hasClass("locateFeatures")&&$(".located").hide()}function T(e,t){w&&w.clean(),E.buildMapTips(),y.hide(),$("body").removeClass("pickLocation");var n=$(".entry.active").index(),r=$.grep(app.layerCurrent.graphics,function(t){return t.attributes.shortlist_id==e.attributes.shortlist_id}),i=v[n].slides[v[n].activeIndex];r[0].attributes.locationSet?(r[0].show(),$(i).find(".editLocation").text("Edit Location")):$(i).find(".editLocation").text("Add Location"),t&&r[0].setGeometry(e.geometry),app.map.getLayer("tempIconLayer").remove(app.map.getLayer("tempIconLayer").graphics[0]);var s=app.map.getLayer(app.data.getShortlistLayerId());s.redraw(),app.addFeatureBar.updateLocatedFeatures(),app.map.setMapCursor("auto"),$(i).find(".editLocation").removeClass("btn-danger"),$(i).find(".editLocation").addClass("btn-primary")}function N(){var e={};e.mode="add",m.present(e)}function C(){var e=$(".entry.active").index();v[e].slides.length==1?($(".detail-btn-left").hide(),$(".detail-btn-right").hide()):($(".detail-btn-left").show(),v[e].activeIndex!=v[e].slides.length-1&&$(".detail-btn-right").show()),v[e].activeIndex==v[e].slides.length-1&&!$("body").hasClass("locateFeatures")?($(".detail-btn-right").hide(),$(".detail-btn-add").show()):($(".detail-btn-add").hide(),v[e].slides.length>1&&$(".detail-btn-right").show())}function k(){console.log("$$$")}function L(){p=!0}var p=!1,d,v=[],m=l,g=this,y,b,w,E;this.init=function(e){E=e,setTimeout(function(){y=new c({map:app.map},"search"),y.startup(),y.hide(),y.on("select-result",function(e){y.hide(),app.map.setMapCursor("auto");var t=$('<div class="addLocationText"><a href="#">Use this location </a> </div>');$(".esriPopup .contentPane").append(t),$(t).on("click",function(){var t=$(".entry.active").index(),n=$(".swiper-slide-active")[t];$(n).find(".editLocation").text("Edit Location");var r=$.grep(app.layerCurrent.graphics,function(e){return e.attributes.shortlist_id==$(n).data("shortlist-id")});r[0].setGeometry(e.result.feature.geometry),r[0].attributes.locationSet=1,r[0].show(),y.highlightGraphic.hide(),$(".esriPopup").hide();var i=app.map.getLayer(app.data.getShortlistLayerId());i.redraw(),app.map.getLayer("tempIconLayer").remove(app.map.getLayer("tempIconLayer").graphics[0]),app.addFeatureBar.updateLocatedFeatures(),$(n).find(".editLocation").removeClass("btn-danger"),$(n).find(".editLocation").addClass("btn-primary"),x(r[0])})})},500),b=new esri.layers.GraphicsLayer,b.id="tempIconLayer",app.map.addLayer(b)},this.buildSlides=function(e,t){var n=app.map.getLayer(app.data.getShortlistLayerId()),r=$(".entry.active").index();r<0&&(r=0),t>-1&&(r=t),v[r].removeAllSlides();var s=$.grep(n.graphics,function(e){return e.attributes.tab_id==r});e&&(s=$.grep(s,function(e){return!e.attributes.locationSet})),$.each(s,function(e,t){var n=t.attributes,s=n.getValueCI(app.cfg.FIELDNAME_TITLE),o=n.description,u=n.getValueCI(app.cfg.FIELDNAME_IMAGEURL),a=n.website,f=$("<div class='swiper-slide'></div>"),l,c=$("<div class='detailHeader'></div>");if(s){if(i.getMapOptions().numberedIcons){var p=$('<div class="detailFeatureNum" style="background-color:'+app.data.getStory()[r].color+'">'+n.getValueCI(app.cfg.FIELDNAME_NUMBER)+"</div>");$(c).append(p),$(c).append($("<div class='detailFeatureTitle'></div>"))}else $(c).append($("<div class='detailFeatureTitle'></div>")),$(c).find(".detailFeatureTitle").addClass("notNumbered");$(c).find(".detailFeatureTitle").text(s)}else $(c).append($("<div class='detailFeatureTitle noTitle'></div>"));$(f).append(c);var d=$('<div class="detailTextContainer"</div>');u&&(l=$("<div></div>").addClass("detailPictureDiv"),$(l).append("<img data-src="+u+' class="swiper-lazy"/>'),$(l).click(N),$(d).append(l)),o&&$(d).append($("<div class='detailFeatureDesc description editable'>"+o+"</div>")),app.data.getWebAppData().getGeneralOptions().moreInfoLink&&a&&($(d).append($('<div class="detailFeatureDesc website"><a class="website" href="'+a+'" target="_blank">'+app.data.getWebAppData().getGeneralOptions().moreInfoLinkAlias+"</a></div>").css("padding-top",10)),$(d).find(".website").show()),$(f).append(d);var m=$('<div class="editLocationContainer"><button class="editLocation btn btn-primary" >Add Location</button></div>');n.locationSet&&$(m).find(".editLocation").text("Edit Location"),$(f).append(m),$(m).find(".editLocation").click(function(){var e=$(".entry.active").index(),t=v[e].slides[v[e].activeIndex],n=$.grep(app.layerCurrent.graphics,function(e){return e.attributes.shortlist_id==$(t).data("shortlist-id")});$(this).hasClass("btn-primary")?S(n[0].attributes.shortlist_id):T(n[0],!1)}),$(f).data("shortlist-id",n.getValueCI(app.cfg.FIELDNAME_ID)),$("#detailView"+r).append(f),g.resize(),$(".detailHeader").css("border-top-color",app.data.getStory()[r].color);var y=new MediumEditor($(f).find(".detailFeatureTitle"),{buttonLabels:"fontawesome",toolbar:!1});y.on($(".detailFeatureTitle"),"blur",E,!0);var b=new MediumEditor($(f).find(".editable"),{buttonLabels:"fontawesome"});b.on($(".editable"),"blur",E,!0);if(app.data.getWebAppData().getGeneralOptions().moreInfoLink){var w=new MediumEditor($(f).find(".website"),{buttonLabels:"fontawesome",toolbar:{buttons:["anchor"]},anchorPreview:{showWhenToolbarIsVisible:!0}});w.on($(".website"),"blur",E,!0)}var E=function(){var e=$(".entry.active").index(),t=v[e].slides[v[e].activeIndex],n=$.grep(app.layerCurrent.graphics,function(e){return e.attributes.shortlist_id==$(t).data("shortlist-id")});if($(this).hasClass("detailFeatureTitle")){n[0].attributes.name=$(this).text();var r=$.grep($("#myList li"),function(e){return $(e).data("shortlist-id")==$(t).data("shortlist-id")});$(r).find(".blurb").text($(this).text())}$(this).hasClass("detailFeatureDesc")&&(n[0].attributes.description=$(this).html()),$(this).hasClass("website")&&(n[0].attributes.website=$(this).html()),i.getTitle()&&h.publish("INCREMENT_SAVE_COUNTER")};v[r].update()})},this.buildAllSlides=function(){var e=app.map.getLayer(app.data.getShortlistLayerId()),t=e.graphics,n=[],r=$("#nav-bar").find(".nav-tabs > li:not(.dropdown)");$.each(r,function(){n.push([])}),$.each(t,function(e,t){n[parseInt(t.attributes.tab_id)].push(t)}),$.each(n,function(e,t){g.buildSlides(!1,e)}),g.resize()},this.addDetailPanelSwiper=function(t){var n=t;t||(n=0);if(n==0)$(r).find("#paneLeft").append(e({})),$(r).find(" .detailView")[n].setAttribute("id","detailView"+n);else{var i=$(r).find(" .detailContainer")[n-1];$(i).after(e({})),$(r).find(" .detailView")[n].setAttribute("id","detailView"+n)}$(".detailContainer").hide();var s=$(".detailContainer")[n];$(s).show();var o=new Swiper($(s),{speed:0,setWrapperSize:!0,lazyLoading:!0,lazyLoadingInPrevNext:!0,simulateTouch:!1});v[n]=o,v[n].updating=!1,o.init(),$(s).hide(),o.update(),o.on("onSlideChangeEnd",function(e){C();if($("body").hasClass("loadingPlaces"))return;E.preSelection();var t=e.slides[e.activeIndex],n=$(t).data("shortlist-id"),r=$.grep(app.layerCurrent.graphics,function(e){return e.attributes.getValueCI(app.cfg.FIELDNAME_ID)==n})[0];E.selected=r,E.selected.attributes.locationSet&&!app.map.extent.contains(E.selected.geometry)&&app.map.centerAt(E.selected.geometry),setTimeout(function(){E.buildMapTips()},0)}),r.find(".detailClose").click(function(){r.find(".detailContainer").hide(),y.hide(),app.ui.mobileIntro.screenSize=="small"&&app.ui.mobileFeatureList.showMobileList()}),r.find($(".detail-btn-left")[n]).click(function(){var e=$(".entry.active").index(),t=v[e];t.activeIndex===0?t.slideTo(t.slides.length-1,0):t.slidePrev(),y.hide()}),r.find($(".detail-btn-right")[n]).click(function(){var e=$(".entry.active").index(),t=v[e];t.activeIndex==t.slides.length-1?t.slideTo(0,0):t.slideNext(),y.hide()}),r.find($(".detail-btn-add")[n]).click(function(){app.addFeatureBar.addFeature(),y.hide()})},this.present=function(e){L()},this.addSlide=function(e,n,s){var o=$(".entry.active").index(),u=$(".detailContainer")[o];r.find("#detailView"+o).append(t());var a=$(u).find(".swiper-slide")[e-1];$(a).find(".detailFeatureNum").text(e);var f=app.cfg.COLOR_ORDER.split(","),l=$.grep(app.cfg.COLOR_SCHEMES,function(e){return e.name==f[o]});i.getMapOptions().numberedIcons?$(a).find(".detailFeatureNum").css("background-color",app.data.getStory()[o].color):($(a).find(".detailFeatureNum").hide(),$(a).find(".detailFeatureTitle").addClass("notNumbered")),app.data.getWebAppData().getGeneralOptions().moreInfoLink&&($(".website").show(),$(".website").text(app.data.getWebAppData().getGeneralOptions().moreInfoLinkAlias||"More Info")),$(a).find(".detailPictureDiv").click(N),$(a).data("shortlist-id",n),$(a).find(".detailFeatureTitle").addClass("noTitle"),s&&(s.name&&($(a).find(".detailFeatureTitle").html(s.name),$(a).find(".detailFeatureTitle").removeClass("noTitle")),s.pic_url&&$(a).find("img").attr("src",s.pic_url),s.description&&$(a).find(".description").html(s.description),s.website&&$(a).find(".detailFeatureDesc.website").replaceWith(s.website),(s.lng&&s.lat||s.locationSet)&&$(a).find(".editLocation").text("Edit Location")),(!s||!s.description)&&$(a).find(".description").append('<div style="min-height: 100px;"></div'),v[o].update();var c=new MediumEditor($(a).find(".detailFeatureTitle"),{buttonLabels:"fontawesome",toolbar:!1,placeholder:{text:"Place name"}});c.on($(".detailFeatureTitle"),"blur",m,!0);var p=new MediumEditor($(a).find(".editable"),{buttonLabels:"fontawesome",placeholder:{text:"Descriptive text",hideOnClick:!0}});p.on($(".editable"),"blur",m,!0);if(app.data.getWebAppData().getGeneralOptions().moreInfoLink){var d=new MediumEditor($(a).find(".website"),{buttonLabels:"fontawesome",toolbar:{buttons:["anchor"]}});d.on($(".website"),"blur",m,!0)}var m=function(){var e=$(".entry.active").index(),t=v[e].slides[v[e].activeIndex],n=$.grep(app.layerCurrent.graphics,function(e){return e.attributes.shortlist_id==$(t).data("shortlist-id")});if($(this).hasClass("detailFeatureTitle")){n[0].attributes.name=$(this).text();var r=$.grep($("#myList li"),function(e){return $(e).data("shortlist-id")==$(t).data("shortlist-id")});$(r).find(".blurb").text($(this).text()),$(t).find(".detailFeatureTitle").removeClass("noTitle")}$(this).hasClass("detailFeatureDesc")&&(n[0].attributes.description=$(this).html()),$(this).hasClass("website")&&(n[0].attributes.website=$(this).html()),i.getTitle()&&h.publish("INCREMENT_SAVE_COUNTER")};(!s||s&&!s.name)&&setTimeout(function(){$(a).find(".detailFeatureTitleText").focus()},0),$(a).find(".editLocation").click(function(){var e=$(".entry.active").index(),t=v[e].slides[v[e].activeIndex],n=$.grep(app.layerCurrent.graphics,function(e){return e.attributes.shortlist_id==$(t).data("shortlist-id")});$(this).hasClass("btn-primary")?S(n[0].attributes.shortlist_id):T(n[0],!1)}),v[o].updating=!1},this.showSlide=function(e){g.resize();var t=$(".entry.active").index(),n=$(".detailContainer")[t];$(n).show(),$(n).css("z-index",99);var r=null;$.each($("#detailView"+t).find($(".swiper-slide")),function(t,n){parseInt($(n).data("shortlist-id"))==e&&(r=t)}),r>-1&&($(n).show(),$(n).css("z-index",99),setTimeout(function(){v[t].slideTo(r,0)},0)),setTimeout(function(){C()},50),g.resize()},this.updateSlide=function(e){var t=$(".entry.active").index();v[t].updating=!0;var n=v[t].slides[v[t].activeIndex];$(n).find("img").attr("src",e.media.pic_url);var r=$.grep(app.layerCurrent.graphics,function(e){return e.attributes.shortlist_id==$(n).data("shortlist-id")});r[0].attributes.pic_url=e.media.pic_url,e.media.thumb_url?r[0].attributes.thumb_url=e.media.thumb_url:r[0].attributes.thumb_url=e.media.pic_url;var s=$.grep($("#myList li"),function(e){return $(e).data("shortlist-id")==$(n).data("shortlist-id")});$(s).find(".tileImage").css("background-image","url("+r[0].attributes.thumb_url+")"),$(s).find(".blurb").text(e.media.name),$(n).find(".detailFeatureTitleText").text().length<=0&&e.media.name&&($(n).find(".detailFeatureTitleText").html(e.media.name),r[0].attributes.name=e.media.name,$("#item"+$(n).data("shortlist-id")).find(".blurb").text(e.media.name),$(n).find(".detailFeatureTitle").removeClass("noTitle")),$(n).find(".description").text()=="Descriptive Text"&&e.media.description&&($(n).find(".description").text(e.media.description),r[0].attributes.description=e.media.description);if(e.media.lat&&e.media.lng&&!r[0].attributes.locationSet){var a=o.lngLatToXY(e.media.lng,e.media.lat),l=new f(a[0],a[1],new u({wkid:app.map.SpatialReference}));r[0].setGeometry(l),r[0].attributes.locationSet=1,$(s).addClass("located"),$(s).find(".unlocated").removeClass("unlocated"),$(n).find(".editLocation").text("Edit Location")}else{if(r[0].attributes.locationSet)return;$(s).find(".tileImage").append('<div class="unlocated" style="outline: none;"></div>'),$(n).find(".editLocation").text("Add Location")}r[0].attributes.locationSet&&r[0].show(),app.addFeatureBar.updateLocatedFeatures(),e.fromService&&m.close(),i.getTitle()&&h.publish("INCREMENT_SAVE_COUNTER"),v[t].updating=!1},this.hideSearch=function(){y&&y.hide()},this.resize=function(){if(!v.length)return;setTimeout(function(){var e=app.isInBuilder?115:35;app.ui.mobileIntro.screenSize=="small"&&($("#paneLeft").css("height",$("#contentPanel").height()-$("#map").height()+10),$("#paneLeft").css("width","100%"),$("#paneLeft").css({top:$("#map").height()-10}),e=20);var t=$(".entry.active").index();t<0&&(t=0);var t=$(".entry.active").index(),n=v[t].slides[v[t].activeIndex];$(n).height($("#paneLeft").outerHeight()-5);var r=$(n).find(".detailHeader").outerHeight();$(".detailTextContainer").css({"margin-top":"10px"}),$(".detailTextContainer").height($("#paneLeft").outerHeight()-r-e+"px"),$(".detailTextContainer").width("100%"),$(".detailPictureDiv img").css("max-width",$("#paneLeft").outerWidth());var i=$("#paneLeft").outerHeight()-r-60<$("#paneLeft").outerHeight()*.6?$("#paneLeft").outerHeight()-r-60:$("#paneLeft").outerHeight()*.6;$(".detailPictureDiv img").css("max-height",parseInt(i)+"px"),$(".detailContainer").width($("#paneLeft").outerWidth()),$(".detailContainer").height($("#paneLeft").outerHeight())},0)},this.close=function(){}}}),define("lib-build/tpl!storymaps/common/builder/ckeditor/plugins/storymapsInlineMedia/dialog/Media",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="modal-dialog">\r\n	<div class="modal-content">\r\n		<div class="modal-header">\r\n			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\r\n			<h4 class="modal-title">'+((__t=lblTitle)==null?"":__t)+'</h4>\r\n			<div class="checkbox opt-select-all-container">\r\n				<label style="outline: none;">\r\n					<input type="checkbox" class="opt-checkbox-select-all">\r\n					Select All\r\n				</label>\r\n			</div>\r\n		</div>\r\n\r\n		<div class="modal-body">\r\n			<div class="viewMediaSelectorContainer"></div>\r\n		</div>\r\n\r\n		<div class="modal-footer">\r\n			<span class="modal-footer-left"><button class="btn btn-back btn-naked">< '+((__t=btnBack)==null?"":__t)+'</button></span>\r\n			<!--<button class="">'+((__t=btnOk)==null?"":__t)+'</button>\r\n			<button class="btnCancel btn btn-naked btn-close" data-dismiss="modal">'+((__t=btnCancel)==null?"":__t)+'</button>-->\r\n			<button class="btnSubmit btn btn-primary importImages"><!--'+((__t=btnOk)==null?"":__t)+'-->Import</button>\r\n			<button class="btnCancel btn btn-naked btn-close" data-dismiss="modal">'+((__t=btnCancel)==null?"":__t)+"</button>\r\n		</div>\r\n	</div>\r\n</div>\r\n";return __p}}),define("lib-build/css!storymaps/common/builder/ckeditor/plugins/storymapsInlineMedia/dialog/Media",[],function(){}),define("lib-build/css!storymaps/common/builder/ckeditor/plugins/Common",[],function(){}),define("lib-build/tpl!storymaps/common/builder/media/MediaSelector",[],function(){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<div class="mediaSelector">\r\n	<!--<label class="lblSelect">'+((__t=lblSelect)==null?"":__t)+':</label>-->\r\n	<span class="media-types">\r\n		<form>\r\n			<div class="media-type-wrapper ',hasMap||(__p+=" disabled "),__p+='">\r\n				<label class="checkbox-inline media-type">\r\n					<input type="radio" name="media-type" value="map"> '+((__t=lblMap)==null?"":__t)+'\r\n				</label>\r\n				<div class="mediaContainersArrow"></div>\r\n			</div>\r\n\r\n			<div class="media-type-wrapper">\r\n				<label class="media-type"></label>\r\n			</div>\r\n\r\n			<div class="media-type-wrapper ',hasVideo||(__p+=" disabled "),__p+='">\r\n				<label class="checkbox-inline media-type">\r\n					<input type="radio" name="media-type" value="video"> '+((__t=lblVideo)==null?"":__t)+'\r\n				</label>\r\n				<div class="mediaContainersArrow"></div>\r\n			</div>\r\n\r\n			<div class="media-type-wrapper ',hasWebPage||(__p+=" disabled "),__p+='">\r\n				<label class="checkbox-inline media-type">\r\n					<input type="radio" name="media-type" value="webpage"> '+((__t=lblExternal)==null?"":__t)+'\r\n				</label>\r\n				<div class="mediaContainersArrow"></div>\r\n			</div>\r\n		</form>\r\n	</span>\r\n\r\n	<div class="mediaContainers">\r\n		<div class="mainMediaTypeContainer mapMediaContainer ',hasMap||(__p+=" disabled "),__p+='"></div>\r\n		<div class="mainMediaTypeContainer imageMediaContainer"></div>\r\n		<div class="mainMediaTypeContainer videoMediaContainer"></div>\r\n		<div class="mainMediaTypeContainer webpageMediaContainer"></div>\r\n	</div>\r\n</div>\r\n';return __p}}),define("lib-build/css!storymaps/common/builder/media/MediaSelector",[],function(){}),define("lib-build/tpl!storymaps/common/builder/media/image/Selector",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="imageSelector">\r\n	<div class="selectorView viewHomeContainer"></div>\r\n	<div class="selectorView viewFlickrContainer"></div>\r\n	<div class="selectorView viewPicasaContainer"></div>\r\n	<div class="selectorView mediaSelectorPickerContainer"></div>\r\n	<div class="selectorView mediaSelectorConfigureContainer"></div>\r\n</div>\r\n';return __p}}),define("lib-build/css!storymaps/common/builder/media/image/Selector",[],function(){}),define("lib-build/tpl!storymaps/common/builder/media/image/ViewHome",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="imageSelectorHome">\r\n	<table class="imageSelectorTable">\r\n		<tr>\r\n			<td class="btn-container btn-select-flickr">\r\n				<span class="btn-img"></span>\r\n			</td>\r\n			<td class="btn-container btn-select-picasa">\r\n				<span class="btn-img"></span>\r\n			</td>\r\n			<td class="btn-container btn-select-url">\r\n				<span class="btn-img"></span>\r\n			</td>\r\n		</tr>\r\n	</table>\r\n</div>\r\n';return __p}}),define("lib-build/css!storymaps/common/builder/media/image/ViewHome",[],function(){}),define("storymaps/common/builder/media/image/ViewHome",["lib-build/tpl!./ViewHome","lib-build/css!./ViewHome","dojo/has"],function(e,t,n){return function(r,i){function s(){r.find(".btn-select-flickr").click(function(){i("flickr")}),r.find(".btn-select-picasa").click(function(){i("picasa")}),r.find(".btn-select-url").click(function(){i("configure",{fromService:!1})}),app.cfg.AUTHORIZED_IMPORT_SOURCE.flickr||r.find(".btn-select-flickr").addClass("disabled").unbind("click"),app.cfg.AUTHORIZED_IMPORT_SOURCE.picasa||r.find(".btn-select-picasa").addClass("disabled").unbind("click"),!n("touch")&&!app.cfg.AUTHORIZED_IMPORT_SOURCE.flickr&&r.find(".btn-select-flickr").tooltip({trigger:"hover",placement:"top",html:!0,title:i18n.commonCore.common.disabledAdmin,container:"body"}),!n("touch")&&!app.cfg.AUTHORIZED_IMPORT_SOURCE.picasa&&r.find(".btn-select-picasa").tooltip({trigger:"hover",placement:"top",html:!0,title:i18n.commonCore.common.disabledAdmin,container:"body"}),n("touch")||r.find(".btn-select-url").tooltip({trigger:"hover",placement:"top",html:!0,title:i18n.commonMedia.mediaSelector.url,container:"body"})}r.append(e({})),s(),this.present=function(){r.show()}}}),define("lib-build/tpl!storymaps/common/builder/media/image/ViewFlickr",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="imageSelectorFlickr">\r\n	<form class="form-inline" role="form" onsubmit="return false;">\r\n		<div class="form-group">\r\n			<span class="service-logo"></span>\r\n			<input type="text" class="form-control userName" value="" placeholder="'+((__t=fieldUserName)==null?"":__t)+'"/>\r\n		</div>\r\n		<button class="btn btn-primary btn-userLogin">'+((__t=btnSearch)==null?"":__t)+'</button>\r\n		<span class="loadingMsg"></span>\r\n	</form>\r\n	<div class="errorMsg"></div>\r\n	<div class="sets"></div>\r\n</div>';return __p}}),define("lib-build/css!storymaps/common/builder/media/image/ViewFlickr",[],function(){}),define("storymaps/common/utils/connector/Flickr",["dojo/Deferred","dojo/_base/lang"],function(e,t){return function(r){function s(){return l("flickr.tags.getListUser",{user_id:i})}function o(){return l("flickr.photosets.getList",{user_id:i})}function u(n,r){var s=new e;r.photoSize=r.photoSize||"b",r.thumbSize=r.thumbSize||"m";var o=t.mixin({extras:"geo,description"},{user_id:i},r);return l(n,o).done(function(e){(!e||e.stat!="ok")&&s.reject();var t=[],n=[];e.photos?n=e.photos.photo:e.photoset&&(n=e.photoset.photo),$.each(n,function(e,n){t.push({name:n.title||"",description:n.description?n.description._content||"":"",pic_url:f(n,r.photoSize),thumb_url:f(n,r.thumbSize),lat:n.latitude||"",lng:n.longitude||"",is_video:!1})}),s.resolve(t)}),s}function a(e){return $.each(e,function(e,t){t._thumbnail="http://farm2.static.flickr.com/"+t.server+"/"+t.primary+"_"+t.secret+"_s"+".jpg"}),e}function f(e,t){return"http://farm"+e.farm+".static.flickr.com/"+e.server+"/"+e.id+"_"+e.secret+"_"+t+".jpg"}function l(e,t){var n="https://api.flickr.com/services/rest/?method="+e+"&format=json"+"&api_key="+r+(t?"&"+$.param(t):"")+"&jsoncallback=?";return $.getJSON(n)}var i=null;if(!r){console.error("Flickr initialization error - missing apiKey parameter");return}this.connect=function(t,n,r){var u=new e;return n=n===!1?!1:!0,r=r===!1?!1:!0,l("flickr.people.findByUsername",{username:t}).done(function(e){e&&e.stat=="ok"?(i=e.user.id,n&&r?$.when(s(),o()).done(function(e,t){u.resolve({tags:e[0].who.tags.tag,sets:a(t[0].photosets.photoset)})}):n?o().then(function(e){u.resolve({sets:a(e.photosets.photoset)})}):r?s().then(function(e){u.resolve({tags:e.who.tags.tag})}):u.resolve({})):u.reject()}),u},this.getPicturesInSet=function(e,n){return u("flickr.photosets.getPhotos",t.mixin({photoset_id:e},n))},this.getPicturesByTag=function(e,n){return u("flickr.photos.search",t.mixin({tags:e},n))}}}),define("lib-build/tpl!storymaps/common/builder/media/image/ViewFlickrSet",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="set" data-id="'+((__t=id)==null?"":__t)+'" style="'+((__t=style)==null?"":__t)+'">\r\n	<img src="'+((__t=thumb)==null?"":__t)+'" />\r\n	<div>'+((__t=title)==null?"":__t)+" ("+((__t=nb)==null?"":__t)+")</div>\r\n</div>";return __p}}),define("storymaps/common/builder/media/image/ViewFlickr",["lib-build/tpl!./ViewFlickr","lib-build/css!./ViewFlickr","storymaps/common/utils/connector/Flickr","lib-build/tpl!./ViewFlickrSet"],function(e,t,n,r){return function(i,s){function u(){var e=i.find(".userName").val(),t=i.parents(".smallSize").length?3:4;f(),o.connect(e,!0,!1).then(function(e){var n="";if(!e||!e.sets||!e.sets.length){i.find(".loadingMsg").html(""),i.find(".errorMsg").show().html(i18n.commonMedia.mediaSelector.noData);return}$.each(e.sets,function(e,i){n+=r({id:i.id,thumb:i._thumbnail,title:i.title._content,nb:i.photos,style:e%t===0?"clear:both":""})}),i.find(".sets").removeClass("disabled").show().html(n),i.find(".sets").off("click").click(a),i.find(".loadingMsg").html('<span class="glyphicon glyphicon-ok"></span>')},function(){i.find(".loadingMsg").html(""),i.find(".errorMsg").show().html(i18n.commonMedia.imageSelectorFlickr.signInMsg2)})}function a(e){f(),i.find(".sets").addClass("disabled"),o.getPicturesInSet($(e.target).data("id")||$(e.target).parents(".set").data("id"),{per_page:100}).then(function(e){i.find(".loadingMsg").html(""),i.find(".sets").removeClass("disabled");if(!e.length)return;s("picker",{data:e})},function(){i.find(".loadingMsg").html(""),i.find(".errorMsg").show().html(i18n.commonMedia.imageSelectorFlickr.loadingFailed)})}function f(){i.find(".loadingMsg").html('<span class="smallLoader"></span>'),i.find(".errorMsg").hide()}function l(){i.find(".btn-userLogin").click(u),i.find(".userName").bind("input propertychange",function(){$(this).val()?i.find(".btn-userLogin").removeAttr("disabled"):i.find(".btn-userLogin").attr("disabled","disabled"),i.find(".loadingMsg").html(""),i.find(".errorMsg").hide(),i.find(".sets").html("")}).keyup(function(e){e.keyCode==13&&$(this).val()&&u()})}var o=new n(app.cfg.FLICKR_API_KEY);i.append(e({fieldUserName:i18n.commonMedia.imageSelectorFlickr.userInputLbl,btnSearch:i18n.commonMedia.mediaSelector.userLookup})),l(),this.present=function(e){if(!e||!e.isReturning)i.find(".userName").val()||i.find(".btn-userLogin").attr("disabled","disabled");i.show(),i.find(".imageSelectorFlickr").width()&&i.find(".userName").css("width",i.find(".imageSelectorFlickr").width()-85-40-i.find(".btn-userLogin").outerWidth()).focus()}}}),define("lib-build/tpl!storymaps/common/builder/media/image/ViewPicasa",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="imageSelectorPicasa">\r\n	<form class="form-inline" role="form" onsubmit="return false;">\r\n		<div class="form-group">\r\n			<span class="service-logo"></span>\r\n			<input type="text" class="form-control userName" value="" placeholder="'+((__t=fieldUserName)==null?"":__t)+'"/>\r\n		</div>\r\n		<button class="btn btn-primary btn-userLogin">'+((__t=btnSearch)==null?"":__t)+'</button>\r\n		<span class="loadingMsg"></span>\r\n	</form>\r\n	<div class="errorMsg"></div>\r\n	<div class="albums"></div>\r\n</div>';return __p}}),define("lib-build/css!storymaps/common/builder/media/image/ViewPicasa",[],function(){}),define("storymaps/common/utils/connector/Picasa",["dojo/Deferred"],function(e){return function(){this.getAlbums=function(t){var n=new e,r=document.location.protocol+"//picasaweb.google.com/data/feed/base/user/"+t+"?alt=json&access=public";return t?($.ajax({url:r,dataType:"jsonp",timeout:4e3}).then(function(e){var t=[];e&&e.feed&&e.feed.entry&&$.each(e.feed.entry,function(e,n){t.push({url:n.id.$t,title:n.title.$t||"",thumbnailUrl:n.media$group.media$thumbnail[0].url})}),n.resolve(t)},function(){n.reject()}),n):(n.reject(),n)},this.getAlbum=function(t,n){var r=new e,i=t.replace("/data/entry/base/","/data/feed/base/")+"&kind=photo&fields=title,subtitle,icon,entry(title,gphoto:numphotos,media:group(media:content,media:thumbnail,media:description),georss:where)";return t?(i+="&imgmax=1600",i+=n?"&max-results="+n:"",$.getJSON(i,function(e){var t=[];$.each(e.feed.entry,function(e,n){var r=n.media$group.media$content[0].url||"",i=n.media$group.media$thumbnail[2].url||"";r=r.replace("https://","http://"),i=i.replace("https://","http://");var s={name:n.media$group.media$description.$t||"",description:"",pic_url:r,thumb_url:i,lat:"",lng:"",is_video:!1};n.georss$where&&n.georss$where.gml$Point&&n.georss$where.gml$Point.gml$pos&&n.georss$where.gml$Point.gml$pos.$t&&n["georss$where"]["gml$Point"]["gml$pos"]["$t"].split(" ").length==2&&(s.lat=n.georss$where.gml$Point.gml$pos.$t.split(" ")[0],s.lng=n.georss$where.gml$Point.gml$pos.$t.split(" ")[1]),t.push(s)}),r.resolve(t)}),r):(r.reject(),r)}}}),define("lib-build/tpl!storymaps/common/builder/media/image/ViewPicasaAlbum",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="album" data-id="'+((__t=id)==null?"":__t)+'" style="'+((__t=style)==null?"":__t)+'">\r\n	<img src="'+((__t=thumb)==null?"":__t)+'" class="album-thumb" />\r\n	<div>'+((__t=title)==null?"":__t)+"</div>\r\n</div>";return __p}}),define("storymaps/common/builder/media/image/ViewPicasa",["lib-build/tpl!./ViewPicasa","lib-build/css!./ViewPicasa","storymaps/common/utils/connector/Picasa","lib-build/tpl!./ViewPicasaAlbum"],function(e,t,n,r){return function(i,s){function u(){var e=i.find(".userName").val(),t=i.parents(".smallSize").length?3:4;f(),o.getAlbums(e).then(function(e){var n="";if(!e||!e.length){i.find(".loadingMsg").html(""),i.find(".errorMsg").show().html(i18n.commonMedia.mediaSelector.noData);return}$.each(e,function(e,i){n+=r({id:i.url,thumb:i.thumbnailUrl,title:i.title,style:e%t===0?"clear:both":""})}),i.find(".albums").removeClass("disabled").show().html(n),i.find(".albums").off("click").click(a),i.find(".loadingMsg").html('<span class="glyphicon glyphicon-ok"></span>')},function(){i.find(".loadingMsg").html(""),i.find(".errorMsg").show().html(i18n.commonMedia.imageSelectorPicasa.signInMsg2)})}function a(e){f(),i.find(".albums").addClass("disabled"),o.getAlbum($(e.target).parents(".album").data("id"),200).then(function(e){i.find(".loadingMsg").html(""),i.find(".albums").removeClass("disabled");if(!e.length)return;s("picker",{data:e})},function(){i.find(".loadingMsg").html(""),i.find(".errorMsg").show().html(i18n.commonMedia.imageSelectorFlickr.loadingFailed)})}function f(){i.find(".loadingMsg").html('<span class="smallLoader"></span>'),i.find(".errorMsg").hide()}function l(){i.find(".btn-userLogin").click(u),i.find(".userName").bind("input propertychange",function(){$(this).val()?i.find(".btn-userLogin").removeAttr("disabled"):i.find(".btn-userLogin").attr("disabled","disabled"),i.find(".loadingMsg").html(""),i.find(".errorMsg").hide(),i.find(".albums").html("")}).keyup(function(e){e.keyCode==13&&$(this).val()&&u()})}var o=new n(app.cfg.FLICKR_API_KEY);i.append(e({fieldUserName:i18n.commonMedia.imageSelectorPicasa.userInputLbl,btnSearch:i18n.commonMedia.mediaSelector.userLookup})),l(),this.present=function(e){if(!e||!e.isReturning)i.find(".userName").val()||i.find(".btn-userLogin").attr("disabled","disabled");i.show(),i.find(".imageSelectorPicasa").width()&&i.find(".userName").css("width",i.find(".imageSelectorPicasa").width()-85-40-i.find(".btn-userLogin").outerWidth()).focus()}}}),define("lib-build/css!storymaps/common/builder/media/ViewPicker",[],function(){}),define("lib-build/tpl!storymaps/common/builder/media/ViewPickerItem",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="mediaItem" data-id="'+((__t=id)==null?"":__t)+'" style="'+((__t=style)==null?"":__t)+'">\r\n	<img class="mediaImg" src="'+((__t=thumb)==null?"":__t)+'" />\r\n	<div>'+((__t=title)==null?"":__t)+"</div>\r\n</div>";return __p}}),define("storymaps/common/builder/media/ViewPicker",["lib-build/css!./ViewPicker","lib-build/tpl!./ViewPickerItem","esri/geometry/Extent","esri/SpatialReference"],function(e,t,n,r){return function(i,s){function u(){$("body").addClass("loadingPlaces");var e=180,t=90,i=-180,s=-90;$.each($(".mediaItem.selected"),function(n,r){var u=o.data[$(r).data("id")];app.addFeatureBar.addFeature(u,!1),u.lng&&u.lat&&(u.lng>i&&(i=u.lng),u.lng<e&&(e=u.lng),u.lat>s&&(s=u.lat),u.lat<t&&(t=u.lat))});var u=new n(e,t,i,s,new r({wkid:4326})),a=$(".entry.active").index(),f=$(".detailContainer")[a];$(f).hide(),$("#editorDialogInlineMedia").hide(),$(".modal-backdrop").hide(),$(".mediaItem").removeClass("selected"),$(".opt-select-all-container").hide(),app.addFeatureBar.updateLocatedFeatures(),setTimeout(function(){app.map.setExtent(u,!0),$("body").removeClass("loadingPlaces")},500)}var o;this.present=function(e){o=e;if(!o.isReturning){var n="";$.each(o.data,function(e,r){n+=t({id:e,title:r.name,thumb:r.thumb_url,style:e%2===0?"clear:both":""})}),i.html(n),o.mode=="import"?($(".opt-checkbox-select-all").attr("checked",!1),$(".opt-select-all-container").show(),$(".viewMediaSelectorContainer").parent().css("margin-top","30px"),i.find(".mediaItem").addClass("albumMediaItem"),$(".opt-checkbox-select-all").change(function(){$(this).is(":checked")?(i.find(".mediaItem").addClass("selected"),$(".importImages").prop("disabled",!1)):(i.find(".mediaItem").removeClass("selected"),$(".importImages").prop("disabled",!0))}),i.find(".mediaItem").on("click",function(){$(this).toggleClass("selected"),i.find(".mediaItem.selected").length?$(".importImages").prop("disabled",!1):$(".importImages").prop("disabled",!0)}),$(".importImages").off("click").click(u)):i.off("click").click(function(e){if(o.mode=="import")return;var t=$(e.target).parents(".mediaItem").index();t!=-1&&s("configure",{mode:o.mode,fromService:!0,media:o.data[t]})})}i.show()}}}),define("lib-build/css!storymaps/common/builder/media/ViewConfigure",[],function(){}),define("lib-build/tpl!storymaps/common/builder/media/ViewConfigure",[],function(){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<div class="mediaSelectorConfigure">\r\n	<form role="form">\r\n		<div class="form-group">\r\n			<!--<label>'+((__t=lblURL)==null?"":__t)+'</label>-->\r\n			<label>Image URL</label>\r\n			<input type="text" class="form-control mediaURL" placeholder="'+((__t=lblURLPH)==null?"":__t)+'">\r\n			<p class="mediaURLError">'+((__t=lblURLError)==null?"":__t)+'</p>\r\n		</div>\r\n		<div class="form-group thumbnailUrl">\r\n			<label>Thumbnail URL</label>\r\n			<input type="text" class="form-control mediaThumbURL" placeholder="'+((__t=lblURLPH)==null?"":__t)+'">\r\n			<p class="mediaURLError">'+((__t=lblURLError)==null?"":__t)+"</p>\r\n		</div>\r\n		<!--",mode=="inlineText"&&(__p+='\r\n			<div class="inline-image">\r\n				<div class="form-group">\r\n					<label style="display: block">'+((__t=lblLabel)==null?"":__t)+'</label>\r\n					<textarea class="form-control mediaTitle" spellcheck="true" placeholder="'+((__t=lblLabelPH)==null?"":__t)+'" style="height: 74px; margin-top: 5px;"></textarea>\r\n				</div>\r\n				<div class="form-group">\r\n					<div class="checkbox">\r\n						<label>\r\n							<input type="checkbox" value="opt-maximize">\r\n							'+((__t=lblMaximize)==null?"":__t)+'\r\n							<a href="#" class="maximizeHelp" data-toggle="tooltip" data-placement="right" data-title="'+((__t=lblMaximizeHelp)==null?"":__t)+'">\r\n								<img src="resources/tpl/builder/icons/builder-help.png"/>\r\n							</a>\r\n						</label>\r\n					</div>\r\n				</div>\r\n			</div>\r\n			<div class="inline-video">\r\n				<label style="display: block; margin-bottom: 15px; margin-left: 122px;">'+((__t=lblPosition)==null?"":__t)+'</label>\r\n				<div style="text-align: center">\r\n					<div class="media-configure-position" data-val="fit">\r\n						<div class="position-selected"></div>\r\n						<img class="position-img" src="resources/common/icons/media-configure-position-fit.png" />\r\n						<div class="position-lbl">'+((__t=lblPosition3)==null?"":__t)+"</div>\r\n						<div>"+((__t=lblPosition3Explain2)==null?"":__t)+'</div>\r\n					</div>\r\n\r\n					<div class="media-configure-position" data-val="custom">\r\n						<div class="position-selected"></div>\r\n						<img class="position-img" src="resources/common/icons/media-configure-position-custom.png" />\r\n						<div class="position-lbl">'+((__t=lblPosition5)==null?"":__t)+'</div>\r\n						<div class="position-params">\r\n							<div>\r\n								<input type="text" class="form-control input-sm posCustomW" placeholder="'+((__t=phWidth)==null?"":__t)+'" style="display: inline-block; width: 65px;">\r\n								<a href="#" class="dimHelp" data-toggle="tooltip">\r\n									<img src="resources/tpl/builder/icons/builder-help.png"/>\r\n								</a>\r\n							</div>\r\n							<div style="margin-top: 2px;">\r\n								<input type="text" class="form-control input-sm posCustomH" placeholder="'+((__t=phHeight)==null?"":__t)+'" style="display: inline-block; width: 65px;">\r\n								<a href="#" class="dimHelp2" data-toggle="tooltip">\r\n									<img src="resources/tpl/builder/icons/builder-help.png"/>\r\n								</a>\r\n							</div>\r\n						</div>\r\n					</div>\r\n				</div>\r\n			</div>-->\r\n			<!--\r\n			<div class="form-group">\r\n				<label style="display: block">Alignment</label>\r\n				<label class="checkbox-inline" style="margin-left: -18px;">\r\n					<input type="radio" name="mediaDisplay" value="none"> None\r\n				</label>\r\n				<label class="checkbox-inline">\r\n					<input type="radio" name="mediaDisplay" value="left"> Left\r\n				</label>\r\n				<label class="checkbox-inline">\r\n					<input type="radio" name="mediaDisplay" value="center"> Center\r\n				</label>\r\n				<label class="checkbox-inline">\r\n					<input type="radio" name="mediaDisplay" value="right"> Right\r\n				</label>\r\n			</div>\r\n			-->\r\n		'),mode=="mainMedia"&&(__p+='\r\n			<div class="form-group position-image">\r\n				<label style="display: block; margin-bottom: 15px;">'+((__t=lblPosition)==null?"":__t)+'</label>\r\n				<div>\r\n					<div class="media-configure-position" data-val="fill">\r\n						<div class="position-selected"></div>\r\n						<img class="position-img" src="resources/common/icons/media-configure-position-fill.png" />\r\n						<div class="position-lbl">'+((__t=lblPosition2)==null?"":__t)+"</div>\r\n						<div>"+((__t=lblPosition2Explain)==null?"":__t)+'</div>\r\n					</div>\r\n\r\n					<div class="media-configure-position" data-val="fit">\r\n						<div class="position-selected"></div>\r\n						<img class="position-img" src="resources/common/icons/media-configure-position-fit.png" />\r\n						<div class="position-lbl">'+((__t=lblPosition3)==null?"":__t)+"</div>\r\n						<div>"+((__t=lblPosition3Explain)==null?"":__t)+'</div>\r\n					</div>\r\n\r\n					<div class="media-configure-position" data-val="stretch">\r\n						<div class="position-selected"></div>\r\n						<img class="position-img" src="resources/common/icons/media-configure-position-stretch.png" />\r\n						<div class="position-lbl">'+((__t=lblPosition4)==null?"":__t)+"</div>\r\n						<div>"+((__t=lblPosition4Explain)==null?"":__t)+'</div>\r\n					</div>\r\n\r\n					<div class="media-configure-position" data-val="center">\r\n						<div class="position-selected"></div>\r\n						<img class="position-img" src="resources/common/icons/media-configure-position-center.png" />\r\n						<div class="position-lbl">'+((__t=lblPosition1)==null?"":__t)+'</div>\r\n					</div>\r\n				</div>\r\n			</div>\r\n			<div class="form-group position-video">\r\n				<label style="display: block; margin-bottom: 15px; margin-left: 7px;">'+((__t=lblPosition)==null?"":__t)+'</label>\r\n				<div style="text-align: center">\r\n					<div class="media-configure-position" data-val="stretch">\r\n						<div class="position-selected"></div>\r\n						<img class="position-img" src="resources/common/icons/media-configure-position-stretch.png" />\r\n						<div class="position-lbl">'+((__t=lblPosition2)==null?"":__t)+'</div>\r\n					</div>\r\n\r\n					<div class="media-configure-position" data-val="fit">\r\n						<div class="position-selected"></div>\r\n						<img class="position-img" src="resources/common/icons/media-configure-position-fit.png" />\r\n						<div class="position-lbl">'+((__t=lblPosition3)==null?"":__t)+'</div>\r\n					</div>\r\n\r\n					<div class="media-configure-position" data-val="center">\r\n						<div class="position-selected"></div>\r\n						<img class="position-img" src="resources/common/icons/media-configure-position-center.png" />\r\n						<div class="position-lbl">'+((__t=lblPosition1)==null?"":__t)+'</div>\r\n					</div>\r\n\r\n					<div class="media-configure-position" data-val="custom">\r\n						<div class="position-selected"></div>\r\n						<img class="position-img" src="resources/common/icons/media-configure-position-custom.png" />\r\n						<div class="position-lbl">'+((__t=lblPosition5)==null?"":__t)+'</div>\r\n						<div class="position-params">\r\n							<div>\r\n								<input type="text" class="form-control input-sm posCustomW" placeholder="'+((__t=phWidth)==null?"":__t)+'" style="display: inline-block; width: 65px;">\r\n								<a href="#" class="dimHelp" data-toggle="tooltip">\r\n									<img src="resources/tpl/builder/icons/builder-help.png"/>\r\n								</a>\r\n							</div>\r\n							<div style="margin-top: 2px;">\r\n								<input type="text" class="form-control input-sm posCustomH" placeholder="'+((__t=phHeight)==null?"":__t)+'" style="display: inline-block; width: 65px;">\r\n								<a href="#" class="dimHelp2" data-toggle="tooltip">\r\n									<img src="resources/tpl/builder/icons/builder-help.png"/>\r\n								</a>\r\n							</div>\r\n						</div>\r\n					</div>\r\n				</div>\r\n			</div>\r\n		'),__p+='\r\n		<div class="form-group mediaUnloadStrategy">\r\n			<div class="checkbox">\r\n				<label>\r\n					<input type="checkbox" class="navigateOutUnload" />\r\n					'+((__t=unloadLbl)==null?"":__t)+'\r\n					<a href="#" class="unloadHelp" data-toggle="tooltip" data-title="'+((__t=unloadHelp)==null?"":__t)+'">\r\n						<img src="resources/tpl/builder/icons/builder-help.png"/>\r\n					</a>\r\n				</label>\r\n			</div>\r\n		</div>\r\n	</form>\r\n</div>\r\n';return __p}}),define("storymaps/common/builder/media/ViewConfigure",["lib-build/css!./ViewConfigure","lib-build/tpl!./ViewConfigure","../../utils/CommonHelper","dojo/_base/lang","dojo/Deferred"],function(e,t,n,r,i){return function(s,o){function c(){s.find(".imageDetailsLbl").click(function(){s.find(".imageDetailsContainer").toggleClass("expanded")}),s.find(".media-configure-position").off("click").click(function(){var e=$(this).data("val");s.find(".media-configure-position").removeClass("selected"),$(this).addClass("selected"),s.find('.media-configure-position[data-val="custom"]').find(".position-params").toggleClass("disabled",e!="custom")}),s.find(".dimHelp").tooltip("destroy").tooltip({title:i18n.commonMedia.mediaConfigure.tooltipDimension,html:!0,trigger:"hover"}),s.find(".dimHelp2").tooltip("destroy").tooltip({title:i18n.commonMedia.mediaConfigure.tooltipDimension2,html:!0,trigger:"hover"}),s.find(".maximizeHelp, .unloadHelp").tooltip({html:!0,trigger:"hover"})}var u=["center","fill","fit","stretch","custom"],a=null,f=null,l=null;s.append(t({mode:o.mode,lblURL:i18n.commonMedia.mediaConfigure.lblURL,lblURLPH:i18n.commonMedia.mediaConfigure.lblURLPH,lblURLError:i18n.commonMedia.mediaConfigure.lblURLError,lblLabel:i18n.commonMedia.mediaConfigure.lblLabel,lblLabelPH:i18n.commonMedia.mediaConfigure.lblLabelPH,lblMaximize:i18n.commonMedia.mediaConfigure.lblMaximize,lblMaximizeHelp:i18n.commonMedia.mediaConfigure.lblMaximizeHelp,lblPosition:i18n.commonMedia.mediaConfigure.lblPosition,lblPosition1:i18n.commonMedia.mediaConfigure.lblPosition1,lblPosition2:i18n.commonMedia.mediaConfigure.lblPosition2,lblPosition3:i18n.commonMedia.mediaConfigure.lblPosition3,lblPosition4:i18n.commonMedia.mediaConfigure.lblPosition4,lblPosition5:i18n.commonMedia.mediaConfigure.lblPosition5,phWidth:i18n.commonCore.common.width,phHeight:i18n.commonCore.common.height,lblPosition2Explain:i18n.commonMedia.mediaConfigure.lblPosition2Explain,lblPosition3Explain:i18n.commonMedia.mediaConfigure.lblPosition3Explain,lblPosition3Explain2:i18n.commonMedia.mediaConfigure.lblPosition3Explain2,lblPosition4Explain:i18n.commonMedia.mediaConfigure.lblPosition4Explain,unloadLbl:i18n.commonMedia.mediaConfigure.unloadLbl,unloadHelp:i18n.commonMedia.mediaConfigure.unloadHelp})),c(),this.present=function(e){e.fromService&&app.detailPanelBuilder.updateSlide(e);var t=e.media,n=null;e.fromService&&(e.media.is_video?t={type:"video",video:{title:e.media.name,titleDisplay:"caption",url:e.media.pic_url}}:t={type:"image",image:{title:e.media.description||e.media.name,titleDisplay:"caption",url:e.media.pic_url}}),t&&t.type=="image"&&t.image&&(n={width:e.fromService?null:t[t.type].width,height:e.fromService?null:t[t.type].height}),f=t?t.type:"image",a=t,l=e,s.find(".mediaURL").val(t?t[t.type].url:"").keyup(function(){s.find(".mediaURLError").fadeOut()}).parent().toggle(e.fromService===!1&&f=="image"),s.find(".mediaURLError").hide(),s.find(".mediaThumbURL").val(t?t[t.type].url:"").keyup(function(){s.find(".mediaURLError").fadeOut()}).parent().toggle(e.fromService===!1&&f=="image"),s.find(".mediaURLError").hide();var r=f=="webpage"&&t[t.type].frameTag;r&&s.find(".mediaURL").val(t[t.type].frameTag),s.find(".position-image").toggle(f=="image"),s.find(".position-video").toggle(f=="video"||f=="webpage"),s.find(".media-configure-position").removeClass("selected");var i=f=="image"?u[1]:u[3],c=null,h=null;if(e.media&&e.media.type){var p=e.media[e.media.type].display;c=e.media[e.media.type].width,h=e.media[e.media.type].height,$.inArray(p,u)!=-1&&(i=p)}var d=f=="image"?".position-image":".position-video";o.mode=="inlineText"&&(f=="video"||f=="webpage")&&(d=".inline-video",!c&&!h&&(i="fit")),(f=="video"||f=="webpage")&&i=="fit"&&(c="",h=""),s.find(d).find(".media-configure-position[data-val="+i+"]").addClass("selected").click(),s.find(".posCustomW").val(c||""),s.find(".posCustomH").val(h||""),s.find(".inline-image").toggle(f=="image"),s.find(".inline-video").toggle(f=="video"||f=="webpage"),s.find(".mediaTitle").val(t?t[t.type].title:""),s.find('[value="opt-maximize"]').prop("checked",t?t[t.type].activateFullScreen:!1),s.find(".mediaUnloadStrategy").toggle(f=="webpage"),s.find(".navigateOutUnload").prop("checked",!e.media||!e.media[e.media.type]||e.media[e.media.type].unload===undefined||e.media[e.media.type].unload),s.show(),s.find(".mediaURL").focus()},this.checkError=function(e){var t=!1;s.find(".mediaURLError").fadeOut();if(l.fromService===!1&&f=="image"){var r=new i,o=e.html();e.html(i18n.commonMedia.mediaConfigure.lblURLCheck);var u=new Image;return u.src=n.prependURLHTTP(s.find(".mediaURL").val().trim()),u.onload=function(){e.html(o),r.resolve(!1)},u.onerror=function(){s.find(".mediaURLError").fadeIn(),e.html(o),r.resolve(!0)},r}return t},this.getData=function(){var e=s.find(".mediaURL").val();if(e){var t={};t.media={},t.media.pic_url=s.find(".mediaURL").val(),t.media.thumb_url=s.find(".mediaThumbURL").val(),app.detailPanelBuilder.updateSlide(t)}var i=s.find(".media-configure-position.selected").data("val"),u={url:s.find(".mediaURL").val().trim(),type:f};return o.mode=="inlineText"?f=="image"?r.mixin(u,{title:s.find(".mediaTitle").val(),width:s.find(".imgActualWidth").val(),height:s.find(".imgActualHeight").val(),type:f,activateFullScreen:s.find('[value="opt-maximize"]').prop("checked")}):(r.mixin(u,{display:i}),i=="custom"&&r.mixin(u,{width:s.find(".inline-video .posCustomW").val(),height:s.find(".inline-video .posCustomH").val()})):(r.mixin(u,{display:i}),i=="custom"&&r.mixin(u,{width:s.find(".position-video .posCustomW").val(),height:s.find(".position-video .posCustomH").val()})),f=="webpage"&&(u.unload=s.find(".navigateOutUnload").prop("checked")),f=="webpage"&&a.webpage.frameTag?(u.frameTag=u.url,u.url="",u.ts=(new Date).getTime()):u.url=n.prependURLHTTP(u.url),u}}}),define("storymaps/common/builder/media/image/Selector",["lib-build/tpl!./Selector","lib-build/css!./Selector","./ViewHome","./ViewFlickr","./ViewPicasa","../ViewPicker","../ViewConfigure"],function(e,t,n,r,i,s,o){return function(u,a,f,l){function y(e,t,n){var t=t||{};if(!g[e])return;e=="home"?v=!1:e!="configure"&&(d=e),n||p.push({name:c,params:h}),t.mode=m,c=e,h=t,l.toggle(c!="home"),e!="home"&&l.off("click").click(function(){var e=p.pop()||{name:"home"};y(e.name||"home",e.params,!0)}),u.find(".selectorView").hide(),g[e].present(t),$(".mediaItem").click(function(){if(t.mode=="import")return;$("#addEditPopup").hide(),$(".modal-backdrop").hide()}),f&&f()}function b(){}u.append(e({lblStep1:i18n.commonMedia.imageSelector.lblStep1,lblStep2:i18n.commonMedia.imageSelector.lblStep2,lblStep3:i18n.commonMedia.imageSelector.lblStep3}));var c=null,h=null,p=null,d=null,v=!1,m=null,g={home:new n(u.find(".viewHomeContainer"),y),flickr:new r(u.find(".viewFlickrContainer"),y),picasa:new i(u.find(".viewPicasaContainer"),y),picker:new s(u.find(".mediaSelectorPickerContainer"),y),configure:new o(u.find(".mediaSelectorConfigureContainer"),a.configure,y)};b(),this.present=function(e){p=[],c=null,h=null,m=e.mode,e.mode=="edit"&&e.media&&e.media.type=="image"?y("configure",{mode:e.mode,media:e.media}):e.keepLastDataSource&&v&&d!=null?y(d,{isReturning:!0}):y("home")},this.checkError=function(e){var t=!1;return c=="configure"?t=g[c].checkError(e):t=!0,u.toggleClass("error",t),v=!t,t},this.getData=function(){return c=="configure"?g[c].getData():null},this.activate=function(){l.toggle(c!="home"),c!="home"&&l.off("click").click(function(){var e=p.pop()||{name:"home"};y(e.name||"home",e.params,!0)})},this.deactivate=function(){l.hide().off("click")}}}),define("lib-build/tpl!storymaps/common/builder/media/video/Selector",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="videoSelector">\r\n	<div class="selectorView viewHomeContainer"></div>\r\n	<div class="selectorView viewYoutubeContainer"></div>\r\n	<div class="selectorView viewVimeoContainer"></div>\r\n	<div class="selectorView viewOtherContainer"></div>\r\n	<div class="selectorView mediaSelectorPickerContainer"></div>\r\n	<div class="selectorView mediaSelectorConfigureContainer"></div>\r\n</div>';return __p}}),define("lib-build/css!storymaps/common/builder/media/video/Selector",[],function(){}),define("lib-build/tpl!storymaps/common/builder/media/video/ViewHome",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="videoSelectorHome">\r\n	<table class="videoSelectorTable">\r\n		<tr>\r\n			<td class="btn-container btn-select-youtube">\r\n				<span class="btn-img"></span>\r\n			</td>\r\n			<td class="btn-container btn-select-vimeo">\r\n				<span class="btn-img"></span>\r\n			</td>\r\n			<td class="btn-container btn-select-other">\r\n				<span class="btn-img"><span class="glyphicon glyphicon-film"></span> '+((__t=lblOther)==null?"":__t)+"</span>\r\n			</td>\r\n		</tr>\r\n	</table>\r\n</div>";return __p}}),define("lib-build/css!storymaps/common/builder/media/video/ViewHome",[],function(){}),define("storymaps/common/builder/media/video/ViewHome",["lib-build/tpl!./ViewHome","lib-build/css!./ViewHome"],function(e){return function(n,r){function i(){n.find(".btn-select-youtube").click(function(){r("youtube")}),n.find(".btn-select-vimeo").click(function(){r("vimeo")}),n.find(".btn-select-other").click(function(){r("other")})}n.append(e({lblOther:i18n.commonMedia.videoSelectorHome.other})),i(),this.present=function(){n.show()}}}),define("lib-build/tpl!storymaps/common/builder/media/video/ViewVideoCommon",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="videoSelectorView">\r\n	<form class="form-inline" role="form" onsubmit="return false;">\r\n		<div class="form-group">\r\n			<span class="service-logo '+((__t=serviceId)==null?"":__t)+'"></span>\r\n			<input type="text" class="form-control url" value="" placeholder="'+((__t=fieldUrl)==null?"":__t)+'"/>\r\n		</div>\r\n		<button class="btn btn-primary btn-check">'+((__t=btnCheck)==null?"":__t)+'</button>\r\n		<span class="loadingMsg"></span>\r\n	</form>\r\n	<div class="errorMsg"></div>\r\n	<div class="result-container">\r\n		<div class="video-detail-container"></div>\r\n	</div>\r\n</div>';return __p}}),define("lib-build/css!storymaps/common/builder/media/video/ViewVideoCommon",[],function(){}),define("storymaps/common/utils/connector/Youtube",["dojo/Deferred"],function(e){return function(){function n(t){var n=new e,r="https://www.googleapis.com/youtube/v3/videos?part=snippet&id="+t+"&key="+app.cfg.YOUTUBE_API_KEY;return $.ajax({url:r,timeout:4e3}).then(function(e){e&&e.items&&e.items.length?n.resolve(e.items[0].snippet):n.reject()},function(e){n.reject(e)}),n}function r(e){var t=/(youtube\.com\/(watch\?v\=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/.exec(e);return t&&t.length==4?t[3]:null}function i(e){return"//www.youtube.com/embed/"+e+"?wmode=opaque"}this.checkVideoUrl=function(t,s){var o=new e,u=r(t);return u?s?n(u).then(function(e){e?o.resolve({title:e.title,description:e.description,user:e.channelTitle,thumbUrl:e.thumbnails["default"].url,embedUrl:i(u),viewCount:null,likeCount:null}):o.reject()},function(e){e&&e.status==403?o.reject("NOT_AUTHORIZED"):o.reject("NOT_FOUND")}):o.resolve({title:"",description:"",user:"",thumbUrl:"",embedUrl:i(u),viewCount:null,likeCount:null,fetchVideoSnippet:!1}):o.reject("INVALID_URL"),o}}}),define("lib-build/tpl!storymaps/common/builder/media/video/ViewVideoCommonDetail",[],function(){return function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<div class="video-detail">\r\n	',typeof fetchVideoSnippet=="undefined"||fetchVideoSnippet?__p+='\r\n		<table>\r\n			<tr>\r\n				<td><img src="'+((__t=thumbUrl)==null?"":__t)+'" /></td>\r\n				<td style="padding-left: 10px">\r\n					<strong>\r\n						'+((__t=title)==null?"":__t)+'\r\n					</strong>\r\n					<div style="max-height: 100px; overflow-y: auto; word-wrap: break-word; word-break: break-word;">\r\n						'+((__t=description)==null?"":__t)+"\r\n					</div>\r\n				</td>\r\n			</tr>\r\n		</table>\r\n	":__p+='\r\n		<div style="font-style: italic; margin: 15px 0 25px 0;">'+((__t=videoNotChecked)==null?"":__t)+"</div>\r\n	",__p+='\r\n	<div style="text-align: center; margin-top: 10px;">\r\n		<button class="btn btn-primary btn-select-video">'+((__t=btnSelect)==null?"":__t)+"</button>\r\n	</div>\r\n</div>";return __p}}),define("storymaps/common/builder/media/video/ViewYoutube",["lib-build/tpl!./ViewVideoCommon","lib-build/css!./ViewVideoCommon","storymaps/common/utils/connector/Youtube","lib-build/tpl!./ViewVideoCommonDetail"],function(e,t,n,r){return function(i,s){function u(){var e=i.find(".url").val(),t=!app.isPortal||!app.cfg.YOUTUBE_DISABLE_ON_PORTAL;a(),o.checkVideoUrl(e,t).then(function(e){i.find(".loadingMsg").html('<span class="glyphicon glyphicon-ok"></span>'),i.find(".video-detail-container").fadeIn().html(r({fetchVideoSnippet:t,thumbUrl:e.thumbUrl,title:e.title,description:e.description,btnSelect:i18n.commonMedia.videoSelectorCommon.select,videoNotChecked:i18n.commonMedia.videoSelectorYoutube.videoNotChecked})),i.find(".btn-select-video").click(function(){s("configure",{mode:"add",fromService:!0,media:{name:e.title||"",description:e.description||"",pic_url:e.embedUrl,thumb_url:e.thumbUrl,lat:"",lng:"",is_video:!0}})})},function(e){i.find(".loadingMsg").html(""),e=="NOT_AUTHORIZED"?i.find(".errorMsg").show().html(i18n.commonMedia.videoSelectorYoutube.checkFailedAPI):i.find(".errorMsg").show().html(i18n.commonMedia.videoSelectorCommon.notFound)})}function a(){i.find(".loadingMsg").html('<span class="smallLoader"></span>'),i.find(".errorMsg").hide(),i.find(".btn-check").attr("disabled","disabled")}function f(){i.find(".btn-check").click(u),i.find(".url").bind("input propertychange",function(){$(this).val()?i.find(".btn-check").removeAttr("disabled"):i.find(".btn-check").attr("disabled","disabled"),i.find(".loadingMsg").html(""),i.find(".errorMsg").hide(),i.find(".video-detail-container").fadeOut().empty()}).keyup(function(e){e.keyCode==13&&$(this).val()&&u()})}var o=new n;i.append(e({serviceId:"youtube",fieldUrl:i18n.commonMedia.videoSelectorYoutube.url+"...",btnCheck:i18n.commonMedia.videoSelectorCommon.check})),f(),this.present=function(e){if(!e||!e.isReturning)i.find(".url").val()||i.find(".btn-check").attr("disabled","disabled");i.show(),i.find(".videoSelectorView").width()&&i.find(".url").css("width",i.find(".videoSelectorView").width()-85-40-i.find(".btn-check").outerWidth()).focus()}}}),define("storymaps/common/utils/connector/Vimeo",["dojo/Deferred"],function(e){return function(){function n(t){var n=new e,r="//vimeo.com/api/v2/video/"+t+".json";return $.ajax({type:"GET",url:r,jsonp:"callback",dataType:"jsonp",timeout:4e3}).then(function(e){e&&e[0]?n.resolve(e[0]):n.reject()},function(){n.reject()}),n}function r(e){return"//player.vimeo.com/video/"+e}this.checkVideoUrl=function(t){var i=new e,s=/^.*(vimeo\.com\/)((channels\/[A-z]+\/)|(groups\/[A-z]+\/videos\/))?([0-9]+)/.exec(t);if(s&&s.length==6){var o=s[5];n(o).then(function(e){e?i.resolve({title:e.title,description:e.description,user:e.user_name,thumbUrl:e.thumbnail_small,embedUrl:r(o),viewCount:e.stats_number_of_plays,likeCount:e.stats_number_of_likes}):i.reject()},function(){i.reject("NOT_FOUND")})}else i.reject("INVALID_URL");return i}}}),define("storymaps/common/builder/media/video/ViewVimeo",["lib-build/tpl!./ViewVideoCommon","lib-build/css!./ViewVideoCommon","storymaps/common/utils/connector/Vimeo","lib-build/tpl!./ViewVideoCommonDetail"],function(e,t,n,r){return function(i,s){function u(){var e=i.find(".url").val();a(),o.checkVideoUrl(e).then(function(e){i.find(".loadingMsg").html('<span class="glyphicon glyphicon-ok"></span>'),i.find(".video-detail-container").fadeIn().html(r({thumbUrl:e.thumbUrl,title:e.title,description:e.description,btnSelect:i18n.commonMedia.videoSelectorCommon.select})),i.find(".btn-select-video").click(function(){s("configure",{mode:"add",fromService:!0,media:{name:e.title||"",description:e.description||"",pic_url:e.embedUrl,thumb_url:e.thumbUrl,lat:"",lng:"",is_video:!0}})})},function(){i.find(".loadingMsg").html(""),i.find(".errorMsg").show().html(i18n.commonMedia.videoSelectorCommon.notFound)})}function a(){i.find(".loadingMsg").html('<span class="smallLoader"></span>'),i.find(".errorMsg").hide(),i.find(".btn-check").attr("disabled","disabled")}function f(){i.find(".btn-check").click(u),i.find(".url").bind("input propertychange",function(){$(this).val()?i.find(".btn-check").removeAttr("disabled"):i.find(".btn-check").attr("disabled","disabled"),i.find(".loadingMsg").html(""),i.find(".errorMsg").hide(),i.find(".video-detail-container").fadeOut().empty()}).keyup(function(e){e.keyCode==13&&$(this).val()&&u()})}var o=new n;i.append(e({serviceId:"vimeo",fieldUrl:i18n.commonMedia.videoSelectorVimeo.url+"...",btnCheck:i18n.commonMedia.videoSelectorCommon.check})),f(),this.present=function(e){if(!e||!e.isReturning)i.find(".url").val()||i.find(".btn-check").attr("disabled","disabled");i.show(),i.find(".videoSelectorView").width()&&i.find(".url").css("width",i.find(".videoSelectorView").width()-85-40-i.find(".btn-check").outerWidth()).focus()}}}),define("lib-build/tpl!storymaps/common/builder/media/video/ViewOther",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="videoSelectorOther">\r\n	<div class="explain">'+((__t=explain)==null?"":__t)+"</div>\r\n</div>";return __p}}),define("lib-build/css!storymaps/common/builder/media/video/ViewOther",[],function(){}),define("storymaps/common/builder/media/video/ViewOther",["lib-build/tpl!./ViewOther","lib-build/css!./ViewOther"],function(e){return function(n){function r(){}n.append(e({explain:i18n.commonMedia.videoSelectorOther.explain1+" "+i18n.commonMedia.videoSelectorOther.explain2.replace("%WEBPAGE%","<strong>"+i18n.commonMedia.videoSelectorOther.webpage+"</strong>")+'<div style="width: 100%; text-align: center; margin: 5px 0 15px 0"><div class="media-video-help-embed-dailymotion"></div></div>'+i18n.commonMedia.videoSelectorOther.explain3.replace("%WEBPAGE%","<strong>"+i18n.commonMedia.videoSelectorOther.webpage+"</strong>").replace("%EXAMPLE%",'<a href="http://www.videojs.com/">Video.js</a>')})),r(),this.present=function(){n.show()}}}),define("storymaps/common/builder/media/video/Selector",["lib-build/tpl!./Selector","lib-build/css!./Selector","./ViewHome","./ViewYoutube","./ViewVimeo","./ViewOther","../ViewConfigure"],function(e,t,n,r,i,s,o){return function(u,a,f,l){function g(e,t,n){if(!m[e])return;e=="home"?v=!1:e!="configure"&&(d=e),n||p.push({name:c,params:h}),c=e,h=t,l.toggle(c!="home"),e!="home"&&l.off("click").click(function(){var e=p.pop()||{name:"home"};g(e.name||"home",e.params,!0)}),u.find(".selectorView").hide(),m[e].present(t),f&&f()}function y(){}u.append(e({}));var c=null,h=null,p=null,d=null,v=!1,m={home:new n(u.find(".viewHomeContainer"),g),youtube:new r(u.find(".viewYoutubeContainer"),g),vimeo:new i(u.find(".viewVimeoContainer"),g),other:new s(u.find(".viewOtherContainer"),g),configure:new o(u.find(".mediaSelectorConfigureContainer"),a.configure,g)};y(),this.present=function(e){p=[],c=null,h=null,e.mode=="edit"&&e.media&&e.media.type=="video"?g("configure",{mode:e.mode,media:e.media}):e.keepLastDataSource&&v&&d!=null?g(d,{isReturning:!0}):g("home")},this.checkError=function(){var e=!1;return c=="configure"?e=m[c].checkError():e=!0,u.toggleClass("error",e),v=!e,e},this.getData=function(){return c=="configure"?m[c].getData():null},this.activate=function(){l.toggle(c!="home"),c!="home"&&l.off("click").click(function(){var e=p.pop()||{name:"home"};g(e.name||"home",e.params,!0)})},this.deactivate=function(){l.hide().off("click")}}}),define("lib-build/tpl!storymaps/common/builder/media/webpage/Selector",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="videoSelector">\r\n	<div class="selectorView viewHomeContainer"></div>\r\n	<div class="selectorView mediaSelectorConfigureContainer"></div>\r\n</div>';return __p}}),define("lib-build/css!storymaps/common/builder/media/webpage/Selector",[],function(){}),define("lib-build/tpl!storymaps/common/builder/media/webpage/ViewHome",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="webpageSelectorHome">	\r\n	<div class="form-group">\r\n		<label>'+((__t=lblUrl)==null?"":__t)+'</label>\r\n		<input type="text" class="form-control url" placeholder="'+((__t=phURL)==null?"":__t)+'"/>\r\n		<button class="btn btn-primary btn-cfg btn-cfg-url">'+((__t=btnConfigure)==null?"":__t)+'</button>\r\n	</div>\r\n	\r\n	<div class="separator">\r\n		<span class="solidline"></span>\r\n		'+((__t=lblOR)==null?"":__t)+'\r\n		<span class="solidline"></span>\r\n	</div>\r\n	\r\n	<div class="form-group">\r\n		<label>'+((__t=lblEmbed)==null?"":__t)+'</label>\r\n		<textarea class="form-control textarea" placeholder="'+((__t=phEmbed)==null?"":__t)+'"></textarea>\r\n		<button class="btn btn-primary btn-cfg btn-cfg-embed">'+((__t=btnConfigure)==null?"":__t)+'</button>\r\n	</div>\r\n	\r\n	<div class="error"></div>\r\n</div>';return __p}}),define("lib-build/css!storymaps/common/builder/media/webpage/ViewHome",[],function(){}),define("storymaps/common/builder/media/webpage/ViewHome",["lib-build/tpl!./ViewHome","lib-build/css!./ViewHome"],function(e){return function(n,r){function i(){var e=s(),t=o();return n.find(".error").toggle(e&&t).html(i18n.commonMedia.webpageSelectorHome.lblError1),e&&t||!e&&!t}function s(){var e=n.find(".url").val();return!!e}function o(){var e=n.find(".textarea").val();return!!e}function u(){return i()?null:{url:n.find(".url").val(),frameTag:n.find(".textarea").val()}}function a(){n.find(".btn-cfg-url").attr("disabled",!s()||o()),n.find(".btn-cfg-embed").attr("disabled",!o()||s()),i()}function f(){n.find(".url").bind("input propertychange",a),n.find(".textarea").bind("input propertychange",a),n.find(".btn-cfg-url").click(function(){r("configure",{media:{type:"webpage",webpage:u()}})}),n.find(".btn-cfg-embed").click(function(){var e=n.find(".textarea").val();if(!e.match(/^<iframe.*<\/iframe>$/)||e.match(/<iframe/g).length>2){n.find(".error").show().html(i18n.commonMedia.webpageSelectorHome.lblError2.replace("%IFRAMETAG%",'"&lt;iframe&gt;"'));return}r("configure",{media:{type:"webpage",webpage:u()}})})}n.append(e({lblUrl:i18n.commonMedia.webpageSelectorHome.lblUrl,lblEmbed:i18n.commonMedia.webpageSelectorHome.lblEmbed,phURL:"http://www.esri.com",phEmbed:"<iframe width=&quot;100%&quot; height=&quot;600px&quot; src=&quot;http://...&quot;></iframe>",lblOR:i18n.commonMedia.webpageSelectorHome.lblOR,btnConfigure:i18n.commonMedia.webpageSelectorHome.configure})),f(),this.present=function(e){n.show(),e&&e.mode=="edit"&&e.media&&e.media.type=="webpage"?(n.find(".url").val(e.media.webpage.url||""),n.find(".textarea").val(e.media.webpage.frameTag||"")):(n.find(".url").val(""),n.find(".textarea").val("")),a(),this.postDisplay()},this.postDisplay=function(){n.find(".webpageSelectorHome").width()&&n.find(".url, .textarea").css("width",n.find(".webpageSelectorHome").width()-5-n.find(".btn-cfg").outerWidth()),n.find(n.find(".textarea").val()?".textarea":".url").focus()}}}),define("storymaps/common/builder/media/webpage/Selector",["lib-build/tpl!./Selector","lib-build/css!./Selector","./ViewHome","../ViewConfigure"],function(e,t,n,r){return function(i,s,o,u){function d(e,t,n){if(!p[e])return;e=="home"?h=!1:e!="configure"&&(c=e),n||l.push({name:a,params:f}),a=e,f=t,u.toggle(a!="home"),e!="home"&&u.off("click").click(function(){var e=l.pop()||{name:"home"};d(e.name||"home",e.params,!0)}),i.find(".selectorView").hide(),p[e].present(t),o&&o()}function v(){}i.append(e({}));var a=null,f=null,l=null,c=null,h=!1,p={home:new n(i.find(".viewHomeContainer"),d),configure:new r(i.find(".mediaSelectorConfigureContainer"),s.configure,d)};v(),this.present=function(e){l=[],a=null,f=null,e.mode=="edit"&&e.media&&e.media.type=="webpage"?(d("home",{mode:e.mode,media:e.media}),d("configure",{mode:e.mode,media:e.media})):e.keepLastDataSource&&h&&c!=null?d(c,{isReturning:!0}):d("home")},this.checkError=function(){var e=!1;return a=="configure"?e=p[a].checkError():e=!0,i.toggleClass("error",e),h=!e,e},this.getData=function(){return a=="configure"?p[a].getData():null},this.activate=function(){u.toggle(a!="home"),a!="home"?u.off("click").click(function(){var e=l.pop()||{name:"home"};d(e.name||"home",e.params,!0)}):p[a].postDisplay()},this.deactivate=function(){u.hide().off("click")}}}),define("storymaps/common/builder/media/MediaSelector",["lib-build/tpl!./MediaSelector","lib-build/css!./MediaSelector","./image/Selector","./video/Selector","./webpage/Selector"],function(e,t,n,r,i){return function(r,i,s,o,u){function p(){r.find(".media-type").eq(c?0:1).click().focus().click()}function d(e){var t=$.inArray(e.media.type,["image"]);r.find(".media-type").eq(t).click().focus().click()}function v(){r.find(".media-type").click(function(){l=f[$(this).parents(".media-type-wrapper").index()],r.find(".media-type-wrapper").removeClass("current"),$(this).parents(".media-type-wrapper").addClass("current"),r.find(".mainMediaTypeContainer").hide().removeClass("current").eq($(this).parents(".media-type-wrapper").index()).addClass("current").show(),a.activate(),o&&o(l)})}r.append(e({hasMap:!!i,hasVideo:!1,hasWebPage:!1,lblMap:i18n.commonMedia.mediaSelector.lblMap,lblImage:i18n.commonMedia.mediaSelector.lblImage,lblVideo:i18n.commonMedia.mediaSelector.lblVideo,lblExternal:i18n.commonMedia.mediaSelector.lblExternal,lblSelect:s?i18n.commonMedia.mediaSelector.lblSelect1:i18n.commonMedia.mediaSelector.lblSelect2,notImplemented:i18n.commonMedia.mediaSelector.notImplemented}));var a=this,f=["image"],l=null,c=null,h=new n(r.find(".imageMediaContainer"),{configure:{mode:i?"mainMedia":"inlineText"}},o,u);r.find(".mediaSelector").toggleClass("smallSize",s),v(),this.present=function(e){h.present(e),e.mode=="add"||e.mode=="import"?p(e):d(e)},this.getData=function(){var e=r.find(".mainMediaTypeContainer.current").index();return{media:{type:"image",image:h.getData()}}},this.checkError=function(e){return h.checkError(e)},this.activate=function(){h.activate()},this.postDisplay=function(){}}}),define("storymaps/common/builder/ckeditor/plugins/storymapsInlineMedia/dialog/Media",["lib-build/tpl!./Media","lib-build/css!./Media","lib-build/css!../../Common","storymaps/common/builder/media/MediaSelector","dojo/Deferred"],function(e,t,n,r,i){return function(n){function a(){var e=u.getData();n.find(".btnSubmit").attr("disabled",!(e.media&&e.media.type&&e.media[e.media.type]))}function f(){var e=u.checkError(n.find(".btnSubmit")),t=function(){var e=u.getData().media;o.resolve(e[e.type]),n.modal("toggle")};e instanceof i?e.then(function(e){e||t()}):e||t()}function l(){n.find(".btnSubmit").click(f)}n.append(e({lblTitle:i18n.commonMedia.editorAddImage.lblTitle,btnOk:i18n.commonCore.common.apply,btnCancel:i18n.commonCore.common.cancel,btnBack:i18n.commonCore.common.back}));var s=null,o=null,u=new r(n.find(".viewMediaSelectorContainer"),null,!0,a,n.find(".btn-back"));this.present=function(e,t){return s=e,o=new i,e.mode=="import"&&(n.find(".modal-title").text(i18n.commonMedia.editorImportImages.lblTitle),$(".btn-select-url").hide(),$(".btnCancel").show()),e.mode=="add"&&(n.find(".modal-title").text(i18n.commonMedia.editorAddImage.lblTitle),$(".btn-select-url").show(),$(".btnCancel").hide(),$("#editorDialogInlineMedia").show(),$(".modal-backdrop").show(),$(".opt-select-all-container").hide(),$(".veiwMediaSelectorContainer").css("margin-top",0),n.find(".btnSubmit").off("click").click(f)),u.present({mode:e.mode,webmaps:null,media:e.mode=="edit"?e.edit.media:null,keepLastDataSource:!0},function(){}),n.find(".modal-content").css("min-height",t),n.modal({keyboard:!0}),o},this.close=function(){n.modal("hide")},this.initLocalization=function(){}}}),define("lib-build/tpl!storymaps/tpl/builder/addedit/Popup",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="backdrop"></div>\r\n<div class="modal-dialog">\r\n	<div class="modal-content">\r\n		<div class="modal-logo"></div>\r\n		<div class="modal-header">\r\n			<h4 class="modal-title">Tab Title</h4>\r\n		</div>\r\n\r\n		<div class="modal-body">\r\n			<!-- Title field -->\r\n			<div class="form-group titleContainer">\r\n				<input type="text" class="form-control title clear" placeholder="" spellcheck="true"/>\r\n				<span class="glyphicon glyphicon-remove form-control-feedback"></span>\r\n			</div>\r\n\r\n			<div class="tab-pane viewMediaSelectorContainer">\r\n				<table class="tab-cfg">\r\n					<tr class="tab-cfg-row ">\r\n						<td class="tab-cfg-title" style="outline: none;">\r\n							Theme Color\r\n						</td>\r\n						<td class="tab-cfg-btns">\r\n							<div class="color-control">\r\n								<input type="text" id="colorpicker" />\r\n							</div>\r\n							<!--<div class="inherit-alt">\r\n								<a href="#" class="help" data-toggle="tooltip" data-placement="right" ">\r\n									<img class="helpImg" src="resources/tpl/builder/icons/builder-help.png">\r\n								</a>\r\n							</div>-->\r\n						</td>\r\n					</tr>\r\n					<tr class="tab-cfg-row tab-cfg-location">\r\n						<td class="tab-cfg-title" style="outline: none;">\r\n							Location\r\n						</td>\r\n						<td class="tab-cfg-btns">\r\n							<div class="regular-control" style="display: block;">\r\n								<span class="btn-group">\r\n									<button type="button" class="btn btn-default btn-xs btn-primary" data-value="default" style="">\r\n										Tab default\r\n									</button>\r\n									<button type="button" class="btn btn-default btn-xs" data-value="custom">\r\n										Custom configuration&nbsp;\r\n									</button>\r\n								</span>\r\n								<a href="#" class="help" data-toggle="tooltip" data-placement="right" title="" data-original-title="Define the location that this tab will display.">\r\n									<img class="helpImg" src="resources/tpl/builder/icons/builder-help.png">\r\n								</a>\r\n							</div>\r\n							<div class="inherit-alt" style="display: none;">\r\n								Inherited from the first tab\r\n								<a href="#" class="help" data-toggle="tooltip" data-placement="right" title="" data-original-title="This tab\'s location is synchronized to the first map in the series. To change this behavior for your series go to Settings > Map Options.">\r\n									<img class="helpImg" src="resources/tpl/builder/icons/builder-help.png">\r\n								</a>\r\n							</div>\r\n						</td>\r\n						<!--<td class="tab-cfg-extent">\r\n							<button class="btn btn-primary btn-cfg btn-cfg-url" >Custom Tab Extent</button>\r\n						</td>-->\r\n					</tr>\r\n					<!--<tr class="tab-cfg-row">\r\n						<td class="tab-cfg-layers">\r\n							<button class="btn btn-primary btn-cfg btn-cfg-url" disabled="disabled">Supporting Layers</button>\r\n						</td>\r\n					</tr>-->\r\n				</table>\r\n			</div>\r\n		</div>\r\n\r\n		<div class="modal-footer">\r\n			<span class="modal-footer-left"><button class="btn btn-back btn-naked">< '+((__t=btnBack)==null?"":__t)+'</button></span>\r\n			<span class="btnSubmitWrapper" data-toggle="tooltip"">\r\n				<button class="btnSubmit btn btn-primary" ></button>\r\n			</span>\r\n			<button class="btnCancel btn btn-naked btn-close">'+((__t=btnCancel)==null?"":__t)+'</button>\r\n			<div class="btnSubmitTooltipContainer"></div>\r\n		</div>\r\n	</div>\r\n</div>\r\n';return __p}}),define("lib-build/css!storymaps/tpl/builder/addedit/Popup",[],function(){}),define("lib-build/tpl!storymaps/common/builder/media/map/MapConfigOverlay",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="mapConfigOverlay toc">\r\n	<!--\r\n	<div class="expandButton">\r\n		<span class="toc-title">\r\n			'+((__t=tocTitle)==null?"":__t)+'\r\n		</span>\r\n		<span class="toc-toggle"></span>\r\n	</div>\r\n	-->\r\n	<div class="header">'+((__t=tocTitle)==null?"":__t)+'</div>\r\n	<div class="explain">'+((__t=tocExplain)==null?"":__t)+'</div>\r\n	<div class="tocContainer"><!-- TOC is injected here --></div>\r\n	<div class="btns">\r\n		<button type="button" class="btn btn-primary save">'+((__t=tocSave)==null?"":__t)+'</button>\r\n		<div style="margin-top:10px">\r\n			<button type="button" class="btn btn-sm btn-naked reset">'+((__t=btnReset)==null?"":__t)+'</button> |\r\n			<button type="button" class="btn btn-sm btn-naked cancel">'+((__t=btnCancel)==null?"":__t)+'</button>\r\n		</div>\r\n	</div>\r\n</div>\r\n\r\n<div class="mapConfigOverlay position">\r\n	<div class="header">'+((__t=extentTitle)==null?"":__t)+'</div>\r\n	<div class="explain">'+((__t=extentExplain)==null?"":__t)+'</div>\r\n	<div class="btns">\r\n		<button type="button" class="btn btn-primary save">'+((__t=extentSave)==null?"":__t)+'</button>\r\n		<div style="margin-top:10px">\r\n			<button type="button" class="btn btn-sm btn-naked reset">'+((__t=btnReset)==null?"":__t)+'</button> |\r\n			<button type="button" class="btn btn-sm btn-naked cancel">'+((__t=btnCancel)==null?"":__t)+'</button>\r\n		</div>\r\n	</div>\r\n</div>\r\n\r\n<div class="mapConfigOverlay popup">\r\n	<div class="header">'+((__t=popupTitle)==null?"":__t)+'</div>\r\n	<div class="explain">'+((__t=popupExplain)==null?"":__t)+'</div>\r\n	<div class="btns">\r\n		<button type="button" class="btn btn-primary save">'+((__t=popupSave)==null?"":__t)+'</button>\r\n		<div style="margin-top:10px">\r\n			<button type="button" class="btn btn-sm btn-naked reset">'+((__t=btnReset)==null?"":__t)+'</button> |\r\n			<button type="button" class="btn btn-sm btn-naked cancel">'+((__t=btnCancel)==null?"":__t)+"</button>\r\n		</div>\r\n	</div>\r\n</div>\r\n";return __p}}),define("lib-build/css!storymaps/common/builder/media/map/MapConfigOverlay",[],function(){}),define("text!lib-app/arcgis-dijit-table-of-contents/js/dijit/templates/TableOfContents.html",[],function(){return'<div class="${theme}" role="presentation">\r\n    <div class="${css.container}">\r\n          <div data-dojo-attach-point="_layersNode"></div>\r\n    </div>\r\n</div>'}),define("lib-app/arcgis-dijit-table-of-contents/js/TableOfContents",["dojo/Evented","dojo/_base/declare","dojo/_base/lang","dojo/has","esri/kernel","dijit/_WidgetBase","dijit/_TemplatedMixin","dojo/on","text!./dijit/templates/TableOfContents.html","dojo/dom-class","dojo/dom-style","dojo/dom-construct","dojo/_base/event","dojo/_base/array"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){var d=t([s,o,e],{declaredClass:"esri.dijit.TableOfContents",templateString:a,options:{theme:"TableOfContents",map:null,layers:null,visible:!0},constructor:function(e,t){var r=n.mixin({},this.options,e);this.domNode=t,this.set("map",r.map),this.set("layers",r.layers),this.set("theme",r.theme),this.set("visible",r.visible),this.watch("theme",this._updateThemeWatch),this.watch("visible",this._visible),this.watch("layers",this._refreshLayers),this.watch("map",this.refresh),this.css={container:"toc-container",layer:"toc-layer",firstLayer:"toc-first-layer",title:"toc-title",titleContainer:"toc-title-container",content:"toc-content",titleCheckbox:"toc-checkbox",checkboxCheck:"icon-check-1",titleText:"toc-text",accountText:"toc-account",visible:"toc-visible",settingsIcon:"icon-cog",settings:"toc-settings",actions:"toc-actions",account:"toc-account",clear:"clear"}},startup:function(){this.map||(this.destroy(),console.log("TableOfContents::map required")),this.map.loaded?this._init():u.once(this.map,"load",n.hitch(this,function(){this._init()}))},destroy:function(){this._removeEvents(),this.inherited(arguments)},show:function(){this.set("visible",!0)},hide:function(){this.set("visible",!1)},refresh:function(){this._createList()},_createList:function(){var e=this.get("layers");this._nodes=[],this._removeEvents(),this._layersNode.innerHTML="";if(e&&e.length){for(var t=0;t<e.length;t++){var n=e[t],r=n.layerObject||(n.featureCollection?n.featureCollection.layers[0].layerObject:null);if(!r)continue;var i=this.css.titleCheckbox,s=this.css.layer;t===e.length-1&&(s+=" ",s+=this.css.firstLayer),r.visible&&(s+=" ",s+=this.css.visible,i+=" ",i+=this.css.checkboxCheck);var o=c.create("div",{className:s});c.place(o,this._layersNode,"first");var u=c.create("div",{className:this.css.title});c.place(u,o,"last");var a=c.create("div",{className:this.css.titleContainer});c.place(a,u,"last");var f=c.create("div",{className:i});c.place(f,a,"last");var l=c.create("div",{className:this.css.titleText,title:n.title,innerHTML:n.title});c.place(l,a,"last");var h;n.account&&(h=c.create("a",{className:this.css.accountText,id:n.account}),c.place(h,l,"last"));var p,d;n.settings&&(p=c.create("div",{className:this.css.settings,id:n.settings}),c.place(p,a,"last"),d=c.create("div",{className:this.css.settingsIcon}),c.place(d,p,"last"));var v=c.create("div",{className:this.css.clear});c.place(v,a,"last");var m={checkbox:f,title:u,titleContainer:a,titleText:l,accountText:h,settingsIcon:d,settingsDiv:p,layer:o};this._nodes.push(m),this._checkboxEvent(t)}this._setLayerEvents()}},_refreshLayers:function(){this.refresh()},_removeEvents:function(){var e;if(this._checkEvents&&this._checkEvents.length)for(e=0;e<this._checkEvents.length;e++)this._checkEvents[e].remove();if(this._layerEvents&&this._layerEvents.length)for(e=0;e<this._layerEvents.length;e++)this._layerEvents[e].remove();this._checkEvents=[],this._layerEvents=[]},_toggleVisible:function(e,t){f.toggle(this._nodes[e].layer,this.css.visible,t),f.toggle(this._nodes[e].checkbox,this.css.checkboxCheck,t),this.emit("toggle",{index:e,visible:t})},_layerEvent:function(e,t){if(!e)return;var r=u(e,"visibility-change",n.hitch(this,function(e){this._toggleVisible(t,e.visible)}));this._layerEvents.push(r)},_featureCollectionVisible:function(e,t,n){var r,i=e.visibleLayers,s=e.featureCollection.layers;i&&i.length?r=p.every(i,function(e){return s[e].layerObject.visible===n}):r=p.every(s,function(e){return e.layerObject.visible===n}),r&&this._toggleVisible(t,n)},_createFeatureLayerEvent:function(e,t,r){var i=e.featureCollection.layers,s=u(i[r].layerObject,"visibility-change",n.hitch(this,function(n){var r=n.visible;this._featureCollectionVisible(e,t,r)}));this._layerEvents.push(s)},_featureLayerEvent:function(e,t){var n=e.featureCollection.layers;if(n&&n.length)for(var r=0;r<n.length;r++)this._createFeatureLayerEvent(e,t,r)},_setLayerEvents:function(){var e=this.get("layers"),t;if(e&&e.length)for(var n=0;n<e.length;n++){var r=e[n];r.featureCollection&&r.featureCollection.layers&&r.featureCollection.layers.length?this._featureLayerEvent(r,n):(t=r.layerObject,this._layerEvent(t,n))}},_getLayerVisibility:function(e){if(this.layers&&this.layers.length){var t=this.layers[e],n=t.layerObject,r=t.featureCollection;if(r)return visibleLayers=t.visibleLayers,visibleLayers&&visibleLayers.length?r.layers[visibleLayers[0]].layerObject.visible:r.layers[0].layerObject.visible;if(n)return t.layerObject.visible}},_toggleLayer:function(e,t){if(this.layers&&this.layers.length){var n,r=this.layers[e],i=r.layerObject,s=r.featureCollection,o,u;if(s){o=r.visibleLayers;if(o&&o.length){n=!s.layers[o[0]].layerObject.visible,n=t!==undefined?t:n;for(u=0;u<o.length;u++)i=s.layers[o[u]].layerObject,i.setVisibility(n)}else{n=!s.layers[0].layerObject.visible,n=t!==undefined?t:n;for(u=0;u<s.layers.length;u++)i=s.layers[u].layerObject,i.setVisibility(n)}}else i&&(n=!r.layerObject.visible,n=t!==undefined?t:n,i.setVisibility(n))}},_checkboxEvent:function(e){var t=function(t){if(!t.ctrlKey)this._toggleLayer(e),h.stop(t);else{var n=this.get("layers"),r=this._getLayerVisibility(e);if(n&&n.length)for(var i=0;i<n.length;i++)this._toggleLayer(i,!r);h.stop(t)}};if(!this._nodes[e])return;var r=u(this._nodes[e].checkbox,"click",n.hitch(this,t));this._checkEvents.push(r);var i=u(this._nodes[e].titleText,"click",n.hitch(this,t));this._checkEvents.push(i)},_init:function(){this._visible(),this._createList(),this.set("loaded",!0),this.emit("load",{})},_updateThemeWatch:function(){var e=arguments[1],t=arguments[2];f.remove(this.domNode,e),f.add(this.domNode,t)},_visible:function(){this.get("visible")?l.set(this.domNode,"display","block"):l.set(this.domNode,"display","none")}});return r("extend-esri")&&n.setObject("dijit.TableOfContents",d,i),d}),define("lib-build/css!lib-app/arcgis-dijit-table-of-contents/css/TableOfContents",[],function(){}),define("storymaps/common/builder/media/map/MapConfigOverlay",["lib-build/tpl!./MapConfigOverlay","lib-build/css!./MapConfigOverlay","dojo/i18n!commonResources/nls/webmap.js?v="+app.version,"dojo/i18n!commonResources/nls/media.js?v="+app.version,"lib-app/arcgis-dijit-table-of-contents/js/TableOfContents","lib-build/css!lib-app/arcgis-dijit-table-of-contents/css/TableOfContents","esri/geometry/Extent","dojo/Deferred","dojo/on","dojo/topic","esri/dijit/Geocoder","storymaps/common/utils/CommonHelper","dojo/_base/lang"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){function O(e,t){d=new u;var n=($("#map").width()-300)/2;return $(".mapConfigOverlay.position").css({right:n}),v=t,b=!1,E=!1,m=app.map._params.extent,g=app.map.extent,w=a(app.map,"extent-change",B),f.subscribe("CORE_UPDATE_EXTENT",H),$(".mainMediaContainer.active .mapControls").addClass("hidden"),N=!1,y?b=JSON.stringify(app.lastExtentSet)!=JSON.stringify(t.extent):b=JSON.stringify(app.lastExtentSet)!=JSON.stringify(app.map.mapJournalInitExtent)&&JSON.stringify(app.lastExtentSet)!=JSON.stringify(m),console.log(JSON.stringify(app.lastExtentSet)!=JSON.stringify(app.map.mapJournalInitExtent),JSON.stringify(app.lastExtentSet)!=JSON.stringify(m),app.lastExtentSet,app.map.mapJournalInitExtent,m,y,T),J(e),d}function M(){$(".mainMediaContainer.active .mapControls").removeClass("hidden"),K(),w.remove(),d.resolve({extent:b?app.map.extent:null})}function _(){p.find(".position .save").click(M),p.find(".position .reset").click(D),p.find(".position .cancel").click(P),p.find(".toc .save").click(M),p.find(".toc .reset").click(F),p.find(".toc .cancel").click(I),p.find(".popup .save").click(M),p.find(".popup .reset").click(X),p.find(".popup .cancel").click(X)}function D(){app.map.setExtent(m).then(function(){b=!1})}function P(){app.ignoreNextEvent=!0,E=!0,app.map.setExtent(g).then(function(){b=y,M()})}function H(){E=!0,b=!1}function B(){E?E=!1:b=!0}function j(){S&&S.destroy(),$(".mainMediaContainer.active .geocoder").html('<div class="simpleGeocoder"></div>').show();try{var e=new l(h.mixin({map:app.map},c.createGeocoderOptions()),$(".mainMediaContainer.active .simpleGeocoder")[0]);$(".mainMediaContainer.active .geocoder input").attr("placeholder",r.commonMedia.editorActionGeocode.lblTitle+"..."),e.startup()}catch(t){console.error(t)}}function F(){$.each(C,function(e,t){t.layerObject?t.layerObject.setVisibility(t.visibility):t.featureCollection&&$.each(t.featureCollection.layers,function(e,n){n.layerObject.setVisibility(t.visibility)})})}function I(){$.each(C,function(e,t){var n=t.layerObject||(t.featureCollection?t.featureCollection.layers[0].layerObject:null),r=$(k).filter(function(e,t){return t.id==n.id}),i=r.length?r[0].visibility:t.visibility;t.layerObject?n.setVisibility(i):$.each(t.featureCollection.layers,function(e,t){t.layerObject.setVisibility(i)})}),M()}function q(){N=R().length>0}function R(){var e=[];return $.each(C,function(t,n){var r=n.layerObject||(n.featureCollection?n.featureCollection.layers[0].layerObject:null);r&&n.visibility!=r.visible&&e.push({id:r.id,visibility:r.visible})}),e}function U(){x&&x.destroy(),p.find(".tocContainer").html('<div class="TableOfContents"></div>'),x=new i({map:app.map,layers:C},p.find(".TableOfContents")[0]),(!C||!C.length)&&p.find(".TableOfContents").html('<div style="margin-bottom: 10px;">'+n.commonWebmap.configure.tocNoData+"</div>"),a(x,"toggle",q),a(x,"load",function(){p.find(".toc-checkbox").addClass("glyphicon glyphicon-unchecked")}),x.startup()}function z(){}function W(){}function X(){app.map.infoWindow.hide(),app.map.infoWindow.clearFeatures(),M()}function V(){var e=app.map.infoWindow.getSelectedFeature();if(!e)return null;var t=e.getLayer()||e.MJlayerRef,n=t.fields,r=$.grep(n,function(e){return e.type=="esriFieldTypeOID"});t&&n&&!r.length&&(r=$.grep(n,function(e){return e.name=="OBJECTID"||e.name=="FID"}),r.length||(r=$.grep(n,function(e){return e.type=="esriFieldTypeInteger"})));if(r.length){var i=r[0].name;return{layerId:t.id,fieldName:i,fieldValue:e.attributes[i],anchorPoint:app.map.infoWindow.location.toJson()}}return null}function J(e){$(".panelEditBtn").fadeOut(),p.find(".mapConfigOverlay.position").show(),j()}function K(){$("body").removeClass("has-builder-mask"),$(".panelEditBtn").fadeIn(),p.find(".mapConfigOverlay").hide(),app.map.enableMapNavigation(),$(app.map.__container).parent().find(".esriSimpleSliderTL").show(),$(".mainMediaContainer.active .geocoder").hide(),L&&(L[0].remove(),L[1].remove(),L=null)}var p=$("#mainStage"),d=null,v=null,m=null,g=null,y=null,b=null,w=null,E=null,S=null,x=null,T=null,N=null,C=null,k=null,L=null;p.append(e({btnReset:n.commonWebmap.configure.btnReset,btnCancel:n.commonWebmap.configure.btnCancel,tocTitle:n.commonWebmap.configure.tocTitle,tocExplain:n.commonWebmap.configure.tocExplain+" "+n.commonWebmap.configure.hintNavigation,tocSave:n.commonWebmap.configure.tocSave,tocHint:n.commonWebmap.configure.hintNavigation,extentTitle:n.commonWebmap.configure.extentTitle,extentExplain:n.commonWebmap.configure.extentExplain,extentSave:n.commonWebmap.configure.extentSave,popupTitle:n.commonWebmap.configure.popupTitle,popupExplain:n.commonWebmap.configure.popupExplain+" "+n.commonWebmap.configure.hintNavigation,popupSave:n.commonWebmap.configure.popupSave}));var A=($("#map").width()-300)/2;return $(".mapConfigOverlay.position").css({right:A}),_(),{present:O}}),define("storymaps/tpl/builder/addedit/Popup",["lib-build/tpl!./Popup","lib-build/css!./Popup","../../../common/builder/media/map/MapConfigOverlay","../../core/WebApplicationData","esri/geometry/Extent","dojo/Deferred"],function(e,t,n,r,i,s){return function(i){function l(){n.present(d()).then(function(e){d();var t=$(".entry.active").index(),n=app.map.extent;app.data.setStory(t,null,null,n),t===0&&r.getMapOptions().mapsSync&&$.each(app.data.getStory(),function(e){if(e===0)return;app.data.setStory(e,null,null,n)}),r.setTabs(app.data.getStory()),i.find(".webmap-loading").hide(),i.find(".map-cfg").removeClass("disabled")})}function c(){var e=$(".entry.active").index();app.data.setStory(e,null,null,app.data.getStory()[0].extent),r.setTabs(app.data.getStory())}function h(){i.find(".btnCancel").click(function(){i.modal("hide"),o.reject()}),i.on("shown.bs.modal",function(){p()}),$('.tab-cfg-location .btn[data-value="custom"]').click(function(){$('.tab-cfg-location .btn[data-value="custom"]').addClass("btn-primary"),$('.tab-cfg-location .btn[data-value="default"]').removeClass("btn-primary"),l()}),$('.tab-cfg-location .btn[data-value="default"]').click(function(){$('.tab-cfg-location .btn[data-value="default"]').addClass("btn-primary"),$('.tab-cfg-location .btn[data-value="custom"]').removeClass("btn-primary"),c()}),a.click(v)}function p(){m()}function d(){i.hasClass("in")?(f=!0,i.addClass("temporaryHide")):i.removeClass("temporaryHide"),i.modal("toggle")}function v(){var e=i.find(".title").val(),t=$("#colorpicker").spectrum("get").toHex();o.resolve({title:e,color:"#"+t}),app.layerCurrent.color=t,i.modal("hide")}function m(){var e=!0;e=!1,u.mode=="edit"?a.html(i18n.commonCore.common.save):a.html(i18n.commonCore.common.add),a.attr("disabled",e);if(e){var t=i18n.builder.addEditPopup.stepMainStageNextTooltip;i.find(".btnSubmitWrapper").tooltip("destroy").tooltip({container:".btnSubmitTooltipContainer",title:t.replace("%LBL_LAYOUT%",app.data.getWebAppData().getLayoutProperties().itemLbl.toLowerCase())})}else i.find(".btnSubmitWrapper").tooltip("destroy")}i.append(e({btnCancel:i18n.commonCore.common.cancel,btnBack:i18n.commonCore.common.back}));var o=null,u=null,a=i.find(".btnSubmit"),f=null;h(),this.present=function(e){o=new s,u=e,app.isAddEditInProgress=!0,$("#colorpicker").spectrum()&&$("#colorpicker").spectrum("destroy"),$("#colorpicker").spectrum({color:e.entry.color,showPalette:!0,showInput:!0,palette:["#425dac","#b82323","#37921e","#874094","#000000","#dc6800","#dab70c","#A67455"],preferredFormat:"hex"}),e.mode=="add"?(i.find(".modal-logo").removeClass("edit"),i.find(".modal-title").html(i18n.builder.addEditPopup.titleAdd),a.html(i18n.commonCore.common.add)):(i.find(".modal-logo").addClass("edit"),i.find(".modal-title").html(i18n.builder.addEditPopup.titleEdit),a.html(i18n.commonCore.common.save)),e.entryIndex&&(app.data.getStory()[e.entryIndex].extent==app.data.getStory()[0].extent||!app.data.getStory()[e.entryIndex].extent)?($('.tab-cfg-location .btn[data-value="default"]').addClass("btn-primary"),$('.tab-cfg-location .btn[data-value="custom"]').removeClass("btn-primary")):e.entryIndex===0&&!app.data.getStory()[0].extent?($('.tab-cfg-location .btn[data-value="default"]').addClass("btn-primary"),$('.tab-cfg-location .btn[data-value="custom"]').removeClass("btn-primary")):($('.tab-cfg-location .btn[data-value="custom"]').addClass("btn-primary"),$('.tab-cfg-location .btn[data-value="default"]').removeClass("btn-primary"));var t=e.syncMaps;return t?i.find(".tab-cfg-location .regular-control").show():i.find(".tab-cfg-location .regular-control").hide(),t?i.find(".tab-cfg-location .inherit-alt").hide():i.find(".tab-cfg-location .inherit-alt").show(),i.toggleClass("isAdding",e.mode=="add"),i.toggleClass("isEditing",e.mode!="add"),m(),i.find(".titleContainer").removeClass("has-feedback has-error").find(".title").val(e.mode=="edit"?e.entry.title:""),i.modal({keyboard:!0}),o},this.close=function(){i.modal("hide"),o.reject()},this.initLocalization=function(){}}}),define("lib-build/tpl!storymaps/tpl/builder/OrganizePopup",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="modal-dialog">\r\n	<div class="modal-content">\r\n		<div class="modal-logo"></div>\r\n		<div class="modal-header">\r\n			<h4 class="modal-title">'+((__t=title)==null?"":__t)+'</h4>\r\n		</div>\r\n\r\n		<div class="modal-body">\r\n			<div class="organizeHeader"></div>\r\n\r\n			<div class="organizeTableContainer">\r\n				<table class="organizeTable table table-striped">\r\n					<thead>\r\n					<tr style="height: 39px">\r\n						<th class="moverHeader">&nbsp;</th>\r\n						<th>'+((__t=lblColTitle)==null?"":__t)+'</th>\r\n						<th style="width: 80px;">'+((__t=lblColStatus)==null?"":__t)+'</th>\r\n						<th style="width: 44px;"></th>\r\n					</tr>\r\n					</thead>\r\n					<tbody class="rows">\r\n						<!-- rows -->\r\n					</tbody>\r\n				</table>\r\n			</div>\r\n		</div>\r\n\r\n		<div class="modal-footer">\r\n			<button type="button" class="btn btnApply btn-primary"></button>\r\n			<button type="button" class="btn btnCancel btn-naked btn-close" data-dismiss="modal">'+((__t=btnCancel)==null?"":__t)+"</button>\r\n		</div>\r\n	</div>\r\n</div>\r\n";return __p}}),define("lib-build/css!storymaps/tpl/builder/OrganizePopup",[],function(){}),define("lib-build/tpl!storymaps/tpl/builder/OrganizePopupEntry",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<tr class="sectionRow ui-state-highlight" data-index="'+((__t=index)==null?"":__t)+'">\r\n	<td class="mover"></td>\r\n	<td class="entryTitle">'+((__t=title)==null?"":__t)+'</td>\r\n	<!--<td class="status" data-value="'+((__t=statusVal)==null?"":__t)+'">\r\n		<div class="btn-group dropup">\r\n			<button class="btn btn-default btn-sm dropdown-toggle" type="button" data-toggle="dropdown">\r\n				<span class="status-list-btn" data-value="'+((__t=statusVal)==null?"":__t)+'">'+((__t=statusLbl)==null?"":__t)+'</span>&nbsp;<span class="caret"></span>\r\n			</button>\r\n			<ul class="dropdown-menu status-list" role="menu"></ul>\r\n		</div>\r\n	</td>-->\r\n	<td>\r\n		<button type="button" class="btn btn-default btn-md glyphicon glyphicon-trash deleteSectionBtn" data-toggle="tooltip" title="'+((__t=helpDelete)==null?"":__t)+'"></button>\r\n	</td>\r\n</tr>\r\n';return __p}}),define("storymaps/tpl/builder/OrganizePopup",["lib-build/tpl!./OrganizePopup","lib-build/css!./OrganizePopup","lib-build/tpl!./OrganizePopupEntry","dojo/Deferred"],function(e,t,n,r){return function(i){function f(){var e=$(this).closest("tr").first();return e.fadeOut("fast",function(){e.remove(),a++,h()}),!1}function l(){var e=[],t=0,n=i.find(".sectionRow").get();$.each($(n),function(n,r){var i=$(r),s=i.data("index"),o=i.find(".status-list-btn").data("value"),a=u.entries[s];a.status=o,e.push(a),s===u.sectionIndex&&(t=n)}),o.resolve({entries:e,sectionIndex:t}),i.modal("hide")}function c(){i.find(".btnApply").click(l),i.on("hide.bs.modal",function(){o.reject()}),s=!0}function h(){i.find(".btnApply").html(i18n.commonCore.common.apply).removeClass("btn-danger").addClass("btn-primary")}var s=!1,o=null,u=null,a=null;i.append(e({title:i18n.builder.organizePopup.title,lblColTitle:i18n.builder.organizePopup.lblColTitle,lblColStatus:i18n.builder.organizePopup.lblColStatus,btnCancel:i18n.commonCore.common.cancel})),this.present=function(e){var t="";o=new r,u=e;if(!e||!e.entries||e.sectionIndex==null)return o.reject();a=0,s||c(),i.find(".organizeHeader").html("Organize"),$.each(u.entries,function(e,r){var i=r.title;t+=n({index:e,title:i,statusVal:"",statusLbl:"",helpDelete:"delete"})}),i.find(".rows").html(t),i.find("*[data-toggle=tooltip]").tooltip({trigger:"hover"}),i.find(".deleteSectionBtn").click(f),i.find(".rows").toggleClass("noreorder",u.entries.length<=1);if(Object.keys(u.entries).length>1)i.find(".organizeTable tbody").sortable({axis:"y",opacity:"0.4",cursor:"move",helper:function(e,t){var n=t.children(),r=t.clone();return r.children().each(function(e){$(this).outerWidth(n.eq(e).outerWidth())}),r}});else try{i.find(".organizeTable tbody").sortable("destroy")}catch(l){}return h(),i.modal({keyboard:!0}),o},this.close=function(){i.modal("hide"),o.reject()}}}),define("lib-build/tpl!storymaps/tpl/builder/shortlistMigration/Migration",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="backdrop"></div>\r\n<div class="modal-dialog">\r\n	<div class="modal-content">\r\n		<div class="modal-logo edit"></div>\r\n		<div class="modal-header">\r\n			<h4 class="modal-title">Welcome to the Shortlist Builder</h4>\r\n		</div>\r\n\r\n		<div class="modal-body">\r\n\r\n			<div class="tab-pane viewMigrationSelectorContainer">\r\n				<div class="importQuestion">\r\n					Your web map contains point data.  Do you want to import those points into your Shortlist as places?\r\n				</div>\r\n\r\n				<div class="radio">\r\n					<label class="opt-radio-import">\r\n						<input type="radio" name="optradio" value="1" />\r\n						Yes\r\n					</label>\r\n					<div class="importExplain">You will be able to edit, manage and add to your places in the Shorlist Builder.  A copy of your web map\r\n					is automatically created so your original data is not modified.</div>\r\n				</div>\r\n				<div class="radio">\r\n					<label class="opt-radio-import">\r\n						<input type="radio" name="optradio" value="0" />\r\n						No\r\n					</label>\r\n					<div class="importExplain">Your points will be displayed on your Shortlist map but won\'t be used as places.  Instead you\'ll add your\r\n					places into your Shortlist in the Builder.</div>\r\n				</div>\r\n\r\n			</div>\r\n		</div>\r\n\r\n		<div class="modal-footer">\r\n			<span class="modal-footer-left"><button class="btn btn-back btn-naked">< '+((__t=btnBack)==null?"":__t)+'</button></span>\r\n			<span class="btnSubmitWrapper" data-toggle="tooltip"">\r\n				<button class="btnSubmit btn btn-primary" ></button>\r\n			</span>\r\n			<div class="btnSubmitTooltipContainer"></div>\r\n		</div>\r\n	</div>\r\n</div>\r\n';return __p}}),define("lib-build/css!storymaps/tpl/builder/shortlistMigration/Migration",[],function(){}),define("lib-build/tpl!storymaps/tpl/builder/shortlistMigration/layerPicker",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="tab-pane viewMigrationLayerSelectorContainer">\r\n	<div class="importQuestion">\r\n		Choose the point layer(s) in your web map you want to use as places:\r\n	</div>\r\n\r\n	<div class="checkbox opt-container layer-picker" >\r\n\r\n	</div>\r\n\r\n	<div class="layer-info">\r\n		If you choose more than one layer, they must all have the same set of fields.\r\n		Each layer you choose will become a tab in your shortlist.\r\n	</div>\r\n\r\n	<div class="layer-info">\r\n		If you choose one layer, an optional field can be chose that contains the tab\r\n		name each place will be displayed in.\r\n	</div>\r\n\r\n	<div class="tab-field-picker">\r\n		<select id="tabFieldSelect">\r\n			<option value="none">none</option>\r\n		</select>\r\n	</div>\r\n\r\n</div>\r\n';return __p}}),define("lib-build/css!storymaps/tpl/builder/shortlistMigration/layerPicker",[],function(){}),define("lib-build/tpl!storymaps/tpl/builder/shortlistMigration/fieldPicker",[],function(){return function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="tab-pane viewMigrationFieldSelectorContainer">\r\n\r\n	<div class="inset field-name">\r\n		Field containing the name of each place:\r\n		<div class="tab-field-name-picker">\r\n			<select id="fieldNameSelect">\r\n				<option value="none">none</option>\r\n			</select>\r\n		</div>\r\n	</div>\r\n\r\n	<div class="inset description-info">\r\n		Field(s) that will appear in the description for each place and their order:\r\n	</div>\r\n	<div class="opt-container description-picker" >\r\n\r\n	</div>\r\n\r\n	<div class="inset url-info">\r\n		Field containing the URL for \'More info\' about each place (optional):\r\n	</div>\r\n	<div class="tab-field-url-picker">\r\n		<select id="fieldUrlSelect">\r\n			<option value="none">none</option>\r\n		</select>\r\n	</div>\r\n\r\n	<div class="inset pic-info">\r\n		Fields containing URL to images for each place (optional):\r\n	</div>\r\n	<div class="tab-field-photo-picker">\r\n		Main image:\r\n		<select class="photoSelect" id="fieldPicUrlSelect">\r\n			<option value="none">none</option>\r\n		</select>\r\n	</div>\r\n	<div class="tab-field-photo-picker">\r\n		Thumbnail:\r\n		<select class="photoSelect" id="fieldThumbUrlSelect">\r\n			<option value="none">none</option>\r\n		</select>\r\n	</div>\r\n	<div class="inset imagesOptional">\r\n		Leave these set to none if you want to add images to your places in the Builder\r\n	</div>\r\n</div>\r\n';return __p}}),define("lib-build/css!storymaps/tpl/builder/shortlistMigration/fieldPicker",[],function(){}),define("storymaps/tpl/builder/shortlistMigration/Migration",["lib-build/tpl!./Migration","lib-build/css!./Migration","lib-build/tpl!./layerPicker","lib-build/css!./layerPicker","lib-build/tpl!./fieldPicker","lib-build/css!./fieldPicker","../../core/Helper","esri/symbols/SimpleMarkerSymbol","esri/graphic","dojo/topic","dojo/Deferred"],function(e,t,n,r,i,s,o,u,a,f,l){return function(r,s,c,h,p){function k(){r.find(".btnCancel").click(function(){r.modal("hide"),y.reject()}),r.on("shown.bs.modal",function(){L()}),x.click(B),T.click(j),$(".viewMigrationSelectorContainer input").on("change",function(){H()})}function L(){H()}function A(){r.hasClass("in")?(N=!0,r.addClass("temporaryHide")):r.removeClass("temporaryHide"),r.modal("toggle")}function O(){setTimeout(function(){r.find(".modal-body").addClass("migrateWebmap"),r.find(".modal-body").removeClass("layerSelector"),r.find(".modal-body").removeClass("migrationQuestion")},500);var e=[];r.find(".layer-picker .opt-checkbox:checkbox:checked").each(function(){e.push($(this).attr("name"))}),w=[],S=[],$.each(e,function(e,t){var n=$.grep(b,function(e){return e.id==t});w.push(n[0])});if(w.length>1){var t=[];$.each(w[0].graphics[0].attributes,function(e){t.push(e)}),$.each(w,function(e,n){var r=[];$.each(t,function(e,i){var s=[];$.each(n.graphics[0].attributes,function(e){s.push(e)});var o=$.grep(s,function(e){return e.toLowerCase()===i.toLowerCase()});if(!o.length){var u=t.indexOf(i);r.push(u)}}),$.each(r,function(e,n){t.splice(n,1)})}),$.each(t,function(e,t){t!="__OBJECTID"&&(S.push(t),$("#fieldSelect").append($("<option></option>").attr("value",t).text(t)))})}else{$.each(w[0].graphics[0].attributes,function(e){e!="__OBJECTID"&&(S.push(e),$("#fieldSelect").append($("<option></option>").attr("value",e).text(e)))});if(r.find(".layer-picker .opt-checkbox:checkbox:checked").length==1&&r.find("#tabFieldSelect").val()!="none"){var n=r.find("#tabFieldSelect").val(),s=[],o=[];$.each(w[0].graphics,function(e,t){o.indexOf(t.attributes[n])<0&&(o.push(t.attributes[n]),s.push({name:t.attributes[n],graphics:[]}))}),$.each(w[0].graphics,function(e,t){var r=$.grep(o,function(e){return e==t.attributes[n]});$.map(s,function(e,n){e.name==r[0]&&s[n].graphics.push(t)})}),w=s}}r.find(".modal-title").text("Choose the fields the Shortlist should use"),r.find(".viewMigrationLayerSelectorContainer").hide(),$(".viewMigrationFieldSelectorContainer").length?$(".viewMigrationFieldSelectorContainer").show():r.find(".modal-body").append(i({})),$("#fieldNameSelect").empty(),$("#fieldUrlSelect").empty(),$("#fieldPicUrlSelect").empty(),$("#fieldThumbUrlSelect").empty(),r.find(".description-picker").empty(),$("#fieldNameSelect").append($("<option></option>").attr("value","none").text("none")),$("#fieldUrlSelect").append($("<option></option>").attr("value","none").text("none")),$("#fieldPicUrlSelect").append($("<option></option>").attr("value","none").text("none")),$("#fieldThumbUrlSelect").append($("<option></option>").attr("value","none").text("none"));var u=!1;$.each(S,function(e,t){$("#fieldNameSelect").append($("<option></option>").attr("value",t).text(t)),$("#fieldUrlSelect").append($("<option></option>").attr("value",t).text(t)),$("#fieldPicUrlSelect").append($("<option></option>").attr("value",t).text(t)),$("#fieldThumbUrlSelect").append($("<option></option>").attr("value",t).text(t));var n=null;t.toLowerCase()=="short_desc"&&(n=1),t.toLowerCase()=="desc1"&&(n=2),t.toLowerCase()=="description"&&(n=2),t.toLowerCase()=="caption"&&(n=2),t.toLowerCase()=="desc2"&&(n=3),t.toLowerCase()=="desc3"&&(n=4),t.toLowerCase()=="desc4"&&(n=5),t.toLowerCase()=="desc5"&&(n=6),t.toLowerCase()=="address"&&(n=7),t.toLowerCase()=="hours"&&(n=8),n?(r.find(".description-picker").append('<div class="checkbox"><label><input type="checkbox" class="opt-checkbox" value='+n+"/>"+t+"</label></div>"),u=!0):r.find(".description-picker").append('<div class="checkbox"><label><input type="checkbox" class="opt-checkbox" />'+t+"</label></div>")}),u&&r.find(".description-picker .checkbox").sort(function(e,t){var n=$(e).find(":checkbox"),r=$(t).find(":checkbox");return n.val()<r.val()?-1:n.val()>r.val()?1:0}).appendTo(".description-picker"),M()}function M(){$.each($("#fieldNameSelect option"),function(e,t){if(t.value.toLowerCase()=="name")return $(this).prop("selected",!0),!1;t.value.toLowerCase()=="title"&&$(this).prop("selected",!0)}),$.each(r.find(".description-picker .opt-checkbox"),function(e,t){$(t).parent().text().toLowerCase()=="short_desc"&&$(this).prop("checked",!0),$(t).parent().text().toLowerCase()=="desc1"&&$(this).prop("checked",!0),$(t).parent().text().toLowerCase()=="description"&&$(this).prop("checked",!0),$(t).parent().text().toLowerCase()=="caption"&&$(this).prop("checked",!0),$(t).parent().text().toLowerCase()=="desc2"&&$(this).prop("checked",!0),$(t).parent().text().toLowerCase()=="hours"&&$(this).prop("checked",!0),$(t).parent().text().toLowerCase()=="address"&&$(this).prop("checked",!0)}),$.each($("#fieldUrlSelect option"),function(e,t){if(t.value.toLowerCase()=="website")return $(this).prop("selected",!0),!1}),$.each($("#fieldPicUrlSelect option"),function(e,t){if(t.value.toLowerCase()=="pic_url")return $(this).prop("selected",!0),!1;t.value.toLowerCase()=="picture"&&$(this).prop("selected",!0),t.value.toLowerCase()=="image_url"&&$(this).prop("selected",!0)}),$.each($("#fieldThumbUrlSelect option"),function(e,t){if(t.value.toLowerCase()=="thumb_url")return $(this).prop("selected",!0),!1;t.value.toLowerCase()=="pic_url"&&$(this).prop("selected",!0),t.value.toLowerCase()=="picture"&&$(this).prop("selected",!0),t.value.toLowerCase()=="image_url"&&$(this).prop("selected",!0)}),setTimeout(function(){H()},500),r.find(".description-picker .opt-checkbox").on("click",function(){H()}),r.find("#fieldNameSelect").on("change",function(){H()}),$(".description-picker").sortable()}function _(){var e=$("input[name=optradio]:checked",".viewMigrationSelectorContainer").val();e=parseInt(e);if(!e)y.resolve(parseInt(e)),r.modal("hide");else{r.find(".modal-title").text("Choose your point Data"),T.show(),r.find(".viewMigrationSelectorContainer").hide();if($(".viewMigrationLayerSelectorContainer").length){$(".viewMigrationLayerSelectorContainer").show(),setTimeout(function(){r.find(".modal-body").addClass("layerSelector"),r.find(".modal-body").removeClass("migrateWebmap"),r.find(".modal-body").removeClass("migrationQuestion")},500);return}r.find(".modal-body").append(n({})),$.each(b,function(e,t){r.find(".layer-picker").append('<div class="checkbox"><label><input type="checkbox" class="opt-checkbox" name='+t.id+" />"+t.name+"</label></div>")}),r.find(".layer-picker .opt-checkbox").click(D),r.find(".layer-picker .opt-checkbox").eq(0).prop("checked",!0),D()}r.find(".layer-picker .opt-checkbox").on("change",function(){H()}),setTimeout(function(){H()},500)}function D(){if(!r.find(".layer-picker .opt-checkbox:checkbox:checked").length)return;if(r.find(".layer-picker .opt-checkbox:checkbox:checked").length>1){$("#tabFieldSelect").attr("disabled",!0),$("#tabFieldSelect").addClass("disableTabSelector");return}$("#tabFieldSelect").attr("disabled",!1),$("#tabFieldSelect").removeClass("disableTabSelector");var e=$(".layer-picker .opt-checkbox:checkbox:checked").attr("name"),t=$.grep(b,function(t){return t.id==e});$("#tabFieldSelect").empty(),$("#tabFieldSelect").append($("<option></option>").attr("value","none").text("none")),$.each(t[0].graphics[0].attributes,function(e){e!="__OBJECTID"&&$("#tabFieldSelect").append($("<option></option>").attr("value",e).text(e))}),$.each($("#tabFieldSelect option"),function(e,t){if(t.value.toLowerCase()=="tabname"||t.value.toLowerCase()=="tab_name")return $(this).prop("selected",!0),!1})}function P(e,t,n,i,s){r.modal("hide"),app.migration=!0,m.buildAddFeatureBar();var o=m.buildWebMap();o.item.title=app.data.getResponse().itemInfo.item.title+" -copy",o.item.extent=app.data.getResponse().itemInfo.item.extent,o.itemData.spatialReference=app.data.getResponse().itemInfo.itemData.spatialReference,o.itemData.baseMap=app.data.getResponse().itemInfo.itemData.baseMap,n!="none"&&app.data.getWebAppData().setGeneralOptions({moreInfoLink:!0}),app.data.getWebAppData().setOriginalWebmap(app.data.getWebAppData().getWebmap()),app.map.destroy(),app.map=null;var l=v.loadWebmap(o,"map");l.then(function(r){app.data.setResponse(r),app.map=l.results[0].map,app.data.setWebMap(l.results[0].itemInfo),m.updateUI(),d.appInitComplete(g),$.each(E,function(e,t){app.map.addLayer(t)});var o=app.map.getLayer(app.data.getShortlistLayerId());$.each(w,function(r,f){$("body").addClass("loadingPlaces"),r===0&&($(".entryLbl").eq(0).text(f.name),app.data.setStory(0,f.name),app.data.getWebAppData().setTabs(app.data.getStory())),r>0&&app.ui.navBar.onClickAdd(f.name),$.each(f.graphics,function(f,l){var c={name:"",description:"",pic_url:"",thumb_url:"",website:"",shortlist_id:o.graphics.length+1,tab_id:r,locationSet:1,getValueCI:C.getValueCI};c.name=l.attributes[e],$.each(t,function(e,t){l.attributes[t]&&(c.description+=l.attributes[t]+"<br><br>")}),n!="none"&&l.attributes[n]&&(c.website=l.attributes[n]),i!="none"&&(c.pic_url=l.attributes[i]),s!="none"&&(c.thumb_url=l.attributes[s]),s=="none"&&i!="none"&&(c.thumb_url=l.attributes[i]);var h=new u,p=new a(l.geometry,h,c),d=app.addFeatureBar.addMapIcon(p,app.data.getStory()[r].color);o.add(d)})}),app.detailPanelBuilder.buildAllSlides(),$("#loadingIndicator").show(),setTimeout(function(){$("body").removeClass("loadingPlaces"),$("#loadingIndicator").hide(),v.activateLayer(0),f.publish("BUILDER_INCREMENT_COUNTER",1)},500)})}function H(){var e=!0;r.find("input[name=optradio]:checked",".viewMigrationSelectorContainer").length&&r.find(".viewMigrationSelectorContainer").css("display")!="none"&&(e=!1,r.find(".modal-body").addClass("migrationQuestion"),r.find(".modal-body").removeClass("layerSelector"),r.find(".modal-body").removeClass("migrateWebmap")),r.find(".layer-picker .opt-checkbox:checkbox:checked").length>0&&r.find(".viewMigrationLayerSelectorContainer").css("display")!="none"&&(e=!1,r.find(".modal-body").addClass("layerSelector"),r.find(".modal-body").removeClass("migrateWebmap"),r.find(".modal-body").removeClass("migrationQuestion")),r.find("#fieldNameSelect").val()!="none"&&r.find(".description-picker .opt-checkbox:checkbox:checked").length>0&&r.find(".viewMigrationFieldSelectorContainer").css("display")!="none"&&(e=!1,r.find(".modal-body").addClass("migrateWebmap"),r.find(".modal-body").removeClass("layerSelector"),r.find(".modal-body").removeClass("migrationQuestion")),x.html("Next"),x.attr("disabled",e)}function B(){r.find(".modal-body").hasClass("migrationQuestion")&&_(),r.find(".modal-body").hasClass("layerSelector")&&(r.find(".viewMigrationLayerSelectorContainer").hide(),O());if(r.find(".modal-body").hasClass("migrateWebmap")){var e=r.find("#fieldNameSelect").val(),t=[];$.each(r.find(".description-picker .opt-checkbox:checkbox:checked"),function(e,n){t.push($(n).parent().text())});var n=r.find("#fieldUrlSelect").val(),i=r.find("#fieldPicUrlSelect").val(),s=r.find("#fieldThumbUrlSelect").val();P(e,t,n,i,s)}}function j(){r.find(".modal-body").hasClass("layerSelector")&&(r.find(".modal-body").removeClass("layerSelector"),r.find(".modal-body").addClass("migrationQuestion"),r.find(".viewMigrationLayerSelectorContainer").hide(),r.find(".viewMigrationSelectorContainer").show(),T.hide(),H()),r.find(".modal-body").hasClass("migrateWebmap")&&($(".viewMigrationFieldSelectorContainer").hide(),_(),H())}r.append(e({btnCancel:i18n.commonCore.common.cancel,btnBack:i18n.commonCore.common.back}));var d=s,v=c,m=h,g=p,y=null,b=null,w=null,E=null,S=[],x=r.find(".btnSubmit"),T=r.find(".btn-back"),N=null,C=new o;k(),this.present=function(e,t){return y=new l,b=e,E=t,H(),r.modal({keyboard:!0}),y},this.close=function(){r.modal("hide"),y.reject()},this.initLocalization=function(){}}}),define("storymaps/tpl/builder/BuilderView",["lib-build/tpl!./BuilderView","lib-build/tpl!./BasemapChooser","lib-build/css!./BuilderView","lib-build/css!./Common","../core/WebApplicationData","storymaps/common/builder/settings/SettingsPopup","storymaps/common/builder/Landing","./InitPopup","storymaps/common/builder/SharePopup","../core/Helper","storymaps/common/utils/CommonHelper","storymaps/common/builder/BuilderHelper","esri/dijit/BasemapGallery","storymaps/common/builder/browse-dialog/js/BrowseIdDlg","lib-build/css!../../common/builder/browse-dialog/css/browse-dialog","lib-build/css!../../common/builder/browse-dialog/storymaps-override","./settings/ViewGeneralOptions","./settings/ViewMapOptions","storymaps/common/builder/settings/ViewHeader","./Workflow","./AddFeatureBar","./DetailPanelBuilder","storymaps/common/builder/ckeditor/plugins/storymapsInlineMedia/dialog/Media","./addedit/Popup","./OrganizePopup","./shortlistMigration/Migration","dojo/Deferred","dojo/topic","dojo/has","dojo/on","dojo/_base/lang"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O){return function(r){function B(e){s.updateUI(!0),e&&i.setTitle(e),k.publish("CORE_UPDATE_UI"),j();if(!u)return;if(app.isDirectCreationFirstSave){var t=app.cfg.COLOR_ORDER.split(","),n=$.grep(app.cfg.COLOR_SCHEMES,function(e){return e.name==t[0]});$("#paneLeft").css("border-top-color",n[0].color);var r={header:"#444",tabText:"#d8d8d8",tab:"#666",tabTextActive:"#fff",tabActive:n[0].color,tabTextHover:"#fff",tabHover:"#666"},o=0,a={};a.title="Tab 1",app.ui.navBar.init([a],o,r,i)}}function j(){s.updateUI(!0),$("body").removeClass("isBuilderLanding"),app.isInitializing=!1,k.publish("BUILDER_INCREMENT_COUNTER",1)}function F(){var e=!1;$(".builder-add").toggleClass("disabled",e).tooltip("destroy"),e&&$(".builder-add").tooltip({trigger:"hover",placement:"top",html:!0,title:i18n.builder.addEditPopup.disabled.replace("%LBL_LAYOUT%",app.data.getWebAppData().getLayoutProperties().itemsLbl.toLowerCase())})}function I(e){var t=new C;return v.present({mode:"edit",displayTab:e.displayTab,entry:app.data.getStoryByIndex(e.entryIndex),entryIndex:e.entryIndex,syncMaps:i.getMapOptions().mapsSync?!e.entryIndex:1}).then(function(n){console.log("$$$$ ",n),app.data.setStory(e.entryIndex,n.title,n.color),i.setTabs(app.data.getStory());var r={header:"#444",tabText:"#d8d8d8",tab:"#666",tabTextActive:"#fff",tabActive:n.color,tabTextHover:"#fff",tabHover:"#666"};app.ui.navBar.init(app.data.getStory(),e.entryIndex,r,i),$.each(app.layerCurrent.graphics,function(e,t){app.addFeatureBar.addMapIcon(t,n.color,!0)}),app.map.getLayer(app.data.getShortlistLayerId()).redraw(),$(".num").css("background-color",n.color),$("#paneLeft").css("border-top-color",n.color),$(".detailContainer").eq(e.entryIndex).find(".detailFeatureNum").css("background-color",n.color),k.publish("story-update-entry",{index:e.entryIndex,section:n}),k.publish("BUILDER_INCREMENT_COUNTER",1),t.resolve(),i.getTitle()&&k.publish("INCREMENT_SAVE_COUNTER")},function(){}),t}function q(){$(".builder-organize").addClass("active"),O.present({entries:app.data.getStory(),sectionIndex:$(".entry.active").index()}).then(function(e){console.log("builder.BuilderView.openOrganizePopup:",e),O.close();var t={header:"#444",tabText:"#d8d8d8",tab:"#666",tabTextActive:"#fff",tabActive:e.entries[e.sectionIndex].color,tabTextHover:"#fff",tabHover:"#666"};app.ui.navBar.init(e.entries,e.sectionIndex,t,i),app.addFeatureBar.updateAllFeatures(e),P.activateLayer(e.sectionIndex),k.publish("story-update-entries"),k.publish("BUILDER_INCREMENT_COUNTER",1)},function(){s.updateUI()})}function R(){$("#loadingMessage").html('<div class="mainMessage">'+i18n.viewer.loading.long+"<br />"+i18n.viewer.loading.long2+"</div>").fadeIn("slow",function(){$("#loadingMessage").addClass("loaded")})}function U(e){e.settings[0].numberedIcons!=i.getMapOptions().numberedIcons&&setTimeout(function(){app.addFeatureBar.updateAllFeatures(),app.detailPanelBuilder.buildAllSlides(),P.activateLayer($(".entry.active").index())},50),i.setGeneralOptions(e.settings[0]),i.setMapOptions(e.settings[1]),i.setHeader(e.settings[2]),e.settings[0].mapsSync&&$.each(app.data.getStory(),function(e,t){if(e===0)return;t.extent=app.data.getStory()[0].extent}),k.publish("BUILDER_INCREMENT_COUNTER",1),k.publish("CORE_UPDATE_UI"),k.publish("CORE_RESIZE"),F()}function z(e){d.present(e)}function W(e){if(e.pickWebmap)r.initPopupComplete(),$("#browse-id-dialog").css({top:"25%",left:"25%"}),$("#browse-id-dialog").show();else{r.displayApp(),r.initPopupComplete(),app.data.getWebAppData().setDefaultLayoutOptions(),s.buildAddFeatureBar(),app.isDirectCreationFirstSave&&(app.data.getWebAppData().setDefaultGeneralOptions(),app.data.getWebAppData().setDefaultMapOptions(),app.addFeatureBar.addLayer());if(app.migration){var t=app.cfg.COLOR_ORDER.split(","),n=$.grep(app.cfg.COLOR_SCHEMES,function(e){return e.name==t[0]});$("#paneLeft").css("border-top-color",n[0].color);var o={header:"#444",tabText:"#d8d8d8",tab:"#666",tabTextActive:"#fff",tabActive:n[0].color,tabTextHover:"#fff",tabHover:"#666"},u=0,a={};a.title="Tab 1",app.ui.navBar.init([a],u,o,i),app.addFeatureBar.addLayer(!0)}else{var f=$.grep(app.map.graphicsLayerIds,function(e){return e.split("_").slice(0,-1).join("_")==i.getShortlistLayerId()?e:e==i.getShortlistLayerId()?e:!1});if(!f.length){var t=app.cfg.COLOR_ORDER.split(","),n=$.grep(app.cfg.COLOR_SCHEMES,function(e){return e.name==t[0]});$("#paneLeft").css("border-top-color",n[0].color);var o={header:"#444",tabText:"#d8d8d8",tab:"#666",tabTextActive:"#fff",tabActive:n[0].color,tabTextHover:"#fff",tabHover:"#666"},u=0,a={};a.title="Tab 1",app.ui.navBar.init([a],u,o,i),app.addFeatureBar.addLayer(!0);return}app.data.setShortlistLayerId(f[0]);var l=app.map.getLayer(app.data.getShortlistLayerId());app.layerCurrent=l,l.on("mouse-over",P.layer_onMouseOver),l.on("mouse-out",P.layer_onMouseOut),l.on("click",P.layer_onClick)}k.publish("CORE_UPDATE_UI"),$("body").addClass("isBuilderLanding"),$("body").addClass("switchLayout"),r.appInitComplete(i)}app.detailPanelBuilder.init(P)}function X(){D=new p({portal:app.portal,galleryType:"webmap"}),A(D._grid,"onItemClick",function(){D.onClose()}),A(D,"close",function(){D.get("selected")&&r.loadWebMap(D.get("selected").id)})}$("#builder-views").append(e({})),$("#map").append(t({}));var s=this,o=r,u=!0,f=null,d=new a($("#sharePopup")),v=new x($("#addEditPopup")),L=new S($("#editorDialogInlineMedia")),O=new T($("#organizePopup")),M=new b($("#initPopup")),_=null,D=null,P,H;app.detailPanelBuilder=new E($("#contentPanel"),L),app.addFeatureBar=new w($("#contentPanel"),L),this.init=function(e,t){f=e,P=t,H=new N($("#migrationPopup"),o,P,s,i),k.subscribe("SETTINGS_POPUP_SAVE",U),k.subscribe("OPEN_HELP",function(){alert("TODO")}),app.builder.openSharePopup=z,app.builder.openEditPopup=I,$(".builder-add").click(function(){$(this).hasClass("disabled")||j()}).find(".builder-lbl").html(i18n.builder.addEditPopup.lblAdd),$(".builder-organize").click(q).find(".builder-lbl").html("Organize Tabs")},this.appInitComplete=function(){!app.isProduction&&l.getUrlParams().debug=="add"&&j(),!app.isProduction&&l.getUrlParams().debug=="organize"&&q(),!app.isProduction&&l.getUrlParams().debug=="settings"&&this.openSettingPopup(),!app.isProduction&&l.getUrlParams().debug=="edit"&&I({displayTab:l.getUrlParams().debugView||"content",sectionIndex:l.getUrlParams().debugIndex||0}),F(),B();var e=dijit.byId("basemapGallery");e&&e.destroyRecursive(!0),e=new h({showArcGISBasemaps:!0,map:app.map},"basemapGallery"),e.startup(),$("#basemapChooser .dijitTitlePaneTextNode").html("Change Basemap"),$("#basemapChooser").show();var t=app.map.extent;e.on("selection-change",function(){t=app.map.extent;var n=e.getSelected(),r=[];$.each(n.layers,function(e,t){var i={id:n.id+"_"+e,opacity:1,visibility:!0,url:t.url};t.type=="reference"?i.isReference=!0:t.type=="OpenStreetMap"&&(delete i.url,i.type="OpenStreetMap"),r.push(i)}),app.data.getWebMap().itemData.baseMap={baseMapLayers:r,title:n.title},app.basemapChanged=!0,k.publish("BUILDER_INCREMENT_COUNTER",1),$("#basemapChooser").find(".dijitTitlePaneTitle").click(),setTimeout(function(){app.map.setExtent(t)},500)});if(u){u=!1;var n={};W(n)}},this.updateUI=function(e){var t=e||app.data.getStoryLength();$(".builder-add, .builder-organize").removeClass("active"),$(".builder-content-panel").toggle(!!t)},this.buildWebMap=function(){return c.getBlankWebmapJSON()},this.getSettingsTab=function(){return[new m,new g,new y({smallSizeOpt:app.appCfg.headerCompactOpt})]},this.openSettingPopup=function(e){f.present([i.getGeneralOptions(),i.getMapOptions(),i.getHeader()],null)},this.openMigrationPopup=function(e,t){console.log("LAYERS ==== ",e,t),H.present(e,t).then(function(e){console.log("*** ",e),e||($("#loadingIndicator").show(),r.appInitComplete(i))})},this.showInitPopup=function(){return},this.buildAddFeatureBar=function(){app.addFeatureBar.loaded||app.addFeatureBar.init(P,s)},this.resize=function(e){},this.initLocalization=function(){f.initLocalization()}}}),require(["storymaps/common/Core","storymaps/common/ui/header/Desktop","storymaps/tpl/core/MainView","storymaps/common/builder/Builder","storymaps/tpl/builder/BuilderView"],function(){}),define("storymaps/tpl/BuildConfigBuilder",function(){});