<html>
<head>
	<style type="text/css">
	body {
		font-family: arial, 'sans-serif';
	}

	#message {
		display: none;
		height: 100%;
		text-align: center;
	}

	#message:before {
		display: inline-block;
		content: '';
		height: 100%;
		vertical-align: middle;
	}

	#inner-message {
		display: inline-block;
		margin-bottom: 100px;
		vertical-align: middle;
	}

	#inner-message .title {
		margin-top: 0;
  	color: #444;
		font-size: 36px;
  	font-weight: 400;
	}

	#inner-message .button {
		padding: 8px 22px;
    background: rgb(74, 131, 204);
    color: white;
    border-radius: 4px;
    box-shadow: 1px 1px 3px 1px #CCC;
    cursor: pointer;
    display: inline-block;
    font-size: 20px;
    font-weight: 400;
	}

	#instructions {
		display: none;
	}

	#inner-message .button:hover {
		background: rgb(69, 124, 193);
	}


	</style>
</head>
<body>
<div id="message">
	<div id="inner-message">
		<h1 id="title" class="title">You are now signed in.</h1>
		<div id="close-window" class="button">Back to Story Maps</div>
		<div id="instructions">
			<h3 id="instructions-message">Close this tab and refresh the website.</h3>
			<div id="close-window-instructions" class="button">Close</div>
		</div>
	</div>
</div>
<script>
	var getPageFrom = function() {
		// get the URL we want to go back to from the state URL property on the hash.
		var pageFrom = '',
			matches = (/&state=(.*?)(?=(#|&|$))/i).exec(window.location.hash),
			redirectParams = null,
			paramObj = null;

		if(matches && matches.length) {
			redirectParams = matches[1];
			paramObj = JSON.parse(decodeURIComponent(redirectParams));
			pageFrom = paramObj.fromUrl;
		}

		return pageFrom;
	};

	var PAGE_FROM = getPageFrom();

// can access parent window?
	var parentWindow = {},
		canAccessParent = true,
		DEFAULT_PORTAL_URL = (/\?defaultPortalURL=(.*?)(?=(#|&|$))/i).exec(window.location.href)[1],
		baseUrl = 'https://' + DEFAULT_PORTAL_URL,
		DEFAULT_CLIENT_ID = (/\&defaultClientId=(.*?)(?=(#|&|$))/i).exec(window.location.href)[1],
		smallUrl = window.location.href.replace(/#(.*?)$/, ''),


	onSignedIn = function() {
		var callback = null,
			cookie = null,
			canAccessParent = true,
			locale = '';

		if(window.location.href.match(/redirectHttps/)) {
			redirectToHttps();
			return;
		}

		if( window.location.href.match(/fromSignOut/) ) {
			// see if we can access the parent's locale
			locale = getLocale();

			window.location.href = baseUrl + "/sharing/rest/oauth2/authorize?client_id=" + DEFAULT_CLIENT_ID + "&display=iframe" +
			"&redirect_uri=" + parentWindow.redirectBase + "arcgis-storymaps-my-stories-utils/sign-in/signedin.html" + encodeURIComponent("?defaultPortalURL=" + DEFAULT_PORTAL_URL +
			"&defaultClientId=" + DEFAULT_CLIENT_ID) + "&response_type=token" + "&showSocialLogins=true" + "&locale=" + locale + "&parent=" + parentWindow.location.origin;

			return;
		}

		cookie = getUserCookie();

		/*
		General logic --
		1) see if here because of a redirect or sign-out (handled above).
		2) if not, see if there is a cookie.
		   if there is, see if you can access the parent window.
		   	  if you can, then finish sign-in.
		   	  if not, then make a request to see if the account is ssl-only or not.
		   	      if it is, then reload the frame to http with a flag so we know to redirect everything to https.
		   	      if it's not, then reload the frame to http.
			if there is no cookie, then see if you can access the parent window.
				if so, then sign out and redirect back to the frame with its matching protocol.
				if not, then sign out and redirect back to the frame with the frame being forced on http.
		*/


		if(cookie) {

			// if can access
			try {
				var a = parentWindow.location.href;

				// Safari doesn't throw the error, just logs it, so we need to look here for a null var from the previous statement.
				if(!a) {
					canAccessParent = false;
				}
			}

			catch(e) {
				canAccessParent = false;
			}

			if(canAccessParent) {
				if(parentWindow.signInManager) {
					// if this isn't a frame (but is a full page)
					if(!window.frameElement) {
						// do your thing
						if(window.location.hash) {
							window.location.hash = '';
						}
						callback = parentWindow.signInManager.getSignedInCallback();
						segueToParent(cookie, callback);
						onTabPageShown();
					}
					// if it is a frame it should do its thing
					else {
						callback = parentWindow.signInManager.getSignedInCallback();
						segueToParent(cookie, callback);
					}
				}
				else {
					// if this isn't a frame (but is a full page)
					if(!window.frameElement) {
						if(window.location.hash) {
							window.location.hash = '';
						}
						onTabPageShownOrphan();
					}
				}
			}

			else {
				// check if it's ssl.
				var request = new XMLHttpRequest();
				var requestUrl = baseUrl + '/sharing/rest/accounts/self?f=json&token=' + cookie.token;

				request.onreadystatechange = function() {
					if(request.readyState === 4) {
						// status code logic from jquery 1.11.3
						if(request.status >= 200 && request.status < 300 || request.status === 304) {
							var parsedResults = JSON.parse(request.responseText),
								isSSLOnly = parsedResults.allSSL;
								if(isSSLOnly) {
									reloadFrameHttp(true);
								}
								else {
									reloadFrameHttp(false);
								}
						}
						else {
							reloadFrameHttp(true);
						}
					}
				};


				request.open('GET', requestUrl);
				request.send();
			}
		}

		else {
			// public sign in
			try {
				var a = parentWindow.location.href;
			}

			catch(e) {
				canAccessParent = false;
			}

			// or sometimes, if cant accessparent, we'll want it to still go to https on signout.
			// frame is on https, page is https
			if(canAccessParent) {
				window.location.href = baseUrl + '/sharing/rest/oauth2/signout?redirect_uri=' + encodeURIComponent(smallUrl + "&fromSignOut=true");
			}
			// frame is on https, page is http
			else {
				var windowHttp = smallUrl.replace((/(.*?):\/\//), 'http://');

				window.location.href = baseUrl + '/sharing/rest/oauth2/signout?redirect_uri=' + encodeURIComponent(windowHttp + "&fromSignOut=true");
			}
		}
	},


	reloadFrameHttp = function(httpsFlag) {
		var urlFlag = '';

		if(httpsFlag) {
			urlFlag = '&redirectHttps=true';
		}

		window.location.href = smallUrl.replace((/(.*?):\/\//), 'http://') + urlFlag;
	},


	redirectToHttps = function() {
		var urlPrefix = '',
			match = '',
			httpsUrl = '';

		// see if came here with the buildApp information. If so, pass back.
		if(window.location.href.match(/&buildApp=true/)) {
			match = (/(&buildApp=true)&app=(.*?)&layout=(.*?)(?=(#|&|$))/).exec(window.location.href)[1];
			urlPrefix = match.replace(/^&/, '?');
		}

		httpsUrl = parentWindow.location.href.replace((/(.*?):\/\//), 'https://') + urlPrefix;

		// if this isn't a frame (but is a full page)
		if(!window.frameElement) {
			if(window.location.hash) {
				window.location.hash = '';
			}
			onTabPageShown(httpsUrl);
		}

		parentWindow.location.href = httpsUrl;
	},


	segueToParent = function(cookie, callback) {
		parentWindow.signInManager.renderHeader();
		parentWindow.signInManager.hideSignInDialog(false);

		if(cookie) {
			parentWindow.signInManager.renderHeader();
			parentWindow.signInManager.hideSignInDialog(false);

			if(typeof callback === 'function') {
				callback(cookie);
			}
		}
		else {
			window.location.href = baseUrl + '/sharing/rest/oauth2/signout?redirect_uri=' + encodeURIComponent(smallUrl + "&fromSignOut=true");
		}
	},


	getLocale = function() {
		var preflang = fetchCookie('preflang'),
			locale = '';

		try {
			locale = parentWindow.dojoConfig.locale;

			// Safari doesn't throw the error, just logs it, so we need to look here for a null var from the previous statement.
			if(!locale) {
				locale = preflang;
			}
		}

		catch(e) {
			locale = preflang;
		}

		if(!locale) {
			locale = 'en';
		}

		return locale;
	},



	getUserCookie = function() {
		// read the cookie, if there is one.
		var cookie = fetchCookie('esri_auth');

		if(!cookie) {
			return null;
		}

		cookie = JSON.parse(cookie.replace('"ssl":undefined', '"ssl":""'));

		return cookie || null;
	},


	/**
	@summary Gets a cookie based on its name. Borrowed from buildapp.js in this project.
	*/
	fetchCookie = function(cookieName) {
		var cookieValue = document.cookie,
			cookieStart = cookieValue.indexOf(" " + cookieName + "=");

		if (cookieStart == -1) {
			cookieStart = cookieValue.indexOf(cookieName + "=");
		}

		if (cookieStart == -1) {
			cookieValue = null;
		}
		else {
			cookieStart = cookieValue.indexOf("=", cookieStart) + 1;
			var cookieEnd = cookieValue.indexOf(";", cookieStart);
			if (cookieEnd == -1) {
				cookieEnd = cookieValue.length;
			}
			cookieValue = decodeURIComponent(cookieValue.substring(cookieStart, cookieEnd));
		}
		return cookieValue;
	},


	onTabPageShown = function(url) {
		window.close();
		showPage(url, true);
	},


	onTabPageShownOrphan = function() {
		showPage(null, false);
	},


	showPage = function(url, canCallback) {
		var closeWindowButton = document.getElementById('close-window'),
			inputUrl = '';

		if(canCallback) {
			// If they are redirected to https (but this frame is http), we provide the URL because they won't have access to parentWindow.
			inputUrl = url ? url : parentWindow.location.href;
		}
		else if(PAGE_FROM) {
			inputUrl = PAGE_FROM;
		}
		else {
			closeWindowButton.style.display = 'none';
			document.getElementById('instructions').style.display = 'block';
			document.getElementById('close-window-instructions').addEventListener('click', function() {
				window.close();
			});
		}

		closeWindowButton.addEventListener('click', function() {
			// redirect user to the page they logged in from.
			window.location.href = inputUrl;
		});

		localizeStrings();

		document.getElementById('message').style.display = 'block';
	},


	localizeStrings = function() {
		var welcomeStrings = JSON.parse(fetchCookie('welcome'));
		if (welcomeStrings) {
			for (var prop in welcomeStrings) {
				if (welcomeStrings.hasOwnProperty(prop)) {
					if (welcomeStrings[prop] && typeof welcomeStrings[prop] === 'string') {
						welcomeStrings[prop] = welcomeStrings[prop].replace(/<.*?>/, '');
					}
				}
			}
			
			if (welcomeStrings.titleOne && typeof welcomeStrings.titleOne === 'string') {
				document.getElementById('title').innerHTML = welcomeStrings.titleOne;
			}
			if (welcomeStrings.buttonOne && typeof welcomeStrings.buttonOne === 'string') {
				document.getElementById('close-window').innerHTML = welcomeStrings.buttonOne;
			}
			if (welcomeStrings.titleTwo && typeof welcomeStrings.titleTwo === 'string') {
				document.getElementById('instructions-message').innerHTML = welcomeStrings.titleTwo;
			}
			if (welcomeStrings.buttonTwo && typeof welcomeStrings.buttonTwo === 'string') {
				document.getElementById('close-window-instructions').innerHTML = welcomeStrings.buttonTwo;
			}
		}
	};


	if(window.opener && window.opener.parent) {
		parentWindow = window.opener.parent;
	}
	else {
		parentWindow = window.parent;
	}



	onSignedIn();

</script>
</body>
</html>
